#!/bin/bash

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
KIND="$SCRIPT_DIR/kind"
KUBECTL="$SCRIPT_DIR/kubectl"

CLUSTER_NAME="argocd-vuln-test"
ARGOCD_VERSION="v2.14.19"

echo "=== CVE-2025-59537 Environment Setup ==="

if [ ! -x "$KIND" ]; then
    echo "Downloading kind..."
    curl -Lo "$KIND" https://kind.sigs.k8s.io/dl/v0.24.0/kind-linux-amd64
    chmod +x "$KIND"
fi

if [ ! -x "$KUBECTL" ]; then
    echo "Downloading kubectl..."
    curl -Lo "$KUBECTL" "https://dl.k8s.io/release/v1.31.0/bin/linux/amd64/kubectl"
    chmod +x "$KUBECTL"
fi

echo "Deleting existing cluster if exists..."
$KIND delete cluster --name $CLUSTER_NAME 2>/dev/null || true

echo "Creating Kind cluster..."
$KIND create cluster --name $CLUSTER_NAME --wait 120s

echo "Creating argocd namespace..."
$KUBECTL create namespace argocd

echo "Installing ArgoCD $ARGOCD_VERSION..."
$KUBECTL apply -n argocd -f https://raw.githubusercontent.com/argoproj/argo-cd/${ARGOCD_VERSION}/manifests/install.yaml

echo "Waiting for ArgoCD pods to be ready..."
$KUBECTL wait --for=condition=available --timeout=300s deployment/argocd-server -n argocd

echo ""
echo "=== Setup Complete ==="
echo "Start port-forward with:"
echo "  $KUBECTL port-forward svc/argocd-server -n argocd 8080:443"
