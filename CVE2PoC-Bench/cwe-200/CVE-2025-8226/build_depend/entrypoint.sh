#!/bin/sh

echo "Waiting for MySQL to be ready (60 seconds)..."
sleep 60

echo "Initializing database..."
mysql --host=mysql --user=root --password=123456 --skip-ssl --connect-timeout=30 -e "CREATE DATABASE IF NOT EXISTS chancms CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci;" 2>&1 || echo "DB may exist"
mysql --host=mysql --user=root --password=123456 --skip-ssl --connect-timeout=30 chancms < /app/data/chancms.sql 2>&1 || echo "Init may have run"

echo "Reordering config to put accessKey first..."
mysql --host=mysql --user=root --password=123456 --skip-ssl chancms -e "
UPDATE sys_config SET id=100 WHERE id=1;
UPDATE sys_config SET id=1 WHERE id=3;
UPDATE sys_config SET id=3 WHERE id=100;
" 2>&1 || echo "Reorder done"

echo "Starting ChanCMS..."
NODE_ENV=prd node app.js
