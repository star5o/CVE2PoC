FROM composer:2 AS vendor

WORKDIR /app

RUN composer config --global audit.block-insecure false

COPY composer.json .
RUN composer install --no-interaction --ignore-platform-reqs

FROM craftcms/nginx:8.2-dev

USER root
RUN apk add --no-cache mysql-client
USER www-data

COPY --chown=www-data:www-data --from=vendor /app /app
COPY --chown=www-data:www-data web/ /app/web/
COPY --chown=www-data:www-data config/ /app/config/
COPY --chown=www-data:www-data bootstrap.php /app/
COPY --chown=www-data:www-data craft /app/

RUN mkdir -p /app/storage /app/web/cpresources && \
    chmod -R 777 /app/storage /app/web/cpresources

ENV CRAFT_ALLOW_UPDATES=true
ENV CRAFT_DEV_MODE=true
