import io
import sys
from flask import Flask, request, jsonify, render_template_string
import pandas as pd

app = Flask(__name__)

df = pd.DataFrame({
    'name': ['Alice', 'Bob', 'Charlie'],
    'age': [25, 30, 35],
    'salary': [50000, 60000, 70000]
})

HTML_TEMPLATE = '''
<!DOCTYPE html>
<html>
<head>
    <title>Table Chat Agent - Data Query</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { color: #333; }
        .info { background: #e7f3ff; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
        textarea { width: 100%; height: 80px; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-family: monospace; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
        button:hover { background: #0056b3; }
        .result { margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 5px; white-space: pre-wrap; font-family: monospace; }
        .data-preview { margin: 20px 0; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background: #f2f2f2; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Table Chat Agent</h1>
        <div class="info">
            <p><strong>Langroid TableChatAgent Demo</strong></p>
            <p>Enter a pandas expression to query the dataset. The expression will be evaluated using pandas eval().</p>
        </div>
        
        <div class="data-preview">
            <h3>Sample Data:</h3>
            <table>
                <tr><th>name</th><th>age</th><th>salary</th></tr>
                <tr><td>Alice</td><td>25</td><td>50000</td></tr>
                <tr><td>Bob</td><td>30</td><td>60000</td></tr>
                <tr><td>Charlie</td><td>35</td><td>70000</td></tr>
            </table>
        </div>
        
        <form id="queryForm">
            <label for="expression"><strong>Pandas Expression:</strong></label><br><br>
            <textarea name="expression" id="expression" placeholder="e.g., df.head() or df['age'].mean()"></textarea>
            <br>
            <button type="submit">Evaluate</button>
        </form>
        
        <div id="result" class="result" style="display:none;"></div>
    </div>
    
    <script>
        document.getElementById('queryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const expression = document.getElementById('expression').value;
            const resultDiv = document.getElementById('result');
            
            try {
                const response = await fetch('/api/pandas_eval', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({expression: expression})
                });
                const data = await response.json();
                resultDiv.style.display = 'block';
                resultDiv.textContent = 'Result:\\n' + data.result;
            } catch (error) {
                resultDiv.style.display = 'block';
                resultDiv.textContent = 'Error: ' + error.message;
            }
        });
    </script>
</body>
</html>
'''

@app.route('/')
def index():
    return render_template_string(HTML_TEMPLATE)

@app.route('/api/pandas_eval', methods=['POST'])
def pandas_eval():
    """Vulnerable endpoint - mimics Langroid TableChatAgent.pandas_eval()"""
    data = request.get_json()
    expression = data.get('expression', '')
    
    local_vars = {"df": df}
    code_out = io.StringIO()
    sys.stdout = code_out
    
    try:
        eval_result = eval(expression, {}, local_vars)
    except Exception as e:
        eval_result = f"ERROR: {type(e).__name__}: {e}"
    
    if eval_result is None:
        eval_result = ""
    
    sys.stdout = sys.__stdout__
    print_result = code_out.getvalue() or ""
    sep = "\n" if print_result else ""
    result = f"{print_result}{sep}{eval_result}"
    if result == "":
        result = "No result"
    
    return jsonify({"result": str(result)})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=False)
