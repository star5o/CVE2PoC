FROM node:20-alpine

WORKDIR /app

ENV NODE_OPTIONS="--max-old-space-size=4096"
ENV AWS_REGION=us-east-1
ENV AWS_ACCESS_KEY_ID=placeholder
ENV AWS_SECRET_ACCESS_KEY=placeholder
ENV BETTER_AUTH_SECRET=build_secret_placeholder
ENV ENCRYPTION_KEY=encryption_key_placeholder

COPY sim/package*.json ./

RUN npm install

COPY sim/ ./

RUN npx drizzle-kit generate

RUN npm run build

EXPOSE 3000

CMD npx drizzle-kit push && npm run start
