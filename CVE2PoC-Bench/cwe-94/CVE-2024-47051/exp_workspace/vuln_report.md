# CVE-2024-47051 Vulnerability Report

## Overview

- **CVE ID**: CVE-2024-47051
- **CWE**: CWE-94 (Improper Control of Generation of Code)
- **Affected Product**: Mautic
- **Affected Versions**: < 5.2.3
- **Severity**: Critical
- **CVSS Score**: 8.8 (High)

## Vulnerability Description

Mautic versions before 5.2.3 contain a Remote Code Execution (RCE) vulnerability in the asset upload functionality. The vulnerability allows authenticated users with asset management permissions to upload and execute arbitrary PHP code.

## Root Cause

The vulnerability exists in the `AssetUploadHelper::uploadAsset()` method located at `app/bundles/AssetBundle/Helper/AssetUploadHelper.php`.

The issue occurs because:
1. When uploading a file, the system validates the file extension against allowed extensions
2. However, when saving the asset, the system uses `guessExtension()` to determine the final extension
3. If `guessExtension()` returns NULL (which happens for files with unrecognized MIME types), the system falls back to using the `originalFileName` extension
4. An attacker can upload a file with PHP code using an allowed extension (e.g., .png), then modify the `originalFileName` parameter to .php during asset creation

## Vulnerable Code Path

1. File upload via `/s/_uploader/asset/upload` with allowed extension
2. Asset creation via `/s/assets/new` with modified `originalFileName`
3. In `AssetUploadHelper::uploadAsset()`:
   - `guessExtension()` returns NULL for PHP code content
   - System uses `originalFileName` extension (.php) as fallback
4. PHP file is saved to `/media/files/` directory
5. Attacker accesses the file to execute arbitrary code

## Exploitation Steps

1. Authenticate to Mautic with asset management permissions
2. Navigate to New Asset page to obtain `tempId` and CSRF token
3. Upload PHP payload with allowed extension (.png) including `tempId` parameter
4. Submit asset form with `originalFileName` set to `.php` extension
5. Access the uploaded file at `/media/files/{sha1hash}.php`
6. PHP code executes, achieving RCE

## Impact

- **Remote Code Execution**: Attackers can execute arbitrary system commands
- **Server Compromise**: Full control over the web server
- **Data Breach**: Access to sensitive data and database
- **Lateral Movement**: Potential to attack other systems in the network

## Proof of Concept

The PoC script `poc.py` demonstrates the vulnerability:

```
[*] CVE-2024-47051 - Mautic RCE
[*] Target: http://localhost:8080
[+] Login successful as admin
[*] Uploading malicious PHP file...
[*] Temp ID: tmp_698238860bf3a
[*] Temp Filename: 6982388617d30.png
[+] Asset created with ID: 4
[+] Uploaded: b932c3ac3c9c98793bc20416b087932fd86d58ab.php
[*] Payload URL: http://localhost:8080/media/files/b932c3ac3c9c98793bc20416b087932fd86d58ab.php
[+] RCE Successful!
[+] Output:
uid=33(www-data) gid=33(www-data) groups=33(www-data)
[+] Vulnerability verified!
```

## Mitigation

1. Upgrade to Mautic version 5.2.3 or later
2. Restrict asset upload permissions to trusted users only
3. Implement additional server-side validation of file contents
4. Use `.htaccess` or server configuration to prevent PHP execution in upload directories

## References

- https://github.com/mautic/mautic/security/advisories/GHSA-xpc7-9c5v-6jm3
- https://nvd.nist.gov/vuln/detail/CVE-2024-47051
- https://www.sonicwall.com/blog/mautic-cve-2024-47051-cve-2024-47050-vulnerabilities-detailed-analysis
