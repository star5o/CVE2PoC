services:
  db:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: mautic_root
      MYSQL_DATABASE: mautic
      MYSQL_USER: mautic
      MYSQL_PASSWORD: mautic
    volumes:
      - mysql-data:/var/lib/mysql
    healthcheck:
      test: mysqladmin --user=mautic --password=mautic ping
      start_period: 5s
      interval: 5s
      timeout: 5s
      retries: 30
    networks:
      - mautic-net

  mautic:
    image: mautic/mautic:5.2.0-fpm
    volumes:
      - mautic-html:/var/www/html
    environment:
      MAUTIC_DB_HOST: db
      MAUTIC_DB_PORT: 3306
      MAUTIC_DB_DATABASE: mautic
      MAUTIC_DB_USER: mautic
      MAUTIC_DB_PASSWORD: mautic
      DOCKER_MAUTIC_LOAD_TEST_DATA: "false"
    depends_on:
      db:
        condition: service_healthy
    networks:
      - mautic-net

  nginx:
    image: nginx:alpine
    ports:
      - "8080:80"
    volumes:
      - ./build_depend/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - mautic-html:/var/www/html:ro
    depends_on:
      - mautic
    networks:
      - mautic-net

volumes:
  mysql-data:
  mautic-html:

networks:
  mautic-net:
