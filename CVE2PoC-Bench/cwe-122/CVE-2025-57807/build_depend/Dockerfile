FROM php:7.4-apache

WORKDIR /var/www/html

RUN apt-get update && apt-get install -y \
    wget \
    build-essential \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    libgomp1 \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

RUN wget https://github.com/ImageMagick/ImageMagick/archive/refs/tags/7.1.2-0.tar.gz && \
    tar xzf 7.1.2-0.tar.gz && \
    cd ImageMagick-7.1.2-0 && \
    ./configure --prefix=/usr/local && \
    make -j$(nproc) && \
    make install && \
    ldconfig /usr/local/lib && \
    cd .. && \
    rm -rf 7.1.2-0.tar.gz

RUN pecl install imagick && \
    docker-php-ext-enable imagick

COPY poc.c /tmp/poc.c
RUN cd /tmp && \
    gcc -o /usr/local/bin/poc poc.c \
    -I/var/www/html/ImageMagick-7.1.2-0 \
    $(pkg-config --cflags --libs MagickCore-7.Q16HDRI) \
    -Wl,-rpath,/usr/local/lib && \
    rm -rf /var/www/html/ImageMagick-7.1.2-0 /tmp/poc.c

COPY index.php /var/www/html/

RUN mkdir -p /var/www/html/uploads && \
    chown -R www-data:www-data /var/www/html && \
    chmod -R 755 /var/www/html

EXPOSE 80

CMD ["apache2-foreground"]
