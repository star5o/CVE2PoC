<!DOCTYPE html>
<html>
<head>
    <title>CVE-2025-57807 - ImageMagick Heap Buffer Overflow</title>
    <style>
        body { font-family: Arial; max-width: 1000px; margin: 50px auto; padding: 20px; }
        .header { background: #f0f0f0; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        .btn { padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; margin: 5px; }
        .btn-info { background: #17a2b8; }
        .result { margin-top: 20px; padding: 15px; border-radius: 5px; background: #f8f9fa; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="header">
        <h1>CVE-2025-57807 Demo</h1>
        <p><strong>Vulnerability</strong>: ImageMagick Heap Buffer Overflow</p>
        <p><strong>CWE-122</strong>: Heap-based Buffer Overflow</p>
        <p><strong>CVSS</strong>: 9.8 (Critical)</p>
    </div>

<?php
header('Content-Type: text/html; charset=utf-8');

if (isset($_GET['action'])) {
    $action = $_GET['action'];
    
    if ($action === 'version') {
        echo "<div class='result'><h3>ImageMagick Version</h3><pre>";
        $output = shell_exec('convert -version 2>&1');
        echo htmlspecialchars($output);
        echo "</pre></div>";
    }
    
    else if ($action === 'trigger') {
        echo "<div class='result'><h3>Triggering CVE-2025-57807 PoC</h3>";
        echo "<p>Executing heap overflow exploit...</p><pre>";
        
        $descriptorspec = array(
            0 => array("pipe", "r"),
            1 => array("pipe", "w"),
            2 => array("pipe", "w")
        );
        
        $process = proc_open('/usr/local/bin/poc 2>&1', $descriptorspec, $pipes);
        
        if (is_resource($process)) {
            fclose($pipes[0]);
            
            $start = microtime(true);
            $output = '';
            $timeout = 5;
            
            stream_set_blocking($pipes[1], false);
            
            while (true) {
                $read = fread($pipes[1], 4096);
                if ($read !== false && $read !== '') {
                    $output .= $read;
                }
                
                $status = proc_get_status($process);
                if (!$status['running']) {
                    $read = stream_get_contents($pipes[1]);
                    if ($read) $output .= $read;
                    break;
                }
                
                if (microtime(true) - $start > $timeout) {
                    proc_terminate($process, 9);
                    $output .= "\n[TIMEOUT] Process killed after {$timeout}s\n";
                    break;
                }
                
                usleep(10000);
            }
            
            fclose($pipes[1]);
            fclose($pipes[2]);
            
            $return_value = proc_close($process);
            
            echo htmlspecialchars($output);
            echo "\n----------------------------------------\n";
            echo "Exit code: " . $return_value . "\n";
            
            if ($return_value == -1 || $return_value == 139 || $return_value == 134 || $return_value == 11 || $return_value == 6) {
                echo "\n[CRASH DETECTED] Process terminated abnormally!\n";
                echo "Signal: ";
                if ($return_value == 139 || $return_value == 11) echo "SIGSEGV (Segmentation Fault)";
                else if ($return_value == 134 || $return_value == 6) echo "SIGABRT (Abort)";
                else echo "Unknown ($return_value)";
                echo "\n\n*** VULNERABILITY CONFIRMED: HEAP OVERFLOW TRIGGERED ***\n";
            } else if ($return_value == 0) {
                echo "\n[INFO] Process completed normally (may need ASan for crash)\n";
            }
        } else {
            echo "Failed to execute PoC";
        }
        
        echo "</pre></div>";
    }
    
    else if ($action === 'info') {
        echo "<div class='result'><h3>Vulnerability Information</h3>";
        echo "<pre>";
        echo "CVE ID: CVE-2025-57807\n";
        echo "Type: Heap-based Buffer Overflow (CWE-122)\n";
        echo "CVSS: 9.8 Critical\n\n";
        echo "Affected: ImageMagick < 14.8.2 (< 7.1.2-3, < 6.9.13-29)\n";
        echo "Fixed: 14.8.2, 7.1.2-3, 6.9.13-29\n\n";
        echo "Root Cause:\n";
        echo "  1. SeekBlob() allows offset > extent without reallocation\n";
        echo "  2. WriteBlob() expands by (quantum + length) not (offset + length)\n";
        echo "  3. memcpy to (data + offset) writes beyond allocation\n\n";
        echo "Attack Vector:\n";
        echo "  1. Create 1-byte BlobStream (extent=1)\n";
        echo "  2. Write 1 byte (offset becomes 1)\n";
        echo "  3. Seek to 256 MiB (offset=0x10000000, extent still 1)\n";
        echo "  4. Write payload -> heap overflow!\n";
        echo "</pre></div>";
    }
}
?>

    <div style="margin-top: 20px;">
        <h3>Actions</h3>
        <a href="?action=version"><button class="btn btn-info">Check Version</button></a>
        <a href="?action=info"><button class="btn btn-info">Vulnerability Info</button></a>
        <a href="?action=trigger"><button class="btn">Trigger Exploit (CRASH)</button></a>
    </div>

    <div style="margin-top: 40px; padding: 20px; background: #fff3cd; border-radius: 5px;">
        <h4>API Endpoints</h4>
        <ul>
            <li><code>GET /?action=version</code> - Check ImageMagick version</li>
            <li><code>GET /?action=info</code> - Get vulnerability details</li>
            <li><code>GET /?action=trigger</code> - <strong>Execute PoC (causes crash)</strong></li>
        </ul>
    </div>

    <div style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 5px;">
        <p><strong>Current Environment</strong>:</p>
        <pre>ImageMagick Version: <?php echo trim(shell_exec('convert -version 2>&1 | head -1')); ?></pre>
    </div>
</body>
</html>
