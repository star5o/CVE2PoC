# CVE-2025-68109 Vulnerability Report

## Overview

| Item | Description |
|------|-------------|
| CVE ID | CVE-2025-68109 |
| Vulnerability Type | CWE-78 (OS Command Injection via Unrestricted File Upload) |
| Affected Software | ChurchCRM |
| Affected Versions | < 6.5.3 |
| Fixed Version | 6.5.3 |
| CVSS Score | High |

## Vulnerability Description

ChurchCRM is an open-source church management system. In versions prior to 6.5.3, the Database Restore functionality does not validate the content or file extension of uploaded files. The vulnerable code is located in `src/ChurchCRM/Backup/RestoreJob.php`.

The `RestoreJob` class accepts user-uploaded files without validating:
1. File extension
2. File content/MIME type
3. Archive contents

When a full backup (tar.gz) is uploaded, the application extracts it and copies the `Images/` directory to the web-accessible Images root. An attacker can craft a malicious backup containing:
1. A PHP webshell in the Images directory
2. A .htaccess file to enable PHP execution

## Technical Analysis

### Vulnerable Code

```php
// RestoreJob.php - Line 48
$this->RestoreFile = new \SplFileInfo($this->TempFolder . '/' . $rawUploadedFile['name']);
move_uploaded_file($rawUploadedFile['tmp_name'], $this->RestoreFile);
```

The file name is taken directly from user input without validation. The `restoreFullBackup()` method then extracts the archive and copies files to the web root:

```php
// RestoreJob.php - Line 116
FileSystemUtils::recursiveCopyDirectory($this->TempFolder . '/Images/', SystemURLs::getImagesRoot());
```

### Attack Vector

1. Attacker authenticates as admin user
2. Attacker creates a malicious tar.gz backup containing:
   - `Images/shell.php` - PHP webshell
   - `Images/.htaccess` - Apache configuration to enable PHP execution
   - `ChurchCRM-Database.sql` - Minimal SQL file to pass validation
3. Attacker uploads the malicious backup via `/api/database/restore`
4. Application extracts backup and copies Images directory to web root
5. Attacker accesses webshell at `/Images/shell.php?cmd=<command>`

## Proof of Concept

### Exploit Flow

```
1. Login to ChurchCRM with admin credentials
2. Create malicious tar.gz backup
3. Upload via POST /api/database/restore
4. Access webshell at /Images/shell.php?cmd=id
```

### Exploit Result

```
[+] Webshell is accessible at: http://localhost:8080/Images/shell.php
[+] Command output:
uid=33(www-data) gid=33(www-data) groups=33(www-data)

[*] Testing RCE with 'uname -a':
Linux 72e85b312ea5 6.8.0-90-generic #91-Ubuntu SMP PREEMPT_DYNAMIC ...
```

## Impact

- **Remote Code Execution**: Attacker can execute arbitrary system commands on the server
- **Complete Server Compromise**: Full control over the web server with www-data privileges
- **Data Breach**: Access to database credentials and sensitive church member data
- **Lateral Movement**: Potential pivot point for further network attacks

## Remediation

1. Upgrade to ChurchCRM version 6.5.3 or later
2. Implement strict file extension validation (allow only .sql, .sql.gz, .tar.gz)
3. Validate archive contents before extraction
4. Sanitize file paths to prevent directory traversal
5. Use MIME type validation for uploaded files

## References

- [ChurchCRM GitHub Repository](https://github.com/ChurchCRM/CRM)
- [CWE-78: Improper Neutralization of Special Elements used in an OS Command](https://cwe.mitre.org/data/definitions/78.html)
