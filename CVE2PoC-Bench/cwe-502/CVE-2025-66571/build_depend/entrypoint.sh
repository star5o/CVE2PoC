#!/bin/bash

echo "Waiting for MySQL to be ready..."
for i in {1..30}; do
    result=$(php -r "try { new PDO('mysql:host=${DB_HOST};', '${DB_USER}', '${DB_PWD}'); echo 'ok'; } catch(Exception \$e) { echo 'fail'; }" 2>/dev/null)
    if [ "$result" = "ok" ]; then
        echo "MySQL is ready!"
        break
    fi
    echo "Waiting for MySQL... ($i/30)"
    sleep 2
done

chown -R www-data:www-data /var/www/html/cache /var/www/html/cache_public /var/www/html/tmp /var/www/html/storage /var/www/html/logs 2>/dev/null || true

echo "Starting Apache..."
exec apache2-foreground
