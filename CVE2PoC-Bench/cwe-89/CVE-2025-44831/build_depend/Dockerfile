FROM debian:bookworm-slim

ARG ENGINEERCMS_TAG=v1.03
ARG ENGINEERCMS_REPO=https://github.com/3xxx/engineercms.git
ARG ENGINEERCMS_BINARY_URL=https://github.com/3xxx/engineercms/releases/download/v1.03/engineercms.linux.rar

RUN apt-get update && apt-get install -y --no-install-recommends git ca-certificates tzdata wget unar && \
    rm -rf /var/lib/apt/lists/* && \
    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

WORKDIR /tmp

RUN git clone --depth 1 --branch ${ENGINEERCMS_TAG} ${ENGINEERCMS_REPO} /tmp/src && \
    wget -O /tmp/engineercms.linux.rar ${ENGINEERCMS_BINARY_URL} && \
    mkdir -p /tmp/bin && \
    unar -f -o /tmp/bin /tmp/engineercms.linux.rar && \
    mkdir -p /app && \
    cp /tmp/bin/engineercms /app/engineercms && \
    cp -r /tmp/src/conf /tmp/src/static /tmp/src/views /tmp/src/swagger /app/ && \
    sed -i 's/^runmode = .*/runmode = prod/' /app/conf/app.conf && \
    [ -f /app/conf/app2.conf ] || touch /app/conf/app2.conf

WORKDIR /app
RUN chmod +x /app/engineercms && mkdir -p /app/database /app/attachment /app/log && \
    rm -rf /tmp/src /tmp/bin /tmp/engineercms.linux.rar

EXPOSE 80

CMD ["./engineercms"]
