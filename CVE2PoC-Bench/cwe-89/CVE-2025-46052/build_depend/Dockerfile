FROM php:7.4-apache

RUN apt-get update && apt-get install -y \
    libpng-dev \
    libjpeg-dev \
    libfreetype6-dev \
    gettext \
    libxml2-dev \
    libonig-dev \
    unzip \
    wget \
    git \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && docker-php-ext-install -j$(nproc) gd mysqli pdo_mysql gettext xml mbstring \
    && a2enmod rewrite \
    && rm -rf /var/lib/apt/lists/*

RUN echo "upload_max_filesize = 50M" >> /usr/local/etc/php/php.ini \
    && echo "post_max_size = 50M" >> /usr/local/etc/php/php.ini \
    && echo "display_errors = On" >> /usr/local/etc/php/php.ini \
    && echo "error_reporting = E_ALL" >> /usr/local/etc/php/php.ini

WORKDIR /var/www/html

# Clone the repository and checkout specific commit
RUN git config --global --add safe.directory /var/www/html && \
    rm -rf * && \
    git clone https://github.com/timschofield/webERP.git . && \
    git checkout fb1a37af31d960a6ace9fe6c8b8881ad78ea0b3c && \
    rm -rf .git

RUN mkdir -p /var/www/html/companies/weberpdemo \
    && cp -r /var/www/html/companies/weberp/* /var/www/html/companies/weberpdemo/ 2>/dev/null || true \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html

COPY build_depend/config.php /var/www/html/config.php

EXPOSE 80
