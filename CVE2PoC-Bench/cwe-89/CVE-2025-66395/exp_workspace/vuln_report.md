# CVE-2025-66395 Vulnerability Report

## Summary

ChurchCRM prior to version 6.5.3 contains a SQL injection vulnerability in the `src/ListEvents.php` file. The `WhichType` POST parameter is not properly sanitized before being used in SQL queries, allowing authenticated users to execute arbitrary SQL commands.

## Affected Component

- File: `src/ListEvents.php`
- Parameter: `WhichType` (POST)
- Vulnerability Type: Time-based Blind SQL Injection

## Vulnerability Analysis

The vulnerable code in `src/ListEvents.php` (version 5.7.0):

```php
if (isset($_POST['WhichType'])) {
    $eType = InputUtils::legacyFilterInput($_POST['WhichType']);
} else {
    $eType = 'All';
}
```

The `legacyFilterInput()` function without a type parameter only performs basic string sanitization, not integer type casting. This value is then directly concatenated into multiple SQL queries:

```php
$sSQL = "SELECT * FROM event_types WHERE type_id=$eType";
```

```php
$sSQL = "SELECT DISTINCT YEAR(events_event.event_start)
       FROM events_event
       WHERE events_event.event_type = '$eType' AND YEAR(events_event.event_start)";
```

## Exploitation

An authenticated user can inject SQL commands via the `WhichType` parameter. For example:

```
POST /ListEvents.php HTTP/1.1
...
WhichType=1 AND SLEEP(5)
```

This causes the database to sleep for 5 seconds, confirming the SQL injection vulnerability.

## Impact

- Any authenticated user, regardless of privilege level, can execute arbitrary SQL queries
- Attackers can exfiltrate sensitive data including user credentials and financial information
- Attackers can modify or delete data in the database
- Full compromise of application data integrity and confidentiality

## Remediation

Upgrade to ChurchCRM version 6.5.3 or later, which properly sanitizes the `WhichType` parameter using `InputUtils::filterInt()`.

## Test Environment

- ChurchCRM Version: 5.7.0
- PHP Version: 8.2
- Database: MariaDB 10.6

## Proof of Concept

The PoC script (`poc.py`) demonstrates the vulnerability by:
1. Authenticating to ChurchCRM
2. Sending a crafted POST request with a time-based SQL injection payload
3. Measuring response time to confirm exploitation
