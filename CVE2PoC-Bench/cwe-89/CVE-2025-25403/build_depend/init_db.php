<?php
define('INDEX_AUTH', 1);

$config = require '/var/www/html/slims/config/database.php';
$node = $config['nodes']['SLiMS'];

$mysqli = new mysqli($node['host'], $node['username'], $node['password'], $node['database'], $node['port']);
if ($mysqli->connect_error) {
    die("Connection failed: " . $mysqli->connect_error);
}

$result = $mysqli->query("SHOW TABLES LIKE 'user'");
if ($result->num_rows > 0) {
    echo "Database already initialized.\n";
    exit(0);
}

echo "Initializing database...\n";

require_once '/var/www/html/slims/install/install.sql.php';

foreach ($sql['create'] as $query) {
    if (!$mysqli->query($query)) {
        echo "Error: " . $mysqli->error . "\n";
    }
}

foreach ($sql['insert'] as $query) {
    if (!$mysqli->query($query)) {
        echo "Error: " . $mysqli->error . "\n";
    }
}

if (isset($query_trigger) && is_array($query_trigger)) {
    foreach ($query_trigger as $query) {
        if (!$mysqli->query($query)) {
            echo "Error: " . $mysqli->error . "\n";
        }
    }
}

$mysqli->query("INSERT IGNORE INTO `setting` (`setting_id`, `setting_name`, `setting_value`) VALUES (1, 'library_name', 'SLiMS Library')");
$mysqli->query("INSERT IGNORE INTO `setting` (`setting_id`, `setting_name`, `setting_value`) VALUES (2, 'library_subname', 'Your Library Tagline')");

echo "Database initialized successfully.\n";
$mysqli->close();
