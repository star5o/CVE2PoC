FROM debian:bookworm-slim

ARG ENGINEERCMS_TAG=v1.03
ARG ENGINEERCMS_REPO=https://github.com/3xxx/engineercms.git
ARG ENGINEERCMS_BINARY_URL=https://github.com/3xxx/engineercms/releases/download/v1.03/engineercms.linux.rar

RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    git \
    unar \
    wget \
    tzdata && \
    rm -rf /var/lib/apt/lists/* && \
    ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

WORKDIR /tmp

# 1) 拉取指定 tag 的资源文件（conf/static/views/database）
RUN git clone --depth 1 --branch ${ENGINEERCMS_TAG} ${ENGINEERCMS_REPO} /tmp/src

# 2) 下载官方 release 二进制并解压
RUN wget -O /tmp/engineercms.linux.rar ${ENGINEERCMS_BINARY_URL} && \
    mkdir -p /tmp/bin && \
    unar -f -o /tmp/bin /tmp/engineercms.linux.rar

WORKDIR /app

RUN cp /tmp/bin/engineercms /app/engineercms && \
    cp -r /tmp/src/conf /app/conf && \
    cp -r /tmp/src/static /app/static && \
    cp -r /tmp/src/views /app/views && \
    cp -r /tmp/src/database /app/database && \
    sed -i 's/^httpport = .*/httpport = 8081/' /app/conf/app.conf && \
    sed -i 's/^runmode = .*/runmode = prod/' /app/conf/app.conf && \
    chmod +x /app/engineercms && \
    mkdir -p /app/attachment /app/runtime/logs && \
    [ -f /app/conf/app2.conf ] || touch /app/conf/app2.conf

EXPOSE 8081

CMD ["./engineercms"]
