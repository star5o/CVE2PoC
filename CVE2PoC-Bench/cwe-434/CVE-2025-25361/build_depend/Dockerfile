FROM maven:3.8.6-openjdk-8 AS builder
WORKDIR /build
RUN apt-get update && apt-get install -y git && rm -rf /var/lib/apt/lists/*
RUN git clone https://github.com/sanluan/PublicCMS.git . \
    && git checkout b8753654ed706c72439ddfe13a46f4dabf5b90f2 \
    && rm -rf .git
RUN cd publiccms-parent && mvn clean package -DskipTests -Dmaven.javadoc.skip=true -q

FROM eclipse-temurin:8-jre
COPY --from=builder /build/publiccms-parent/publiccms/target/publiccms.war /opt/publiccms.war
COPY --from=builder /build/data /data
ENV PORT=8080
ENV CONTEXTPATH=""
ENV FILEPATH="/data/publiccms"
ENV TZ=Asia/Shanghai
VOLUME $FILEPATH
ENTRYPOINT java -jar -Dcms.port=$PORT -Dcms.contextPath=$CONTEXTPATH -Dcms.filePath=$FILEPATH /opt/publiccms.war
EXPOSE $PORT
