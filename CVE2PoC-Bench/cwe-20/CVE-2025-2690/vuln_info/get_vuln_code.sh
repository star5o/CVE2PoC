#!/bin/bash

REPO_URL="https://github.com/yiisoft/yii2.git"
VULNERABLE_TAG="2.0.37"
TARGET_DIR="$(dirname "$0")/source_code"

if [ -d "$TARGET_DIR" ]; then
    echo "Source code directory exists at $TARGET_DIR"
    cd "$TARGET_DIR"
    git fetch --tags 2>/dev/null
    git checkout "$VULNERABLE_TAG" 2>/dev/null || git checkout "tags/$VULNERABLE_TAG" 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "Checked out to $VULNERABLE_TAG"
        exit 0
    fi
fi

rm -rf "$TARGET_DIR"
git clone --depth 1 --branch "$VULNERABLE_TAG" "$REPO_URL" "$TARGET_DIR"

if [ $? -eq 0 ]; then
    echo "Successfully cloned Yii2 $VULNERABLE_TAG to $TARGET_DIR"
else
    echo "Failed to clone with tag, trying full clone..."
    git clone "$REPO_URL" "$TARGET_DIR"
    cd "$TARGET_DIR"
    git checkout "$VULNERABLE_TAG" 2>/dev/null || git checkout "tags/$VULNERABLE_TAG"
fi
