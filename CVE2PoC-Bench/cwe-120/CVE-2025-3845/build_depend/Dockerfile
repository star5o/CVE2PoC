FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    g++ \
    make \
    git \
    libmysqlclient-dev \
    mysql-client \
    netcat \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Clone vulnerable source at pinned commit (WebServer v1.0-era codebase).
RUN git config --global --add safe.directory /app \
    && git clone https://github.com/markparticle/WebServer.git /app \
    && cd /app \
    && git checkout 3b375204a80cc0de1caf5c076e95d6b5567a8159 \
    && rm -rf /app/.git

RUN mkdir -p /app/bin && cd /app/build && make

COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

EXPOSE 1316

ENTRYPOINT ["/entrypoint.sh"]
