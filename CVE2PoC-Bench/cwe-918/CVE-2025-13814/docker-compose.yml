version: '3.8'

services:
  mysql:
    image: registry.cn-shenzhen.aliyuncs.com/mogublog/mysql
    restart: always
    container_name: mogu_mysql
    environment:
      MYSQL_ROOT_PASSWORD: mogu2018
    command:
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_general_ci
      --explicit_defaults_for_timestamp=true
      --lower_case_table_names=1
    ports:
      - 3306:3306
    volumes:
      - ./build_depend/mysql_data:/var/lib/mysql
      - ./build_depend/mysql_init:/docker-entrypoint-initdb.d/
    networks:
      - mogu
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-uroot", "-pmogu2018"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: registry.cn-shenzhen.aliyuncs.com/mogublog/redis
    restart: always
    container_name: mogu_redis
    ports:
      - 6379:6379
    command: redis-server --requirepass mogu2018 --appendonly yes
    networks:
      - mogu

  rabbitmq:
    restart: always
    image: registry.cn-shenzhen.aliyuncs.com/mogublog/rabbitmq
    container_name: mogu_rabbitmq
    ports:
      - 5672:5672
      - 15672:15672
    environment:
      TZ: Asia/Shanghai
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: mogu2018
    networks:
      - mogu

  nacos:
    image: registry.cn-shenzhen.aliyuncs.com/mogublog/nacos-server
    container_name: mogu_nacos
    env_file:
      - ./build_depend/nacos/nacos-config.env
    volumes:
      - ./build_depend/nacos/custom.properties:/home/nacos/init.d/custom.properties
    ports:
      - "8848:8848"
      - "9555:9555"
    restart: always
    networks:
      - mogu
    depends_on:
      mysql:
        condition: service_healthy

  mogu_picture:
    image: registry.cn-shenzhen.aliyuncs.com/mogublog/mogu_picture:latest
    container_name: mogu_picture
    restart: always
    ports:
      - 8602:8602
    networks:
      - mogu
    volumes:
      - ./build_depend/config/mogu_picture:/config/
      - ./build_depend/mogu_data:/home/mogu_blog/mogu_data/
    depends_on:
      - nacos
      - mysql
      - redis

  internal-service:
    image: nginx:alpine
    container_name: mogu_internal
    expose:
      - "80"
    volumes:
      - ./build_depend/internal_data.html:/usr/share/nginx/html/index.html:ro
    networks:
      - mogu

networks:
  mogu:
    driver: bridge
