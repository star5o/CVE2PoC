FROM node:20-bookworm

WORKDIR /app

RUN apt-get update && apt-get install -y \
    python3 \
    python3-pip \
    python3-venv \
    git \
    && rm -rf /var/lib/apt/lists/*

RUN npm install -g pnpm supergateway

RUN git clone https://github.com/zcaceres/markdownify-mcp.git /app/markdownify-mcp && \
    cd /app/markdownify-mcp && \
    git checkout 949f12e633320548c565c6ec892d33695b158d64 && \
    rm -rf /app/markdownify-mcp/.git

WORKDIR /app/markdownify-mcp

RUN python3 -m venv .venv && \
    .venv/bin/pip install markitdown

RUN rm -f .python-version && pnpm install && pnpm run build

ENV UV_PATH="/usr/bin/env"

EXPOSE 8000

CMD ["supergateway", "--stdio", "node dist/index.js", "--port", "8000", "--cors"]
