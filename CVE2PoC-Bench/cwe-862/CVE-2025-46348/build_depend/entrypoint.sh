#!/bin/bash

echo "Waiting for MySQL to be ready..."
sleep 15

if [ ! -f /var/www/html/wakka.config.php ]; then
    cat > /var/www/html/wakka.config.php << 'EOF'
<?php
$wakkaConfig = array(
    'wakka_version' => '0.1.1',
    'wikini_version' => '0.5.0',
    'yeswiki_version' => '4.5.3',
    'yeswiki_release' => 'doryphore',
    'debug' => 'no',
    'mysql_host' => 'db',
    'mysql_database' => 'yeswiki',
    'mysql_user' => 'yeswiki',
    'mysql_password' => 'yeswiki123',
    'table_prefix' => 'yeswiki_',
    'root_page' => 'PagePrincipale',
    'wakka_name' => 'VulnWiki',
    'base_url' => 'http://localhost:8085/?',
    'rewrite_mode' => '0',
    'meta_keywords' => '',
    'meta_description' => '',
    'action_path' => 'actions',
    'handler_path' => 'handlers',
    'header_action' => 'header',
    'footer_action' => 'footer',
    'navigation_links' => 'PagePrincipale :: TableauDeBord :: GererSite',
    'referrers_purge_time' => 24,
    'pages_purge_time' => 0,
    'default_language' => 'fr',
    'default_write_acl' => '*',
    'default_read_acl' => '*',
    'default_comment_acl' => '@admins',
    'preview_before_save' => '0',
    'allow_raw_html' => '0',
    'favorite_theme' => 'margot',
    'favorite_squelette' => 'responsive-1col.tpl.html',
    'favorite_style' => 'margot.css',
);
EOF
    chown www-data:www-data /var/www/html/wakka.config.php
fi

chown -R www-data:www-data /var/www/html/cache /var/www/html/files /var/www/html/private 2>/dev/null || true

exec apache2-foreground
