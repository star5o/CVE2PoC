#!/bin/bash

REPO_URL="https://github.com/xwiki/xwiki-platform.git"
VULNERABLE_TAG="xwiki-platform-16.4.0"
TARGET_DIR="$(dirname "$0")/source_code"

if [ -d "$TARGET_DIR" ]; then
    echo "Removing existing directory..."
    rm -rf "$TARGET_DIR"
fi

mkdir -p "$TARGET_DIR"
cd "$TARGET_DIR" || exit 1

git init
git remote add origin "$REPO_URL"
git sparse-checkout init --cone
git sparse-checkout set xwiki-platform-core/xwiki-platform-wiki/xwiki-platform-wiki-rest xwiki-platform-core/xwiki-platform-rest

git fetch --depth 1 origin "refs/tags/$VULNERABLE_TAG:refs/tags/$VULNERABLE_TAG"
git checkout "$VULNERABLE_TAG"

echo "Source code available at: $TARGET_DIR"
