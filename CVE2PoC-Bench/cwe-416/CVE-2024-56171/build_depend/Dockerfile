FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update && apt-get install -y \
    build-essential \
    python3 \
    python3-pip \
    wget \
    pkg-config \
    libtool \
    autoconf \
    automake \
    libfl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /build

RUN wget -q https://github.com/GNOME/libxml2/archive/refs/tags/v2.12.9.tar.gz && \
    tar -xzf v2.12.9.tar.gz && \
    cd libxml2-2.12.9 && \
    ./autogen.sh && \
    CFLAGS="-fsanitize=address -g -O1 -fno-omit-frame-pointer" \
    LDFLAGS="-fsanitize=address" \
    ./configure --prefix=/usr/local --with-schemas && \
    make -j$(nproc) && \
    make install && \
    ldconfig

RUN pip3 install flask

WORKDIR /app
COPY app.py schema.xsd validator.c /app/

RUN gcc -fsanitize=address -g -O1 -fno-omit-frame-pointer \
    -I/usr/local/include/libxml2 \
    -o /app/validator /app/validator.c \
    -L/usr/local/lib -lxml2 -Wl,-rpath,/usr/local/lib

ENV LD_LIBRARY_PATH=/usr/local/lib
ENV ASAN_OPTIONS=detect_leaks=0:abort_on_error=0:halt_on_error=0

EXPOSE 8080
CMD ["python3", "app.py"]
