#!/usr/bin/env python3
from flask import Flask, request, jsonify
import subprocess
import tempfile
import os

app = Flask(__name__)

@app.route('/')
def index():
    result = subprocess.run(['/usr/local/bin/xmllint', '--version'], 
                          capture_output=True, text=True)
    version = result.stderr.split('\n')[0] if result.stderr else 'unknown'
    return f'<h1>XML Validator Service</h1><p>POST XML to /validate</p><p>{version}</p>'

@app.route('/validate', methods=['POST'])
def validate_xml():
    xml_data = request.data
    if not xml_data:
        return jsonify({"error": "No XML data"}), 400
    
    with tempfile.NamedTemporaryFile(mode='wb', suffix='.xml', delete=False) as f:
        f.write(xml_data)
        xml_path = f.name
    
    try:
        env = os.environ.copy()
        env['ASAN_OPTIONS'] = 'detect_leaks=0:abort_on_error=0:halt_on_error=0:print_stacktrace=1'
        
        result = subprocess.run(
            ['/app/validator', '/app/schema.xsd', xml_path],
            capture_output=True,
            text=True,
            timeout=30,
            env=env
        )
        
        asan_error = 'AddressSanitizer' in result.stderr
        
        return jsonify({
            "status": "valid" if result.returncode == 0 else "invalid",
            "stdout": result.stdout,
            "stderr": result.stderr,
            "asan_triggered": asan_error,
            "returncode": result.returncode
        })
    except subprocess.TimeoutExpired:
        return jsonify({"error": "Timeout"}), 500
    except Exception as e:
        return jsonify({"error": str(e)}), 500
    finally:
        os.unlink(xml_path)

@app.route('/health')
def health():
    return jsonify({"status": "ok"})

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8080, threaded=False)
